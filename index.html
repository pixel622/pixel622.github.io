<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pok√©mon Emerald Adventure</title>
    <style>
        /* ===== FULLSCREEN RESET ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: 'Pokemon Emerald', monospace;
        }

        body {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        /* ===== EMERALD GBA SCREEN ===== */
        #game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: #8bac0f;
            overflow: hidden;
            image-rendering: pixelated;
        }

        /* ===== CANVAS ===== */
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* ===== EMERALD UI ELEMENTS ===== */
        .screen-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        .crt-effect {
            background: 
                repeating-linear-gradient(
                    0deg,
                    rgba(0, 0, 0, 0.15) 0px,
                    rgba(0, 0, 0, 0.15) 1px,
                    transparent 1px,
                    transparent 2px
                ),
                radial-gradient(
                    ellipse at center,
                    rgba(0, 0, 0, 0) 0%,
                    rgba(15, 56, 15, 0.3) 100%
                );
        }

        .scanlines {
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
        }

        /* ===== GAME SCREENS ===== */
        .game-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 2;
        }

        #intro-screen {
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        #title-screen {
            background: linear-gradient(135deg, #306230 0%, #8bac0f 100%);
        }

        #game-screen {
            background: #8bac0f;
        }

        #name-screen {
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ===== NINTENDO LOGO ===== */
        .nintendo-logo {
            text-align: center;
            animation: introFade 4s ease-in-out forwards;
        }

        .nintendo-logo .copyright {
            font-size: 15vw;
            margin-bottom: 5vh;
            color: white;
        }

        .nintendo-logo .text {
            font-size: 6vw;
            color: white;
            letter-spacing: 1vw;
        }

        .nintendo-logo .gba {
            font-size: 3vw;
            color: #8bac0f;
            margin-top: 2vh;
            letter-spacing: 0.5vw;
        }

        @keyframes introFade {
            0% { opacity: 0; transform: scale(0.8); }
            20% { opacity: 1; transform: scale(1); }
            80% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.1); }
        }

        /* ===== EMERALD TITLE SCREEN ===== */
        .title-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            text-align: center;
        }

        .pokemon-logo {
            font-size: 12vw;
            color: #ffcc00;
            text-shadow: 
                0.5vw 0.5vw 0 #306230,
                1vw 1vw 0 rgba(0, 0, 0, 0.3);
            margin-bottom: 2vh;
            animation: logoGlow 2s infinite alternate;
        }

        .emerald-text {
            font-size: 5vw;
            color: #00cc88;
            text-shadow: 0.3vw 0.3vw 0 #306230;
            margin-bottom: 8vh;
            letter-spacing: 0.5vw;
        }

        .title-menu {
            display: flex;
            flex-direction: column;
            gap: 1.5vh;
            align-items: center;
        }

        .menu-option {
            width: 60vw;
            padding: 2vh 0;
            background: #306230;
            border: 0.8vh solid #0f380f;
            color: #e8f8e0;
            font-size: 4vw;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            border-radius: 1vh;
        }

        .menu-option:hover, .menu-option.selected {
            background: #ffcc00;
            color: #306230;
            transform: translateX(2vw);
        }

        .save-info {
            margin-top: 5vh;
            font-size: 3vw;
            color: #a8a878;
        }

        @keyframes logoGlow {
            0% { text-shadow: 0.5vw 0.5vw 0 #306230, 1vw 1vw 0 rgba(0, 0, 0, 0.3); }
            100% { text-shadow: 0.5vw 0.5vw 0 #306230, 1vw 1vw 0 rgba(255, 204, 0, 0.5); }
        }

        /* ===== EMERALD DIALOG BOX ===== */
        .dialog-box {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30vh;
            background: #e8f8e0;
            border: 1.5vh solid #0f380f;
            border-left: 0;
            border-right: 0;
            border-bottom: 0;
            padding: 2vh 3vh;
            z-index: 50;
            display: none;
            box-shadow: 0 -1vh 3vh rgba(0, 0, 0, 0.3);
        }

        .dialog-text {
            font-size: 4vh;
            line-height: 5vh;
            color: #0f380f;
            height: 18vh;
            overflow: hidden;
            font-family: monospace;
        }

        .dialog-arrow {
            position: absolute;
            bottom: 2vh;
            right: 3vh;
            color: #306230;
            font-size: 4vh;
            animation: arrowBlink 1s infinite;
        }

        @keyframes arrowBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* ===== EMERALD NAME INPUT ===== */
        .name-input-container {
            background: #e8f8e0;
            border: 2vh solid #0f380f;
            padding: 5vh;
            width: 80vw;
            text-align: center;
            border-radius: 2vh;
        }

        .name-input-title {
            font-size: 4vh;
            color: #0f380f;
            margin-bottom: 3vh;
        }

        .name-display {
            font-size: 6vh;
            color: #306230;
            margin: 4vh 0;
            min-height: 8vh;
            letter-spacing: 1vh;
            font-weight: bold;
            border-bottom: 0.5vh solid #0f380f;
            padding-bottom: 2vh;
        }

        .name-keyboard {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 1vh;
            margin: 3vh 0;
        }

        .keyboard-key {
            padding: 2vh;
            background: #306230;
            color: #e8f8e0;
            border: 0.5vh solid #0f380f;
            font-size: 3vh;
            cursor: pointer;
            text-align: center;
            border-radius: 1vh;
        }

        .keyboard-key:active {
            background: #ffcc00;
            color: #306230;
        }

        .name-controls {
            display: flex;
            justify-content: center;
            gap: 3vw;
            margin-top: 4vh;
        }

        .name-btn {
            padding: 2vh 4vw;
            background: #306230;
            color: #e8f8e0;
            border: 0.5vh solid #0f380f;
            font-size: 3vh;
            cursor: pointer;
            min-width: 25vw;
            text-align: center;
            border-radius: 1vh;
        }

        .name-btn.confirm {
            background: #4a752c;
        }

        .name-btn.cancel {
            background: #d85050;
        }

        /* ===== EMERALD BATTLE SCREEN ===== */
        .battle-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #3060a8 0%, #78c850 100%);
            display: none;
            z-index: 40;
        }

        .battle-hud {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 25vh;
            background: #306230;
            border-top: 1.5vh solid #0f380f;
            padding: 2vh;
        }

        .battle-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5vh;
            height: 20vh;
        }

        .battle-option {
            background: #e8f8e0;
            border: 0.8vh solid #0f380f;
            color: #0f380f;
            font-size: 3vh;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 1vh;
        }

        .battle-option:active {
            background: #ffcc00;
        }

        .battle-info {
            position: absolute;
            top: 3vh;
            left: 3vh;
            background: #e8f8e0;
            border: 1vh solid #0f380f;
            padding: 2vh;
            width: 45vw;
            border-radius: 1vh;
        }

        .battle-info.enemy {
            left: auto;
            right: 3vh;
            text-align: right;
        }

        .pokemon-name {
            font-size: 3vh;
            color: #306230;
            margin-bottom: 1vh;
        }

        .pokemon-level {
            color: #ffcc00;
        }

        .health-bar {
            height: 2.5vh;
            background: #0f380f;
            border: 0.3vh solid #000;
            border-radius: 0.5vh;
            overflow: hidden;
            margin: 1vh 0;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(to right, #00ff00, #88ff00);
            transition: width 0.5s ease;
        }

        .health-text {
            font-size: 2.5vh;
            color: #0f380f;
        }

        .battle-sprites {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 40vh;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 5vw;
        }

        .battle-sprite {
            width: 30vw;
            height: 30vw;
            background: rgba(255, 255, 255, 0.1);
            border: 1.5vh solid rgba(255, 255, 255, 0.2);
            border-radius: 4vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20vw;
        }

        /* ===== MOBILE CONTROLS ===== */
        #mobile-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100vw;
            height: 35vh;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            padding: 3vh;
            pointer-events: none;
        }

        .dpad-container {
            width: 35vh;
            height: 35vh;
            position: relative;
            pointer-events: auto;
        }

        .dpad-button {
            position: absolute;
            width: 12vh;
            height: 12vh;
            background: rgba(48, 98, 48, 0.95);
            border: 1.5vh solid #0f380f;
            color: #e8f8e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8vh;
            cursor: pointer;
            border-radius: 3vh;
            box-shadow: 0 1vh 2vh rgba(0, 0, 0, 0.4);
        }

        .dpad-button:active {
            background: #ffcc00;
            color: #306230;
            transform: scale(0.95);
        }

        .dpad-up { top: 0; left: 11.5vh; }
        .dpad-down { bottom: 0; left: 11.5vh; }
        .dpad-left { top: 11.5vh; left: 0; }
        .dpad-right { top: 11.5vh; right: 0; }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 4vh;
            pointer-events: auto;
            align-items: center;
        }

        .action-button {
            width: 15vh;
            height: 15vh;
            background: rgba(139, 172, 15, 0.95);
            border: 1.5vh solid #306230;
            border-radius: 50%;
            color: #e8f8e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 6vh;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 1.5vh 3vh rgba(0, 0, 0, 0.5);
        }

        .action-button:active {
            background: #ffcc00;
            color: #306230;
            transform: scale(0.95);
        }

        .action-button.start {
            width: 25vh;
            height: 10vh;
            border-radius: 5vh;
            font-size: 4vh;
            margin-top: 2vh;
        }

        /* ===== ORIENTATION WARNING ===== */
        #orientation-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #ffcc00;
            text-align: center;
            padding: 5vh;
        }

        .rotate-icon {
            font-size: 25vh;
            margin-bottom: 5vh;
            animation: rotate 2s infinite linear;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(90deg); }
        }

        /* ===== LOADING SCREEN ===== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #8bac0f;
        }

        .loading-spinner {
            width: 15vh;
            height: 15vh;
            border: 2vh solid #306230;
            border-top-color: #ffcc00;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 5vh;
        }

        .loading-text {
            font-size: 4vh;
            animation: pulse 1.5s infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .pokemon-logo {
                font-size: 15vw;
            }
            .emerald-text {
                font-size: 6vw;
            }
            .menu-option {
                font-size: 5vw;
                width: 70vw;
            }
        }

        @media (orientation: portrait) {
            #orientation-warning {
                display: flex;
            }
            #mobile-controls {
                display: none;
            }
        }

        @media (orientation: landscape) {
            #orientation-warning {
                display: none;
            }
            #mobile-controls {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <!-- Game Container -->
    <div id="game-container">
        <!-- Game Screens -->
        <div id="intro-screen" class="game-screen">
            <div class="nintendo-logo">
                <div class="copyright">¬©</div>
                <div class="text">NINTENDO</div>
                <div class="gba">GAME BOY ADVANCE</div>
            </div>
        </div>
        
        <div id="title-screen" class="game-screen">
            <div class="title-container">
                <div class="pokemon-logo">POK√©MON</div>
                <div class="emerald-text">EMERALD ADVENTURE</div>
                <div class="title-menu">
                    <div class="menu-option selected" id="new-game-btn">NEW GAME</div>
                    <div class="menu-option" id="continue-btn">CONTINUE</div>
                    <div class="menu-option" id="options-btn">OPTIONS</div>
                </div>
                <div class="save-info" id="save-info">No saved data</div>
            </div>
        </div>
        
        <div id="game-screen" class="game-screen">
            <canvas id="game-canvas"></canvas>
            
            <!-- Dialog Box -->
            <div id="dialog-box" class="dialog-box">
                <div id="dialog-text" class="dialog-text"></div>
                <div class="dialog-arrow">‚ñº</div>
            </div>
        </div>
        
        <div id="name-screen" class="game-screen">
            <div class="name-input-container">
                <div class="name-input-title">What is your name?</div>
                <div id="name-display" class="name-display"></div>
                <div class="name-keyboard" id="name-keyboard"></div>
                <div class="name-controls">
                    <div class="name-btn confirm" id="confirm-name">OK</div>
                    <div class="name-btn cancel" id="cancel-name">CANCEL</div>
                </div>
            </div>
        </div>
        
        <!-- Battle Screen -->
        <div id="battle-screen" class="game-screen battle-screen">
            <div class="battle-sprites">
                <div class="battle-sprite" id="player-sprite">‚ö°</div>
                <div class="battle-sprite" id="enemy-sprite">üê¶</div>
            </div>
            
            <div class="battle-info">
                <div class="pokemon-name" id="player-pokemon-name">PIKACHU <span class="pokemon-level">Lv.5</span></div>
                <div class="health-bar">
                    <div id="player-health" class="health-fill" style="width: 100%"></div>
                </div>
                <div class="health-text" id="player-health-text">HP: 20/20</div>
            </div>
            
            <div class="battle-info enemy">
                <div class="pokemon-name" id="enemy-pokemon-name">PIDGEY <span class="pokemon-level">Lv.3</span></div>
                <div class="health-bar">
                    <div id="enemy-health" class="health-fill" style="width: 100%"></div>
                </div>
                <div class="health-text" id="enemy-health-text">HP: 18/18</div>
            </div>
            
            <div class="battle-hud">
                <div class="battle-options">
                    <div class="battle-option" data-action="fight">FIGHT</div>
                    <div class="battle-option" data-action="pokemon">POK√©MON</div>
                    <div class="battle-option" data-action="bag">BAG</div>
                    <div class="battle-option" data-action="run">RUN</div>
                </div>
            </div>
        </div>
        
        <!-- Screen Effects -->
        <div class="screen-overlay crt-effect"></div>
        <div class="screen-overlay scanlines"></div>
    </div>
    
    <!-- Mobile Controls -->
    <div id="mobile-controls">
        <div class="dpad-container">
            <div class="dpad-button dpad-up" data-direction="up">‚Üë</div>
            <div class="dpad-button dpad-down" data-direction="down">‚Üì</div>
            <div class="dpad-button dpad-left" data-direction="left">‚Üê</div>
            <div class="dpad-button dpad-right" data-direction="right">‚Üí</div>
        </div>
        
        <div class="action-buttons">
            <div class="action-button" id="btn-a">A</div>
            <div class="action-button" id="btn-b">B</div>
            <div class="action-button start" id="btn-start">START</div>
        </div>
    </div>
    
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">NOW LOADING...</div>
    </div>
    
    <!-- Orientation Warning -->
    <div id="orientation-warning">
        <div class="rotate-icon">‚Üª</div>
        <h2 style="margin-bottom: 3vh; color: #ffcc00;">PLEASE ROTATE DEVICE</h2>
        <p style="color: #8bac0f; font-size: 4vh; line-height: 1.5;">
            Pok√©mon Emerald Adventure<br>
            requires landscape mode
        </p>
    </div>

    <script>
        // ============================================
        // POK√âMON EMERALD GAME ENGINE
        // ============================================
        
        // Game State
        const GameState = {
            currentScreen: "loading",
            player: {
                name: "",
                gender: "boy",
                money: 3000,
                badges: 0,
                pokedex: { seen: [25, 16], caught: [25] },
                position: { x: 0, y: 0 },
                direction: "down",
                isRunning: false,
                team: [
                    {
                        id: 25,
                        name: "PIKACHU",
                        level: 5,
                        hp: 20,
                        maxHp: 20,
                        moves: [
                            { name: "THUNDERSHOCK", pp: 30, maxPP: 30 },
                            { name: "GROWL", pp: 40, maxPP: 40 },
                            { name: "QUICK ATTACK", pp: 30, maxPP: 30 }
                        ]
                    }
                ],
                bag: {
                    items: [
                        { id: "POTION", quantity: 3 },
                        { id: "POK√© BALL", quantity: 10 }
                    ]
                }
            },
            dialog: {
                active: false,
                lines: [],
                currentLine: 0,
                typing: false,
                speed: 30
            },
            battle: {
                active: false,
                enemy: null
            },
            map: {
                current: "littleroot",
                npcs: [
                    { x: 150, y: 200, name: "MOM", dialog: "Take care on your journey, dear!" },
                    { x: 300, y: 150, name: "PROF. BIRCH", dialog: "Welcome to the world of Pok√©mon!" }
                ]
            }
        };

        // DOM Elements
        const elements = {
            canvas: document.getElementById('game-canvas'),
            ctx: document.getElementById('game-canvas').getContext('2d'),
            screens: {
                intro: document.getElementById('intro-screen'),
                title: document.getElementById('title-screen'),
                game: document.getElementById('game-screen'),
                name: document.getElementById('name-screen'),
                battle: document.getElementById('battle-screen')
            },
            dialog: {
                box: document.getElementById('dialog-box'),
                text: document.getElementById('dialog-text')
            },
            loading: document.getElementById('loading-screen'),
            orientationWarning: document.getElementById('orientation-warning'),
            mobileControls: document.getElementById('mobile-controls')
        };

        // Initialize Game
        function initGame() {
            console.log("Starting Pok√©mon Emerald Adventure...");
            
            // Set canvas size
            resizeCanvas();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check orientation
            checkOrientation();
            
            // Start game
            setTimeout(() => {
                elements.loading.style.display = 'none';
                startIntro();
            }, 2000);
            
            // Start game loop
            requestAnimationFrame(gameLoop);
        }

        // Resize canvas to full screen
        function resizeCanvas() {
            elements.canvas.width = window.innerWidth;
            elements.canvas.height = window.innerHeight;
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Window events
            window.addEventListener('resize', resizeCanvas);
            window.addEventListener('orientationchange', checkOrientation);
            
            // Title screen buttons
            document.getElementById('new-game-btn').addEventListener('click', startNewGame);
            document.getElementById('continue-btn').addEventListener('click', continueGame);
            document.getElementById('options-btn').addEventListener('click', showOptions);
            
            // Name input
            document.getElementById('confirm-name').addEventListener('click', confirmName);
            document.getElementById('cancel-name').addEventListener('click', cancelName);
            
            // Dialog
            elements.dialog.box.addEventListener('click', handleDialogClick);
            
            // Battle buttons
            document.querySelectorAll('.battle-option').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.target.getAttribute('data-action');
                    handleBattleAction(action);
                });
            });
            
            // Mobile controls
            setupMobileControls();
            
            // Keyboard support
            document.addEventListener('keydown', handleKeyDown);
            
            // Prevent unwanted behaviors
            document.addEventListener('touchstart', (e) => {
                if (e.target === elements.canvas || 
                    e.target.closest('.dpad-button') || 
                    e.target.closest('.action-button')) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.addEventListener('contextmenu', (e) => e.preventDefault());
        }

        // Setup mobile controls
        function setupMobileControls() {
            // D-pad buttons
            document.querySelectorAll('.dpad-button').forEach(btn => {
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const direction = btn.getAttribute('data-direction');
                    startMoving(direction);
                });
                
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    stopMoving();
                });
            });
            
            // Action buttons
            document.getElementById('btn-a').addEventListener('click', handleAButton);
            document.getElementById('btn-b').addEventListener('click', handleBButton);
            document.getElementById('btn-start').addEventListener('click', handleStartButton);
        }

        // Handle keyboard input
        function handleKeyDown(e) {
            if (GameState.currentScreen === "name") {
                handleNameInputKey(e);
                return;
            }
            
            switch(e.key) {
                case 'ArrowUp':
                case 'w':
                    startMoving('up');
                    setTimeout(() => stopMoving(), 100);
                    break;
                case 'ArrowDown':
                case 's':
                    startMoving('down');
                    setTimeout(() => stopMoving(), 100);
                    break;
                case 'ArrowLeft':
                case 'a':
                    startMoving('left');
                    setTimeout(() => stopMoving(), 100);
                    break;
                case 'ArrowRight':
                case 'd':
                    startMoving('right');
                    setTimeout(() => stopMoving(), 100);
                    break;
                case 'Enter':
                case ' ':
                    handleAButton();
                    break;
                case 'Escape':
                case 'Backspace':
                    handleBButton();
                    break;
                case 'Shift':
                    GameState.player.isRunning = true;
                    break;
            }
        }

        // Movement variables
        let movementInterval = null;
        let currentDirection = null;

        function startMoving(direction) {
            if (GameState.currentScreen !== "game" || GameState.dialog.active || GameState.battle.active) return;
            
            currentDirection = direction;
            GameState.player.direction = direction;
            
            if (movementInterval) clearInterval(movementInterval);
            
            movementInterval = setInterval(() => {
                movePlayer();
            }, 16);
        }

        function stopMoving() {
            if (movementInterval) {
                clearInterval(movementInterval);
                movementInterval = null;
                currentDirection = null;
            }
            GameState.player.isRunning = false;
        }

        function movePlayer() {
            if (!currentDirection) return;
            
            const speed = GameState.player.isRunning ? 5 : 3;
            const canvas = elements.canvas;
            
            switch(currentDirection) {
                case 'up':
                    GameState.player.position.y = Math.max(20, GameState.player.position.y - speed);
                    break;
                case 'down':
                    GameState.player.position.y = Math.min(canvas.height - 20, GameState.player.position.y + speed);
                    break;
                case 'left':
                    GameState.player.position.x = Math.max(20, GameState.player.position.x - speed);
                    break;
                case 'right':
                    GameState.player.position.x = Math.min(canvas.width - 20, GameState.player.position.x + speed);
                    break;
            }
            
            // Check for random encounters
            if (Math.random() < 0.003) {
                startWildBattle();
            }
        }

        // Handle A button
        function handleAButton() {
            switch(GameState.currentScreen) {
                case "title":
                    // Menu navigation
                    break;
                case "game":
                    if (GameState.dialog.active) {
                        advanceDialog();
                    } else if (GameState.battle.active) {
                        // Battle handled by buttons
                    } else {
                        interact();
                    }
                    break;
                case "battle":
                    // Battle handled by buttons
                    break;
            }
        }

        // Handle B button
        function handleBButton() {
            if (GameState.dialog.active) {
                if (GameState.dialog.typing) {
                    GameState.dialog.typing = false;
                    elements.dialog.text.textContent = GameState.dialog.lines[GameState.dialog.currentLine - 1];
                } else {
                    advanceDialog();
                }
            } else if (GameState.battle.active) {
                endBattle();
            }
        }

        // Handle Start button
        function handleStartButton() {
            if (GameState.currentScreen === "game" && !GameState.dialog.active && !GameState.battle.active) {
                showDialog([
                    "TRAINER CARD",
                    GameState.player.name,
                    "BADGES: " + GameState.player.badges + "/8",
                    "POK√©DEX: " + GameState.player.pokedex.seen.length,
                    "TIME: 0:00",
                    "MONEY: $" + GameState.player.money
                ]);
            }
        }

        // ============================================
        // GAME SCREENS
        // ============================================

        function startIntro() {
            GameState.currentScreen = "intro";
            
            setTimeout(() => {
                showTitleScreen();
            }, 4000);
        }

        function showTitleScreen() {
            GameState.currentScreen = "title";
            elements.screens.intro.style.display = 'none';
            elements.screens.title.style.display = 'block';
            
            // Update save info
            updateSaveInfo();
        }

        function startNewGame() {
            GameState.player.name = "";
            showNameInput();
        }

        function showNameInput() {
            GameState.currentScreen = "name";
            elements.screens.title.style.display = 'none';
            elements.screens.name.style.display = 'flex';
            
            // Create keyboard
            createKeyboard();
            updateNameDisplay();
        }

        function createKeyboard() {
            const keyboard = document.getElementById('name-keyboard');
            keyboard.innerHTML = '';
            
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            
            // Create letter keys
            for (let i = 0; i < letters.length; i++) {
                const key = document.createElement('div');
                key.className = 'keyboard-key';
                key.textContent = letters[i];
                key.addEventListener('click', () => {
                    if (GameState.player.name.length < 10) {
                        GameState.player.name += letters[i];
                        updateNameDisplay();
                    }
                });
                keyboard.appendChild(key);
            }
            
            // Add space and backspace
            const space = document.createElement('div');
            space.className = 'keyboard-key';
            space.textContent = 'SPACE';
            space.style.gridColumn = 'span 2';
            space.addEventListener('click', () => {
                if (GameState.player.name.length < 10) {
                    GameState.player.name += ' ';
                    updateNameDisplay();
                }
            });
            keyboard.appendChild(space);
            
            const backspace = document.createElement('div');
            backspace.className = 'keyboard-key';
            backspace.textContent = '‚å´';
            backspace.style.gridColumn = 'span 2';
            backspace.addEventListener('click', () => {
                GameState.player.name = GameState.player.name.slice(0, -1);
                updateNameDisplay();
            });
            keyboard.appendChild(backspace);
        }

        function updateNameDisplay() {
            document.getElementById('name-display').textContent = 
                GameState.player.name.padEnd(10, '_');
        }

        function handleNameInputKey(e) {
            if (e.key === 'Backspace') {
                GameState.player.name = GameState.player.name.slice(0, -1);
            } else if (e.key === 'Enter') {
                confirmName();
            } else if (e.key.length === 1 && /[A-Za-z]/.test(e.key)) {
                if (GameState.player.name.length < 10) {
                    GameState.player.name += e.key.toUpperCase();
                }
            }
            updateNameDisplay();
            e.preventDefault();
        }

        function confirmName() {
            if (GameState.player.name.trim().length > 0) {
                GameState.player.name = GameState.player.name.trim().toUpperCase();
                startGame();
            } else {
                showDialog("Please enter your name!");
            }
        }

        function cancelName() {
            showTitleScreen();
        }

        function startGame() {
            GameState.currentScreen = "game";
            elements.screens.name.style.display = 'none';
            elements.screens.game.style.display = 'block';
            elements.mobileControls.style.display = 'flex';
            
            // Center player
            GameState.player.position.x = elements.canvas.width / 2;
            GameState.player.position.y = elements.canvas.height / 2;
            
            // Start game introduction
            startGameIntro();
        }

        function startGameIntro() {
            showDialog([
                "Hello there! Welcome to the world",
                "of POK√©MON! My name is BIRCH!",
                "But everyone calls me the POK√©MON",
                "PROFESSOR!"
            ], () => {
                setTimeout(() => {
                    showDialog([
                        "This world is widely inhabited by",
                        "creatures known as POK√©MON.",
                        "We humans live alongside POK√©MON,",
                        "at times as friendly playmates,",
                        "and at times as cooperative",
                        "workmates."
                    ], () => {
                        setTimeout(() => {
                            showDialog([
                                "And sometimes, we band together",
                                "and battle others like us.",
                                "But despite our closeness, we",
                                "don't know everything about",
                                "POK√©MON."
                            ], () => {
                                setTimeout(() => {
                                    showDialog([
                                        "In fact, there are many,",
                                        "many secrets surrounding",
                                        "POK√©MON.",
                                        "I study POK√©MON as a",
                                        "profession."
                                    ], () => {
                                        setTimeout(() => {
                                            showDialog([
                                                `So, ${GameState.player.name}!`,
                                                "I hear you're moving next door!",
                                                "I have a favor to ask.",
                                                "Come see me in my LAB, OK?"
                                            ]);
                                        }, 1000);
                                    });
                                }, 1000);
                            });
                        }, 1000);
                    });
                }, 1000);
            });
        }

        function continueGame() {
            const saved = localStorage.getItem('pokemon_save');
            if (saved) {
                try {
                    GameState.player = JSON.parse(saved);
                    startGame();
                    showDialog(`Welcome back, ${GameState.player.name}!`);
                } catch (e) {
                    showDialog("Save data corrupted!");
                }
            } else {
                showDialog("No save data found!");
            }
        }

        function showOptions() {
            showDialog([
                "OPTIONS",
                "Text Speed: FAST",
                "Battle Style: SET",
                "Sound: ON",
                "Music: ON",
                "Button Mode: HELP"
            ]);
        }

        function updateSaveInfo() {
            const saved = localStorage.getItem('pokemon_save');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    document.getElementById('save-info').textContent = 
                        `Saved: ${data.name} | ${data.badges} badges`;
                } catch (e) {
                    document.getElementById('save-info').textContent = "No saved data";
                }
            } else {
                document.getElementById('save-info').textContent = "No saved data";
            }
        }

        // ============================================
        // DIALOG SYSTEM
        // ============================================

        function showDialog(lines, callback = null) {
            if (typeof lines === 'string') {
                GameState.dialog.lines = lines.split('\n');
            } else {
                GameState.dialog.lines = lines;
            }
            
            GameState.dialog.active = true;
            GameState.dialog.currentLine = 0;
            GameState.dialog.typing = true;
            GameState.dialog.callback = callback;
            
            elements.dialog.box.style.display = 'block';
            typeDialog();
        }

        function typeDialog() {
            if (GameState.dialog.currentLine >= GameState.dialog.lines.length) {
                GameState.dialog.typing = false;
                if (GameState.dialog.callback) {
                    setTimeout(GameState.dialog.callback, 500);
                }
                return;
            }
            
            const line = GameState.dialog.lines[GameState.dialog.currentLine];
            elements.dialog.text.textContent = '';
            GameState.dialog.currentLine++;
            
            let i = 0;
            const typeChar = () => {
                if (i < line.length && GameState.dialog.typing) {
                    elements.dialog.text.textContent += line.charAt(i);
                    i++;
                    setTimeout(typeChar, GameState.dialog.speed);
                } else {
                    GameState.dialog.typing = false;
                }
            };
            
            typeChar();
        }

        function handleDialogClick() {
            if (GameState.dialog.active) {
                if (GameState.dialog.typing) {
                    GameState.dialog.typing = false;
                    elements.dialog.text.textContent = GameState.dialog.lines[GameState.dialog.currentLine - 1];
                } else {
                    advanceDialog();
                }
            }
        }

        function advanceDialog() {
            if (GameState.dialog.typing) {
                GameState.dialog.typing = false;
                elements.dialog.text.textContent = GameState.dialog.lines[GameState.dialog.currentLine - 1];
            } else {
                if (GameState.dialog.currentLine < GameState.dialog.lines.length) {
                    typeDialog();
                } else {
                    closeDialog();
                }
            }
        }

        function closeDialog() {
            GameState.dialog.active = false;
            elements.dialog.box.style.display = 'none';
            GameState.dialog.callback = null;
        }

        // ============================================
        // GAMEPLAY FUNCTIONS
        // ============================================

        function interact() {
            // Check for NPC interactions
            for (const npc of GameState.map.npcs) {
                const distance = Math.sqrt(
                    Math.pow(GameState.player.position.x - npc.x, 2) + 
                    Math.pow(GameState.player.position.y - npc.y, 2)
                );
                
                if (distance < 50) {
                    showDialog(npc.dialog);
                    return;
                }
            }
            
            // Check for map objects
            const canvas = elements.canvas;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Check if near house
            if (GameState.player.position.x > centerX - 100 && 
                GameState.player.position.x < centerX + 100 &&
                GameState.player.position.y > centerY - 100 && 
                GameState.player.position.y < centerY + 100) {
                showDialog("This is your house. Your mom is inside!");
                return;
            }
            
            // Default message
            showDialog("There's nothing to do here.");
        }

        // ============================================
        // BATTLE SYSTEM
        // ============================================

        function startWildBattle() {
            if (GameState.battle.active || GameState.dialog.active) return;
            
            GameState.battle.active = true;
            GameState.currentScreen = "battle";
            elements.screens.game.style.display = 'none';
            elements.screens.battle.style.display = 'block';
            
            // Create wild Pok√©mon
            GameState.battle.enemy = {
                id: 16,
                name: "PIDGEY",
                level: 3,
                hp: 18,
                maxHp: 18
            };
            
            // Update battle UI
            updateBattleUI();
            
            // Show battle message
            showDialog(`Wild ${GameState.battle.enemy.name} appeared!`);
        }

        function updateBattleUI() {
            const player = GameState.player.team[0];
            const enemy = GameState.battle.enemy;
            
            // Update names
            document.getElementById('player-pokemon-name').textContent = 
                `${player.name} Lv.${player.level}`;
            document.getElementById('enemy-pokemon-name').textContent = 
                `${enemy.name} Lv.${enemy.level}`;
            
            // Update health bars
            const playerHealthPercent = (player.hp / player.maxHp) * 100;
            const enemyHealthPercent = (enemy.hp / enemy.maxHp) * 100;
            
            document.getElementById('player-health').style.width = `${playerHealthPercent}%`;
            document.getElementById('enemy-health').style.width = `${enemyHealthPercent}%`;
            
            // Update health text
            document.getElementById('player-health-text').textContent = 
                `HP: ${player.hp}/${player.maxHp}`;
            document.getElementById('enemy-health-text').textContent = 
                `HP: ${enemy.hp}/${enemy.maxHp}`;
        }

        function handleBattleAction(action) {
            if (!GameState.battle.active) return;
            
            switch(action) {
                case 'fight':
                    useMove("THUNDERSHOCK");
                    break;
                case 'pokemon':
                    showDialog("Choose a POK√©MON.");
                    break;
                case 'bag':
                    showDialog("Opened the BAG.");
                    break;
                case 'run':
                    attemptRun();
                    break;
            }
        }

        function useMove(moveName) {
            const player = GameState.player.team[0];
            const enemy = GameState.battle.enemy;
            
            // Calculate damage
            const damage = Math.floor(Math.random() * 10) + 5;
            enemy.hp = Math.max(0, enemy.hp - damage);
            
            // Show message
            showDialog(`${player.name} used ${moveName}!`);
            
            // Update UI
            updateBattleUI();
            
            // Check if enemy fainted
            if (enemy.hp <= 0) {
                enemyFainted();
            } else {
                setTimeout(enemyTurn, 1500);
            }
        }

        function enemyTurn() {
            const player = GameState.player.team[0];
            const enemy = GameState.battle.enemy;
            
            // Enemy attacks
            const damage = Math.floor(Math.random() * 8) + 3;
            player.hp = Math.max(0, player.hp - damage);
            
            // Show message
            showDialog(`Foe ${enemy.name} used TACKLE!`);
            
            // Update UI
            updateBattleUI();
            
            // Check if player fainted
            if (player.hp <= 0) {
                playerFainted();
            }
        }

        function enemyFainted() {
            const enemy = GameState.battle.enemy;
            const player = GameState.player.team[0];
            
            // Give experience
            const exp = enemy.level * 15;
            
            showDialog(`Foe ${enemy.name} fainted!`);
            setTimeout(() => {
                showDialog(`${player.name} gained ${exp} EXP. Points!`);
                setTimeout(endBattle, 1500);
            }, 1500);
        }

        function playerFainted() {
            const player = GameState.player.team[0];
            
            showDialog(`${player.name} fainted!`);
            setTimeout(() => {
                showDialog("You have no more POK√©MON!");
                setTimeout(() => {
                    showDialog("You blacked out!");
                    setTimeout(endBattle, 1500);
                }, 1500);
            }, 1500);
        }

        function attemptRun() {
            const success = Math.random() > 0.3;
            if (success) {
                showDialog("Got away safely!");
                setTimeout(endBattle, 1000);
            } else {
                showDialog("Can't escape!");
                setTimeout(enemyTurn, 1500);
            }
        }

        function endBattle() {
            GameState.battle.active = false;
            GameState.currentScreen = "game";
            elements.screens.battle.style.display = 'none';
            elements.screens.game.style.display = 'block';
            closeDialog();
        }

        // ============================================
        // RENDERING
        // ============================================

        function drawGameWorld() {
            const ctx = elements.ctx;
            const canvas = elements.canvas;
            
            // Clear canvas
            ctx.fillStyle = '#8bac0f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw grass pattern
            drawGrass();
            
            // Draw path
            drawPath();
            
            // Draw player's house
            drawHouse();
            
            // Draw NPCs
            drawNPCs();
            
            // Draw player
            drawPlayer();
            
            // Draw minimap/HUD
            drawHUD();
        }

        function drawGrass() {
            const ctx = elements.ctx;
            const canvas = elements.canvas;
            const tileSize = 40;
            
            ctx.fillStyle = '#4a752c';
            for (let y = 0; y < canvas.height; y += tileSize) {
                for (let x = 0; x < canvas.width; x += tileSize) {
                    // Alternate grass color for pattern
                    if ((x + y) % (tileSize * 2) === 0) {
                        ctx.fillStyle = '#5a853c';
                    } else {
                        ctx.fillStyle = '#4a752c';
                    }
                    ctx.fillRect(x, y, tileSize, tileSize);
                    
                    // Grass border
                    ctx.strokeStyle = '#0f380f';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, tileSize, tileSize);
                }
            }
        }

        function drawPath() {
            const ctx = elements.ctx;
            const canvas = elements.canvas;
            
            // Draw main horizontal path
            ctx.fillStyle = '#a8a878';
            const pathWidth = canvas.width * 0.25;
            const pathX = (canvas.width - pathWidth) / 2;
            ctx.fillRect(pathX, 0, pathWidth, canvas.height);
            
            // Draw path border
            ctx.strokeStyle = '#0f380f';
            ctx.lineWidth = 3;
            ctx.strokeRect(pathX, 0, pathWidth, canvas.height);
        }

        function drawHouse() {
            const ctx = elements.ctx;
            const canvas = elements.canvas;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Draw house base
            ctx.fillStyle = '#d87070';
            ctx.fillRect(centerX - 60, centerY - 80, 120, 100);
            
            // Draw roof
            ctx.fillStyle = '#306230';
            ctx.beginPath();
            ctx.moveTo(centerX - 70, centerY - 80);
            ctx.lineTo(centerX + 70, centerY - 80);
            ctx.lineTo(centerX, centerY - 120);
            ctx.closePath();
            ctx.fill();
            
            // Draw door
            ctx.fillStyle = '#0f380f';
            ctx.fillRect(centerX - 15, centerY - 20, 30, 40);
            
            // Draw window
            ctx.fillStyle = '#a0d8f1';
            ctx.fillRect(centerX - 45, centerY - 60, 30, 30);
            ctx.strokeStyle = '#0f380f';
            ctx.lineWidth = 2;
            ctx.strokeRect(centerX - 45, centerY - 60, 30, 30);
            
            // Draw house border
            ctx.strokeStyle = '#0f380f';
            ctx.lineWidth = 3;
            ctx.strokeRect(centerX - 60, centerY - 80, 120, 100);
            
            // Draw label
            ctx.fillStyle = '#0f380f';
            ctx.font = 'bold 20px monospace';
            ctx.textAlign = 'center';
            ctx.fillText("YOUR HOUSE", centerX, centerY + 40);
        }

        function drawNPCs() {
            const ctx = elements.ctx;
            
            GameState.map.npcs.forEach(npc => {
                // Draw NPC body
                ctx.fillStyle = '#3060a8';
                ctx.fillRect(npc.x - 15, npc.y - 15, 30, 30);
                
                // Draw NPC face
                ctx.fillStyle = '#ffcc00';
                ctx.fillRect(npc.x - 8, npc.y - 15, 16, 8);
                
                // Draw name tag
                ctx.fillStyle = '#0f380f';
                ctx.font = '14px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(npc.name, npc.x, npc.y - 25);
            });
        }

        function drawPlayer() {
            const ctx = elements.ctx;
            const x = GameState.player.position.x;
            const y = GameState.player.position.y;
            
            // Draw player body
            ctx.fillStyle = '#3060a8';
            ctx.fillRect(x - 15, y - 15, 30, 30);
            
            // Draw direction indicator
            ctx.fillStyle = '#ffcc00';
            switch(GameState.player.direction) {
                case 'up':
                    ctx.fillRect(x - 8, y - 15, 16, 8);
                    break;
                case 'down':
                    ctx.fillRect(x - 8, y + 7, 16, 8);
                    break;
                case 'left':
                    ctx.fillRect(x - 15, y - 8, 8, 16);
                    break;
                case 'right':
                    ctx.fillRect(x + 7, y - 8, 8, 16);
                    break;
            }
            
            // Draw running effect
            if (GameState.player.isRunning) {
                ctx.fillStyle = '#ff4444';
                ctx.beginPath();
                ctx.arc(x, y + 20, 5, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawHUD() {
            const ctx = elements.ctx;
            const canvas = elements.canvas;
            
            // Draw HUD background
            ctx.fillStyle = 'rgba(15, 56, 15, 0.8)';
            ctx.fillRect(10, 10, 250, 60);
            ctx.strokeStyle = '#8bac0f';
            ctx.lineWidth = 3;
            ctx.strokeRect(10, 10, 250, 60);
            
            // Draw player info
            ctx.fillStyle = '#e8f8e0';
            ctx.font = '16px monospace';
            ctx.textAlign = 'left';
            
            if (GameState.player.name) {
                ctx.fillText(GameState.player.name, 20, 35);
            } else {
                ctx.fillText("PLAYER", 20, 35);
            }
            
            ctx.fillText(`$${GameState.player.money}`, 20, 60);
            ctx.fillText(`TIME: 0:00`, 150, 35);
            ctx.fillText(`BADGES: ${GameState.player.badges}/8`, 150, 60);
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function checkOrientation() {
            const isPortrait = window.innerHeight > window.innerWidth;
            
            if (isPortrait) {
                elements.orientationWarning.style.display = 'flex';
                elements.mobileControls.style.display = 'none';
            } else {
                elements.orientationWarning.style.display = 'none';
                if (GameState.currentScreen === "game") {
                    elements.mobileControls.style.display = 'flex';
                }
            }
        }

        // ============================================
        // GAME LOOP
        // ============================================

        function gameLoop() {
            // Draw game if in gameplay screen
            if (GameState.currentScreen === "game" && !GameState.dialog.active && !GameState.battle.active) {
                drawGameWorld();
            }
            
            // Continue loop
            requestAnimationFrame(gameLoop);
        }

        // ============================================
        // START GAME
        // ============================================

        window.addEventListener('load', initGame);
        
        // Prevent pull-to-refresh
        document.addEventListener('touchmove', (e) => {
            if (GameState.currentScreen === "game") {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
