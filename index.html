<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kyan Monsters - Amber Version</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }
        body {
            background: #000;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            font-family: 'Courier New', monospace;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        #gameContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
        }
        #gameCanvas {
            width: 100vw;
            height: 100vh;
            display: block;
            image-rendering: pixelated;
        }
        #ui {
            position: fixed;
            top: 10px;
            left: 10px;
            color: #fff;
            font-size: 16px;
            text-shadow: 2px 2px 0 #000;
            font-family: 'Courier New', monospace;
            z-index: 10;
            pointer-events: none;
        }
        #gbaDialog {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(16,16,32,0.9));
            border-top: 4px solid #fff;
            color: #fff;
            font-size: 18px;
            font-family: 'Courier New', monospace;
            padding: 15px 25px;
            box-sizing: border-box;
            display: none;
            z-index: 20;
            text-shadow: 2px 2px 0 #000;
            line-height: 1.3;
            pointer-events: all;
        }
        #dialogText {
            font-weight: bold;
            font-size: 16px;
        }
        #dialogPress {
            position: absolute;
            bottom: 8px;
            right: 25px;
            color: #ccc;
            font-size: 14px;
        }
        #joystick {
            position: fixed;
            bottom: 80px;
            left: 40px;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: 3px solid rgba(255,255,255,0.4);
            display: none;
            z-index: 15;
        }
        #joystickKnob {
            position: absolute;
            width: 36px;
            height: 36px;
            background: #fff;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
        }
        #actionBtn {
            position: fixed;
            bottom: 80px;
            right: 40px;
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #4CAF50, #45a049);
            border: 4px solid #fff;
            border-radius: 50%;
            color: #fff;
            font-size: 28px;
            font-weight: bold;
            display: none;
            z-index: 15;
            box-shadow: 0 6px 20px rgba(0,0,0,0.6);
        }
        #actionBtn:active {
            background: linear-gradient(145deg, #45a049, #4CAF50);
            transform: scale(0.92);
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="ui">
            <div>Location: <span id="location">Home</span></div>
            <div>Kyan Monster: <span id="monster">None</span></div>
        </div>
        <div id="gbaDialog">
            <div id="dialogText"></div>
            <div id="dialogPress">Tap to continue</div>
        </div>
        <div id="joystick">
            <div id="joystickKnob"></div>
        </div>
        <div id="actionBtn">A</div>
    </div>

    <script>
        class KyanGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.ctx.imageSmoothingEnabled = false;
                
                // Game state
                this.currentScene = 'houseIntro';
                this.player = { x: 152, y: 152, vx: 0, vy: 0, speed: 2.5, dir: 'down' };
                this.playerName = 'TRAINER';
                this.kyanMonster = null;
                this.rivalMonster = null;
                this.dialogActive = false;
                this.dialogLines = [];
                this.dialogIndex = 0;
                this.joystickActive = false;
                this.joystickCenter = { x: 0, y: 0 };
                this.joystickPos = { x: 0, y: 0 };
                this.gameWidth = 320;
                this.gameHeight = 240;
                
                this.init();
            }
            
            init() {
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                
                // Full screen touch controls
                document.addEventListener('touchstart', (e) => this.handleInput(e, 'start'), { passive: false });
                document.addEventListener('touchmove', (e) => this.handleInput(e, 'move'), { passive: false });
                document.addEventListener('touchend', (e) => this.handleInput(e, 'end'), { passive: false });
                document.addEventListener('click', (e) => this.handleClick(e));
                
                document.getElementById('actionBtn').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.interact();
                });
                
                this.startIntro();
                this.gameLoop();
            }
            
            resizeCanvas() {
                const aspect = this.gameWidth / this.gameHeight;
                let width = window.innerWidth;
                let height = window.innerHeight;
                
                if (width / height > aspect) {
                    width = height * aspect;
                } else {
                    height = width / aspect;
                }
                
                this.canvas.width = this.gameWidth;
                this.canvas.height = this.gameHeight;
                this.canvas.style.width = width + 'px';
                this.canvas.style.height = height + 'px';
                this.canvas.style.marginLeft = (window.innerWidth - width) / 2 + 'px';
                this.canvas.style.marginTop = (window.innerHeight - height) / 2 + 'px';
            }
            
            handleInput(e, type) {
                e.preventDefault();
                if (this.dialogActive) return;
                
                const rect = this.canvas.getBoundingClientRect();
                const scaleX = this.gameWidth / rect.width;
                const scaleY = this.gameHeight / rect.height;
                
                if (type === 'start' || type === 'move') {
                    const touch = e.touches[0];
                    const x = (touch.clientX - rect.left) * scaleX;
                    const y = (touch.clientY - rect.top) * scaleY;
                    
                    // Joystick area (left bottom)
                    if (x < rect.width * 0.4 && y > rect.height * 0.6) {
                        this.joystickActive = true;
                        this.joystickCenter = { x: 60, y: this.gameHeight - 60 };
                        document.getElementById('joystick').style.display = 'block';
                        document.getElementById('actionBtn').style.display = 'block';
                    }
                    
                    if (this.joystickActive) {
                        const dx = x - this.joystickCenter.x;
                        const dy = y - this.joystickCenter.y;
                        const dist = Math.min(35, Math.sqrt(dx*dx + dy*dy));
                        const angle = Math.atan2(dy, dx);
                        
                        this.joystickPos = {
                            x: this.joystickCenter.x + Math.cos(angle) * dist,
                            y: this.joystickCenter.y + Math.sin(angle) * dist
                        };
                        
                        this.player.vx = Math.cos(angle) * this.player.speed * (dist / 35);
                        this.player.vy = Math.sin(angle) * this.player.speed * (dist / 35);
                        
                        this.updateJoystickUI();
                    }
                } else {
                    this.resetJoystick();
                }
            }
            
            handleClick(e) {
                if (this.dialogActive) {
                    e.preventDefault();
                    this.nextDialog();
                }
            }
            
            resetJoystick() {
                this.joystickActive = false;
                this.player.vx = 0;
                this.player.vy = 0;
                this.joystickPos = { x: this.joystickCenter.x, y: this.joystickCenter.y };
                this.updateJoystickUI();
                setTimeout(() => {
                    document.getElementById('joystick').style.display = 'none';
                    document.getElementById('actionBtn').style.display = 'none';
                }, 150);
            }
            
            updateJoystickUI() {
                const knob = document.getElementById('joystickKnob');
                knob.style.left = ((this.joystickPos.x - 18) / this.gameWidth * 100) + '%';
                knob.style.top = ((this.joystickPos.y - 18) / this.gameHeight * 100) + '%';
            }
            
            startIntro() {
                this.showDialog([
                    "MOM: Wake up! Urgent letter from Professor Sequoia!",
                    "MOM: Your childhood friend already left for the lab.",
                    "MOM: Head to Professor Sequoia's Habitat Research Lab!",
                    "MAPLE ROOT TOWN awaits..."
                ]);
            }
            
            showDialog(lines) {
                this.dialogLines = lines;
                this.dialogIndex = 0;
                this.dialogActive = true;
                this.showCurrentDialog();
            }
            
            showCurrentDialog() {
                if (this.dialogIndex < this.dialogLines.length) {
                    const dialogEl = document.getElementById('dialogText');
                    dialogEl.textContent = this.dialogLines[this.dialogIndex];
                    document.getElementById('gbaDialog').style.display = 'block';
                }
            }
            
            nextDialog() {
                this.dialogIndex++;
                if (this.dialogIndex < this.dialogLines.length) {
                    this.showCurrentDialog();
                } else {
                    document.getElementById('gbaDialog').style.display = 'none';
                    this.dialogActive = false;
                    
                    if (this.currentScene === 'houseIntro') {
                        this.currentScene = 'house';
                        document.getElementById('location').textContent = 'House';
                    }
                }
            }
            
            interact() {
                if (this.dialogActive) return;
                
                const tileX = Math.floor(this.player.x / 16);
                const tileY = Math.floor(this.player.y / 16);
                
                switch(this.currentScene) {
                    case 'house':
                        if (tileX === 9 && tileY === 9) {
                            this.currentScene = 'town';
                            this.player.x = 128;
                            this.player.y = 192;
                            document.getElementById('location').textContent = 'Maple Root Town';
                            this.showDialog(['Welcome to Maple Root Town!']);
                        }
                        break;
                        
                    case 'town':
                        if (tileX === 14 && tileY === 8) {
                            this.currentScene = 'labGroundFloor';
                            this.player.x = 32;
                            this.player.y = 128;
                            document.getElementById('location').textContent = 'Lab Ground Floor';
                            this.showDialog([
                                "LAB ASSISTANT: Ah, you must be TRAINER!",
                                "PROFESSOR: Go upstairs through that door!",
                                "DOOR TELEPORT ACTIVATED!"
                            ]);
                        }
                        break;
                        
                    case 'labGroundFloor':
                        if (tileX === 12 && tileY === 8) {
                            this.teleportEffect();
                            setTimeout(() => {
                                this.currentScene = 'labUpperFloor';
                                this.player.x = 128;
                                this.player.y = 64;
                                document.getElementById('location').textContent = 'Lab Upper Floor';
                            }, 200);
                        }
                        break;
                        
                    case 'labUpperFloor':
                        if (tileX === 8 && tileY === 12) {
                            this.teleportEffect();
                            setTimeout(() => {
                                this.currentScene = 'professorStudy';
                                this.player.x = 128;
                                this.player.y = 64;
                                document.getElementById('location').textContent = 'Professor Study';
                                this.professorScene();
                            }, 200);
                        }
                        break;
                }
            }
            
            professorScene() {
                if (!this.kyanMonster) {
                    this.showDialog([
                        "PROFESSOR SEQUOIA: Three Kyan Monsters from distant regions...",
                        "PROFESSOR: A tremor shook Orebound! We need trainers!",
                        "RIVAL: I choose FLAMEPUP (Fire)!",
                        "RIVAL: It beats whatever you pick!",
                        "PROFESSOR: Choose your partner TRAINER:",
                        "1. Leaflet (Grass)  2. Bubbletoad (Water)"
                    ]);
                    setTimeout(() => {
                        this.kyanMonster = { name: 'Leaflet (Grass)', color: '#4CAF50' };
                        this.rivalMonster = { name: 'Flamepup (Fire)', color: '#f44336' };
                        document.getElementById('monster').textContent = this.kyanMonster.name;
                        this.showDialog([
                            "PROFESSOR: Here's your KYANDEX!",
                            "MISSION: Find assistant on Route 1 for Kyan Balls!",
                            "UNCOVER OREBOUND'S SEISMIC MYSTERY!",
                            "A New Adventure Takes Root!"
                        ]);
                    }, 12000);
                }
            }
            
            teleportEffect() {
                const ctx = this.ctx;
                const steps = 10;
                let i = 0;
                const shimmer = setInterval(() => {
                    ctx.save();
                    ctx.globalAlpha = 0.6;
                    ctx.fillStyle = `hsl(60, 100%, ${50 + i*5}%)`;
                    ctx.fillRect(this.player.x - 12, this.player.y - 12, 32, 32);
                    ctx.restore();
                    i++;
                    if (i >= steps) clearInterval(shimmer);
                }, 50);
            }
            
            update() {
                if (!this.dialogActive && this.joystickActive) {
                    this.player.x = Math.max(8, Math.min(this.gameWidth - 24, this.player.x + this.player.vx));
                    this.player.y = Math.max(8, Math.min(this.gameHeight - 32, this.player.y + this.player.vy));
                    this.checkSceneTransitions();
                }
            }
            
            checkSceneTransitions() {
                const tileX = Math.floor(this.player.x / 16);
                const tileY = Math.floor(this.player.y / 16);
                
                if (this.currentScene === 'professorStudy' && tileX === 8 && tileY === 14) {
                    this.teleportEffect();
                    setTimeout(() => {
                        this.currentScene = 'labUpperFloor';
                        this.player.x = 128;
                        this.player.y = 64;
                        document.getElementById('location').textContent = 'Lab Upper Floor';
                    }, 200);
                }
            }
            
            renderHouse() {
                const ctx = this.ctx;
                ctx.fillStyle = '#87CEEB'; // Sky
                ctx.fillRect(0, 0, this.gameWidth, 80);
                ctx.fillStyle = '#DEB887'; // Floor
                ctx.fillRect(0, 160, this.gameWidth, 80);
                ctx.fillStyle = '#8B4513'; // Walls
                ctx.fillRect(80, 80, 160, 80);
                ctx.fillStyle = '#A52A2A'; // Roof
                ctx.fillRect(64, 64, 192, 32);
                ctx.fillStyle = '#654321'; // Door
                ctx.fillRect(144, 144, 32, 48);
                ctx.fillStyle = '#D2691E'; // Bookshelf
                ctx.fillRect(16, 120, 32, 80);
            }
            
            renderTown() {
                const ctx = this.ctx;
                ctx.fillStyle = '#87CEEB'; // Sky
                ctx.fillRect(0, 0, this.gameWidth, 96);
                ctx.fillStyle = '#90EE90'; // Grass
                ctx.fillRect(0, 160, this.gameWidth, 80);
                ctx.fillStyle = '#8B4513'; // Tree trunk
                ctx.fillRect(144, 112, 32, 80);
                ctx.fillStyle = '#228B22'; // Tree leaves
                ctx.fillRect(128, 64, 64, 64);
                ctx.fillStyle = '#DEB887'; // Cottages
                ctx.fillRect(32, 144, 64, 64);
                ctx.fillRect(224, 144, 64, 64);
                ctx.fillStyle = '#D2B48C'; // Path
                ctx.fillRect(240, 112, 64, 32);
                ctx.fillStyle = '#A9A9A9'; // Lab
                ctx.fillRect(256, 144, 48, 48);
            }
            
            renderLabGroundFloor() {
                const ctx = this.ctx;
                ctx.fillStyle = '#C0C0C0'; // Floor
                ctx.fillRect(0, 0, this.gameWidth, this.gameHeight);
                ctx.fillStyle = '#00BFFF'; // Tanks
                ctx.fillRect(32, 48, 48, 48);
                ctx.fillRect(96, 48, 48, 48);
                ctx.fillStyle = '#FFFF00'; // Charts
                ctx.fillRect(160, 32, 80, 32);
                ctx.fillStyle = '#808080'; // Door
                ctx.fillRect(208, 128, 32, 32);
            }
            
            renderLabUpperFloor() {
                const ctx = this.ctx;
                ctx.fillStyle = '#F5DEB3'; // Wood floor
                ctx.fillRect(0, 0, this.gameWidth, this.gameHeight);
                ctx.fillStyle = '#8B4513'; // Bookshelves
                ctx.fillRect(16, 48, 32, 128);
                ctx.fillRect(272, 48, 32, 128);
                ctx.fillStyle = '#808080'; // Door
                ctx.fillRect(128, 208, 64, 32);
            }
            
            renderProfessorStudy() {
                this.renderLabUpperFloor();
                const ctx = this.ctx;
                ctx.fillStyle = '#D2691E'; // Desk
                ctx.fillRect(112, 160, 96, 32);
                ctx.fillStyle = '#FF4444'; // Kyan Balls
                ctx.fillRect(128, 168, 12, 12);
                ctx.fillRect(160, 168, 12, 12);
                ctx.fillRect(192, 168, 12, 12);
                ctx.fillStyle = '#FFF'; // Ball highlights
                ctx.fillRect(132, 172, 4, 4);
                ctx.fillRect(164, 172, 4, 4);
                ctx.fillRect(196, 172, 4, 4);
                ctx.fillStyle = '#4488FF'; // Professor
                ctx.fillRect(96, 96, 16, 24);
                ctx.fillStyle = '#FF4444'; // Rival
                ctx.fillRect(208, 96, 16, 24);
            }
            
            renderPlayer() {
                const ctx = this.ctx;
                ctx.fillStyle = '#FFDBAC'; // Skin
                ctx.fillRect(this.player.x + 4, this.player.y + 4, 8, 8);
                ctx.fillStyle = '#00008B'; // Pants
                ctx.fillRect(this.player.x + 2, this.player.y + 12, 12, 8);
                ctx.fillStyle = '#FFFF66'; // Shirt
                ctx.fillRect(this.player.x, this.player.y + 8, 16, 8);
                ctx.fillStyle = '#000'; // Hat/shoes
                ctx.fillRect(this.player.x + 2, this.player.y, 12, 6);
                ctx.fillRect(this.player.x + 4, this.player.y + 20, 8, 4);
            }
            
            renderScene() {
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.gameWidth, this.gameHeight);
                
                switch(this.currentScene) {
                    case 'houseIntro':
                    case 'house':
                        this.renderHouse();
                        break;
                    case 'town':
                        this.renderTown();
                        break;
                    case 'labGroundFloor':
                        this.renderLabGroundFloor();
                        break;
                    case 'labUpperFloor':
                        this.renderLabUpperFloor();
                        break;
                    case 'professorStudy':
                        this.renderProfessorStudy();
                        break;
                }
            }
            
            render() {
                this.renderScene();
                this.renderPlayer();
            }
            
            update() {
                this.update();
                this.checkSceneTransitions();
            }
            
            gameLoop() {
                this.update();
                this.render();
                requestAnimationFrame(() => this.gameLoop());
            }
        }
        
        window.addEventListener('load', () => {
            new KyanGame();
        });
    </script>
</body>
</html>
