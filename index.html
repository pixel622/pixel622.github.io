<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pokémon K&E Version - Enhanced</title>
    <style>
        :root {
            --gba-blue: #285088;
            --gba-light-blue: #5888c8;
            --font-main: 'Courier New', Courier, monospace;
        }

        body, html {
            margin: 0; padding: 0; 
            width: 100vw; height: 100vh;
            background: #222; overflow: hidden; 
            touch-action: none;
            display: flex; justify-content: center; align-items: center;
        }

        #game-wrapper {
            position: relative;
            width: 100%; height: 100%;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
            image-rendering: pixelated;
        }

        #title-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(#2a75bb, #3a8fb7); color: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; transition: opacity 0.5s ease-out;
            font-family: var(--font-main);
        }

        #title-screen h1 { 
            font-size: 48px; margin-bottom: 20px; text-align: center; 
            color: #ffcb05; text-shadow: 4px 4px #2a75bb, -2px -2px 0 #000; 
        }

        #start-btn {
            padding: 15px 40px; font-size: 20px; font-family: var(--font-main);
            background: #e4000f; color: white; border: 4px solid white;
            cursor: pointer; border-radius: 50px; font-weight: bold;
            box-shadow: 0 5px #a00000;
        }

        #ui-layer {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%); width: 90%;
            z-index: 100; cursor: pointer; display: none;
        }

        #dialogue-box {
            background: #f8f8f8; border: 6px solid #484848; border-radius: 10px;
            padding: 20px; font-family: var(--font-main); font-weight: bold;
            font-size: 20px; box-shadow: inset -4px -4px 0 #ccc, 0 4px 10px rgba(0,0,0,0.5);
            min-height: 80px; user-select: none; color: #333;
        }

        #speaker-tag {
            position: absolute; top: -25px; left: 30px;
            background: #484848; color: white;
            padding: 5px 20px; border-radius: 8px 8px 0 0;
            font-size: 16px;
        }

        #joystick-wrapper {
            position: absolute; bottom: 80px; left: 40px;
            width: 120px; height: 120px;
            background: rgba(0,0,0,0.2); border-radius: 50%; border: 4px solid rgba(255,255,255,0.2);
            display: flex; justify-content: center; align-items: center; z-index: 200;
        }

        #joystick-knob { 
            width: 50px; height: 50px; 
            background: radial-gradient(circle, #fff, #888); 
            border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        #shimmer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; z-index: 999;
        }

        #bag-btn {
            position: absolute; bottom: 80px; right: 40px;
            background: #f08030; color: white;
            padding: 15px 30px; border-radius: 8px;
            font-family: var(--font-main); font-weight: bold;
            border: 3px solid white; cursor: pointer; z-index: 300;
            box-shadow: 0 4px #a05010;
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="title-screen">
        <h1>Pokémon K&E</h1>
        <button id="start-btn" onclick="startGame()">PRESS START</button>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div id="shimmer"></div>
    <div id="bag-btn" onclick="alert('Bag: Potion x1, Pokéball x3')">BAG</div>

    <div id="ui-layer" onclick="handleDialogueClick()">
        <div id="speaker-tag">Prof. Sequoia</div>
        <div id="dialogue-box">Welcome to the Habitat Research Lab!</div>
    </div>

    <div id="joystick-wrapper">
        <div id="joystick-knob"></div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const knob = document.getElementById('joystick-knob');
    const wrapper = document.getElementById('joystick-wrapper');
    const uiLayer = document.getElementById('ui-layer');
    const dialogueBox = document.getElementById('dialogue-box');
    const titleScreen = document.getElementById('title-screen');

    const script = [
        "Welcome to the Habitat Research Lab!",
        "Look around! This facility is dedicated to studying ecology.",
        "The tremor earlier was quite strong. We must act quickly.",
        "Go ahead and choose your first Pokémon!"
    ];
    let scriptIndex = 0;
    let currentMap = 'LAB';
    let choosingState = false;
    let holdingPokeball = false; 
    let width, height;

    function resize() {
        width = window.innerWidth; height = window.innerHeight;
        canvas.width = width; canvas.height = height;
    }
    window.addEventListener('resize', resize);
    resize();

    const player = { x: width/2, y: height - 120, speed: 5, history: [] };
    const follower = { active: false, name: '', x: 0, y: 0, color: '#000' };

    const pokeballs = [
        { name: 'Treecko', x: 0, y: 0, color: '#32CD32', active: true },
        { name: 'Froakie', x: 0, y: 0, color: '#1E90FF', active: true },
        { name: 'Charmander', x: 0, y: 0, color: '#FF4500', active: true }
    ];

    function startGame() {
        titleScreen.style.opacity = '0';
        setTimeout(() => {
            titleScreen.style.display = 'none';
            uiLayer.style.display = 'block';
        }, 500);
    }

    let stickX = 0, stickY = 0, isTouching = false;

    function handleDialogueClick() {
        if (scriptIndex < script.length - 1) {
            scriptIndex++;
            dialogueBox.innerText = script[scriptIndex];
        } else {
            uiLayer.style.display = 'none';
            choosingState = true;
        }
    }

    canvas.addEventListener('mousedown', (e) => checkPokeClick(e.clientX, e.clientY));
    canvas.addEventListener('touchstart', (e) => checkPokeClick(e.touches[0].clientX, e.touches[0].clientY));

    function checkPokeClick(clickX, clickY) {
        if (!choosingState || follower.active || currentMap !== 'LAB') return;
        pokeballs.forEach(ball => {
            if(!ball.active) return;
            const dx = clickX - ball.realX;
            const dy = clickY - ball.realY;
            if (Math.sqrt(dx*dx + dy*dy) < 40) {
                follower.active = true; follower.name = ball.name;
                follower.color = ball.color; follower.x = ball.realX;
                follower.y = ball.realY; ball.active = false;
                holdingPokeball = true;
            }
        });
    }

    wrapper.addEventListener('touchstart', (e) => { isTouching = true; e.preventDefault(); });
    window.addEventListener('touchend', () => { isTouching = false; stickX = 0; stickY = 0; knob.style.transform = `translate(0px, 0px)`; });
    window.addEventListener('touchmove', (e) => {
        if (!isTouching) return;
        const rect = wrapper.getBoundingClientRect();
        const touch = e.touches[0];
        let dx = touch.clientX - (rect.left + rect.width/2);
        let dy = touch.clientY - (rect.top + rect.height/2);
        const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
        const angle = Math.atan2(dy, dx);
        stickX = Math.cos(angle) * (dist/40); stickY = Math.sin(angle) * (dist/40);
        knob.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
    });

    function checkCollision(nx, ny) {
        if (currentMap === 'LAB') {
            const dW = 350, dH = 100, dX = width/2 - dW/2, dY = height/2.5;
            if (nx > dX - 15 && nx < dX + dW + 15 && ny > dY - 15 && ny < dY + dH + 15) return true;
            if (ny < 130) return true;
        } else {
            const hX = width/2 - 110, hY = height/2 - 150;
            if (nx > hX - 20 && nx < hX + 240 && ny > hY - 60 && ny < hY + 150) {
                if (Math.abs(nx - width/2) < 30 && ny > hY + 100) return false;
                return true;
            }
            if (ny > height/2 + 120 && ny < height/2 + 130) {
                if (Math.abs(nx - width/2) > 40) return true;
            }
        }
        return false;
    }

    let isTeleporting = false;
    function teleport() {
        if (isTeleporting) return;
        isTeleporting = true;
        const shim = document.getElementById('shimmer');
        shim.style.opacity = '1';
        setTimeout(() => {
            currentMap = (currentMap === 'LAB') ? 'OUTSIDE' : 'LAB';
            player.x = width/2;
            player.y = (currentMap === 'OUTSIDE') ? height/2 + 80 : height - 120;
            player.history = []; 
            shim.style.opacity = '0';
            isTeleporting = false;
        }, 300);
    }

    function update() {
        if (isTouching) {
            let nextX = player.x + stickX * player.speed;
            let nextY = player.y + stickY * player.speed;
            if (!checkCollision(nextX, nextY)) {
                player.history.push({x: player.x, y: player.y});
                if (player.history.length > 60) player.history.shift();
                player.x = nextX; player.y = nextY;
            }
        }
        const matX = width / 2;
        const matY = (currentMap === 'LAB') ? height - 30 : height / 2 + 10;
        if (Math.abs(player.x - matX) < 50 && Math.abs(player.y - matY) < 30) teleport();
        
        if (follower.active && player.history.length > 12) {
            const fp = player.history[player.history.length - 12];
            follower.x += (fp.x - follower.x) * 0.15; follower.y += (fp.y - follower.y) * 0.15;
        }
        player.x = Math.max(20, Math.min(width-20, player.x));
        player.y = Math.max(20, Math.min(height-20, player.y));
    }

    function drawPokeBall(x, y, scale=1) {
        ctx.save();
        ctx.translate(x, y);
        ctx.scale(scale, scale);
        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.beginPath(); ctx.ellipse(0, 15, 12, 5, 0, 0, Math.PI*2); ctx.fill();
        // Red Top
        const gradTop = ctx.createRadialGradient(-5, -5, 2, 0, 0, 15);
        gradTop.addColorStop(0, '#ff5555'); gradTop.addColorStop(1, '#aa0000');
        ctx.fillStyle = gradTop;
        ctx.beginPath(); ctx.arc(0, 0, 15, Math.PI, 0); ctx.fill();
        // White Bottom
        const gradBot = ctx.createRadialGradient(-5, 5, 2, 0, 0, 15);
        gradBot.addColorStop(0, '#ffffff'); gradBot.addColorStop(1, '#bbbbbb');
        ctx.fillStyle = gradBot;
        ctx.beginPath(); ctx.arc(0, 0, 15, 0, Math.PI); ctx.fill();
        // Middle Line
        ctx.strokeStyle = '#333'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(-15, 0); ctx.lineTo(15, 0); ctx.stroke();
        // Center Button
        ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(0, 0, 4, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0, 0, 2, 0, Math.PI*2); ctx.fill();
        ctx.restore();
    }

    function draw() {
        ctx.clearRect(0, 0, width, height);

        if (currentMap === 'LAB') {
            // Shiny Wooden Floor
            ctx.fillStyle = '#d89060'; ctx.fillRect(0, 0, width, height);
            ctx.strokeStyle = '#b87040'; ctx.lineWidth = 1;
            for(let i=0; i<width; i+=40) ctx.strokeRect(i, 0, 40, height);
            
            // Lab Entrance Mat
            ctx.fillStyle = '#3a8fb7'; ctx.fillRect(width/2 - 60, height - 40, 120, 40);
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 3; ctx.strokeRect(width/2 - 60, height - 40, 120, 40);

            // Tech Desks
            ctx.fillStyle = '#444'; 
            for(let i=50; i<width-100; i+=150) {
                ctx.fillRect(i, 20, 110, 80);
                ctx.fillStyle = '#5fb6d9'; ctx.fillRect(i+10, 30, 90, 50); // Screens
                ctx.fillStyle = '#444';
            }

            // The Pokéball Table
            const dW = 350, dH = 100, dX = width/2 - dW/2, dY = height/2.5;
            ctx.fillStyle = '#63422b'; ctx.fillRect(dX-5, dY-5, dW+10, dH+10);
            ctx.fillStyle = '#8b5a2b'; ctx.fillRect(dX, dY, dW, dH);
            
            pokeballs.forEach((ball, i) => {
                if (!ball.active) return;
                ball.realX = dX + 60 + (i * 110); ball.realY = dY + 40;
                drawPokeBall(ball.realX, ball.realY, 1.2);
                ctx.fillStyle = '#fff'; ctx.font = 'bold 14px var(--font-main)'; ctx.textAlign = 'center'; 
                ctx.fillText(ball.name.toUpperCase(), ball.realX, ball.realY - 30);
            });
        } else {
            // Grass and Outside
            ctx.fillStyle = '#719e71'; ctx.fillRect(0, 0, width, height);
            
            // Grass Tufts
            ctx.fillStyle = '#5d8a5d';
            for(let row=0; row<10; row++) {
                for(let col=0; col<15; col++) {
                    let gx = (width/2) + col*45, gy = 50 + row*45;
                    if (gy < height/2 + 100) {
                        ctx.beginPath(); ctx.moveTo(gx, gy); ctx.lineTo(gx+5, gy-10); ctx.lineTo(gx+10, gy); ctx.fill();
                    }
                }
            }

            // Path
            ctx.fillStyle = '#e5d17c'; ctx.fillRect(0, height/2 + 120, width, height);

            // Pond with Water Ripples
            const wX = width/2 - 350, wY = height/2 - 50;
            ctx.fillStyle = '#1e5aab'; ctx.beginPath(); ctx.ellipse(wX, wY, 150, 100, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#3a8fb7'; ctx.beginPath(); ctx.ellipse(wX, wY, 135, 85, 0, 0, Math.PI*2); ctx.fill();

            // House Graphics
            const hX = width/2 - 110, hY = height/2 - 150;
            ctx.fillStyle = '#eee'; ctx.fillRect(hX, hY, 220, 150); // Walls
            ctx.fillStyle = '#e4000f'; ctx.beginPath(); ctx.moveTo(hX-30, hY); ctx.lineTo(width/2, hY-70); ctx.lineTo(hX+250, hY); ctx.fill(); // Roof
            ctx.fillStyle = '#484848'; ctx.fillRect(width/2 - 35, height/2 - 50, 70, 50); // Door
        }

        // DRAW FOLLOWER
        if (follower.active) {
            ctx.fillStyle = 'rgba(0,0,0,0.2)'; ctx.beginPath(); ctx.arc(follower.x, follower.y+10, 10, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = follower.color; ctx.beginPath(); ctx.arc(follower.x, follower.y, 14, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#fff'; ctx.fillRect(follower.x-6, follower.y-5, 4, 4); ctx.fillRect(follower.x+2, follower.y-5, 4, 4);
        }

        // DRAW PLAYER (More Detailed)
        ctx.save();
        ctx.translate(player.x, player.y);
        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.2)'; ctx.beginPath(); ctx.ellipse(0, 18, 15, 6, 0, 0, Math.PI*2); ctx.fill();
        // Legs/Shoes
        ctx.fillStyle = '#333'; ctx.fillRect(-12, 12, 8, 8); ctx.fillRect(4, 12, 8, 8);
        // Body (Shirt)
        ctx.fillStyle = '#e4000f'; ctx.fillRect(-12, -8, 24, 20);
        // Head
        ctx.fillStyle = '#ffdbac'; ctx.fillRect(-10, -25, 20, 18);
        // Cap
        ctx.fillStyle = '#e4000f'; ctx.fillRect(-12, -28, 24, 8);
        ctx.fillStyle = '#fff'; ctx.fillRect(-4, -26, 8, 4);
        // Eyes
        ctx.fillStyle = '#000'; ctx.fillRect(-5, -18, 3, 4); ctx.fillRect(2, -18, 3, 4);
        
        if (holdingPokeball) drawPokeBall(18, 0, 0.5);
        ctx.restore();

        update();
        requestAnimationFrame(draw);
    }
    draw();
</script>
</body>
</html>
