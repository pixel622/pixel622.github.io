<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pokémon Nova Genesis</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background:#000;
    font-family:'Press Start 2P',cursive;
    overflow:hidden;
    touch-action:none;
    height:100vh;
  }
  #container {
    position:relative;
    width:100vw;
    height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background:radial-gradient(#001122,#000);
  }
  #canvas {
    width:90vmin;
    height:calc(90vmin * 240/320);
    max-width:540px;
    max-height:405px;
    image-rendering:pixelated;
    image-rendering:crisp-edges;
    border:6px solid #222;
    box-shadow:0 0 30px rgba(0,255,255,0.3);
  }
  #ui {
    position:absolute;
    inset:0;
    pointer-events:none;
  }
  #dialogue {
    position:absolute;
    bottom:4%;
    left:4%;
    right:4%;
    height:18%;
    background:rgba(255,255,255,0.92);
    border:4px solid #0044cc;
    color:#000;
    padding:6px 10px;
    font-size:calc(10px + 0.8vw);
    line-height:1.3;
    display:flex;
    align-items:center;
    pointer-events:auto;
    overflow:hidden;
  }
  #advance {
    min-width:32px;
    height:32px;
    margin-left:8px;
    background:#0044cc;
    color:#fff;
    border:3px solid #fff;
    font-size:16px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }
  #controls {
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    height:38vh;
    pointer-events:none;
    display:none;
  }
  .dpad {
    position:absolute;
    left:6%;
    bottom:12%;
    width:28vw;
    height:28vw;
    max-width:140px;
    max-height:140px;
  }
  .dpad div {
    position:absolute;
    width:38%;
    height:38%;
    background:rgba(255,255,255,0.35);
    border:4px solid #fff;
    color:#000;
    font-weight:bold;
    font-size:min(7vw,32px);
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:auto;
  }
  #up    { top:0;    left:31%; }
  #down  { bottom:0; left:31%; }
  #left  { left:0;   top:31%;  }
  #right { right:0;  top:31%;  }
  .ab {
    position:absolute;
    right:8%;
    bottom:14%;
    display:flex;
    flex-direction:column;
    gap:20%;
  }
  .ab div {
    width:22vw;
    height:22vw;
    max-width:100px;
    max-height:100px;
    border-radius:50%;
    border:5px solid #fff;
    font-size:min(9vw,40px);
    font-weight:bold;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:auto;
  }
  #a { background:rgba(0,220,0,0.85); color:#fff; }
  #b { background:rgba(220,0,0,0.85); color:#fff; }
  #menuIcon {
    position:fixed;
    top:4%;
    right:4%;
    width:60px;
    height:60px;
    background:rgba(0,120,255,0.8);
    border:4px solid #fff;
    border-radius:50%;
    color:#fff;
    font-size:28px;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:auto;
    z-index:10;
  }
  #menuPanel {
    position:fixed;
    inset:0;
    background:rgba(0,0,120,0.96);
    color:#fff;
    padding:10%;
    display:none;
    flex-direction:column;
    font-size:calc(10px + 1vw);
    z-index:20;
    pointer-events:auto;
  }
  .menuRow {
    padding:12px 0;
    border-bottom:1px solid #444;
    cursor:pointer;
  }
  .menuRow:active { background:rgba(255,255,255,0.2); }
  #nameScreen, #confirmScreen {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.92);
    color:#fff;
    display:none;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    font-size:calc(12px + 1.2vw);
    pointer-events:auto;
    z-index:30;
  }
  #nameText { margin:20px 0; font-size:1.4em; }
  #kb {
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:4px;
    max-width:90%;
  }
  .kbKey {
    aspect-ratio:1;
    background:#555;
    border:3px solid #aaa;
    color:#fff;
    font-size:calc(10px + 0.8vw);
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }
  .kbKey:active { background:#fff; color:#000; }
  .wide { grid-column:span 2; }
  #confirmScreen button {
    margin:15px 20px;
    padding:12px 32px;
    font-size:1.1em;
    background:#0044cc;
    color:#fff;
    border:3px solid #fff;
    cursor:pointer;
  }
  .hidden { display:none !important; }
</style>
</head>
<body>

<div id="container">
  <canvas id="canvas" width="320" height="240"></canvas>

  <div id="ui">
    <div id="dialogue" class="hidden">
      <span id="text"></span>
      <div id="advance">▶</div>
    </div>
  </div>

  <div id="nameScreen">
    <div id="nameText">NOVA</div>
    <div id="kb"></div>
  </div>

  <div id="confirmScreen">
    <div id="confirmMsg">You chose CHARMANDER! Are you sure?</div>
    <button id="yes">YES</button>
    <button id="no">NO</button>
  </div>

  <div id="controls">
    <div class="dpad">
      <div id="up">↑</div>
      <div id="down">↓</div>
      <div id="left">←</div>
      <div id="right">→</div>
    </div>
    <div class="ab">
      <div id="b">B</div>
      <div id="a">A</div>
    </div>
  </div>

  <div id="menuIcon">M</div>

  <div id="menuPanel">
    <div class="menuRow">Pokémon</div>
    <div class="menuRow">Bag → Potion x1</div>
    <div class="menuRow" id="saveBtn">Save Game</div>
    <div class="menuRow" id="closeMenu">Close</div>
  </div>

</div>

<script>
// ────────────────────────────────────────────────
const c = document.getElementById('canvas');
const ctx = c.getContext('2d');
ctx.imageSmoothingEnabled = false;

const TILE = 16;
const W = 320, H = 240;

let state = 'title';
let name = 'NOVA';
let starter = null;
let px = 8, py = 7, pdir = 2; // 0↑ 1← 2↓ 3→
let fx = 8, fy = 8; // follower
let camx = 0, camy = 0;
let map = 'bed';
let dialog = [];
let dtext = '';
let dpos = 0;
let potion = 1;
let talkedMom = false;
let showPokeChoice = false; // new flag for poke selection screen

const maps = {
  bed: [ /* same as before */ ],
  kit: [ /* same as before */ ],
  town: [ /* same as before */ ]
};

// ... (keep the same colors, drawTile, drawMap, drawChar, drawStarter functions as before)

function drawPokeChoice() {
  // Three Poké Balls
  const positions = [
    {x: 4*TILE, y: 8*TILE, poke:'charmander'},
    {x: 10*TILE, y: 8*TILE, poke:'treecko'},
    {x: 16*TILE, y: 8*TILE, poke:'froakie'}
  ];

  positions.forEach((pos, i) => {
    // Poké Ball
    ctx.fillStyle = '#ffffff';
    ctx.beginPath();
    ctx.arc(pos.x + 32, pos.y + 32, 28, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = '#ff4444';
    ctx.fillRect(pos.x + 4, pos.y + 20, 56, 24);
    ctx.fillStyle = '#000000';
    ctx.beginPath();
    ctx.arc(pos.x + 32, pos.y + 32, 12, 0, Math.PI*2);
    ctx.fill();

    // Pokémon name (always visible below)
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 12px "Press Start 2P"';
    ctx.textAlign = 'center';
    ctx.fillText(['CHARMANDER','TREECKO','FROAKIE'][i], pos.x + 32, pos.y + 90);
  });
}

function render() {
  ctx.fillStyle = '#081820';
  ctx.fillRect(0,0,W,H);

  if (state === 'title') {
    // ... title screen as before
  } else if (state === 'prof' || state === 'choose') {
    // Lab background
    ctx.fillStyle = '#c8e8ff';
    ctx.fillRect(0,0,W,H);

    // Professor (simple placeholder)
    drawChar(10, 4, 2);

    if (showPokeChoice) {
      drawPokeChoice();
    }
  } else {
    drawMap();
    drawChar(px, py, pdir, (performance.now()/200|0)%2);
    drawStarter(fx, fy);
    if (map === 'kit' && !talkedMom) drawChar(9,5,2); // mom
  }

  // dialog overlay
  if (dtext) {
    document.getElementById('text').textContent = dtext.slice(0, dpos);
    document.getElementById('dialogue').classList.remove('hidden');
  } else {
    document.getElementById('dialogue').classList.add('hidden');
  }
}

// ────────────────────────────────────────────────
// Name input → show poke choice screen
function confirmName() {
  if (name) {
    document.getElementById('nameScreen').style.display = 'none';
    showPokeChoice = true;
    state = 'choose';
    queueDialog(['Which of these three resonates with you?']);
  }
}

// Click to choose Pokémon
c.addEventListener('click', (e) => {
  if (state !== 'choose' || !showPokeChoice) return;

  const rect = c.getBoundingClientRect();
  const scaleX = W / rect.width;
  const scaleY = H / rect.height;
  const clickX = (e.clientX - rect.left) * scaleX;
  const clickY = (e.clientY - rect.top) * scaleY;

  if (clickY > 110 && clickY < 170) {
    let chosen = null;
    if (clickX < 100) chosen = 'charmander';
    else if (clickX < 200) chosen = 'treecko';
    else if (clickX < 300) chosen = 'froakie';

    if (chosen) {
      showPokeChoice = false;
      document.getElementById('confirmMsg').textContent = `You chose ${chosen.toUpperCase()}! Are you sure?`;
      document.getElementById('confirmScreen').style.display = 'flex';
      starter = chosen;  // temporary until confirmed
    }
  }
});

// Yes → start following
document.getElementById('yes').onclick = () => {
  document.getElementById('confirmScreen').style.display = 'none';
  queueDialog([
    'An excellent choice! This Pokémon is full of potential!',
    `Alright, ${starter.toUpperCase()}! Let's go meet Mom downstairs, then start our journey!`
  ]);
  state = 'play';
  map = 'bed';
  document.getElementById('controls').style.display = 'block';

  // Pokémon starts following right away
  fx = px - 1;
  fy = py;
};

// ... rest of the code (movement, door teleport, walls, etc.) remains the same as previous version

// In movement function, after successful move:
if (moved && starter) {
  // Simple follow: stay 1 tile behind
  fx = px - (pdir === 1 ? -1 : pdir === 3 ? 1 : 0);
  fy = py - (pdir === 0 ? -1 : pdir === 2 ? 1 : 0);
}
