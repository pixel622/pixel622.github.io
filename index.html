<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pok√©mon Island Village</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        canvas {
            display: block;
            image-rendering: pixelated;
        }

        /* Game Container */
        #gameContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }

        /* Title Screen */
        #titleScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0, 50, 100, 0.9), rgba(0, 80, 160, 0.9));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .title-logo {
            font-size: 48px;
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700,
                         0 0 20px #ffd700,
                         2px 2px 0 #000;
            margin-bottom: 50px;
            animation: logoGlow 2s infinite;
            letter-spacing: 5px;
        }

        @keyframes logoGlow {
            0%, 100% { text-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700, 2px 2px 0 #000; }
            50% { text-shadow: 0 0 20px #ffd700, 0 0 40px #ffd700, 2px 2px 0 #000; }
        }

        .title-menu {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .title-btn {
            background: linear-gradient(to bottom, #4a90e2, #2c6cb0);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            min-width: 200px;
        }

        .title-btn:hover {
            background: linear-gradient(to bottom, #5a9cf2, #3c7cd0);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
        }

        /* Joystick */
        #joyBase {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.7);
            border: 3px solid #4a90e2;
            border-radius: 50%;
            z-index: 100;
            box-shadow: 0 0 30px rgba(74, 144, 226, 0.5);
            display: none;
            touch-action: none;
        }

        #joy {
            position: absolute;
            width: 50px;
            height: 50px;
            left: 35px;
            top: 35px;
            background: linear-gradient(to bottom, #ffd700, #ffaa00);
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            transition: transform 0.1s;
        }

        /* HUD */
        #hud {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(to right, rgba(0, 40, 80, 0.9), rgba(0, 60, 120, 0.9));
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            border: 3px solid #4a90e2;
            font-size: 14px;
            z-index: 50;
            display: none;
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.5);
            backdrop-filter: blur(5px);
        }

        /* Dialog Box */
        #dialogBox {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            background: linear-gradient(to bottom, rgba(0, 40, 80, 0.95), rgba(0, 60, 120, 0.95));
            border: 4px solid #ffd700;
            border-radius: 20px;
            padding: 20px;
            color: white;
            font-size: 16px;
            z-index: 800;
            display: none;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        .dialog-text {
            margin-bottom: 15px;
            min-height: 60px;
            line-height: 1.6;
            text-shadow: 1px 1px 2px #000;
        }

        .dialog-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .dialog-btn {
            background: linear-gradient(to bottom, #4a90e2, #2c6cb0);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
        }

        .dialog-btn:hover {
            background: linear-gradient(to bottom, #5a9cf2, #3c7cd0);
            transform: translateY(-2px);
        }

        /* Controls */
        #controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 100;
            display: none;
        }

        .control-btn {
            background: linear-gradient(to bottom, #4a90e2, #2c6cb0);
            border: 3px solid #fff;
            color: white;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        /* Location Indicator */
        #locationIndicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #4a90e2;
            font-size: 14px;
            z-index: 50;
            display: none;
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.5);
        }

        /* Screen Fade */
        .screen-fade {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            opacity: 0;
            z-index: 700;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .title-logo { font-size: 32px; }
            .title-btn { padding: 12px 30px; font-size: 18px; min-width: 180px; }
            #joyBase { width: 100px; height: 100px; }
            #joy { width: 40px; height: 40px; left: 30px; top: 30px; }
        }
    </style>
</head>
<body>
    <!-- Title Screen -->
    <div id="titleScreen">
        <div class="title-logo">ISLAND VILLAGE</div>
        <div class="title-menu">
            <button class="title-btn" onclick="startGame()">EXPLORE VILLAGE</button>
            <button class="title-btn" onclick="showInstructions()">HOW TO PLAY</button>
        </div>
    </div>

    <!-- Game Container -->
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <!-- Screen Fade -->
        <div class="screen-fade" id="screenFade"></div>
        
        <!-- Dialog Box -->
        <div id="dialogBox">
            <div class="dialog-text" id="dialogText"></div>
            <div class="dialog-options" id="dialogOptions"></div>
        </div>

        <!-- Controls -->
        <div id="joyBase"><div id="joy"></div></div>
        <div id="hud">
            <div id="hudContent">Island Village</div>
        </div>
        <div id="controls">
            <div class="control-btn" onclick="interact()">üí¨</div>
            <div class="control-btn" onclick="toggleMap()">üó∫Ô∏è</div>
        </div>
        
        <!-- Location Indicator -->
        <div id="locationIndicator">Village Square</div>
    </div>

    <script>
        // Game initialization
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Game state
        let gameState = {
            player: {
                x: 400,
                y: 300,
                direction: 0, // 0: down, 1: left, 2: right, 3: up
                speed: 4,
                spriteFrame: 0,
                currentArea: 'village_square',
                inBuilding: false,
                currentBuilding: null
            },
            areas: {},
            inDialog: false,
            currentTime: 'day'
        };

        // Island Village Areas - Each area is its own screen
        const islandVillage = {
            // The village is on a green island with different connected areas
            areas: [
                {
                    id: 'village_square',
                    name: 'Village Square',
                    type: 'square',
                    connections: {
                        north: 'north_path',
                        east: 'east_path',
                        south: 'south_beach',
                        west: 'west_path'
                    },
                    buildings: [
                        { id: 'pokemon_center', x: 300, y: 200, width: 80, height: 60, type: 'center', name: 'Pok√©mon Center', color: '#ff9999', roof: '#ff6b6b' },
                        { id: 'pokemart', x: 500, y: 200, width: 70, height: 55, type: 'shop', name: 'Pok√© Mart', color: '#78c850', roof: '#57a773' }
                    ],
                    npcs: [
                        { x: 400, y: 350, type: 'mayor', dialog: "Welcome to our island village! It's peaceful here." },
                        { x: 350, y: 400, type: 'child', dialog: "My Pok√©mon is playing in the flowers!" }
                    ],
                    decorations: [
                        { x: 200, y: 250, type: 'fountain', size: 30 },
                        { x: 600, y: 250, type: 'bench', size: 25 }
                    ]
                },
                {
                    id: 'north_path',
                    name: 'Northern Path',
                    type: 'path',
                    connections: {
                        south: 'village_square',
                        north: 'northern_houses'
                    },
                    buildings: [],
                    npcs: [
                        { x: 400, y: 300, type: 'hiker', dialog: "The path north leads to some houses. Beautiful view up there!" }
                    ],
                    decorations: [
                        { x: 300, y: 200, type: 'tree', size: 35 },
                        { x: 500, y: 200, type: 'tree', size: 30 },
                        { x: 400, y: 400, type: 'sign', text: 'North: Residential Area' }
                    ]
                },
                {
                    id: 'northern_houses',
                    name: 'Residential Area',
                    type: 'residential',
                    connections: {
                        south: 'north_path',
                        east: 'east_houses',
                        west: 'west_houses'
                    },
                    buildings: [
                        { id: 'house1', x: 250, y: 250, width: 65, height: 50, type: 'house', name: 'Red House', color: '#ff6b6b', roof: '#cc4444' },
                        { id: 'house2', x: 550, y: 250, width: 70, height: 52, type: 'house', name: 'Blue House', color: '#4a90e2', roof: '#2c6cb0' },
                        { id: 'house3', x: 400, y: 150, width: 75, height: 55, type: 'house', name: 'Green House', color: '#78c850', roof: '#57a773' }
                    ],
                    npcs: [
                        { x: 250, y: 320, type: 'lady', dialog: "I live in the red house. It's cozy!" },
                        { x: 550, y: 320, type: 'man', dialog: "The blue house is mine. Best view on the island!" },
                        { x: 400, y: 220, type: 'old_woman', dialog: "My garden is full of beautiful flowers." }
                    ],
                    decorations: [
                        { x: 150, y: 200, type: 'tree', size: 40 },
                        { x: 650, y: 200, type: 'tree', size: 40 },
                        { x: 400, y: 400, type: 'flower_bed', size: 50 }
                    ]
                },
                {
                    id: 'east_path',
                    name: 'Eastern Path',
                    type: 'path',
                    connections: {
                        west: 'village_square',
                        east: 'east_houses'
                    },
                    buildings: [],
                    npcs: [
                        { x: 400, y: 300, type: 'fisherman', dialog: "The eastern houses have a great view of the ocean!" }
                    ],
                    decorations: [
                        { x: 300, y: 200, type: 'rock', size: 25 },
                        { x: 500, y: 200, type: 'rock', size: 30 },
                        { x: 400, y: 400, type: 'sign', text: 'East: Cliff Houses' }
                    ]
                },
                {
                    id: 'east_houses',
                    name: 'Cliffside Area',
                    type: 'cliff',
                    connections: {
                        west: 'east_path',
                        north: 'northern_houses'
                    },
                    buildings: [
                        { id: 'house4', x: 300, y: 200, width: 80, height: 60, type: 'house', name: 'Yellow House', color: '#ffd700', roof: '#ccaa00' },
                        { id: 'lab', x: 500, y: 200, width: 90, height: 65, type: 'lab', name: 'Research Lab', color: '#a8a8a8', roof: '#888888' }
                    ],
                    npcs: [
                        { x: 300, y: 270, type: 'scientist', dialog: "The research lab studies island Pok√©mon." },
                        { x: 500, y: 270, type: 'researcher', dialog: "We discovered new Pok√©mon species here!" }
                    ],
                    decorations: [
                        { x: 200, y: 150, type: 'cliff_edge', size: 40 },
                        { x: 600, y: 150, type: 'cliff_edge', size: 40 },
                        { x: 400, y: 450, type: 'telescope', size: 30 }
                    ]
                },
                {
                    id: 'west_path',
                    name: 'Western Path',
                    type: 'path',
                    connections: {
                        east: 'village_square',
                        west: 'west_houses'
                    },
                    buildings: [],
                    npcs: [
                        { x: 400, y: 300, type: 'gardener', dialog: "The west has the best gardens on the island!" }
                    ],
                    decorations: [
                        { x: 300, y: 200, type: 'bush', size: 35 },
                        { x: 500, y: 200, type: 'bush', size: 40 },
                        { x: 400, y: 400, type: 'sign', text: 'West: Garden Houses' }
                    ]
                },
                {
                    id: 'west_houses',
                    name: 'Garden Area',
                    type: 'garden',
                    connections: {
                        east: 'west_path',
                        north: 'northern_houses'
                    },
                    buildings: [
                        { id: 'house5', x: 300, y: 200, width: 70, height: 55, type: 'house', name: 'Purple House', color: '#a855f7', roof: '#7c3aed' },
                        { id: 'gym', x: 500, y: 200, width: 85, height: 60, type: 'gym', name: 'Island Gym', color: '#f08030', roof: '#cc5500' }
                    ],
                    npcs: [
                        { x: 300, y: 270, type: 'gardener', dialog: "My garden has rare berries!" },
                        { x: 500, y: 270, type: 'gym_leader', dialog: "Challenge me at the gym when you're ready!" }
                    ],
                    decorations: [
                        { x: 200, y: 300, type: 'flower_garden', size: 60 },
                        { x: 600, y: 300, type: 'flower_garden', size: 60 },
                        { x: 400, y: 150, type: 'fountain', size: 35 }
                    ]
                },
                {
                    id: 'south_beach',
                    name: 'Southern Beach',
                    type: 'beach',
                    connections: {
                        north: 'village_square'
                    },
                    buildings: [
                        { id: 'beach_house', x: 400, y: 200, width: 75, height: 50, type: 'house', name: 'Beach House', color: '#87CEEB', roof: '#4682B4' }
                    ],
                    npcs: [
                        { x: 300, y: 350, type: 'swimmer', dialog: "The water is perfect for swimming!" },
                        { x: 500, y: 350, type: 'fisherman', dialog: "I catch the best Pok√©mon here!" }
                    ],
                    decorations: [
                        { x: 200, y: 450, type: 'palm_tree', size: 40 },
                        { x: 600, y: 450, type: 'palm_tree', size: 40 },
                        { x: 400, y: 500, type: 'beach_umbrella', size: 30 }
                    ]
                }
            ],
            
            // Building interiors
            buildingInteriors: {
                'pokemon_center': {
                    name: 'Pok√©mon Center',
                    color: '#ff9999',
                    furniture: [
                        { type: 'counter', x: 300, y: 300, width: 200, height: 30 },
                        { type: 'healing_machine', x: 350, y: 250, width: 100, height: 80 },
                        { type: 'chairs', x: 250, y: 400, width: 40, height: 30 },
                        { type: 'chairs', x: 510, y: 400, width: 40, height: 30 }
                    ],
                    npc: { x: 400, y: 320, type: 'nurse', dialog: "Welcome! I can heal your Pok√©mon." }
                },
                'pokemart': {
                    name: 'Pok√© Mart',
                    color: '#78c850',
                    furniture: [
                        { type: 'counter', x: 300, y: 300, width: 200, height: 30 },
                        { type: 'shelves', x: 200, y: 200, width: 400, height: 60 },
                        { type: 'cash_register', x: 350, y: 290, width: 30, height: 20 }
                    ],
                    npc: { x: 400, y: 320, type: 'shopkeeper', dialog: "Welcome to the Pok√© Mart! What can I get you?" }
                },
                'lab': {
                    name: 'Research Lab',
                    color: '#a8a8a8',
                    furniture: [
                        { type: 'lab_table', x: 250, y: 250, width: 300, height: 40 },
                        { type: 'computers', x: 300, y: 200, width: 200, height: 40 },
                        { type: 'bookshelf', x: 200, y: 350, width: 150, height: 100 },
                        { type: 'specimen', x: 450, y: 350, width: 150, height: 100 }
                    ],
                    npc: { x: 400, y: 300, type: 'professor', dialog: "Welcome to our lab! We study island Pok√©mon." }
                },
                'gym': {
                    name: 'Island Gym',
                    color: '#f08030',
                    furniture: [
                        { type: 'battle_platform', x: 350, y: 200, width: 100, height: 80 },
                        { type: 'stands', x: 200, y: 300, width: 400, height: 30 },
                        { type: 'trophy_case', x: 300, y: 350, width: 200, height: 80 }
                    ],
                    npc: { x: 400, y: 250, type: 'gym_leader', dialog: "Welcome to the Island Gym! Ready for a challenge?" }
                },
                // Generic house interior
                'house': {
                    name: 'House',
                    color: '#d2b48c',
                    furniture: [
                        { type: 'table', x: 350, y: 300, width: 100, height: 30 },
                        { type: 'chairs', x: 330, y: 330, width: 40, height: 30 },
                        { type: 'chairs', x: 430, y: 330, width: 40, height: 30 },
                        { type: 'bed', x: 250, y: 200, width: 120, height: 60 },
                        { type: 'bookshelf', x: 550, y: 200, width: 50, height: 80 }
                    ],
                    npc: { x: 400, y: 350, type: 'resident', dialog: "Welcome to my home! Make yourself comfortable." }
                }
            }
        };

        // Initialize game
        function initGame() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
            
            // Setup joystick
            setupJoystick();
            
            // Initialize areas
            islandVillage.areas.forEach(area => {
                gameState.areas[area.id] = area;
            });
            
            // Start game loop
            gameLoop();
        }

        // Joystick controls
        let joystick = { x: 0, y: 0, active: false };
        function setupJoystick() {
            const joyBase = document.getElementById('joyBase');
            const joyStick = document.getElementById('joy');

            joyBase.addEventListener('mousedown', startDrag);
            joyBase.addEventListener('touchstart', startDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag);

            function startDrag(e) {
                e.preventDefault();
                joystick.active = true;
                updateJoystick(e);
            }

            function endDrag() {
                joystick.active = false;
                joystick.x = joystick.y = 0;
                joyStick.style.transform = 'translate(0, 0)';
            }

            function drag(e) {
                if (!joystick.active) return;
                updateJoystick(e);
            }

            function updateJoystick(e) {
                const rect = joyBase.getBoundingClientRect();
                const touch = e.touches ? e.touches[0] : e;
                
                let x = touch.clientX - rect.left - 60;
                let y = touch.clientY - rect.top - 60;
                
                const distance = Math.sqrt(x * x + y * y);
                const maxDistance = 50;
                
                if (distance > maxDistance) {
                    x = (x / distance) * maxDistance;
                    y = (y / distance) * maxDistance;
                }
                
                joystick.x = x / maxDistance;
                joystick.y = y / maxDistance;
                
                joyStick.style.transform = `translate(${x}px, ${y}px)`;
                
                // Update player direction
                if (Math.abs(joystick.x) > Math.abs(joystick.y)) {
                    gameState.player.direction = joystick.x > 0 ? 2 : 1;
                } else {
                    gameState.player.direction = joystick.y > 0 ? 0 : 3;
                }
            }
        }

        // Dialog system
        function showDialog(text, options = []) {
            gameState.inDialog = true;
            document.getElementById('dialogText').textContent = text;
            const optionsDiv = document.getElementById('dialogOptions');
            optionsDiv.innerHTML = '';
            
            if (options.length === 0) {
                const btn = document.createElement('button');
                btn.className = 'dialog-btn';
                btn.textContent = 'Continue';
                btn.onclick = () => {
                    document.getElementById('dialogBox').style.display = 'none';
                    gameState.inDialog = false;
                };
                optionsDiv.appendChild(btn);
            } else {
                options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'dialog-btn';
                    btn.textContent = opt.text;
                    btn.onclick = () => {
                        document.getElementById('dialogBox').style.display = 'none';
                        gameState.inDialog = false;
                        opt.action();
                    };
                    optionsDiv.appendChild(btn);
                });
            }
            
            document.getElementById('dialogBox').style.display = 'block';
        }

        // Fade screen for transitions
        function fadeScreen(fadeIn, callback) {
            const fade = document.getElementById('screenFade');
            if (fadeIn) {
                fade.style.opacity = '1';
                setTimeout(() => {
                    if (callback) callback();
                    setTimeout(() => {
                        fade.style.opacity = '0';
                    }, 500);
                }, 500);
            } else {
                fade.style.opacity = '0';
                if (callback) callback();
            }
        }

        // Change area
        function changeArea(areaId) {
            fadeScreen(true, () => {
                gameState.player.currentArea = areaId;
                gameState.player.x = 400;
                gameState.player.y = 300;
                updateLocationIndicator();
                fadeScreen(false);
            });
        }

        // Enter building
        function enterBuilding(buildingId, buildingData) {
            fadeScreen(true, () => {
                gameState.player.inBuilding = true;
                gameState.player.currentBuilding = {
                    id: buildingId,
                    data: buildingData
                };
                gameState.player.x = 400;
                gameState.player.y = 450;
                updateLocationIndicator();
                fadeScreen(false);
                
                // Show building entry dialog
                const interior = islandVillage.buildingInteriors[buildingData.type] || islandVillage.buildingInteriors.house;
                showDialog(`You entered ${buildingData.name}.`);
            });
        }

        // Exit building
        function exitBuilding() {
            fadeScreen(true, () => {
                gameState.player.inBuilding = false;
                gameState.player.currentBuilding = null;
                gameState.player.x = 400;
                gameState.player.y = 400;
                updateLocationIndicator();
                fadeScreen(false);
                showDialog("You left the building.");
            });
        }

        // Update location indicator
        function updateLocationIndicator() {
            const indicator = document.getElementById('locationIndicator');
            if (gameState.player.inBuilding) {
                indicator.textContent = gameState.player.currentBuilding.data.name;
            } else {
                const area = gameState.areas[gameState.player.currentArea];
                indicator.textContent = area.name;
            }
            indicator.style.display = 'block';
        }

        // Interaction system
        function interact() {
            if (gameState.inDialog) return;
            
            if (gameState.player.inBuilding) {
                // Inside building - talk to NPC or exit
                const building = gameState.player.currentBuilding;
                const interior = islandVillage.buildingInteriors[building.data.type] || islandVillage.buildingInteriors.house;
                
                // Check if near NPC
                const npc = interior.npc;
                const distance = Math.sqrt(
                    Math.pow(gameState.player.x - npc.x, 2) + 
                    Math.pow(gameState.player.y - npc.y, 2)
                );
                
                if (distance < 80) {
                    showDialog(`${getNPCTypeName(npc.type)}: "${npc.dialog}"`);
                } else {
                    // Show exit option
                    showDialog("What would you like to do?", [
                        { text: "Exit Building", action: exitBuilding },
                        { text: "Look Around", action: () => showDialog("You're in a cozy building.") }
                    ]);
                }
            } else {
                // Outside - check for nearby interactions
                const area = gameState.areas[gameState.player.currentArea];
                
                // Check buildings
                for (const building of area.buildings) {
                    const distance = Math.sqrt(
                        Math.pow(gameState.player.x - building.x, 2) + 
                        Math.pow(gameState.player.y - building.y, 2)
                    );
                    
                    if (distance < 60) {
                        showDialog(`Do you want to enter ${building.name}?`, [
                            { text: "Enter", action: () => enterBuilding(building.id, building) },
                            { text: "Cancel", action: () => {} }
                        ]);
                        return;
                    }
                }
                
                // Check NPCs
                for (const npc of area.npcs) {
                    const distance = Math.sqrt(
                        Math.pow(gameState.player.x - npc.x, 2) + 
                        Math.pow(gameState.player.y - npc.y, 2)
                    );
                    
                    if (distance < 50) {
                        showDialog(`${getNPCTypeName(npc.type)}: "${npc.dialog}"`);
                        return;
                    }
                }
                
                // Check area transitions
                const playerNearEdge = 
                    gameState.player.x < 50 || 
                    gameState.player.x > 750 || 
                    gameState.player.y < 50 || 
                    gameState.player.y > 550;
                
                if (playerNearEdge) {
                    const direction = getDirectionFromPosition();
                    const area = gameState.areas[gameState.player.currentArea];
                    
                    if (area.connections[direction]) {
                        const newAreaId = area.connections[direction];
                        const newArea = gameState.areas[newAreaId];
                        showDialog(`This path leads to ${newArea.name}. Go there?`, [
                            { text: "Go", action: () => changeArea(newAreaId) },
                            { text: "Stay", action: () => {} }
                        ]);
                        return;
                    }
                }
                
                // Default dialog
                showDialog("There's nothing special here.");
            }
        }

        function getNPCTypeName(type) {
            const names = {
                'mayor': 'Mayor',
                'child': 'Child',
                'hiker': 'Hiker',
                'lady': 'Lady',
                'man': 'Man',
                'old_woman': 'Grandma',
                'fisherman': 'Fisherman',
                'scientist': 'Scientist',
                'researcher': 'Researcher',
                'gardener': 'Gardener',
                'gym_leader': 'Gym Leader',
                'swimmer': 'Swimmer',
                'nurse': 'Nurse Joy',
                'shopkeeper': 'Shopkeeper',
                'professor': 'Professor',
                'resident': 'Resident'
            };
            return names[type] || 'Villager';
        }

        function getDirectionFromPosition() {
            if (gameState.player.x < 50) return 'west';
            if (gameState.player.x > 750) return 'east';
            if (gameState.player.y < 50) return 'north';
            if (gameState.player.y > 550) return 'south';
            return null;
        }

        function toggleMap() {
            showDialog("Island Village Map\n\n" +
                      "North: Residential Area\n" +
                      "East: Cliffside Area\n" +
                      "West: Garden Area\n" +
                      "South: Beach\n" +
                      "Center: Village Square");
        }

        // Rendering
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (gameState.player.inBuilding) {
                renderBuildingInterior();
            } else {
                renderCurrentArea();
            }
            
            drawPlayer();
        }

        function renderCurrentArea() {
            const area = gameState.areas[gameState.player.currentArea];
            
            // Draw ground based on area type
            drawGround(area.type);
            
            // Draw buildings
            area.buildings.forEach(building => {
                drawBuilding(building);
            });
            
            // Draw NPCs
            area.npcs.forEach(npc => {
                drawNPC(npc);
            });
            
            // Draw decorations
            area.decorations.forEach(deco => {
                drawDecoration(deco, area.type);
            });
            
            // Draw area border/edge indicators
            drawAreaEdges(area);
        }

        function drawGround(areaType) {
            let groundColor, patternColor;
            
            switch(areaType) {
                case 'square':
                    groundColor = '#8b7355'; // Stone path
                    patternColor = '#a0522d';
                    break;
                case 'path':
                    groundColor = '#a8a878'; // Dirt path
                    patternColor = '#8b7355';
                    break;
                case 'residential':
                    groundColor = '#5dbb63'; // Green grass
                    patternColor = '#57a773';
                    break;
                case 'cliff':
                    groundColor = '#b8a038'; // Rocky ground
                    patternColor = '#a89030';
                    break;
                case 'garden':
                    groundColor = '#78c850'; // Garden grass
                    patternColor = '#5dbb63';
                    break;
                case 'beach':
                    groundColor = '#f5deb3'; // Sand
                    patternColor = '#d2b48c';
                    break;
                default:
                    groundColor = '#5dbb63';
                    patternColor = '#57a773';
            }
            
            // Fill entire screen with ground
            ctx.fillStyle = groundColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Add pattern
            ctx.fillStyle = patternColor;
            const tileSize = 40;
            for(let x = 0; x < canvas.width; x += tileSize) {
                for(let y = 0; y < canvas.height; y += tileSize) {
                    if ((x + y) % (tileSize * 2) === 0) {
                        ctx.fillRect(x, y, tileSize, tileSize);
                    }
                }
            }
            
            // Add sky
            const skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            skyGradient.addColorStop(0, '#87CEEB');
            skyGradient.addColorStop(0.3, '#E0F6FF');
            skyGradient.addColorStop(0.7, 'transparent');
            ctx.fillStyle = skyGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height * 0.3);
        }

        function drawBuilding(building) {
            // Main building
            ctx.fillStyle = building.color;
            ctx.fillRect(building.x - building.width/2, building.y - building.height/2, building.width, building.height);
            
            // Roof
            ctx.fillStyle = building.roof;
            ctx.beginPath();
            ctx.moveTo(building.x - building.width/2 - 10, building.y - building.height/2);
            ctx.lineTo(building.x, building.y - building.height/2 - 20);
            ctx.lineTo(building.x + building.width/2 + 10, building.y - building.height/2);
            ctx.closePath();
            ctx.fill();
            
            // Door
            ctx.fillStyle = '#654321';
            ctx.fillRect(building.x - 8, building.y + building.height/2 - 20, 16, 20);
            
            // Windows
            ctx.fillStyle = '#4a8bca';
            ctx.fillRect(building.x - building.width/2 + 15, building.y - 10, 12, 12);
            ctx.fillRect(building.x + building.width/2 - 27, building.y - 10, 12, 12);
            
            // Building name
            ctx.fillStyle = '#fff';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(building.name, building.x, building.y - building.height/2 - 25);
        }

        function drawNPC(npc) {
            // NPC body color based on type
            const npcColors = {
                'mayor': '#4a90e2',
                'child': '#ff6b9d',
                'hiker': '#8b4513',
                'lady': '#f08030',
                'man': '#2c8bff',
                'old_woman': '#888',
                'fisherman': '#6890f0',
                'scientist': '#a8a8a8',
                'researcher': '#78c850',
                'gardener': '#57a773',
                'gym_leader': '#ffd700',
                'swimmer': '#87CEEB'
            };
            
            ctx.fillStyle = npcColors[npc.type] || '#fff';
            ctx.beginPath();
            ctx.arc(npc.x, npc.y, 12, 0, Math.PI * 2);
            ctx.fill();
            
            // Face
            ctx.fillStyle = '#ffcc99';
            ctx.beginPath();
            ctx.arc(npc.x, npc.y - 2, 8, 0, Math.PI * 2);
            ctx.fill();
            
            // Interaction indicator
            ctx.fillStyle = '#4a90e2';
            ctx.beginPath();
            ctx.arc(npc.x, npc.y - 20, 5, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawDecoration(deco, areaType) {
            switch(deco.type) {
                case 'tree':
                    ctx.fillStyle = areaType === 'beach' ? '#2d5a27' : '#3a7d34';
                    ctx.beginPath();
                    ctx.arc(deco.x, deco.y, deco.size, 0, Math.PI * 2);
                    ctx.fill();
                    // Trunk
                    ctx.fillStyle = '#8b4513';
                    ctx.fillRect(deco.x - 5, deco.y + deco.size/2, 10, 25);
                    break;
                    
                case 'palm_tree':
                    // Trunk
                    ctx.fillStyle = '#8b4513';
                    ctx.fillRect(deco.x - 5, deco.y, 10, 40);
                    // Leaves
                    ctx.fillStyle = '#2d5a27';
                    ctx.beginPath();
                    ctx.arc(deco.x, deco.y - 10, 25, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                    
                case 'fountain':
                    ctx.fillStyle = '#4a8bca';
                    ctx.beginPath();
                    ctx.arc(deco.x, deco.y, deco.size, 0, Math.PI * 2);
                    ctx.fill();
                    // Water animation
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    for(let i = 0; i < 3; i++) {
                        const offset = Math.sin(Date.now() * 0.002 + i) * 3;
                        ctx.beginPath();
                        ctx.arc(deco.x, deco.y - 5 + offset, deco.size/2, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    break;
                    
                case 'bench':
                    ctx.fillStyle = '#8b4513';
                    // Seat
                    ctx.fillRect(deco.x - deco.size, deco.y, deco.size * 2, 8);
                    // Back
                    ctx.fillRect(deco.x - deco.size, deco.y - 8, deco.size * 2, 4);
                    // Legs
                    ctx.fillRect(deco.x - deco.size + 5, deco.y + 8, 6, 15);
                    ctx.fillRect(deco.x + deco.size - 11, deco.y + 8, 6, 15);
                    break;
                    
                case 'sign':
                    ctx.fillStyle = '#8b4513';
                    ctx.fillRect(deco.x - 30, deco.y - 20, 60, 40);
                    ctx.fillStyle = '#fff';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(deco.text, deco.x, deco.y);
                    break;
                    
                case 'flower_bed':
                    ctx.fillStyle = '#78c850';
                    ctx.fillRect(deco.x - deco.size/2, deco.y - deco.size/2, deco.size, deco.size);
                    // Flowers
                    const flowerColors = ['#ff6b9d', '#ffd700', '#87CEEB', '#ff4444'];
                    for(let i = 0; i < 8; i++) {
                        const angle = (i / 8) * Math.PI * 2;
                        const fx = deco.x + Math.cos(angle) * (deco.size/3);
                        const fy = deco.y + Math.sin(angle) * (deco.size/3);
                        ctx.fillStyle = flowerColors[i % flowerColors.length];
                        ctx.beginPath();
                        ctx.arc(fx, fy, 8, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    break;
                    
                case 'rock':
                    ctx.fillStyle = '#888';
                    ctx.beginPath();
                    ctx.arc(deco.x, deco.y, deco.size, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                    
                case 'bush':
                    ctx.fillStyle = '#2d5a27';
                    ctx.beginPath();
                    ctx.arc(deco.x, deco.y, deco.size, 0, Math.PI * 2);
                    ctx.fill();
                    break;
            }
        }

        function drawAreaEdges(area) {
            // Draw exit indicators
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 5]);
            
            for (const [direction, targetArea] of Object.entries(area.connections)) {
                switch(direction) {
                    case 'north':
                        ctx.beginPath();
                        ctx.moveTo(300, 30);
                        ctx.lineTo(500, 30);
                        ctx.stroke();
                        break;
                    case 'south':
                        ctx.beginPath();
                        ctx.moveTo(300, canvas.height - 30);
                        ctx.lineTo(500, canvas.height - 30);
                        ctx.stroke();
                        break;
                    case 'east':
                        ctx.beginPath();
                        ctx.moveTo(canvas.width - 30, 250);
                        ctx.lineTo(canvas.width - 30, 350);
                        ctx.stroke();
                        break;
                    case 'west':
                        ctx.beginPath();
                        ctx.moveTo(30, 250);
                        ctx.lineTo(30, 350);
                        ctx.stroke();
                        break;
                }
            }
            ctx.setLineDash([]);
        }

        function renderBuildingInterior() {
            const building = gameState.player.currentBuilding;
            const interior = islandVillage.buildingInteriors[building.data.type] || islandVillage.buildingInteriors.house;
            
            // Draw walls and floor
            ctx.fillStyle = interior.color;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw floor pattern
            ctx.fillStyle = '#8b7355';
            const tileSize = 40;
            for(let x = 0; x < canvas.width; x += tileSize) {
                for(let y = 0; y < canvas.height; y += tileSize) {
                    if ((x + y) % (tileSize * 2) === 0) {
                        ctx.fillRect(x, y, tileSize, tileSize);
                    }
                }
            }
            
            // Draw furniture
            interior.furniture.forEach(item => {
                ctx.fillStyle = '#8b4513';
                ctx.fillRect(item.x - item.width/2, item.y - item.height/2, item.width, item.height);
            });
            
            // Draw NPC if present
            if (interior.npc) {
                drawNPC(interior.npc);
            }
            
            // Draw exit door
            ctx.fillStyle = '#654321';
            ctx.fillRect(canvas.width/2 - 40, canvas.height - 80, 80, 30);
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('EXIT', canvas.width/2, canvas.height - 60);
            
            // Building name
            ctx.fillStyle = '#000';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(building.data.name, canvas.width/2, 50);
        }

        function drawPlayer() {
            const player = gameState.player;
            
            // Walking animation
            if (joystick.x !== 0 || joystick.y !== 0) {
                player.spriteFrame = (player.spriteFrame + 0.2) % 8;
            }
            
            ctx.save();
            ctx.translate(player.x, player.y);
            
            // Body
            ctx.fillStyle = '#ff4444'; // Red hat
            ctx.fillRect(-8, -20, 16, 8);
            
            ctx.fillStyle = '#2c8bff'; // Blue shirt
            ctx.fillRect(-10, -12, 20, 16);
            
            ctx.fillStyle = '#000'; // Pants
            ctx.fillRect(-10, 4, 20, 8);
            
            // Face
            ctx.fillStyle = '#ffcc99';
            ctx.beginPath();
            ctx.arc(0, -15, 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Hair
            ctx.fillStyle = '#8b4513';
            ctx.fillRect(-8, -22, 16, 8);
            
            // Legs with animation
            let legOffset = 0;
            if (joystick.x !== 0 || joystick.y !== 0) {
                legOffset = Math.sin(player.spriteFrame) * 3;
            }
            
            ctx.fillStyle = '#000';
            ctx.fillRect(-6, 12, 4, 8 + legOffset);
            ctx.fillRect(2, 12, 4, 8 - legOffset);
            
            // Interaction indicator if near something
            if (checkNearbyInteraction()) {
                ctx.fillStyle = '#4a90e2';
                ctx.beginPath();
                ctx.arc(0, -30, 5, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.restore();
        }

        function checkNearbyInteraction() {
            if (gameState.player.inBuilding) return true;
            
            const area = gameState.areas[gameState.player.currentArea];
            
            // Check buildings
            for (const building of area.buildings) {
                const distance = Math.sqrt(
                    Math.pow(gameState.player.x - building.x, 2) + 
                    Math.pow(gameState.player.y - building.y, 2)
                );
                if (distance < 60) return true;
            }
            
            // Check NPCs
            for (const npc of area.npcs) {
                const distance = Math.sqrt(
                    Math.pow(gameState.player.x - npc.x, 2) + 
                    Math.pow(gameState.player.y - npc.y, 2)
                );
                if (distance < 50) return true;
            }
            
            // Check area edges
            return gameState.player.x < 70 || 
                   gameState.player.x > 730 || 
                   gameState.player.y < 70 || 
                   gameState.player.y > 530;
        }

        // Game loop
        function gameLoop() {
            // Update player position
            if (!gameState.inDialog && !gameState.player.inBuilding) {
                gameState.player.x += joystick.x * gameState.player.speed;
                gameState.player.y += joystick.y * gameState.player.speed;
                
                // Keep player on screen
                gameState.player.x = Math.max(30, Math.min(770, gameState.player.x));
                gameState.player.y = Math.max(30, Math.min(570, gameState.player.y));
            }
            
            // Update HUD
            const area = gameState.areas[gameState.player.currentArea];
            document.getElementById('hudContent').innerHTML = `
                ${area.name}<br>
                ${gameState.player.inBuilding ? 'Inside Building' : 'Exploring'}
            `;
            
            // Render
            render();
            
            // Next frame
            requestAnimationFrame(gameLoop);
        }

        // Start game
        function startGame() {
            document.getElementById('titleScreen').style.display = 'none';
            document.getElementById('joyBase').style.display = 'block';
            document.getElementById('hud').style.display = 'block';
            document.getElementById('controls').style.display = 'flex';
            document.getElementById('locationIndicator').style.display = 'block';
            
            showDialog("Welcome to Island Village! Explore different areas, enter buildings, and talk to villagers. Use the joystick to move and the üí¨ button to interact.");
            
            updateLocationIndicator();
            initGame();
        }

        function showInstructions() {
            showDialog("HOW TO PLAY:\n\n" +
                      "‚Ä¢ Use the JOYSTICK to move\n" +
                      "‚Ä¢ Press üí¨ to interact with people and buildings\n" +
                      "‚Ä¢ Walk to screen edges to change areas\n" +
                      "‚Ä¢ Enter buildings to explore interiors\n" +
                      "‚Ä¢ Talk to villagers for information\n\n" +
                      "Explore the entire island village!");
        }
    </script>
</body>
</html>
