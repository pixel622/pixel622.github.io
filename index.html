<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Pokémon Nova Genesis</title>
<style>
  body {
    margin:0;
    padding:0;
    overflow:hidden;
    background:#000;
    font-family: 'Courier New', Courier, monospace;
    image-rendering: pixelated;
    touch-action: none;
  }
  #game {
    display: block;
    width: 100vw;
    height: 100vh;
  }
  #ui {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }
  #dialogue-box {
    position: absolute;
    bottom: 10px;
    left: 10px;
    right: 10px;
    background: rgba(0,0,0,0.75);
    color: #def;
    padding: 12px 16px;
    border: 3px solid #6bd;
    border-radius: 8px;
    font-size: 18px;
    line-height: 1.4;
    max-height: 140px;
    overflow-y: auto;
    pointer-events: auto;
  }
  #name-entry {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    gap: 20px;
    pointer-events: auto;
  }
  #name-input {
    font-size: 28px;
    padding: 12px 20px;
    width: 280px;
    text-align: center;
  }
  .btn {
    padding: 14px 32px;
    font-size: 22px;
    background: #336;
    color: white;
    border: 3px solid #6bd;
    border-radius: 8px;
    cursor: pointer;
  }
  #controls {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }
  .dpad {
    position: absolute;
    left: 24px;
    bottom: 24px;
    width: 140px;
    height: 140px;
    pointer-events: auto;
  }
  .dpad div {
    position: absolute;
    width: 54px;
    height: 54px;
    background: rgba(255,255,255,0.18);
    border: 3px solid rgba(255,255,255,0.5);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 28px;
    user-select: none;
  }
  #up    { top:0;    left:43px; }
  #down  { bottom:0; left:43px; }
  #left  { left:0;   top:43px;  }
  #right { right:0;  top:43px;  }
  .abtns {
    position: absolute;
    right: 30px;
    bottom: 40px;
    display: flex;
    gap: 30px;
    pointer-events: auto;
  }
  .abtn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: rgba(0,180,0,0.6);
    border: 4px solid #0f0;
    color: white;
    font-size: 32px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #bBtn { background: rgba(180,0,0,0.6); border-color: #f00; }
  #menuBtn {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 54px;
    height: 54px;
    background: rgba(80,80,255,0.5);
    border: 3px solid #88f;
    border-radius: 12px;
    color: white;
    font-size: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
  }
  .hidden { display:none !important; }
</style>
</head>
<body>

<canvas id="game"></canvas>

<div id="ui">
  <div id="name-entry" class="hidden">
    <div>What is your name?</div>
    <input id="name-input" type="text" maxlength="12" value="NOVA" autocomplete="off"/>
    <button class="btn" id="confirmName">Confirm</button>
  </div>

  <div id="dialogue-box" class="hidden"></div>

  <div id="controls">
    <div class="dpad">
      <div id="up">↑</div>
      <div id="down">↓</div>
      <div id="left">←</div>
      <div id="right">→</div>
    </div>
    <div class="abtns">
      <div class="abtn" id="aBtn">A</div>
      <div class="abtn" id="bBtn">B</div>
    </div>
    <div id="menuBtn">M</div>
  </div>
</div>

<script>
// ────────────────────────────────────────────────
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const dialogBox = document.getElementById('dialogue-box');

// Game state
let state = "title"; // title → professor → choose → home → playing
let playerName = "NOVA";
let chosenPokemon = null;
let player = { x: 0, y: 0, dir: "down", frame: 0, moving: false };
let pokemonFollow = { x: 0, y: 0, dir: "down", frame: 0 };
let mapOffset = { x: 0, y: 0 };

// Simple room (home bedroom + downstairs)
const TILE = 32;
const MAP_W = 20;
const MAP_H = 18;
const homeMap = [
  // 0 = walkable, 1 = wall, 2 = door, 3 = mom (downstairs)
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,1,1,1,1,1,1,2,2,1,1,1,1,1,1,1,1,1,1,1], // stairs / transition
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,1], // mom
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
];

// Dialogue queue
let dialogQueue = [];
let dialogTyping = false;
let dialogCharIndex = 0;
let dialogSpeed = 40; // ms per char
let lastCharTime = 0;

// Audio (very basic beeps)
function playCry(which) {
  const audio = new AudioContext();
  const osc = audio.createOscillator();
  osc.type = 'square';
  osc.frequency.value = which === "charmander" ? 680 : which === "treecko" ? 820 : 440;
  osc.connect(audio.destination);
  osc.start();
  osc.stop(audio.currentTime + 0.18);
}

// ────────────────────────────────────────────────
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// ──────────────────────────────────────────────── Title Screen
function drawTitle() {
  ctx.fillStyle = "#0a001a";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Fake stars
  ctx.fillStyle = "white";
  for(let i=0;i<80;i++){
    let x = Math.random()*canvas.width;
    let y = Math.random()*canvas.height*0.7;
    ctx.fillRect(x,y,2,2);
  }

  ctx.font = "bold 72px Courier New";
  ctx.fillStyle = "#6cf";
  ctx.textAlign = "center";
  ctx.fillText("Pokémon", canvas.width/2, canvas.height*0.38);
  ctx.fillStyle = "#ffeb3b";
  ctx.fillText("NOVA GENESIS", canvas.width/2, canvas.height*0.52);

  ctx.font = "32px Courier New";
  ctx.fillStyle = "white";
  ctx.fillText("Tap to Start", canvas.width/2, canvas.height*0.72);
}

// ──────────────────────────────────────────────── Professor Lab
function drawLab() {
  ctx.fillStyle = "#8ac";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Table
  ctx.fillStyle = "#642";
  ctx.fillRect(canvas.width/2-120, canvas.height/2-40, 240, 80);

  // Professor Chen (simple sprite placeholder)
  ctx.fillStyle = "#ddd";
  ctx.fillRect(canvas.width/2-32, canvas.height/2-100, 64, 96); // body
  ctx.fillStyle = "#333";
  ctx.fillRect(canvas.width/2-24, canvas.height/2-116, 48, 32); // hair
  ctx.fillStyle = "white";
  ctx.fillRect(canvas.width/2-20, canvas.height/2-80, 40, 16); // coat label

  // Poké Balls (appear later)
  if (state === "choose") {
    ["charmander","treecko","froakie"].forEach((p,i) => {
      let x = canvas.width/2 - 120 + i*120;
      ctx.fillStyle = "#fff";
      ctx.beginPath();
      ctx.arc(x, canvas.height/2-40, 36, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "#f44";
      ctx.fillRect(x-36, canvas.height/2-40-18, 72, 18);
      ctx.fillStyle = "black";
      ctx.beginPath();
      ctx.arc(x, canvas.height/2-40, 12, 0, Math.PI*2);
      ctx.fill();
    });
  }
}

// ──────────────────────────────────────────────── Home (simple top-down)
function drawHome() {
  ctx.fillStyle = "#000";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const centerX = canvas.width/2;
  const centerY = canvas.height/2 - 60;

  // Draw map tiles
  for(let y=0; y<MAP_H; y++){
    for(let x=0; x<MAP_W; x++){
      let tile = homeMap[y][x];
      let px = centerX + (x-10)*TILE + mapOffset.x;
      let py = centerY + (y-9)*TILE + mapOffset.y;

      if (px+TILE<0 || px>canvas.width || py+TILE<0 || py>canvas.height) continue;

      if (tile === 0) ctx.fillStyle = "#c9a";
      else if (tile === 1) ctx.fillStyle = "#444";
      else if (tile === 2) ctx.fillStyle = "#8c4";
      else if (tile === 3) ctx.fillStyle = "#f8c";

      ctx.fillRect(px, py, TILE, TILE);
    }
  }

  // Player
  ctx.fillStyle = "#f88";
  ctx.fillRect(centerX-16, centerY-32, 32, 48);

  // Follow Pokémon
  if (chosenPokemon) {
    ctx.fillStyle = chosenPokemon === "charmander" ? "#f60" :
                    chosenPokemon === "treecko"   ? "#0c4" :
                    "#48f";
    ctx.fillRect(centerX+12, centerY-20, 28, 36);
  }
}

// ──────────────────────────────────────────────── Render loop
function loop(ts) {
  ctx.imageSmoothingEnabled = false;

  if (state === "title") {
    drawTitle();
  }
  else if (state === "professor" || state === "choose") {
    drawLab();
  }
  else if (state === "home" || state === "playing") {
    drawHome();
  }

  // Dialogue typing
  if (dialogQueue.length > 0 && !dialogTyping) {
    startTyping(dialogQueue.shift());
  }

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// ──────────────────────────────────────────────── Dialogue system
function showText(lines) {
  dialogQueue.push(...lines);
  dialogBox.classList.remove("hidden");
}

function startTyping(text) {
  dialogTyping = true;
  dialogCharIndex = 0;
  lastCharTime = performance.now();
  dialogBox.textContent = "";
  typeNextChar(text);
}

function typeNextChar(fullText) {
  const now = performance.now();
  if (now - lastCharTime >= dialogSpeed) {
    dialogCharIndex++;
    lastCharTime = now;
    dialogBox.textContent = fullText.slice(0, dialogCharIndex);
  }
  if (dialogCharIndex < fullText.length) {
    requestAnimationFrame(() => typeNextChar(fullText));
  } else {
    dialogTyping = false;
  }
}

function advanceDialog() {
  if (dialogTyping) {
    // Skip typing
    dialogBox.textContent = dialogQueue[dialogQueue.length-1] || "";
    dialogTyping = false;
  } else if (dialogQueue.length === 0) {
    // End of dialogue block
    if (state === "professor") {
      document.getElementById("name-entry").classList.remove("hidden");
    }
    else if (state === "choose") {
      // Show pokemon already drawn
    }
  }
}

// ──────────────────────────────────────────────── Controls
const keys = {};
const touchMoves = {};

function updateMovement() {
  if (state !== "playing") return;

  let dx=0, dy=0;
  if (keys["ArrowUp"]    || keys["w"] || touchMoves.up)    dy -= 2;
  if (keys["ArrowDown"]  || keys["s"] || touchMoves.down)  dy += 2;
  if (keys["ArrowLeft"]  || keys["a"] || touchMoves.left)  dx -= 2;
  if (keys["ArrowRight"] || keys["d"] || touchMoves.right) dx += 2;

  if (dx || dy) {
    player.moving = true;
    if (Math.abs(dx) > Math.abs(dy)) {
      player.dir = dx > 0 ? "right" : "left";
    } else {
      player.dir = dy > 0 ? "down" : "up";
    }

    // Very basic collision → prevent going too far left/up
    if (player.x + dx > -200 && player.x + dx < 200) player.x += dx;
    if (player.y + dy > -180 && player.y + dy < 180) player.y += dy;

    mapOffset.x -= dx * 0.4;
    mapOffset.y -= dy * 0.4;
  } else {
    player.moving = false;
  }
}

window.addEventListener("keydown", e => { keys[e.key] = true; });
window.addEventListener("keyup",   e => { keys[e.key] = false; });

// Touch controls
document.querySelectorAll(".dpad div").forEach(el => {
  el.addEventListener("touchstart", e => {
    e.preventDefault();
    touchMoves[el.id] = true;
  });
  el.addEventListener("touchend", e => {
    touchMoves[el.id] = false;
  });
});

["aBtn","bBtn"].forEach(id => {
  document.getElementById(id).addEventListener("touchstart", e => {
    e.preventDefault();
    if (id === "aBtn") advanceDialog();
  });
});

document.getElementById("menuBtn").addEventListener("touchstart", e => {
  e.preventDefault();
  alert("Menu: Pokémon / Bag / Save (not implemented yet)");
});

// ──────────────────────────────────────────────── Game flow
document.body.addEventListener("click", function startGame(e) {
  if (state !== "title") return;

  state = "professor";
  document.body.removeEventListener("click", startGame);

  showText([
    "Ah! There you are! I've been expecting you.",
    "Welcome to the world of Pokémon!",
    "My name is Chen. I study the unique bond between humans and Pokémon here in the Aura Region.",
    "And you are...?"
  ]);

  // After name → auto continue
  document.getElementById("confirmName").onclick = () => {
    playerName = document.getElementById("name-input").value.trim() || "NOVA";
    document.getElementById("name-entry").classList.add("hidden");

    showText([
      `Perfect, ${playerName}!`,
      "Now, for your first partner.",
      "The Aura Region is home to Pokémon with powerful latent abilities.",
      "Which of these three resonates with you?"
    ]);

    state = "choose";

    // Click on Pokémon (simple — whole screen zones for demo)
    const chooseListener = e => {
      const rect = canvas.getBoundingClientRect();
      const tx = e.clientX - rect.left;
      const ty = e.clientY - rect.top;

      if (ty > canvas.height/2 - 100 && ty < canvas.height/2 + 40) {
        if (tx < canvas.width/3) {
          chosenPokemon = "charmander";
          playCry("charmander");
        } else if (tx < canvas.width*2/3) {
          chosenPokemon = "treecko";
          playCry("treecko");
        } else {
          chosenPokemon = "froakie";
          playCry("froakie");
        }

        if (chosenPokemon) {
          canvas.removeEventListener("click", chooseListener);
          showText([
            `You chose ${chosenPokemon.toUpperCase()}!`,
            "An excellent choice! This Pokémon is full of potential!",
            `Alright, ${chosenPokemon.toUpperCase()}! Let's go meet Mom downstairs, then start our journey!`
          ]);

          setTimeout(() => {
            state = "home";
            dialogBox.classList.add("hidden");
            document.getElementById("controls").style.display = "block";
            setTimeout(() => {
              state = "playing";
              showText(["Use the D-pad to move. Tap A to interact."]);
            }, 1800);
          }, 2800);
        }
      }
    };

    canvas.addEventListener("click", chooseListener);
    canvas.addEventListener("touchend", chooseListener);
  };
}, {once:true});

// Simple game loop logic
setInterval(updateMovement, 1000/60);

</script>
</body>
</html>
