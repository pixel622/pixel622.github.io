<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pokémon K&E Version</title>
    <style>
        :root {
            --gba-blue: #285088;
            --gba-light-blue: #5888c8;
            --font-main: 'Courier New', Courier, monospace;
        }

        body, html {
            margin: 0; padding: 0; 
            width: 100vw; height: 100vh;
            background: #000; overflow: hidden; 
            touch-action: none;
            display: flex; justify-content: center; align-items: center;
        }

        #game-wrapper { position: relative; width: 100%; height: 100%; }

        canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
            image-rendering: pixelated;
        }

        #title-screen, #battle-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; font-family: var(--font-main);
        }

        #title-screen { background: #000; color: #fff; transition: opacity 0.5s; }
        #title-screen h1 { font-size: 40px; color: #ffcb05; text-shadow: 3px 3px #2a75bb; }

        #battle-screen { 
            background: rgba(0,0,0,0.85); 
            display: none; z-index: 2500; color: white;
            border: 10px double white;
        }

        #start-btn, .battle-btn {
            padding: 15px 40px; font-size: 20px; font-family: var(--font-main);
            background: var(--gba-blue); color: white; border: 4px solid white;
            cursor: pointer; border-radius: 10px; font-weight: bold; margin: 10px;
        }

        #ui-layer {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%); width: 90%;
            z-index: 100; cursor: pointer; display: none;
        }

        #dialogue-box {
            background: white; border: 6px solid var(--gba-blue); border-radius: 18px;
            padding: 20px; font-family: var(--font-main); font-weight: bold;
            font-size: 20px; box-shadow: inset 0 0 0 3px var(--gba-light-blue);
            min-height: 80px;
        }

        #speaker-tag {
            position: absolute; top: -25px; left: 30px;
            background: var(--gba-blue); color: white; padding: 5px 20px; border-radius: 10px 10px 0 0;
        }

        #joystick-wrapper {
            position: absolute; bottom: 80px; left: 40px;
            width: 130px; height: 130px;
            background: rgba(255,255,255,0.15); border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);
            display: flex; justify-content: center; align-items: center; z-index: 200;
        }

        #joystick-knob { width: 50px; height: 50px; background: rgba(255,255,255,0.6); border-radius: 50%; }

        #bag-btn {
            position: absolute; bottom: 80px; right: 40px;
            background: var(--gba-blue); color: white; padding: 15px 30px; border-radius: 8px;
            font-family: var(--font-main); font-weight: bold; border: 3px solid white; z-index: 300;
        }

        #bag-menu {
            display: none; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 70%; background: white;
            border: 6px solid var(--gba-blue); border-radius: 15px; padding: 20px; z-index: 3000;
            font-family: var(--font-main);
        }

        #shimmer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 999; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="title-screen">
        <h1>Pokémon K&E Version</h1>
        <button id="start-btn" onclick="startGame()">START GAME</button>
    </div>

    <div id="battle-screen">
        <h2 id="battle-text">A Wild Pokémon appeared!</h2>
        <div style="display:flex;">
            <button class="battle-btn" onclick="battleAction('ATTACK')">ATTACK</button>
            <button class="battle-btn" onclick="battleAction('CATCH')">THROW BALL</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div id="shimmer"></div>
    <div id="bag-btn" onclick="openBag()">BAG</div>

    <div id="bag-menu">
        <h2 style="color:var(--gba-blue)">POKÉMON BAG</h2>
        <div id="bag-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px;"></div>
        <button class="battle-btn" onclick="closeBag()">CLOSE</button>
    </div>

    <div id="ui-layer" onclick="handleDialogueClick()">
        <div id="speaker-tag">Professor Sequoia</div>
        <div id="dialogue-box">Welcome to the Habitat Research Lab!</div>
    </div>

    <div id="joystick-wrapper">
        <div id="joystick-knob"></div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const knob = document.getElementById('joystick-knob');
    const wrapper = document.getElementById('joystick-wrapper');
    const uiLayer = document.getElementById('ui-layer');
    const dialogueBox = document.getElementById('dialogue-box');
    const titleScreen = document.getElementById('title-screen');
    const battleScreen = document.getElementById('battle-screen');

    const script = [
        "Welcome to the Habitat Research Lab!",
        "Look around! This facility is dedicated to studying Orebound's ecology.",
        "The tremor earlier was quite strong. We must act quickly.",
        "Go ahead and click on the Pokémon you want to partner with!"
    ];

    const encounters = {
        GRASS: ['Shroomish', 'Ralts', 'Lillipup', 'Venipede', 'Skwovet'],
        WATER: ['Lotad', 'Magikarp', 'Slowpoke', 'Buizel', 'Chewtle'],
        ROCKY: ['Onix', 'Larvitar', 'Cubone', 'Rockruff', 'Aron']
    };

    let scriptIndex = 0;
    let currentMap = 'LAB';
    let choosingState = false;
    let holdingPokeball = false; 
    let isBattle = false;
    let currentWild = "";
    let caughtPokemon = [];
    let width, height;
    let walkCounter = 0;

    const rocks = [];
    function genRocks() {
        rocks.length = 0;
        for(let i=0; i<25; i++) rocks.push({x: Math.random()*2000, y: Math.random()*400, s: 15+Math.random()*20});
    }

    function resize() {
        width = window.innerWidth; height = window.innerHeight;
        canvas.width = width; canvas.height = height;
        genRocks();
    }
    window.addEventListener('resize', resize);
    resize();

    const player = { x: width/2, y: height - 120, speed: 5, history: [] };
    const follower = { active: false, name: '', x: 0, y: 0, color: '#000' };

    const pokeballs = [
        { name: 'Treecko', x: 0, y: 0, color: '#32CD32', active: true },
        { name: 'Froakie', x: 0, y: 0, color: '#1E90FF', active: true },
        { name: 'Charmander', x: 0, y: 0, color: '#FF4500', active: true }
    ];

    function startGame() {
        titleScreen.style.opacity = '0';
        setTimeout(() => { titleScreen.style.display = 'none'; uiLayer.style.display = 'block'; }, 500);
    }

    function openBag() {
        const list = document.getElementById('bag-list');
        list.innerHTML = caughtPokemon.length ? caughtPokemon.map(p => `• ${p}`).join('<br>') : "No Pokémon caught.";
        document.getElementById('bag-menu').style.display = 'block';
    }
    function closeBag() { document.getElementById('bag-menu').style.display = 'none'; }

    function triggerBattle(terrain) {
        if (!follower.active || isBattle) return;
        isBattle = true;
        const pool = encounters[terrain];
        currentWild = pool[Math.floor(Math.random()*pool.length)];
        document.getElementById('battle-text').innerText = `A wild ${currentWild} appeared!`;
        battleScreen.style.display = 'flex';
        isTouching = false;
    }

    function battleAction(act) {
        if (act === 'ATTACK') {
            document.getElementById('battle-text').innerText = `${follower.name} used Tackle!`;
        } else {
            caughtPokemon.push(currentWild);
            document.getElementById('battle-text').innerText = `Gotcha! ${currentWild} was caught!`;
            setTimeout(() => { battleScreen.style.display = 'none'; isBattle = false; }, 1200);
        }
    }

    let stickX = 0, stickY = 0, isTouching = false;

    function handleDialogueClick() {
        if (scriptIndex < script.length - 1) {
            scriptIndex++; dialogueBox.innerText = script[scriptIndex];
        } else { uiLayer.style.display = 'none'; choosingState = true; }
    }

    canvas.addEventListener('mousedown', (e) => checkPokeClick(e.clientX, e.clientY));
    canvas.addEventListener('touchstart', (e) => checkPokeClick(e.touches[0].clientX, e.touches[0].clientY));

    function checkPokeClick(clickX, clickY) {
        if (!choosingState || follower.active || currentMap !== 'LAB') return;
        pokeballs.forEach(ball => {
            if(!ball.active) return;
            const dx = clickX - ball.realX, dy = clickY - ball.realY;
            if (Math.sqrt(dx*dx + dy*dy) < 40) {
                follower.active = true; follower.name = ball.name;
                follower.color = ball.color; follower.x = ball.realX;
                follower.y = ball.realY; ball.active = false;
                holdingPokeball = true;
                caughtPokemon.push(ball.name);
            }
        });
    }

    wrapper.addEventListener('touchstart', (e) => { isTouching = true; e.preventDefault(); });
    window.addEventListener('touchend', () => { isTouching = false; stickX = 0; stickY = 0; knob.style.transform = `translate(0px, 0px)`; });
    window.addEventListener('touchmove', (e) => {
        if (!isTouching || isBattle) return;
        const rect = wrapper.getBoundingClientRect();
        const touch = e.touches[0];
        let dx = touch.clientX - (rect.left + rect.width/2), dy = touch.clientY - (rect.top + rect.height/2);
        const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
        const angle = Math.atan2(dy, dx);
        stickX = Math.cos(angle) * (dist/40); stickY = Math.sin(angle) * (dist/40);
        knob.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
    });

    function update() {
        if (isBattle) return;
        if (isTouching) {
            let nx = player.x + stickX * player.speed, ny = player.y + stickY * player.speed;
            player.history.push({x: player.x, y: player.y});
            if (player.history.length > 60) player.history.shift();
            player.x = nx; player.y = ny;

            // ENCOUNTER CHECK
            if (currentMap === 'OUTSIDE') {
                walkCounter++;
                if (walkCounter > 120) {
                    walkCounter = 0;
                    if (ny > height/2 + 120) triggerBattle('ROCKY');
                    else if (nx > width - 450 && ny < height/2 + 100) triggerBattle('GRASS');
                    else if (Math.hypot(nx - (width/2 - 350), ny - (height/2 - 50)) < 100) triggerBattle('WATER');
                }
            }
        }
        const matX = width/2, matY = (currentMap === 'LAB') ? height-30 : height/2+10;
        if (Math.abs(player.x - matX) < 50 && Math.abs(player.y - matY) < 30) {
            currentMap = (currentMap === 'LAB') ? 'OUTSIDE' : 'LAB';
            player.x = width/2; player.y = (currentMap === 'OUTSIDE') ? height/2 + 80 : height - 120;
            player.history = [];
        }
        if (follower.active && player.history.length > 12) {
            const fp = player.history[player.history.length - 12];
            follower.x += (fp.x - follower.x) * 0.15; follower.y += (fp.y - follower.y) * 0.15;
        }
    }

    function draw() {
        ctx.clearRect(0, 0, width, height);
        if (currentMap === 'LAB') {
            ctx.fillStyle = '#d89060'; ctx.fillRect(0, 0, width, height);
            ctx.strokeStyle = '#b87040'; for(let i=0; i<width; i+=60) ctx.strokeRect(i, 0, 60, height);
            ctx.fillStyle = '#3a8fb7'; ctx.fillRect(width/2 - 50, height - 50, 100, 50);
            const dW = 350, dH = 100, dX = width/2 - dW/2, dY = height/2.5;
            ctx.fillStyle = '#804020'; ctx.fillRect(dX, dY, dW, dH);
            pokeballs.forEach((ball, i) => {
                if (!ball.active) return;
                ball.realX = dX + 60 + (i * 110); ball.realY = dY + 40;
                ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(ball.realX, ball.realY, 15, Math.PI, 0); ctx.fill();
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(ball.realX, ball.realY, 15, 0, Math.PI); ctx.fill();
            });
        } else {
            ctx.fillStyle = '#719e71'; ctx.fillRect(0, 0, width, height);
            ctx.fillStyle = '#567d56'; for(let r=0; r<8; r++) for(let c=0; c<12; c++) ctx.fillRect(width - 450 + c*40, 50 + r*40, 35, 35);
            ctx.fillStyle = '#e5d17c'; ctx.fillRect(0, height/2 + 120, width, height);
            rocks.forEach(r => { ctx.fillStyle = '#c5b16c'; ctx.beginPath(); ctx.moveTo(r.x%width, height/2+120+(r.y%200)); ctx.lineTo(r.x%width+r.s, height/2+120+(r.y%200)); ctx.lineTo(r.x%width+r.s/2, height/2+120+(r.y%200)-r.s); ctx.fill(); });
            ctx.fillStyle = '#1e5aab'; ctx.beginPath(); ctx.ellipse(width/2-350, height/2-50, 145, 95, 0, 0, Math.PI*2); ctx.fill();
            const hX = width/2 - 110, hY = height/2 - 150;
            ctx.fillStyle = '#a0c0d8'; ctx.fillRect(hX, hY, 220, 150);
            ctx.fillStyle = '#e06060'; ctx.beginPath(); ctx.moveTo(hX-20, hY); ctx.lineTo(width/2, hY-60); ctx.lineTo(hX+240, hY); ctx.fill();
        }
        if (follower.active) { ctx.fillStyle = follower.color; ctx.beginPath(); ctx.arc(follower.x, follower.y, 14, 0, Math.PI*2); ctx.fill(); }
        ctx.fillStyle = '#a03030'; ctx.fillRect(player.x-15, player.y-10, 30, 25);
        ctx.fillStyle = '#ffdbac'; ctx.fillRect(player.x-10, player.y-25, 20, 18);
        update(); requestAnimationFrame(draw);
    }
    draw();
</script>
</body>
</html>
