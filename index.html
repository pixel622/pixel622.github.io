<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pokemon Style Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body {
    margin: 0;
    overflow: hidden;
    background: #000;
    font-family: 'Arial', sans-serif;
    touch-action: none;
}

canvas {
    display: block;
}

/* Joystick */
#joyBase {
    position: fixed;
    bottom: 30px;
    left: 30px;
    width: 100px;
    height: 100px;
    background: rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.4);
    border-radius: 50%;
    z-index: 100;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    touch-action: none;
}

#joy {
    position: absolute;
    width: 40px;
    height: 40px;
    left: 30px;
    top: 30px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    border: 2px solid rgba(100, 100, 255, 0.8);
    box-shadow: 0 0 10px rgba(100, 100, 255, 0.5);
    transition: transform 0.1s;
    touch-action: none;
}

/* Battle UI */
#battle {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, #1a5f7a, #0a3d62);
    color: white;
    display: none;
    z-index: 1000;
    font-family: 'Arial', sans-serif;
}

.battle-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 20px;
    box-sizing: border-box;
}

.enemy-area {
    flex: 1;
    display: flex;
    justify-content: flex-end;
    align-items: flex-start;
    padding-top: 40px;
}

.player-area {
    flex: 1;
    display: flex;
    justify-content: flex-start;
    align-items: flex-end;
    padding-bottom: 40px;
}

.hp-bar {
    width: 200px;
    height: 20px;
    background: #333;
    border: 2px solid #fff;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}

.hp-fill {
    height: 100%;
    background: linear-gradient(to right, #ff4444, #ffaa44);
    transition: width 0.3s;
    width: 100%;
}

.battle-menu {
    background: rgba(0, 0, 0, 0.8);
    border: 3px solid #fff;
    border-radius: 10px;
    padding: 15px;
    margin-top: 20px;
    display: none;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    max-width: 300px;
    align-self: center;
}

.battle-menu button {
    background: linear-gradient(to bottom, #4a90e2, #2c6cb0);
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

.battle-menu button:hover {
    background: linear-gradient(to bottom, #5a9cf2, #3c7cd0);
    transform: translateY(-2px);
}

.battle-menu button:active {
    transform: translateY(0);
}

#battleLog {
    background: rgba(0, 0, 0, 0.7);
    border: 2px solid #fff;
    border-radius: 10px;
    padding: 15px;
    margin: 20px 0;
    min-height: 60px;
    font-size: 18px;
    color: #fff;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Dialog Box */
#dialogBox {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 600px;
    background: rgba(0, 0, 0, 0.9);
    border: 3px solid #fff;
    border-radius: 15px;
    padding: 20px;
    color: white;
    font-size: 18px;
    z-index: 2000;
    display: none;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
}

#dialogText {
    margin-bottom: 15px;
    min-height: 60px;
    line-height: 1.5;
}

#dialogOptions {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}

.dialog-option {
    background: linear-gradient(to bottom, #4a90e2, #2c6cb0);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 120px;
}

.dialog-option:hover {
    background: linear-gradient(to bottom, #5a9cf2, #3c7cd0);
    transform: translateY(-2px);
}

/* Starter Selection */
#starterSelection {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 500px;
    background: rgba(0, 0, 0, 0.95);
    border: 4px solid #fff;
    border-radius: 20px;
    padding: 30px;
    color: white;
    z-index: 3000;
    display: none;
    text-align: center;
    box-shadow: 0 0 40px rgba(255, 255, 255, 0.3);
}

.starter-title {
    color: #ffd700;
    font-size: 28px;
    margin-bottom: 20px;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

.starter-options {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 30px 0;
    flex-wrap: wrap;
}

.starter-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s;
    width: 120px;
    border: 2px solid transparent;
}

.starter-card:hover {
    transform: translateY(-10px);
    background: rgba(255, 255, 255, 0.2);
    border-color: #fff;
}

.starter-card.selected {
    border-color: #ffd700;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
}

.starter-name {
    font-size: 20px;
    margin: 10px 0;
    font-weight: bold;
}

.starter-type {
    font-size: 14px;
    color: #aaa;
}

/* Animation for attacks */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

@keyframes flash {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
}

.shake { animation: shake 0.3s; }
.flash { animation: flash 0.3s; }
.float { animation: float 2s infinite; }
.bounce { animation: bounce 0.5s; }

/* HUD */
#hud {
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 10px 15px;
    border-radius: 10px;
    border: 2px solid #fff;
    font-size: 14px;
    z-index: 50;
}

.enemy-info, .player-info {
    background: rgba(0, 0, 0, 0.6);
    padding: 10px 20px;
    border-radius: 10px;
    border: 2px solid #fff;
}

.battle-sprite {
    width: 100px;
    height: 100px;
    margin: 0 20px;
}

/* Attack Menu */
#attackMenu {
    display: none;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 20px;
}

.attack-btn {
    background: linear-gradient(to bottom, #ff4444, #cc0000);
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

.attack-btn:hover {
    background: linear-gradient(to bottom, #ff5555, #dd1111);
    transform: translateY(-2px);
}

.back-btn {
    background: linear-gradient(to bottom, #666, #333);
    grid-column: span 2;
}
</style>
</head>

<body>
<canvas id="game"></canvas>
<div id="joyBase"><div id="joy"></div></div>
<div id="hud"></div>

<!-- Starter Selection -->
<div id="starterSelection">
    <div class="starter-title">Choose Your Starter Pokémon!</div>
    <p>Select your first Pokémon to begin your journey.</p>
    <div class="starter-options">
        <div class="starter-card" onclick="selectStarter('bulbasaur')" data-type="bulbasaur">
            <div class="starter-name" style="color: #78c850">Bulbasaur</div>
            <div class="starter-type">Grass/Poison</div>
        </div>
        <div class="starter-card" onclick="selectStarter('charmander')" data-type="charmander">
            <div class="starter-name" style="color: #f08030">Charmander</div>
            <div class="starter-type">Fire</div>
        </div>
        <div class="starter-card" onclick="selectStarter('squirtle')" data-type="squirtle">
            <div class="starter-name" style="color: #6890f0">Squirtle</div>
            <div class="starter-type">Water</div>
        </div>
    </div>
    <button onclick="confirmStarter()" style="margin-top: 20px; padding: 10px 30px; font-size: 18px;">Start Adventure!</button>
</div>

<!-- Dialog Box -->
<div id="dialogBox">
    <div id="dialogText"></div>
    <div id="dialogOptions"></div>
</div>

<!-- Battle UI -->
<div id="battle">
    <div class="battle-container">
        <div class="enemy-area">
            <div class="enemy-info">
                <h2 id="enemyName">Wild Pokémon</h2>
                <div class="hp-bar">
                    <div id="enemyHPFill" class="hp-fill"></div>
                </div>
                <div id="enemyHPText">HP: 20/20</div>
            </div>
            <div id="enemySprite" class="battle-sprite"></div>
        </div>
        
        <div id="battleLog">A wild Pokémon appeared!</div>
        
        <div class="player-area">
            <div id="playerSprite" class="battle-sprite"></div>
            <div class="player-info">
                <h2 id="playerPokemonName">Bulbasaur</h2>
                <div class="hp-bar">
                    <div id="playerHPFill" class="hp-fill"></div>
                </div>
                <div id="playerHPText">HP: 30/30</div>
            </div>
        </div>
        
        <div class="battle-menu" id="battleMenu">
            <button onclick="showAttackMenu()">FIGHT</button>
            <button onclick="usePotion()">POTION</button>
            <button onclick="usePokeball()">POKéBALL</button>
            <button onclick="run()">RUN</button>
        </div>
        
        <div class="battle-menu" id="attackMenu" style="display: none;">
            <button class="attack-btn" onclick="useAttack(0)">Tackle</button>
            <button class="attack-btn" onclick="useAttack(1)">Growl</button>
            <button class="attack-btn" onclick="useAttack(2)">Vine Whip</button>
            <button class="attack-btn" onclick="useAttack(3)">Leech Seed</button>
            <button class="back-btn" onclick="showBattleMenu()">Back</button>
        </div>
    </div>
</div>

<script>
// Initialize canvas
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// Set canvas size
function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Game constants
const TILE = 64;
const GRASS_COLORS = ['#5dbb63', '#6fcf97', '#57a773'];

// Game state
let world = "outside";
let inBattle = false;
let inDialog = false;
let gameTime = 0;
let playerPokemon = null;
let starterChosen = false;

// Player
const player = {
    x: 0,
    y: 0,
    size: 24,
    speed: 3,
    direction: 0,
    animationFrame: 0,
    pokemonFollowing: null
};

// Camera
const cam = { x: 0, y: 0 };

// Pokémon data
const pokemonData = {
    bulbasaur: {
        name: "Bulbasaur",
        type: "Grass/Poison",
        color: "#78c850",
        hp: 30,
        maxHp: 30,
        level: 5,
        attacks: [
            { name: "Tackle", damage: 4, type: "Normal" },
            { name: "Growl", damage: 0, type: "Status", effect: "attackDown" },
            { name: "Vine Whip", damage: 7, type: "Grass" },
            { name: "Leech Seed", damage: 2, type: "Grass", effect: "drain" }
        ],
        spriteColor: "#78c850",
        followingOffset: { x: -20, y: 0 }
    },
    charmander: {
        name: "Charmander",
        type: "Fire",
        color: "#f08030",
        hp: 28,
        maxHp: 28,
        level: 5,
        attacks: [
            { name: "Scratch", damage: 4, type: "Normal" },
            { name: "Growl", damage: 0, type: "Status", effect: "attackDown" },
            { name: "Ember", damage: 7, type: "Fire" },
            { name: "Smokescreen", damage: 0, type: "Status", effect: "accuracyDown" }
        ],
        spriteColor: "#f08030",
        followingOffset: { x: 20, y: 0 }
    },
    squirtle: {
        name: "Squirtle",
        type: "Water",
        color: "#6890f0",
        hp: 32,
        maxHp: 32,
        level: 5,
        attacks: [
            { name: "Tackle", damage: 4, type: "Normal" },
            { name: "Tail Whip", damage: 0, type: "Status", effect: "defenseDown" },
            { name: "Water Gun", damage: 7, type: "Water" },
            { name: "Withdraw", damage: 0, type: "Status", effect: "defenseUp" }
        ],
        spriteColor: "#6890f0",
        followingOffset: { x: 0, y: -20 }
    },
    // Wild Pokémon
    pikachu: {
        name: "Pikachu",
        type: "Electric",
        color: "#ffd700",
        hp: 25,
        maxHp: 25,
        level: 4,
        attacks: [
            { name: "Thunder Shock", damage: 6, type: "Electric" },
            { name: "Quick Attack", damage: 4, type: "Normal" }
        ]
    },
    rattata: {
        name: "Rattata",
        type: "Normal",
        color: "#a8a878",
        hp: 22,
        maxHp: 22,
        level: 3,
        attacks: [
            { name: "Tackle", damage: 4, type: "Normal" },
            { name: "Quick Attack", damage: 4, type: "Normal" }
        ]
    },
    pidgey: {
        name: "Pidgey",
        type: "Normal/Flying",
        color: "#a890f0",
        hp: 24,
        maxHp: 24,
        level: 3,
        attacks: [
            { name: "Gust", damage: 5, type: "Flying" },
            { name: "Sand Attack", damage: 0, type: "Status", effect: "accuracyDown" }
        ]
    }
};

// Terrain details
const terrainDetails = [];
for(let i = 0; i < 50; i++) {
    terrainDetails.push({
        x: Math.random() * 1200 - 600,
        y: Math.random() * 1200 - 600,
        type: Math.random() > 0.5 ? 'flower' : 'bush',
        color: ['#ff6b9d', '#ffd166', '#06d6a0', '#118ab2'][Math.floor(Math.random() * 4)],
        size: Math.random() * 8 + 4
    });
}

// Buildings
const buildings = [
    { x: 300, y: 0, type: "house", width: 80, height: 60 },
    { x: -300, y: 0, type: "center", width: 100, height: 60 }
];

// Battle system
let enemyPokemon = null;
let potions = 3;
let pokeballs = 5;
let battleState = "menu"; // menu, attack, item

// Joystick
let joyX = 0, joyY = 0, drag = false;
const base = document.getElementById("joyBase");
const stick = document.getElementById("joy");

// Touch/Mouse events for joystick
base.addEventListener('mousedown', startDrag);
base.addEventListener('touchstart', startDrag);
window.addEventListener('mouseup', endDrag);
window.addEventListener('touchend', endDrag);
window.addEventListener('mousemove', handleMove);
window.addEventListener('touchmove', handleMove);

function startDrag(e) {
    e.preventDefault();
    drag = true;
    updateJoy(e);
}

function endDrag() {
    drag = false;
    joyX = joyY = 0;
    stick.style.transform = 'translate(0, 0)';
    player.animationFrame = 0;
}

function handleMove(e) {
    if (!drag) return;
    updateJoy(e);
}

function updateJoy(e) {
    const rect = base.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : e;
    
    let x = touch.clientX - rect.left - 50;
    let y = touch.clientY - rect.top - 50;
    
    const distance = Math.sqrt(x * x + y * y);
    const maxDistance = 50;
    
    if (distance > maxDistance) {
        x = (x / distance) * maxDistance;
        y = (y / distance) * maxDistance;
    }
    
    joyX = x / maxDistance;
    joyY = y / maxDistance;
    
    stick.style.transform = `translate(${x}px, ${y}px)`;
    
    // Update player direction
    if (Math.abs(joyX) > Math.abs(joyY)) {
        player.direction = joyX > 0 ? 2 : 1; // 2: right, 1: left
    } else {
        player.direction = joyY > 0 ? 0 : 3; // 0: down, 3: up
    }
}

// Dialog System
function showDialog(text, options = []) {
    inDialog = true;
    document.getElementById("dialogText").textContent = text;
    const optionsDiv = document.getElementById("dialogOptions");
    optionsDiv.innerHTML = '';
    
    if (options.length === 0) {
        const continueBtn = document.createElement("button");
        continueBtn.className = "dialog-option";
        continueBtn.textContent = "Continue";
        continueBtn.onclick = closeDialog;
        optionsDiv.appendChild(continueBtn);
    } else {
        options.forEach(option => {
            const btn = document.createElement("button");
            btn.className = "dialog-option";
            btn.textContent = option.text;
            btn.onclick = option.action;
            optionsDiv.appendChild(btn);
        });
    }
    
    document.getElementById("dialogBox").style.display = "block";
}

function closeDialog() {
    inDialog = false;
    document.getElementById("dialogBox").style.display = "none";
}

// Starter Selection
let selectedStarter = null;

function selectStarter(type) {
    selectedStarter = type;
    document.querySelectorAll('.starter-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelector(`[data-type="${type}"]`).classList.add('selected');
}

function confirmStarter() {
    if (!selectedStarter) {
        alert("Please select a starter Pokémon!");
        return;
    }
    
    playerPokemon = JSON.parse(JSON.stringify(pokemonData[selectedStarter]));
    starterChosen = true;
    document.getElementById("starterSelection").style.display = "none";
    
    showDialog(`Congratulations! You chose ${playerPokemon.name}! ${playerPokemon.name} will now follow you on your journey.`, [
        { text: "Begin!", action: () => {
            closeDialog();
            updateHUD();
            showDialog("Welcome to the world of Pokémon! Explore the world, catch wild Pokémon, and visit the Pokémon Center to heal your team. Good luck on your adventure!");
        }}
    ]);
}

// Initialize game with introduction
window.addEventListener('load', () => {
    setTimeout(() => {
        document.getElementById("starterSelection").style.display = "block";
    }, 1000);
});

// Battle functions
function startBattle() {
    const wildPokemon = Math.random();
    if (wildPokemon < 0.33) {
        enemyPokemon = JSON.parse(JSON.stringify(pokemonData.pikachu));
    } else if (wildPokemon < 0.66) {
        enemyPokemon = JSON.parse(JSON.stringify(pokemonData.rattata));
    } else {
        enemyPokemon = JSON.parse(JSON.stringify(pokemonData.pidgey));
    }
    
    inBattle = true;
    battleState = "menu";
    
    document.getElementById("battle").style.display = "block";
    document.getElementById("enemyName").textContent = "Wild " + enemyPokemon.name;
    document.getElementById("enemyName").style.color = enemyPokemon.color;
    document.getElementById("playerPokemonName").textContent = playerPokemon.name;
    document.getElementById("playerPokemonName").style.color = playerPokemon.color;
    
    updateBattleText();
    createBattleSprites();
    
    setTimeout(() => {
        document.getElementById("battleMenu").style.display = "grid";
        document.getElementById("attackMenu").style.display = "none";
        addBattleLog(`A wild ${enemyPokemon.name} appeared!`);
    }, 1000);
}

function updateBattleText() {
    const enemyPercent = Math.max(0, (enemyPokemon.hp / enemyPokemon.maxHp) * 100);
    const playerPercent = Math.max(0, (playerPokemon.hp / playerPokemon.maxHp) * 100);
    
    document.getElementById("enemyHPFill").style.width = enemyPercent + "%";
    document.getElementById("playerHPFill").style.width = playerPercent + "%";
    
    document.getElementById("enemyHPText").textContent = `HP: ${Math.max(0, enemyPokemon.hp)}/${enemyPokemon.maxHp}`;
    document.getElementById("playerHPText").textContent = `HP: ${Math.max(0, playerPokemon.hp)}/${playerPokemon.maxHp}`;
}

function createBattleSprites() {
    const enemySprite = document.getElementById("enemySprite");
    const playerSprite = document.getElementById("playerSprite");
    
    enemySprite.innerHTML = '';
    playerSprite.innerHTML = '';
    
    // Create enemy sprite
    const enemyCanvas = document.createElement('canvas');
    enemyCanvas.width = 100;
    enemyCanvas.height = 100;
    const enemyCtx = enemyCanvas.getContext('2d');
    drawPokemonSprite(enemyCtx, 50, 50, enemyPokemon, 1.5);
    enemySprite.appendChild(enemyCanvas);
    
    // Create player sprite
    const playerCanvas = document.createElement('canvas');
    playerCanvas.width = 100;
    playerCanvas.height = 100;
    const playerCtx = playerCanvas.getContext('2d');
    drawPokemonSprite(playerCtx, 50, 50, playerPokemon, 1.5);
    playerSprite.appendChild(playerCanvas);
}

function drawPokemonSprite(ctx, x, y, pokemon, scale = 1) {
    ctx.save();
    ctx.translate(x, y);
    ctx.scale(scale, scale);
    
    switch(pokemon.name) {
        case "Bulbasaur":
            ctx.fillStyle = pokemon.spriteColor;
            ctx.beginPath();
            ctx.arc(0, 0, 15, 0, Math.PI * 2);
            ctx.fill();
            
            // Bulb
            ctx.fillStyle = "#a8e6a8";
            ctx.beginPath();
            ctx.arc(0, -12, 8, 0, Math.PI * 2);
            ctx.fill();
            
            // Eyes
            ctx.fillStyle = "#000";
            ctx.fillRect(-6, -3, 3, 5);
            ctx.fillRect(3, -3, 3, 5);
            break;
            
        case "Charmander":
            ctx.fillStyle = pokemon.spriteColor;
            ctx.beginPath();
            ctx.arc(0, 0, 15, 0, Math.PI * 2);
            ctx.fill();
            
            // Flame
            ctx.fillStyle = "#ff4444";
            ctx.beginPath();
            ctx.arc(15, -5, 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Eyes
            ctx.fillStyle = "#000";
            ctx.fillRect(-6, -3, 3, 5);
            ctx.fillRect(3, -3, 3, 5);
            break;
            
        case "Squirtle":
            ctx.fillStyle = pokemon.spriteColor;
            ctx.beginPath();
            ctx.arc(0, 0, 15, 0, Math.PI * 2);
            ctx.fill();
            
            // Shell
            ctx.fillStyle = "#a0522d";
            ctx.beginPath();
            ctx.arc(0, 0, 12, 0, Math.PI * 2);
            ctx.fill();
            
            // Eyes
            ctx.fillStyle = "#000";
            ctx.fillRect(-6, -3, 3, 5);
            ctx.fillRect(3, -3, 3, 5);
            break;
            
        case "Pikachu":
            ctx.fillStyle = "#ffd700";
            ctx.beginPath();
            ctx.arc(0, 0, 15, 0, Math.PI * 2);
            ctx.fill();
            
            // Cheeks
            ctx.fillStyle = "#ff6b9d";
            ctx.beginPath();
            ctx.arc(-12, 0, 6, 0, Math.PI * 2);
            ctx.arc(12, 0, 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Eyes
            ctx.fillStyle = "#000";
            ctx.fillRect(-6, -3, 3, 5);
            ctx.fillRect(3, -3, 3, 5);
            break;
    }
    
    ctx.restore();
}

function addBattleLog(message) {
    document.getElementById("battleLog").textContent = message;
}

function showAttackMenu() {
    battleState = "attack";
    document.getElementById("battleMenu").style.display = "none";
    document.getElementById("attackMenu").style.display = "grid";
    
    // Update attack buttons
    const attackButtons = document.querySelectorAll('.attack-btn');
    attackButtons.forEach((btn, index) => {
        if (playerPokemon.attacks[index]) {
            btn.textContent = playerPokemon.attacks[index].name;
            btn.style.display = "block";
        } else {
            btn.style.display = "none";
        }
    });
}

function showBattleMenu() {
    battleState = "menu";
    document.getElementById("battleMenu").style.display = "grid";
    document.getElementById("attackMenu").style.display = "none";
}

function useAttack(index) {
    if (!playerPokemon.attacks[index]) return;
    
    const attack = playerPokemon.attacks[index];
    let damage = attack.damage;
    
    // Add some randomness
    damage += Math.floor(Math.random() * 3) - 1;
    if (damage < 0) damage = 0;
    
    enemyPokemon.hp -= damage;
    
    // Visual effects
    document.getElementById("enemySprite").classList.add('shake');
    document.getElementById("enemyHPFill").classList.add('flash');
    
    addBattleLog(`${playerPokemon.name} used ${attack.name}!`);
    if (damage > 0) {
        addBattleLog(`It did ${damage} damage!`);
    }
    
    updateBattleText();
    
    setTimeout(() => {
        document.getElementById("enemySprite").classList.remove('shake');
        document.getElementById("enemyHPFill").classList.remove('flash');
        
        if (enemyPokemon.hp <= 0) {
            addBattleLog(`Wild ${enemyPokemon.name} fainted!`);
            setTimeout(() => endBattle(true), 1500);
            return;
        }
        
        setTimeout(() => enemyAttack(), 800);
    }, 500);
}

function enemyAttack() {
    const attackIndex = Math.floor(Math.random() * enemyPokemon.attacks.length);
    const attack = enemyPokemon.attacks[attackIndex];
    let damage = attack.damage;
    
    // Add some randomness
    damage += Math.floor(Math.random() * 3) - 1;
    if (damage < 0) damage = 0;
    
    playerPokemon.hp -= damage;
    
    document.getElementById("playerSprite").classList.add('shake');
    document.getElementById("playerHPFill").classList.add('flash');
    
    addBattleLog(`Wild ${enemyPokemon.name} used ${attack.name}!`);
    if (damage > 0) {
        addBattleLog(`It did ${damage} damage!`);
    }
    
    updateBattleText();
    updateHUD();
    
    setTimeout(() => {
        document.getElementById("playerSprite").classList.remove('shake');
        document.getElementById("playerHPFill").classList.remove('flash');
        
        if (playerPokemon.hp <= 0) {
            addBattleLog(`${playerPokemon.name} fainted!`);
            setTimeout(() => endBattle(false), 1500);
        } else {
            showBattleMenu();
        }
    }, 500);
}

function usePotion() {
    if (potions > 0) {
        potions--;
        const heal = 20;
        playerPokemon.hp = Math.min(playerPokemon.hp + heal, playerPokemon.maxHp);
        addBattleLog(`You used a Potion! ${playerPokemon.name} recovered ${heal} HP!`);
        updateBattleText();
        updateHUD();
        
        setTimeout(() => enemyAttack(), 1000);
    } else {
        addBattleLog("No potions left!");
    }
}

function usePokeball() {
    if (pokeballs > 0) {
        pokeballs--;
        addBattleLog(`You threw a Pokéball!`);
        updateHUD();
        
        const catchChance = (enemyPokemon.hp / enemyPokemon.maxHp) * 0.5 + 0.3;
        if (Math.random() < catchChance) {
            addBattleLog(`Gotcha! ${enemyPokemon.name} was caught!`);
            setTimeout(() => endBattle(true), 2000);
        } else {
            addBattleLog(`Oh no! ${enemyPokemon.name} broke free!`);
            setTimeout(() => enemyAttack(), 1000);
        }
    } else {
        addBattleLog("No Pokéballs left!");
    }
}

function run() {
    const runChance = 0.7;
    if (Math.random() < runChance) {
        addBattleLog("Got away safely!");
        setTimeout(() => endBattle(false), 1000);
    } else {
        addBattleLog("Couldn't escape!");
        setTimeout(() => enemyAttack(), 800);
    }
}

function endBattle(victory) {
    inBattle = false;
    document.getElementById("battle").style.display = "none";
    document.getElementById("battleMenu").style.display = "none";
    document.getElementById("attackMenu").style.display = "none";
    
    if (!victory && playerPokemon.hp <= 0) {
        // Player's Pokémon fainted
        showDialog(`Your ${playerPokemon.name} fainted! You blacked out and woke up at the Pokémon Center.`, [
            { text: "OK", action: () => {
                closeDialog();
                // Reset position and heal
                player.x = buildings[1].x;
                player.y = buildings[1].y + 100;
                playerPokemon.hp = playerPokemon.maxHp;
                updateHUD();
            }}
        ]);
    }
}

function updateHUD() {
    if (!playerPokemon) return;
    
    document.getElementById("hud").innerHTML = 
        `${playerPokemon.name} Lv.${playerPokemon.level}<br>` +
        `HP: ${playerPokemon.hp}/${playerPokemon.maxHp}<br>` +
        `Potions: ${potions}<br>` +
        `Pokéballs: ${pokeballs}`;
}

// Drawing functions
function drawPlayer() {
    ctx.save();
    ctx.translate(canvas.width / 2, canvas.height / 2);
    
    // Player character (trainer)
    ctx.fillStyle = '#ff4444'; // Red hat
    ctx.fillRect(-8, -20, 16, 8);
    
    ctx.fillStyle = '#2c8bff'; // Blue shirt
    ctx.fillRect(-10, -12, 20, 16);
    
    ctx.fillStyle = '#000'; // Pants
    ctx.fillRect(-10, 4, 20, 8);
    
    // Face
    ctx.fillStyle = '#ffcc99';
    ctx.beginPath();
    ctx.arc(0, -15, 6, 0, Math.PI * 2);
    ctx.fill();
    
    // Legs with walking animation
    let legOffset = 0;
    if ((joyX !== 0 || joyY !== 0) && !inBattle) {
        player.animationFrame = (player.animationFrame + 0.2) % 8;
        legOffset = Math.sin(player.animationFrame) * 3;
    }
    
    ctx.fillStyle = '#000';
    ctx.fillRect(-6, 12, 4, 8 + legOffset);
    ctx.fillRect(2, 12, 4, 8 - legOffset);
    
    ctx.restore();
}

function drawFollowingPokemon() {
    if (!playerPokemon || !starterChosen) return;
    
    ctx.save();
    // Position Pokémon slightly offset from player
    const offsetX = player.direction === 1 ? -30 : player.direction === 2 ? 30 : 0;
    const offsetY = player.direction === 0 ? 20 : player.direction === 3 ? -20 : 0;
    
    const pokemonX = canvas.width / 2 + offsetX;
    const pokemonY = canvas.height / 2 + offsetY + Math.sin(gameTime * 0.1) * 2; // Gentle bobbing
    
    drawPokemonSprite(ctx, pokemonX, pokemonY, playerPokemon, 0.8);
    ctx.restore();
}

function drawGrass() {
    const startX = Math.floor(cam.x / TILE);
    const endX = Math.ceil((cam.x + canvas.width) / TILE);
    const startY = Math.floor(cam.y / TILE);
    const endY = Math.ceil((cam.y + canvas.height) / TILE);
    
    for (let x = startX; x <= endX; x++) {
        for (let y = startY; y <= endY; y++) {
            const colorIndex = (x + y) % GRASS_COLORS.length;
            ctx.fillStyle = GRASS_COLORS[colorIndex];
            ctx.fillRect(x * TILE - cam.x, y * TILE - cam.y, TILE, TILE);
            
            // Grass details
            if ((x + y) % 3 === 0) {
                ctx.fillStyle = '#3a7d34';
                ctx.fillRect(x * TILE - cam.x + 10, y * TILE - cam.y + 10, 3, 12);
                ctx.fillRect(x * TILE - cam.x + 20, y * TILE - cam.y + 15, 3, 8);
            }
        }
    }
}

function drawDetails() {
    terrainDetails.forEach(detail => {
        const dx = detail.x - cam.x;
        const dy = detail.y - cam.y;
        
        if (dx > -50 && dx < canvas.width + 50 && dy > -50 && dy < canvas.height + 50) {
            if (detail.type === 'flower') {
                // Stem
                ctx.fillStyle = '#2d5a27';
                ctx.fillRect(dx - 1, dy, 2, detail.size);
                
                // Flower
                ctx.fillStyle = detail.color;
                ctx.beginPath();
                ctx.arc(dx, dy - 5, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // Petals
                for (let i = 0; i < 5; i++) {
                    const angle = (i / 5) * Math.PI * 2;
                    const px = dx + Math.cos(angle) * 8;
                    const py = dy - 5 + Math.sin(angle) * 8;
                    ctx.beginPath();
                    ctx.arc(px, py, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else {
                // Bush
                ctx.fillStyle = detail.color;
                ctx.beginPath();
                ctx.arc(dx, dy, detail.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }
    });
}

function drawBuilding(building) {
    const dx = building.x - cam.x;
    const dy = building.y - cam.y;
    
    if (building.type === "house") {
        // Main structure
        ctx.fillStyle = '#a0522d';
        ctx.fillRect(dx - building.width/2, dy - building.height, building.width, building.height);
        
        // Roof
        ctx.fillStyle = '#8b4513';
        ctx.beginPath();
        ctx.moveTo(dx - building.width/2 - 10, dy - building.height);
        ctx.lineTo(dx, dy - building.height - 20);
        ctx.lineTo(dx + building.width/2 + 10, dy - building.height);
        ctx.closePath();
        ctx.fill();
        
        // Door
        ctx.fillStyle = '#654321';
        ctx.fillRect(dx - 8, dy - 20, 16, 20);
        
        // Windows
        ctx.fillStyle = '#87CEEB';
        ctx.fillRect(dx - 25, dy - 40, 12, 12);
        ctx.fillRect(dx + 13, dy - 40, 12, 12);
        
    } else if (building.type === "center") {
        // Main structure
        ctx.fillStyle = '#ff9999';
        ctx.fillRect(dx - building.width/2, dy - building.height, building.width, building.height);
        
        // Roof
        ctx.fillStyle = '#ff6b6b';
        ctx.fillRect(dx - building.width/2 - 5, dy - building.height - 10, building.width + 10, 10);
        
        // Windows
        ctx.fillStyle = '#87CEEB';
        for (let i = 0; i < 3; i++) {
            ctx.fillRect(dx - 35 + i * 25, dy - 40, 15, 15);
        }
        
        // Door
        ctx.fillStyle = '#8b4513';
        ctx.fillRect(dx - 15, dy - 25, 30, 25);
        
        // Sign
        ctx.fillStyle = '#fff';
        ctx.fillRect(dx - 40, dy - building.height - 30, 80, 20);
        ctx.fillStyle = '#ff4444';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('POKé CENTER', dx, dy - building.height - 16);
    }
}

// Game loop functions
function update() {
    if (inBattle || inDialog || !starterChosen) return;
    
    gameTime++;
    
    // Move player
    player.x += joyX * player.speed;
    player.y += joyY * player.speed;
    
    // Boundaries
    const BOUNDARY = 500;
    player.x = Math.max(-BOUNDARY, Math.min(BOUNDARY, player.x));
    player.y = Math.max(-BOUNDARY, Math.min(BOUNDARY, player.y));
    
    // Check building entry
    if (world === "outside") {
        buildings.forEach(building => {
            const dx = player.x - building.x;
            const dy = player.y - building.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < 50) {
                if (building.type === "house") {
                    world = "house";
                    player.x = 0;
                    player.y = 40;
                    showDialog("Welcome to the house! Rest here to heal your Pokémon.");
                } else if (building.type === "center") {
                    world = "center";
                    player.x = 0;
                    player.y = 40;
                    // Heal at center
                    playerPokemon.hp = playerPokemon.maxHp;
                    updateHUD();
                    showDialog("Welcome to the Pokémon Center! Your Pokémon have been healed!");
                }
            }
        });
    }
    
    // Check building exit
    if ((world === "house" || world === "center") && player.y > 100) {
        world = "outside";
        const buildingIndex = world === "house" ? 0 : 1;
        player.x = buildings[buildingIndex].x;
        player.y = buildings[buildingIndex].y + 80;
    }
    
    // Random battle
    if (world === "outside" && Math.random() < 0.003 && joyX !== 0 && joyY !== 0) {
        startBattle();
    }
    
    // Smooth camera
    cam.x += (player.x - canvas.width/2 - cam.x) * 0.1;
    cam.y += (player.y - canvas.height/2 - cam.y) * 0.1;
}

function draw() {
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (!inBattle && starterChosen) {
        if (world === "outside") {
            // Sky
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Clouds
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            for (let i = 0; i < 3; i++) {
                const cloudX = (cam.x * 0.2 + i * 200) % (canvas.width + 400) - 200;
                const cloudY = 50 + Math.sin(gameTime * 0.001 + i) * 20;
                ctx.beginPath();
                ctx.arc(cloudX, cloudY, 20, 0, Math.PI * 2);
                ctx.arc(cloudX + 25, cloudY - 10, 25, 0, Math.PI * 2);
                ctx.arc(cloudX + 55, cloudY, 20, 0, Math.PI * 2);
                ctx.fill();
            }
            
            drawGrass();
            drawDetails();
            buildings.forEach(drawBuilding);
            
            // Paths to buildings
            ctx.fillStyle = '#8b7355';
            ctx.fillRect(canvas.width/2 - 150, canvas.height/2, 300, 20);
            ctx.fillRect(canvas.width/2 - 10, canvas.height/2 - 150, 20, 300);
            
        } else if (world === "house") {
            // House interior
            ctx.fillStyle = '#d2b48c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Wood floor
            for (let x = 0; x < canvas.width; x += 40) {
                for (let y = 0; y < canvas.height; y += 40) {
                    ctx.fillStyle = (x + y) % 80 === 0 ? '#8b7355' : '#a0522d';
                    ctx.fillRect(x, y, 40, 40);
                }
            }
            
            // Furniture
            ctx.fillStyle = '#8b4513';
            ctx.fillRect(canvas.width/2 - 100, canvas.height/2 - 50, 200, 20); // Table
            ctx.fillRect(canvas.width/2 - 120, canvas.height/2 - 30, 40, 30); // Chair
            ctx.fillRect(canvas.width/2 + 80, canvas.height/2 - 30, 40, 30); // Chair
            ctx.fillRect(canvas.width/2 - 40, canvas.height/2 + 40, 80, 40); // Bed
            
            // Exit
            ctx.fillStyle = '#333';
            ctx.fillRect(canvas.width/2 - 30, canvas.height - 50, 60, 30);
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('EXIT', canvas.width/2, canvas.height - 30);
            
        } else if (world === "center") {
            // Center interior
            ctx.fillStyle = '#f8f8f8';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Tile floor
            for (let x = 0; x < canvas.width; x += 40) {
                for (let y = 0; y < canvas.height; y += 40) {
                    ctx.fillStyle = (x + y) % 80 === 0 ? '#d0d0d0' : '#e8e8e8';
                    ctx.fillRect(x, y, 40, 40);
                }
            }
            
            // Counter
            ctx.fillStyle = '#8b4513';
            ctx.fillRect(canvas.width/2 - 120, canvas.height/2 - 30, 240, 20);
            
            // Healing machine
            ctx.fillStyle = '#4a8bca';
            ctx.fillRect(canvas.width/2 - 40, canvas.height/2 - 80, 80, 60);
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(canvas.width/2 - 20, canvas.height/2 - 60, 40, 20);
            
            // Exit
            ctx.fillStyle = '#333';
            ctx.fillRect(canvas.width/2 - 30, canvas.height - 50, 60, 30);
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('EXIT', canvas.width/2, canvas.height - 30);
        }
        
        drawPlayer();
        drawFollowingPokemon();
    }
}

function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

// Start the game
gameLoop();
</script>
</body>
</html>
