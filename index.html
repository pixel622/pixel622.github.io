
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Pokémon Nova Genesis</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #000;
      font-family: 'Press Start 2P', monospace;
      overflow: hidden;
      touch-action: none;
      color: white;
    }
    #gameContainer {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle, #001122 0%, #000 100%);
    }
    #gameCanvas {
      width: 80vmin;
      height: calc(80vmin * 160 / 240);
      max-width: 480px;
      max-height: 320px;
      border: 4px solid #333;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
      background: #000;
    }
    #ui {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    #dialogueBox {
      position: absolute;
      bottom: 8px;
      left: 8px;
      right: 8px;
      height: 48px;
      background: #fff;
      border: 2px solid #0040c0;
      color: #000;
      padding: 4px 8px;
      font-size: 10px;
      line-height: 1.2;
      display: flex;
      align-items: center;
      pointer-events: auto;
    }
    #dialogueText { flex: 1; }
    #advanceIcon { width: 24px; height: 24px; background: #0040c0; color: #fff; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; margin-left: 4px; }
    #nameOverlay, #confirmOverlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      pointer-events: auto;
    }
    #nameDisplay { font-size: 16px; margin: 20px 0; }
    #virtualKeyboard {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 2px;
      max-width: 240px;
      font-size: 12px;
    }
    .keyBtn {
      aspect-ratio: 1;
      background: #666;
      border: 2px solid #fff;
      color: #fff;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }
    .keyBtn:active { background: #fff; color: #000; }
    .wideKey { grid-column: span 2; }
    #confirmOverlay button {
      margin: 10px;
      padding: 10px 20px;
      font-family: inherit;
      font-size: 12px;
      background: #0040c0;
      color: #fff;
      border: 2px solid #fff;
      cursor: pointer;
    }
    #controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40vh;
      display: none;
      pointer-events: none;
      opacity: 0.9;
    }
    .dpadContainer {
      position: absolute;
      left: 5%;
      bottom: 10%;
      width: 25vw;
      height: 25vw;
      max-width: 120px;
      max-height: 120px;
    }
    .dpadBtn {
      position: absolute;
      width: 30%;
      height: 30%;
      background: rgba(255,255,255,0.3);
      border: 3px solid #fff;
      color: #000;
      font-weight: bold;
      font-size: min(5vw, 24px);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
    }
    #dpadUp { top: 0; left: 35%; }
    #dpadDown { bottom: 0; left: 35%; }
    #dpadLeft { left: 0; top: 35%; }
    #dpadRight { right: 0; top: 35%; }
    .actionBtns {
      position: absolute;
      right: 5%;
      bottom: 15%;
      display: flex;
      flex-direction: column;
      gap: 15%;
    }
    .actionBtn {
      width: 20vw;
      height: 20vw;
      max-width: 80px;
      max-height: 80px;
      border-radius: 50%;
      border: 4px solid #fff;
      font-size: min(8vw, 36px);
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
    }
    #aBtn { background: rgba(0,200,0,0.8); color: #fff; }
    #bBtn { background: rgba(200,0,0,0.8); color: #fff; }
    #menuBtn {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: rgba(0,100,255,0.8);
      border: 3px solid #fff;
      border-radius: 50%;
      color: #fff;
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
    }
    #menuOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,100,0.95);
      color: #fff;
      padding: 40px;
      display: none;
      flex-direction: column;
      pointer-events: auto;
      font-size: 12px;
      z-index: 100;
    }
    .menuItem {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #444;
    }
    .menuItem:active { background: #fff; color: #000; }
    #closeMenu { margin-top: auto; }
    #fullscreenBtn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #333;
      color: #fff;
      border: none;
      padding: 10px;
      cursor: pointer;
      font-family: inherit;
      font-size: 10px;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="ui">
      <div id="dialogueBox" class="hidden">
        <span id="dialogueText"></span>
        <div id="advanceIcon">▶</div>
      </div>
    </div>
  </div>

  <div id="nameOverlay">
    <div id="nameDisplay">NOVA</div>
    <div id="virtualKeyboard"></div>
  </div>

  <div id="confirmOverlay">
    <div id="confirmText">You chose CHARMANDER! Are you sure?</div>
    <button id="yesBtn">Yes</button>
    <button id="noBtn">No</button>
  </div>

  <div id="controls">
    <div class="dpadContainer">
      <div class="dpadBtn" id="dpadUp">↑</div>
      <div class="dpadBtn" id="dpadDown">↓</div>
      <div class="dpadBtn" id="dpadLeft">←</div>
      <div class="dpadBtn" id="dpadRight">→</div>
    </div>
    <div class="actionBtns">
      <div class="actionBtn" id="bBtn">B</div>
      <div class="actionBtn" id="aBtn">A</div>
    </div>
  </div>

  <div id="menuBtn">MENU</div>

  <div id="menuOverlay">
    <div class="menuItem">POKÉMON</div>
    <div class="menuItem">Your starter</div>
    <div class="menuItem">BAG</div>
    <div class="menuItem" id="bagItem">Potion x1</div>
    <div class="menuItem">SAVE</div>
    <div class="menuItem" id="saveItem">Save</div>
    <div class="menuItem" id="closeMenu">CLOSE</div>
  </div>

  <button id="fullscreenBtn">FULLSCREEN</button>

  <script>
    // GBA Constants
    const GBA_WIDTH = 240;
    const GBA_HEIGHT = 160;
    const TILE_SIZE = 16;
    const SCALE = 1; // Internal scale

    // Canvas setup
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;

    // Resize
    function resizeCanvas() {
      const container = document.getElementById('gameContainer');
      const size = Math.min(container.clientWidth * 0.9, container.clientHeight * 0.9 * GBA_WIDTH / GBA_HEIGHT, 480);
      canvas.width = GBA_WIDTH;
      canvas.height = GBA_HEIGHT;
      canvas.style.width = size + 'px';
      canvas.style.height = (size * GBA_HEIGHT / GBA_WIDTH) + 'px';
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Game State
    let state = 'title'; // title, professor, naming, choosing, home, playing
    let playerName = 'NOVA';
    let chosenPokemon = null;
    let playerPos = { x: 7, y: 7, dir: 2, animFrame: 0 }; // tile pos, dir 0up 1left 2down 3right
    let followerPos = { x: 7, y: 8 };
    let camera = { x: 0, y: 0 };
    let currentMap = 'bedroom';
    let dialogQueue = [];
    let currentDialog = '';
    let dialogPos = 0;
    let typingSpeed = 2; // chars per frame
    let inputBuffer = { up: false, down: false, left: false, right: false, a: false, b: false };
    let potionCount = 1;
    let talkedToMom = false;

    // Maps (expanded to match images)
    const maps = {
      bedroom: [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,12,12,0,0,0,0,0,0,0,1], // bed
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,13,13,13,0,0,0,0,0,0,1], // desk pc
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,2,2,2,0,0,0,0,1], // stairs
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
      ],
      kitchen: [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,14,14,0,0,0,0,15,15,15,15,0,0,0,1], // window
        [1,4,4,5,5,5,0,0,0,0,0,0,16,16,1], // fridge, stove/sink, cabinet
        [1,4,4,5,5,5,0,0,0,0,0,0,16,16,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,17,0,0,0,0,1], // mom
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,2,2,0,0,0,0,0,0,0,0,0,0,2,1], // doors
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
      ],
      town: [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,7,7,7,18,18,18,18,7,7,7,0,0,0,1], // grass, pc
        [1,7,7,7,18,18,18,18,7,7,7,0,0,0,1],
        [1,7,7,7,19,19,19,19,7,7,7,2,2,0,1], // pc door
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,20,20,0,0,0,0,0,0,0,0,0,0,0,1], // house
        [1,20,20,21,0,0,0,0,0,0,0,0,22,22,1], // house door, mart
        [1,0,0,0,0,0,0,0,0,0,0,0,22,22,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,23,23,1], // mart door?
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
      ]
    };

    // Tile colors to match images
    const tilePalette = {
      0: '#ff99cc', // pink floor
      1: '#ccbbaa', // wall brown
      2: '#aa8800', // door brown
      4: '#888888', // fridge gray
      5: '#aa7744', // stove/counter brown
      12: '#ffcc99', // bed orange
      13: '#ddccbb', // desk wood
      14: '#88aacc', // window blue
      15: '#aaccdd', // wall white-ish
      16: '#44aa44', // cabinet green
      17: '#ff88cc', // mom pink
      7: '#88cc88', // grass
      18: '#ffffff', // pc white
      19: '#cc0000', // pc red roof
      20: '#cccccc', // house gray
      21: '#aa0000', // house red door
      22: '#4444ff', // mart blue
      23: '#0000aa' // mart door
    };

    // Audio
    let audioCtx;
    function initAudio() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    function playBeep(freq = 440, duration = 0.1, type = 'square') {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.type = type;
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
      osc.start(audioCtx.currentTime);
      osc.stop(audioCtx.currentTime + duration);
    }
    function playPokemonCry(poke) {
      const freqs = { charmander: 660, treecko: 800, froakie: 520 };
      playBeep(freqs[poke] || 440, 0.3, 'sawtooth');
    }

    // Draw functions
    function drawTile(x, y, type) {
      const screenX = x * TILE_SIZE + camera.x;
      const screenY = y * TILE_SIZE + camera.y;
      if (screenX + TILE_SIZE < 0 || screenX > GBA_WIDTH || screenY + TILE_SIZE < 0 || screenY > GBA_HEIGHT) return;
      ctx.fillStyle = tilePalette[type] || '#000';
      ctx.fillRect(screenX, screenY, TILE_SIZE, TILE_SIZE);
    }
    function drawMap(mapName) {
      const mapData = maps[mapName];
      for (let y = 0; y < mapData.length; y++) {
        for (let x = 0; x < mapData[y].length; x++) {
          drawTile(x, y, mapData[y][x]);
        }
      }
    }
    function drawPlayer(x, y, dir, frame) {
      const px = x * TILE_SIZE + camera.x;
      const py = y * TILE_SIZE + camera.y;
      // GBA style player sprite 12x16 approx
      // Head
      ctx.fillStyle = '#f8d8a8';
      ctx.fillRect(px + 2, py, 12, 8);
      ctx.fillStyle = '#e0b890';
      ctx.fillRect(px + 4, py + 2, 8, 4);
      // Eyes
      ctx.fillStyle = '#000';
      ctx.fillRect(px + 5, py + 3, 1, 1);
      ctx.fillRect(px + 9, py + 3, 1, 1);
      // Body
      ctx.fillStyle = '#4080ff';
      ctx.fillRect(px + 1, py + 8, 14, 12);
      // Shorts
      ctx.fillStyle = '#ff6600';
      ctx.fillRect(px + 3, py + 16, 10, 6);
      // Arms
      ctx.fillStyle = '#f8d8a8';
      if (dir === 0 || dir === 2) {
        ctx.fillRect(px + 1, py + 10, 4, 6);
        ctx.fillRect(px + 13, py + 10, 4, 6);
      }
      // Legs walk anim
      const legOffset = frame ? 1 : 0;
      ctx.fillStyle = '#aa4400';
      ctx.fillRect(px + 4 + legOffset, py + 20, 3, 6);
      ctx.fillRect(px + 9 - legOffset, py + 20, 3, 6);
      // Hat
      ctx.fillStyle = '#ff0000';
      ctx.fillRect(px + 3, py - 2, 10, 4);
    }
    function drawFollower(x, y, poke) {
      const px = x * TILE_SIZE + camera.x + 2;
      const py = y * TILE_SIZE + camera.y + 2;
      if (poke === 'charmander') {
        ctx.fillStyle = '#ff6600';
        ctx.fillRect(px, py + 4, 12, 8);
        ctx.fillStyle = '#ff4400';
        ctx.fillRect(px + 2, py + 6, 8, 4);
        ctx.fillStyle = '#ffaa00';
        ctx.fillRect(px + 10, py + 2, 4, 4); // tail flame
      } else if (poke === 'treecko') {
        ctx.fillStyle = '#00aa44';
        ctx.fillRect(px, py + 4, 12, 8);
        ctx.fillStyle = '#008822';
        ctx.fillRect(px + 2, py + 6, 8, 4);
        ctx.fillStyle = '#44ff88';
        ctx.fillRect(px + 4, py, 4, 6); // tail
      } else if (poke === 'froakie') {
        ctx.fillStyle = '#4488cc';
        ctx.fillRect(px, py + 4, 12, 8);
        ctx.fillStyle = '#2266aa';
        ctx.fillRect(px + 2, py + 6, 8, 4);
        ctx.fillStyle = '#66aaff';
        ctx.fillRect(px, py, 4, 6); // bubble
      }
    }
    function drawMom(x, y) {
      const px = x * TILE_SIZE + camera.x;
      const py = y * TILE_SIZE + camera.y;
      // Simple mom
      ctx.fillStyle = '#ff88cc';
      ctx.fillRect(px + 2, py + 4, 12, 12); // dress
      drawPlayer(x, y, 2, 0); // base player head/body
    }
    function drawLab() {
      // Lab background
      ctx.fillStyle = '#c8e8ff';
      ctx.fillRect(0, 0, GBA_WIDTH, GBA_HEIGHT);
      // Floor
      ctx.fillStyle = '#a8c8e8';
      ctx.fillRect(0, 100, GBA_WIDTH, 60);
      // Professor
      drawPlayer(7, 3, 2, 0); // placeholder
      ctx.fillStyle = '#888';
      ctx.fillRect(100, 40, 40, 60); // lab coat
      // Platforms for pokemon
      ctx.fillStyle = '#a88060';
      ctx.fillRect(20, 110, 60, 12);
      ctx.fillRect(80, 110, 60, 12);
      ctx.fillRect(140, 110, 60, 12);
      if (state === 'choosing') {
        drawFollower(2.5, 6.5, 'charmander');
        drawFollower(6, 6.5, 'treecko');
        drawFollower(9.5, 6.5, 'froakie');
        // Names
        ctx.fillStyle = '#000';
        ctx.font = '8px "Press Start 2P"';
        ctx.textAlign = 'center';
        ctx.fillText('CHARMANDER', 50, 155);
        ctx.fillText('TREECKO', 110, 155);
        ctx.fillText('FROAKIE', 170, 155);
      }
    }

    // Camera
    function updateCamera() {
      camera.x = Math.floor(-playerPos.x * TILE_SIZE + GBA_WIDTH / 2 - TILE_SIZE / 2);
      camera.y = Math.floor(-playerPos.y * TILE_SIZE + GBA_HEIGHT / 2);
      camera.x = Math.max(-(maps[currentMap][0].length - 15) * TILE_SIZE, Math.min(0, camera.x));
      camera.y = Math.max(-(maps[currentMap].length - 10) * TILE_SIZE, Math.min(0, camera.y));
    }

    // Render loop
    let frameCount = 0;
    function render() {
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, GBA_WIDTH, GBA_HEIGHT);

      if (state === 'title') {
        // Stars
        ctx.fillStyle = '#fff';
        for (let i = 0; i < 60; i++) {
          const x = (frameCount * 0.5 + i * 4) % GBA_WIDTH;
          const y = (i * 2.7) % GBA_HEIGHT;
          ctx.fillRect(x, y, 1, 1);
        }
        // Title
        ctx.fillStyle = '#ffeb3b';
        ctx.font = 'bold 20px "Press Start 2P"';
        ctx.textAlign = 'center';
        ctx.fillText('POKÉMON', 120, 70);
        ctx.fillStyle = '#ff4444';
        ctx.font = 'bold 16px "Press Start 2P"';
        ctx.fillText('NOVA', 90, 100);
        ctx.fillStyle = '#44ff44';
        ctx.fillText('GENESIS', 150, 100);
        ctx.fillStyle = '#fff';
        ctx.font = '12px "Press Start 2P"';
        ctx.fillText('Tap START', 120, 140);
      } else if (state === 'professor' || state === 'choosing') {
        drawLab();
      } else {
        drawMap(currentMap);
        drawPlayer(playerPos.x, playerPos.y, playerPos.dir, playerPos.animFrame);
        if (chosenPokemon) drawFollower(followerPos.x, followerPos.y, chosenPokemon);
        // Mom
        if (currentMap === 'kitchen' && !talkedToMom) {
          drawMom(9, 5);
        }
      }

      // Dialog
      if (currentDialog) {
        document.getElementById('dialogueBox').classList.remove('hidden');
        document.getElementById('dialogueText').textContent = currentDialog.slice(0, dialogPos);
      } else {
        document.getElementById('dialogueBox').classList.add('hidden');
      }
    }

    // Dialog system
    function queueDialog(lines) {
      dialogQueue = dialogQueue.concat(lines.map(l => l.replace('{name}', playerName)));
      if (currentDialog === '') nextDialogLine();
    }
    function nextDialogLine() {
      if (dialogQueue.length === 0) {
        currentDialog = '';
        dialogPos = 0;
        if (state === 'professor') {
          showNameInput();
        }
        return;
      }
      currentDialog = dialogQueue.shift();
      dialogPos = 0;
    }
    function advanceDialog() {
      if (dialogPos < currentDialog.length) {
        dialogPos = currentDialog.length; // skip typing
      } else {
        nextDialogLine();
      }
    }

    // Name input
    function showNameInput() {
      state = 'naming';
      playerName = '';
      updateNameDisplay();
      document.getElementById('nameOverlay').style.display = 'flex';
      createVirtualKeyboard();
    }
    function updateNameDisplay() {
      document.getElementById('nameDisplay').textContent = playerName || 'NOVA';
    }
    function createVirtualKeyboard() {
      const keys = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ BKSP OK'.split(' ');
      const kb = document.getElementById('virtualKeyboard');
      kb.innerHTML = '';
      keys.forEach(k => {
        const btn = document.createElement('div');
        btn.className = 'keyBtn' + (k.length > 1 ? ' wideKey' : '');
        btn.textContent = k;
        btn.onclick = () => {
          if (k === 'OK') {
            if (playerName) {
              document.getElementById('nameOverlay').style.display = 'none';
              state = 'choosing';
              queueDialog([
                'Perfect, {name}! Now, for your first partner.',
                'The Aura Region is home to Pokémon with powerful latent abilities.',
                'Which of these three resonates with you?'
              ]);
            }
          } else if (k === 'BKSP') {
            playerName = playerName.slice(0, -1);
          } else {
            playerName += k;
            if (playerName.length > 10) playerName = playerName.slice(0, 10);
          }
          updateNameDisplay();
        };
        kb.appendChild(btn);
      });
    }

    // Movement
    const dirs = [[0, -1], [-1, 0], [0, 1], [1, 0]]; // up left down right
    function tryMove(dirIndex) {
      const [dx, dy] = dirs[dirIndex];
      const nx = playerPos.x + dx;
      const ny = playerPos.y + dy;
      const mapData = maps[currentMap];
      if (nx >= 0 && nx < mapData[0].length && ny >= 0 && ny < mapData.length) {
        const tile = mapData[ny][nx];
        if (tile === 0 || tile === 2) {
          playerPos.x = nx;
          playerPos.y = ny;
          playerPos.dir = dirIndex;
          playerPos.animFrame ^= 1;
          playBeep(220, 0.05);
          updateFollower();
          checkTileInteraction(tile, nx, ny);
          return true;
        }
      }
      return false;
    }
    function updateFollower() {
      // Simple follow
      const dx = playerPos.x - followerPos.x;
      const dy = playerPos.y - followerPos.y;
      if (Math.abs(dx) > 1 || Math.abs(dy) > 1) {
        followerPos.x += Math.sign(dx) * 0.5;
        followerPos.y += Math.sign(dy) * 0.5;
      } else {
        const offDx = dirs[playerPos.dir][0];
        const offDy = dirs[playerPos.dir][1];
        followerPos.x = playerPos.x + offDx;
        followerPos.y = playerPos.y + offDy;
      }
    }
    function checkTileInteraction(tile, x, y) {
      if (tile === 2) {
        // Door transition
        if (currentMap === 'bedroom') {
          currentMap = 'kitchen';
          playerPos.x = 7;
          playerPos.y = 8;
        } else if (currentMap === 'kitchen') {
          if (x === 1) { // left door to town? adjust
            currentMap = 'town';
            playerPos.x = 12;
            playerPos.y = 8;
          }
        } else if (currentMap === 'town') {
          currentMap = 'kitchen';
          playerPos.x = 13;
          playerPos.y = 8;
        }
        playBeep(440, 0.1);
      } else if (tile === 17 && currentMap === 'kitchen' && !talkedToMom) {
        talkedToMom = true;
        queueDialog([
          "Mom: Ah, {name}! You got your first Pokémon from Professor Chen!",
          "Here, take this Potion. It'll heal your Pokémon in battle.",
          "Go explore Aura Town, visit the Pokémon Center, and start your adventure!"
        ]);
        potionCount++;
        updateBagDisplay();
        maps.kitchen[5][9] = 0; // remove mom tile
      }
    }

    // Input
    function setupControls() {
      ['up', 'down', 'left', 'right'].forEach(d => {
        const el = document.getElementById(`dpad${d.charAt(0).toUpperCase() + d.slice(1)}`);
        const down = () => inputBuffer[d] = true;
        const up = () => inputBuffer[d] = false;
        el.addEventListener('touchstart', down, {passive: false});
        el.addEventListener('touchend', up);
        el.addEventListener('mousedown', down);
        el.addEventListener('mouseup', up);
      });
      document.getElementById('aBtn').addEventListener('touchstart', (e) => {
        e.preventDefault();
        inputBuffer.a = true;
      });
      document.getElementById('aBtn').addEventListener('touchend', () => inputBuffer.a = false);
      document.getElementById('aBtn').addEventListener('mousedown', (e) => {
        e.preventDefault();
        inputBuffer.a = true;
      });
      document.getElementById('aBtn').addEventListener('mouseup', () => inputBuffer.a = false);
      // Similar for b
      document.getElementById('advanceIcon').onclick = advanceDialog;
      document.getElementById('yesBtn').onclick = confirmChoice;
      document.getElementById('noBtn').onclick = () => document.getElementById('confirmOverlay').style.display = 'none';
      document.getElementById('menuBtn').onclick = toggleMenu;
      document.getElementById('saveItem').onclick = saveGame;
      document.getElementById('closeMenu').onclick = toggleMenu;
      document.getElementById('fullscreenBtn').onclick = () => {
        if (document.fullscreenElement) {
          document.exitFullscreen();
        } else {
          document.documentElement.requestFullscreen();
        }
      };
    }
    function toggleMenu() {
      const overlay = document.getElementById('menuOverlay');
      overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';
    }
    function updateBagDisplay() {
      document.getElementById('bagItem').textContent = `Potion x${potionCount}`;
    }
    function saveGame() {
      localStorage.setItem('novaSave', JSON.stringify({playerName, chosenPokemon, playerPos, currentMap, potionCount, talkedToMom}));
      queueDialog(['Saved the game!']);
      toggleMenu();
    }

    // Pokemon choice
    canvas.onclick = (e) => {
      if (state !== 'choosing') return;
      const rect = canvas.getBoundingClientRect();
      const scaleX = GBA_WIDTH / rect.width;
      const scaleY = GBA_HEIGHT / rect.height;
      const logicalX = (e.clientX - rect.left) * scaleX;
      const logicalY = (e.clientY - rect.top) * scaleY;
      let poke;
      if (logicalX < 80) poke = 'charmander';
      else if (logicalX < 160) poke = 'treecko';
      else poke = 'froakie';
      if (poke) {
        document.getElementById('confirmText').textContent = `You chose ${poke.toUpperCase()}! Are you sure?`;
        document.getElementById('confirmOverlay').style.display = 'flex';
        chosenPokemonTemp = poke;
      }
    };
    let chosenPokemonTemp;
    function confirmChoice() {
      chosenPokemon = chosenPokemonTemp;
      playPokemonCry(chosenPokemon);
      document.getElementById('confirmOverlay').style.display = 'none';
      queueDialog(['An excellent choice! This Pokémon is full of potential!']);
      // Auto next after dialog
      setTimeout(() => {
        if (dialogQueue.length === 0) {
          queueDialog([`Alright, ${chosenPokemon.toUpperCase()}! Let's go meet Mom downstairs, then start our journey!`]);
          state = 'home';
          currentMap = 'bedroom';
          document.getElementById('controls').style.display = 'block';
          saveGame();
        }
      }, 3000);
    }

    // Title start
    canvas.onclick = (e) => {
      if (state !== 'title') return;
      state = 'professor';
      queueDialog([
        "Ah! There you are! I've been expecting you.",
        "Welcome to the world of Pokémon! My name is Chen.",
        "I study the unique bond between humans and Pokémon here in the Aura Region.",
        "And you are...?"
      ]);
      playBeep(600, 0.1);
    };

    // Load save
    function loadGame() {
      const save = localStorage.getItem('novaSave');
      if (save) {
        const data = JSON.parse(save);
        playerName = data.playerName;
        chosenPokemon = data.chosenPokemon;
        Object.assign(playerPos, data.playerPos);
        currentMap = data.currentMap;
        potionCount = data.potionCount || 1;
        talkedToMom = data.talkedToMom || false;
        updateBagDisplay();
        state = 'playing';
        document.getElementById('controls').style.display = 'block';
      }
    }
    loadGame();

    // Main loop
    function gameLoop() {
      frameCount++;

      // Typing
      if (currentDialog && dialogPos < currentDialog.length) {
        dialogPos += typingSpeed;
      }

      // Movement
      if (state === 'playing') {
        if (inputBuffer.up) tryMove(0);
        else if (inputBuffer.down) tryMove(2);
        else if (inputBuffer.left) tryMove(1);
        else if (inputBuffer.right) tryMove(3);
        if (frameCount % 10 === 0) playerPos.animFrame ^= 1;
        updateCamera();
      }

      // A press
      if (inputBuffer.a) {
        inputBuffer.a = false;
        if (state === 'professor' || state === 'choosing' || state === 'home') {
          advanceDialog();
        }
      }

      render();
      requestAnimationFrame(gameLoop);
    }

    // Init
    initAudio();
    setupControls();
    gameLoop();
  </script>
</body>
</html>
