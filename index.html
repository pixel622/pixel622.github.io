<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pokemon Style Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body {
    margin: 0;
    overflow: hidden;
    background: #000;
    font-family: 'Arial', sans-serif;
    touch-action: none;
}

canvas {
    display: block;
}

/* Joystick */
#joyBase {
    position: fixed;
    bottom: 30px;
    left: 30px;
    width: 100px;
    height: 100px;
    background: rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.4);
    border-radius: 50%;
    z-index: 100;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    touch-action: none;
}

#joy {
    position: absolute;
    width: 40px;
    height: 40px;
    left: 30px;
    top: 30px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    border: 2px solid rgba(100, 100, 255, 0.8);
    box-shadow: 0 0 10px rgba(100, 100, 255, 0.5);
    transition: transform 0.1s;
    touch-action: none;
}

/* Battle UI */
#battle {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, #1a5f7a, #0a3d62);
    color: white;
    display: none;
    z-index: 1000;
    font-family: 'Arial', sans-serif;
}

.battle-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 20px;
    box-sizing: border-box;
}

.enemy-area {
    flex: 1;
    display: flex;
    justify-content: flex-end;
    align-items: flex-start;
    padding-top: 40px;
}

.player-area {
    flex: 1;
    display: flex;
    justify-content: flex-start;
    align-items: flex-end;
    padding-bottom: 40px;
}

.hp-bar {
    width: 200px;
    height: 20px;
    background: #333;
    border: 2px solid #fff;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}

.hp-fill {
    height: 100%;
    background: linear-gradient(to right, #ff4444, #ffaa44);
    transition: width 0.3s;
    width: 100%;
}

.battle-menu {
    background: rgba(0, 0, 0, 0.8);
    border: 3px solid #fff;
    border-radius: 10px;
    padding: 15px;
    margin-top: 20px;
    display: none;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    max-width: 300px;
    align-self: center;
}

.battle-menu button {
    background: linear-gradient(to bottom, #4a90e2, #2c6cb0);
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

.battle-menu button:hover {
    background: linear-gradient(to bottom, #5a9cf2, #3c7cd0);
    transform: translateY(-2px);
}

.battle-menu button:active {
    transform: translateY(0);
}

#battleLog {
    background: rgba(0, 0, 0, 0.7);
    border: 2px solid #fff;
    border-radius: 10px;
    padding: 15px;
    margin: 20px 0;
    min-height: 60px;
    font-size: 18px;
    color: #fff;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Animation for attacks */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

@keyframes flash {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.shake { animation: shake 0.3s; }
.flash { animation: flash 0.3s; }
.float { animation: float 2s infinite; }

/* Minimap */
#minimap {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 120px;
    height: 120px;
    background: rgba(0, 0, 0, 0.7);
    border: 2px solid #fff;
    border-radius: 10px;
    z-index: 50;
    display: none;
}

/* HUD */
#hud {
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 10px 15px;
    border-radius: 10px;
    border: 2px solid #fff;
    font-size: 14px;
    z-index: 50;
}

.enemy-info, .player-info {
    background: rgba(0, 0, 0, 0.6);
    padding: 10px 20px;
    border-radius: 10px;
    border: 2px solid #fff;
}

.battle-sprite {
    width: 100px;
    height: 100px;
    margin: 0 20px;
}

canvas#battleCanvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 999;
    display: none;
}
</style>
</head>

<body>
<canvas id="game"></canvas>
<canvas id="battleCanvas"></canvas>
<div id="joyBase"><div id="joy"></div></div>
<div id="hud">HP: 30/30<br>Potions: 3<br>Pokéballs: 5</div>

<div id="battle">
    <div class="battle-container">
        <div class="enemy-area">
            <div class="enemy-info">
                <h2 id="enemyName">Wild Pokémon</h2>
                <div class="hp-bar">
                    <div id="enemyHPFill" class="hp-fill"></div>
                </div>
                <div id="enemyHPText">HP: 20/20</div>
            </div>
            <div id="enemySprite" class="battle-sprite"></div>
        </div>
        
        <div id="battleLog">A wild Pokémon appeared!</div>
        
        <div class="player-area">
            <div id="playerSprite" class="battle-sprite"></div>
            <div class="player-info">
                <h2>Trainer</h2>
                <div class="hp-bar">
                    <div id="playerHPFill" class="hp-fill"></div>
                </div>
                <div id="playerHPText">HP: 30/30</div>
            </div>
        </div>
        
        <div class="battle-menu" id="battleMenu">
            <button onclick="attack()">FIGHT</button>
            <button onclick="usePotion()">POTION</button>
            <button onclick="usePokeball()">POKéBALL</button>
            <button onclick="run()">RUN</button>
        </div>
    </div>
</div>

<script>
// Initialize canvases
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const battleCanvas = document.getElementById("battleCanvas");
const battleCtx = battleCanvas.getContext("2d");

// Set canvas sizes
function resizeCanvases() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    battleCanvas.width = window.innerWidth;
    battleCanvas.height = window.innerHeight;
}
resizeCanvases();
window.addEventListener('resize', resizeCanvases);

// Game constants
const TILE = 64;
const GRASS_COLORS = ['#5dbb63', '#6fcf97', '#57a773'];

// Game state
let world = "outside";
let inBattle = false;
let gameTime = 0;

// Player
const player = {
    x: 0,
    y: 0,
    size: 24,
    speed: 3,
    direction: 0,
    animationFrame: 0
};

// Camera
const cam = { x: 0, y: 0 };

// Terrain details
const terrainDetails = [];
for(let i = 0; i < 50; i++) {
    terrainDetails.push({
        x: Math.random() * 1200 - 600,
        y: Math.random() * 1200 - 600,
        type: Math.random() > 0.5 ? 'flower' : 'bush',
        color: ['#ff6b9d', '#ffd166', '#06d6a0', '#118ab2'][Math.floor(Math.random() * 4)],
        size: Math.random() * 8 + 4
    });
}

// Buildings
const buildings = [
    { x: 300, y: 0, type: "house", width: 80, height: 60 },
    { x: -300, y: 0, type: "center", width: 100, height: 60 }
];

// Battle system variables
let enemyHP = 0;
let playerHP = 30;
let maxPlayerHP = 30;
let enemyType = null;
let potions = 3;
let pokeballs = 5;

const pokemonTypes = [
    { name: "Pikachu", color: "#ffd700", hp: 20, attack: 8 },
    { name: "Bulbasaur", color: "#78c850", hp: 25, attack: 7 },
    { name: "Charmander", color: "#f08030", hp: 22, attack: 9 },
    { name: "Squirtle", color: "#6890f0", hp: 23, attack: 7 }
];

// Joystick
let joyX = 0, joyY = 0, drag = false;
const base = document.getElementById("joyBase");
const stick = document.getElementById("joy");

// Touch/Mouse events for joystick
base.addEventListener('mousedown', startDrag);
base.addEventListener('touchstart', startDrag);
window.addEventListener('mouseup', endDrag);
window.addEventListener('touchend', endDrag);
window.addEventListener('mousemove', handleMove);
window.addEventListener('touchmove', handleMove);

function startDrag(e) {
    e.preventDefault();
    drag = true;
    updateJoy(e);
}

function endDrag() {
    drag = false;
    joyX = joyY = 0;
    stick.style.transform = 'translate(0, 0)';
    player.animationFrame = 0;
}

function handleMove(e) {
    if (!drag) return;
    updateJoy(e);
}

function updateJoy(e) {
    const rect = base.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : e;
    
    let x = touch.clientX - rect.left - 50;
    let y = touch.clientY - rect.top - 50;
    
    const distance = Math.sqrt(x * x + y * y);
    const maxDistance = 50;
    
    if (distance > maxDistance) {
        x = (x / distance) * maxDistance;
        y = (y / distance) * maxDistance;
    }
    
    joyX = x / maxDistance;
    joyY = y / maxDistance;
    
    stick.style.transform = `translate(${x}px, ${y}px)`;
    
    // Update player direction
    if (Math.abs(joyX) > Math.abs(joyY)) {
        player.direction = joyX > 0 ? 2 : 1; // 2: right, 1: left
    } else {
        player.direction = joyY > 0 ? 0 : 3; // 0: down, 3: up
    }
}

// Battle functions
function startBattle() {
    inBattle = true;
    enemyType = pokemonTypes[Math.floor(Math.random() * pokemonTypes.length)];
    enemyHP = enemyType.hp;
    
    document.getElementById("battle").style.display = "block";
    document.getElementById("enemyName").textContent = "Wild " + enemyType.name;
    document.getElementById("enemyName").style.color = enemyType.color;
    
    updateBattleText();
    updateHUD();
    
    // Show battle menu after delay
    setTimeout(() => {
        document.getElementById("battleMenu").style.display = "grid";
        addBattleLog("What will you do?");
    }, 1000);
}

function updateBattleText() {
    const enemyPercent = Math.max(0, (enemyHP / enemyType.hp) * 100);
    const playerPercent = Math.max(0, (playerHP / maxPlayerHP) * 100);
    
    document.getElementById("enemyHPFill").style.width = enemyPercent + "%";
    document.getElementById("playerHPFill").style.width = playerPercent + "%";
    
    document.getElementById("enemyHPText").textContent = `HP: ${Math.max(0, enemyHP)}/${enemyType.hp}`;
    document.getElementById("playerHPText").textContent = `HP: ${Math.max(0, playerHP)}/${maxPlayerHP}`;
}

function addBattleLog(message) {
    document.getElementById("battleLog").textContent = message;
}

function attack() {
    const damage = 5 + Math.floor(Math.random() * 4);
    enemyHP -= damage;
    
    // Visual effects
    document.getElementById("enemySprite").classList.add('shake');
    document.getElementById("enemyHPFill").classList.add('flash');
    
    addBattleLog(`You attacked for ${damage} damage!`);
    updateBattleText();
    
    setTimeout(() => {
        document.getElementById("enemySprite").classList.remove('shake');
        document.getElementById("enemyHPFill").classList.remove('flash');
        
        if (enemyHP <= 0) {
            addBattleLog(`Wild ${enemyType.name} fainted!`);
            setTimeout(() => endBattle(true), 1500);
            return;
        }
        
        setTimeout(() => enemyAttack(), 800);
    }, 500);
}

function enemyAttack() {
    const damage = enemyType.attack + Math.floor(Math.random() * 3);
    playerHP -= damage;
    
    document.getElementById("playerSprite").classList.add('shake');
    document.getElementById("playerHPFill").classList.add('flash');
    
    addBattleLog(`Wild ${enemyType.name} attacked for ${damage} damage!`);
    updateBattleText();
    
    setTimeout(() => {
        document.getElementById("playerSprite").classList.remove('shake');
        document.getElementById("playerHPFill").classList.remove('flash');
        
        if (playerHP <= 0) {
            addBattleLog("You blacked out!");
            setTimeout(() => endBattle(false), 1500);
        }
    }, 500);
}

function usePotion() {
    if (potions > 0) {
        potions--;
        const heal = 15;
        playerHP = Math.min(playerHP + heal, maxPlayerHP);
        addBattleLog(`You used a Potion and restored ${heal} HP!`);
        updateBattleText();
        updateHUD();
        
        setTimeout(() => enemyAttack(), 1000);
    } else {
        addBattleLog("No potions left!");
    }
}

function usePokeball() {
    if (pokeballs > 0) {
        pokeballs--;
        addBattleLog(`You threw a Pokéball!`);
        updateHUD();
        
        const catchChance = (enemyHP / enemyType.hp) * 0.5 + 0.3;
        if (Math.random() < catchChance) {
            addBattleLog(`Gotcha! ${enemyType.name} was caught!`);
            setTimeout(() => endBattle(true), 2000);
        } else {
            addBattleLog(`Oh no! ${enemyType.name} broke free!`);
            setTimeout(() => enemyAttack(), 1000);
        }
    } else {
        addBattleLog("No Pokéballs left!");
    }
}

function run() {
    const runChance = 0.7;
    if (Math.random() < runChance) {
        addBattleLog("Got away safely!");
        setTimeout(() => endBattle(false), 1000);
    } else {
        addBattleLog("Couldn't escape!");
        setTimeout(() => enemyAttack(), 800);
    }
}

function endBattle(victory) {
    inBattle = false;
    document.getElementById("battle").style.display = "none";
    document.getElementById("battleMenu").style.display = "none";
    
    if (!victory && playerHP <= 0) {
        // Player fainted - reset position and heal
        player.x = buildings[1].x;
        player.y = buildings[1].y + 100;
        playerHP = maxPlayerHP;
        updateHUD();
    }
}

function updateHUD() {
    document.getElementById("hud").innerHTML = 
        `HP: ${playerHP}/${maxPlayerHP}<br>` +
        `Potions: ${potions}<br>` +
        `Pokéballs: ${pokeballs}`;
}

// Drawing functions
function drawPlayer() {
    ctx.save();
    ctx.translate(canvas.width / 2, canvas.height / 2);
    
    // Body (red shirt)
    ctx.fillStyle = '#ff4444';
    ctx.fillRect(-12, -12, 24, 24);
    
    // Pants (blue)
    ctx.fillStyle = '#2c8bff';
    ctx.fillRect(-12, 6, 24, 6);
    
    // Head
    ctx.fillStyle = '#ffcc99';
    ctx.beginPath();
    ctx.arc(0, -20, 10, 0, Math.PI * 2);
    ctx.fill();
    
    // Hair
    ctx.fillStyle = '#8b4513';
    ctx.fillRect(-8, -30, 16, 12);
    
    // Walking animation
    let legOffset = 0;
    if ((joyX !== 0 || joyY !== 0) && !inBattle) {
        player.animationFrame = (player.animationFrame + 0.2) % 8;
        legOffset = Math.sin(player.animationFrame) * 3;
    }
    
    // Legs
    ctx.fillStyle = '#000';
    ctx.fillRect(-6, 12, 4, 8 + legOffset);
    ctx.fillRect(2, 12, 4, 8 - legOffset);
    
    ctx.restore();
}

function drawGrass() {
    const startX = Math.floor(cam.x / TILE);
    const endX = Math.ceil((cam.x + canvas.width) / TILE);
    const startY = Math.floor(cam.y / TILE);
    const endY = Math.ceil((cam.y + canvas.height) / TILE);
    
    for (let x = startX; x <= endX; x++) {
        for (let y = startY; y <= endY; y++) {
            const colorIndex = (x + y) % GRASS_COLORS.length;
            ctx.fillStyle = GRASS_COLORS[colorIndex];
            ctx.fillRect(x * TILE - cam.x, y * TILE - cam.y, TILE, TILE);
            
            // Grass details
            if ((x + y) % 3 === 0) {
                ctx.fillStyle = '#3a7d34';
                ctx.fillRect(x * TILE - cam.x + 10, y * TILE - cam.y + 10, 3, 12);
                ctx.fillRect(x * TILE - cam.x + 20, y * TILE - cam.y + 15, 3, 8);
            }
        }
    }
}

function drawDetails() {
    terrainDetails.forEach(detail => {
        const dx = detail.x - cam.x;
        const dy = detail.y - cam.y;
        
        if (dx > -50 && dx < canvas.width + 50 && dy > -50 && dy < canvas.height + 50) {
            if (detail.type === 'flower') {
                // Stem
                ctx.fillStyle = '#2d5a27';
                ctx.fillRect(dx - 1, dy, 2, detail.size);
                
                // Flower
                ctx.fillStyle = detail.color;
                ctx.beginPath();
                ctx.arc(dx, dy - 5, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // Petals
                for (let i = 0; i < 5; i++) {
                    const angle = (i / 5) * Math.PI * 2;
                    const px = dx + Math.cos(angle) * 8;
                    const py = dy - 5 + Math.sin(angle) * 8;
                    ctx.beginPath();
                    ctx.arc(px, py, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else {
                // Bush
                ctx.fillStyle = detail.color;
                ctx.beginPath();
                ctx.arc(dx, dy, detail.size, 0, Math.PI * 2);
                ctx.fill();
                
                // Bush details
                ctx.fillStyle = '#2d5a27';
                ctx.beginPath();
                ctx.arc(dx - detail.size/2, dy, detail.size/2, 0, Math.PI * 2);
                ctx.arc(dx + detail.size/2, dy, detail.size/2, 0, Math.PI * 2);
                ctx.fill();
            }
        }
    });
}

function drawBuilding(building) {
    const dx = building.x - cam.x;
    const dy = building.y - cam.y;
    
    if (building.type === "house") {
        // Main structure
        ctx.fillStyle = '#a0522d';
        ctx.fillRect(dx - building.width/2, dy - building.height, building.width, building.height);
        
        // Roof
        ctx.fillStyle = '#8b4513';
        ctx.beginPath();
        ctx.moveTo(dx - building.width/2 - 10, dy - building.height);
        ctx.lineTo(dx, dy - building.height - 20);
        ctx.lineTo(dx + building.width/2 + 10, dy - building.height);
        ctx.closePath();
        ctx.fill();
        
        // Door
        ctx.fillStyle = '#654321';
        ctx.fillRect(dx - 8, dy - 20, 16, 20);
        
        // Windows
        ctx.fillStyle = '#87CEEB';
        ctx.fillRect(dx - 25, dy - 40, 12, 12);
        ctx.fillRect(dx + 13, dy - 40, 12, 12);
        
        // Chimney
        ctx.fillStyle = '#696969';
        ctx.fillRect(dx + 15, dy - building.height - 25, 10, 25);
        
    } else if (building.type === "center") {
        // Main structure
        ctx.fillStyle = '#ff9999';
        ctx.fillRect(dx - building.width/2, dy - building.height, building.width, building.height);
        
        // Roof
        ctx.fillStyle = '#ff6b6b';
        ctx.fillRect(dx - building.width/2 - 5, dy - building.height - 10, building.width + 10, 10);
        
        // Windows
        ctx.fillStyle = '#87CEEB';
        for (let i = 0; i < 3; i++) {
            ctx.fillRect(dx - 35 + i * 25, dy - 40, 15, 15);
        }
        
        // Door
        ctx.fillStyle = '#8b4513';
        ctx.fillRect(dx - 15, dy - 25, 30, 25);
        
        // Sign
        ctx.fillStyle = '#fff';
        ctx.fillRect(dx - 40, dy - building.height - 30, 80, 20);
        ctx.fillStyle = '#ff4444';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('POKé CENTER', dx, dy - building.height - 16);
    }
}

function drawBattleSprites() {
    // Create sprites for battle
    const enemySprite = document.getElementById("enemySprite");
    const playerSprite = document.getElementById("playerSprite");
    
    enemySprite.innerHTML = '';
    playerSprite.innerHTML = '';
    
    // Create enemy sprite
    const enemyCanvas = document.createElement('canvas');
    enemyCanvas.width = 100;
    enemyCanvas.height = 100;
    const enemyCtx = enemyCanvas.getContext('2d');
    
    if (enemyType) {
        switch(enemyType.name) {
            case 'Pikachu':
                enemyCtx.fillStyle = '#ffd700';
                enemyCtx.beginPath();
                enemyCtx.arc(50, 50, 30, 0, Math.PI * 2);
                enemyCtx.fill();
                
                // Ears
                enemyCtx.fillStyle = '#000';
                enemyCtx.fillRect(35, 10, 5, 20);
                enemyCtx.fillRect(60, 10, 5, 20);
                
                // Cheeks
                enemyCtx.fillStyle = '#ff6b9d';
                enemyCtx.beginPath();
                enemyCtx.arc(30, 50, 10, 0, Math.PI * 2);
                enemyCtx.arc(70, 50, 10, 0, Math.PI * 2);
                enemyCtx.fill();
                
                // Face
                enemyCtx.fillStyle = '#000';
                enemyCtx.fillRect(40, 40, 5, 8);
                enemyCtx.fillRect(55, 40, 5, 8);
                enemyCtx.fillRect(45, 60, 10, 4);
                break;
                
            case 'Bulbasaur':
                enemyCtx.fillStyle = '#78c850';
                enemyCtx.beginPath();
                enemyCtx.arc(50, 50, 30, 0, Math.PI * 2);
                enemyCtx.fill();
                
                enemyCtx.fillStyle = '#a8e6a8';
                enemyCtx.beginPath();
                enemyCtx.arc(50, 30, 15, 0, Math.PI * 2);
                enemyCtx.fill();
                break;
        }
    }
    enemySprite.appendChild(enemyCanvas);
    
    // Create player sprite
    const playerCanvas = document.createElement('canvas');
    playerCanvas.width = 100;
    playerCanvas.height = 100;
    const playerCtx = playerCanvas.getContext('2d');
    
    // Player trainer
    playerCtx.fillStyle = '#ff4444';
    playerCtx.fillRect(30, 40, 40, 40);
    
    playerCtx.fillStyle = '#2c8bff';
    playerCtx.fillRect(30, 65, 40, 15);
    
    playerCtx.fillStyle = '#ffcc99';
    playerCtx.beginPath();
    playerCtx.arc(50, 30, 15, 0, Math.PI * 2);
    playerCtx.fill();
    
    playerCtx.fillStyle = '#8b4513';
    playerCtx.fillRect(35, 15, 30, 20);
    
    playerSprite.appendChild(playerCanvas);
}

// Game loop functions
function update() {
    if (inBattle) return;
    
    gameTime++;
    
    // Move player
    player.x += joyX * player.speed;
    player.y += joyY * player.speed;
    
    // Boundaries
    const BOUNDARY = 500;
    player.x = Math.max(-BOUNDARY, Math.min(BOUNDARY, player.x));
    player.y = Math.max(-BOUNDARY, Math.min(BOUNDARY, player.y));
    
    // Check building entry
    if (world === "outside") {
        buildings.forEach(building => {
            const dx = player.x - building.x;
            const dy = player.y - building.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < 50) {
                if (building.type === "house") {
                    world = "house";
                    player.x = 0;
                    player.y = 40;
                } else if (building.type === "center") {
                    world = "center";
                    player.x = 0;
                    player.y = 40;
                    // Heal at center
                    playerHP = maxPlayerHP;
                    updateHUD();
                }
            }
        });
    }
    
    // Check building exit
    if ((world === "house" || world === "center") && player.y > 100) {
        world = "outside";
        const buildingIndex = world === "house" ? 0 : 1;
        player.x = buildings[buildingIndex].x;
        player.y = buildings[buildingIndex].y + 80;
    }
    
    // Random battle
    if (world === "outside" && Math.random() < 0.003 && joyX !== 0 && joyY !== 0) {
        startBattle();
        drawBattleSprites();
    }
    
    // Smooth camera
    cam.x += (player.x - canvas.width/2 - cam.x) * 0.1;
    cam.y += (player.y - canvas.height/2 - cam.y) * 0.1;
}

function draw() {
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (!inBattle) {
        if (world === "outside") {
            // Sky
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Clouds
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            for (let i = 0; i < 3; i++) {
                const cloudX = (cam.x * 0.2 + i * 200) % (canvas.width + 400) - 200;
                const cloudY = 50 + Math.sin(gameTime * 0.001 + i) * 20;
                ctx.beginPath();
                ctx.arc(cloudX, cloudY, 20, 0, Math.PI * 2);
                ctx.arc(cloudX + 25, cloudY - 10, 25, 0, Math.PI * 2);
                ctx.arc(cloudX + 55, cloudY, 20, 0, Math.PI * 2);
                ctx.fill();
            }
            
            drawGrass();
            drawDetails();
            buildings.forEach(drawBuilding);
            
            // Paths to buildings
            ctx.fillStyle = '#8b7355';
            ctx.fillRect(canvas.width/2 - 150, canvas.height/2, 300, 20);
            ctx.fillRect(canvas.width/2 - 10, canvas.height/2 - 150, 20, 300);
            
        } else if (world === "house") {
            // House interior
            ctx.fillStyle = '#d2b48c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Wood floor
            for (let x = 0; x < canvas.width; x += 40) {
                for (let y = 0; y < canvas.height; y += 40) {
                    ctx.fillStyle = (x + y) % 80 === 0 ? '#8b7355' : '#a0522d';
                    ctx.fillRect(x, y, 40, 40);
                }
            }
            
            // Furniture
            ctx.fillStyle = '#8b4513';
            ctx.fillRect(canvas.width/2 - 100, canvas.height/2 - 50, 200, 20); // Table
            ctx.fillRect(canvas.width/2 - 120, canvas.height/2 - 30, 40, 30); // Chair
            ctx.fillRect(canvas.width/2 + 80, canvas.height/2 - 30, 40, 30); // Chair
            ctx.fillRect(canvas.width/2 - 40, canvas.height/2 + 40, 80, 40); // Bed
            ctx.fillRect(canvas.width/2 + 100, canvas.height/2 - 80, 30, 60); // Bookshelf
            
            // Exit
            ctx.fillStyle = '#333';
            ctx.fillRect(canvas.width/2 - 30, canvas.height - 50, 60, 30);
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('EXIT', canvas.width/2, canvas.height - 30);
            
        } else if (world === "center") {
            // Center interior
            ctx.fillStyle = '#f8f8f8';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Tile floor
            for (let x = 0; x < canvas.width; x += 40) {
                for (let y = 0; y < canvas.height; y += 40) {
                    ctx.fillStyle = (x + y) % 80 === 0 ? '#d0d0d0' : '#e8e8e8';
                    ctx.fillRect(x, y, 40, 40);
                }
            }
            
            // Counter
            ctx.fillStyle = '#8b4513';
            ctx.fillRect(canvas.width/2 - 120, canvas.height/2 - 30, 240, 20);
            
            // Healing machine
            ctx.fillStyle = '#4a8bca';
            ctx.fillRect(canvas.width/2 - 40, canvas.height/2 - 80, 80, 60);
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(canvas.width/2 - 20, canvas.height/2 - 60, 40, 20);
            
            // Nurse
            ctx.fillStyle = '#fff';
            ctx.fillRect(canvas.width/2 - 10, canvas.height/2 + 10, 20, 30);
            ctx.fillStyle = '#ff6b9d';
            ctx.fillRect(canvas.width/2 - 15, canvas.height/2, 30, 15);
            
            // Exit
            ctx.fillStyle = '#333';
            ctx.fillRect(canvas.width/2 - 30, canvas.height - 50, 60, 30);
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('EXIT', canvas.width/2, canvas.height - 30);
        }
        
        drawPlayer();
    }
}

function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

// Start the game
gameLoop();
updateHUD();
</script>
</body>
</html>
