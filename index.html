<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Pokémon Adventure - My Pixel Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<style>
  body { margin:0; overflow:hidden; background:#000; font-family:Arial, Helvetica, sans-serif; image-rendering:pixelated; }
  #game { position:relative; width:100vw; height:100vh; }
  canvas { image-rendering:pixelated; }
  #ui { position:absolute; inset:0; pointer-events:none; }
  #dialogue-box {
    position:absolute; bottom:10px; left:10px; right:10px; background:rgba(0,0,0,0.8); color:white;
    padding:15px; border:4px solid #fff; border-radius:8px; font-size:18px; box-sizing:border-box;
    pointer-events:auto; display:none;
  }
  #name-input, #starter-choice { display:none; text-align:center; padding:20px; background:rgba(0,0,0,0.8); color:white; }
  button { font-size:20px; padding:10px 20px; margin:10px; cursor:pointer; }
  #joystick {
    position:absolute; bottom:30px; left:30px; width:120px; height:120px; border-radius:50%;
    background:rgba(255,255,255,0.2); pointer-events:auto; touch-action:none; display:none;
  }
  #knob {
    position:absolute; width:60px; height:60px; border-radius:50%; background:rgba(255,255,255,0.5);
    transform:translate(-50%,-50%);
  }
  #start-btn { display:none; margin:20px auto; font-size:28px; padding:15px 40px; }
</style>
</head>
<body>
<div id="game">
  <canvas id="c"></canvas>
  <div id="ui">
    <div id="joystick"><div id="knob"></div></div>
    <div id="dialogue-box"></div>
    <div id="name-input">
      <h2>What is your name?</h2>
      <input type="text" id="playerName" placeholder="Your name..." style="font-size:24px; padding:10px; width:80%; max-width:300px;">
      <button onclick="submitName()">OK</button>
    </div>
    <div id="starter-choice">
      <h2>Choose your Pokémon!</h2>
      <button onclick="chooseStarter('Treecko')">Treecko (Grass)</button>
      <button onclick="chooseStarter('Froakie')">Froakie (Water)</button>
      <button onclick="chooseStarter('Charmander')">Charmander (Fire)</button>
    </div>
    <button id="start-btn" onclick="startGame()">Start Adventure!</button>
  </div>
</div>

<script>
// ======================== CONFIG ========================
const TILE_SIZE = 32;
const VIEW_WIDTH = 15;   // tiles visible horizontally (~480px)
const VIEW_HEIGHT = 10;  // tiles visible vertically (~320px)
const PLAYER_SPEED = 2;

// Simple map: 0=walkable grass, 1=wall, 2=door
const HOUSE_MAP = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,2,0,0,0,0,0,1], // door at ~6,4
  [1,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const OUTSIDE_MAP = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

// ======================== STATE ========================
let canvas, ctx;
let player = { x: 6*TILE_SIZE, y: 5*TILE_SIZE, dir: 'down', name: '', starter: '' };
let camera = { x: 0, y: 0 };
let inHouse = true;
let currentMap = HOUSE_MAP;
let dialogueQueue = [];
let dialogueActive = false;
let keys = {};
let touchStart = null, touchMove = null;
let joystickActive = false;

// ======================== INIT ========================
window.onload = () => {
  canvas = document.getElementById('c');
  ctx = canvas.getContext('2d');
  resize();
  window.addEventListener('resize', resize);

  // Keyboard
  window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
  window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

  // Touch joystick
  const joy = document.getElementById('joystick');
  const knob = document.getElementById('knob');
  if ('ontouchstart' in window) joy.style.display = 'block';

  joy.addEventListener('touchstart', e => {
    e.preventDefault();
    joystickActive = true;
    updateJoystick(e.touches[0]);
  });
  joy.addEventListener('touchmove', e => {
    e.preventDefault();
    if (joystickActive) updateJoystick(e.touches[0]);
  });
  joy.addEventListener('touchend', () => {
    joystickActive = false;
    touchMove = null;
    knob.style.left = '50%';
    knob.style.top  = '50%';
  });

  showIntro();
  requestAnimationFrame(gameLoop);
};

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

// ======================== JOYSTICK ========================
function updateJoystick(touch) {
  const rect = document.getElementById('joystick').getBoundingClientRect();
  const centerX = rect.left + rect.width/2;
  const centerY = rect.top + rect.height/2;

  let dx = touch.clientX - centerX;
  let dy = touch.clientY - centerY;
  const dist = Math.sqrt(dx*dx + dy*dy);
  const maxDist = 50;

  if (dist > maxDist) {
    dx *= maxDist / dist;
    dy *= maxDist / dist;
  }

  document.getElementById('knob').style.left = `${50 + (dx / maxDist)*40}%`;
  document.getElementById('knob').style.top  = `${50 + (dy / maxDist)*40}%`;

  touchMove = { dx: dx / maxDist, dy: dy / maxDist };
}

// ======================== DIALOGUE ========================
function showText(text, callback = null) {
  const box = document.getElementById('dialogue-box');
  box.innerHTML = text.replace(/\.\.\./g, '...<br><small>(click/tap to continue)</small>');
  box.style.display = 'block';
  dialogueActive = true;

  const next = () => {
    box.style.display = 'none';
    dialogueActive = false;
    if (callback) callback();
  };

  const listener = () => {
    document.removeEventListener('click', listener);
    document.removeEventListener('touchstart', listener);
    next();
  };
  document.addEventListener('click', listener);
  document.addEventListener('touchstart', listener);
}

function showIntro() {
  // Fake pixel Pokémon logo (placeholder)
  ctx.fillStyle = 'red';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = 'white';
  ctx.font = 'bold 60px Arial';
  ctx.textAlign = 'center';
  ctx.fillText("Pokémon", canvas.width/2, canvas.height/2 - 40);
  ctx.font = '30px Arial';
  ctx.fillText("Click / Tap to Start", canvas.width/2, canvas.height/2 + 40);

  const startIntro = () => {
    document.removeEventListener('click', startIntro);
    document.removeEventListener('touchstart', startIntro);
    ctx.clearRect(0,0,canvas.width,canvas.height);

    dialogueQueue = [
      "Hello there! Welcome to the world of Pokémon!",
      "My name is Kyan! ... People call me the Pokémon Prof!",
      "This world is inhabited by creatures called Pokémon!",
      "For some people, Pokémon are pets. Others use them for fights.",
      "Myself… I study Pokémon as a profession...",
      "First, what is your name?"
    ];
    showNextDialogue();
  };

  document.addEventListener('click', startIntro);
  document.addEventListener('touchstart', startIntro);
}

function showNextDialogue() {
  if (dialogueQueue.length === 0) {
    document.getElementById('name-input').style.display = 'block';
    return;
  }
  const text = dialogueQueue.shift();
  if (text.includes("your name")) {
    showText(text, () => {
      document.getElementById('name-input').style.display = 'block';
    });
  } else {
    showText(text, showNextDialogue);
  }
}

function submitName() {
  const name = document.getElementById('playerName').value.trim() || "Trainer";
  player.name = name;
  document.getElementById('name-input').style.display = 'none';

  dialogueQueue = [
    `Your very own Pokémon legend is about to unfold!`,
    `A world of dreams and adventures with Pokémon awaits! Let's go!`
  ];
  showNextDialogue();

  setTimeout(() => {
    document.getElementById('start-btn').style.display = 'block';
  }, 2000);
}

function startGame() {
  document.getElementById('start-btn').style.display = 'none';
  document.getElementById('dialogue-box').style.display = 'none';
  // Spawn in house
  player.x = 6 * TILE_SIZE;
  player.y = 4 * TILE_SIZE;
  inHouse = true;
  currentMap = HOUSE_MAP;
  // Professor appears later when near door
}

// Starter selection
function chooseStarter(poke) {
  player.starter = poke;
  document.getElementById('starter-choice').style.display = 'none';
  showText(`Great choice! ${poke}, I choose you! Your adventure begins now.`, () => {
    // After starter → real game
    player.x = 6 * TILE_SIZE;
    player.y = 5 * TILE_SIZE;
  });
}

// ======================== GAME LOOP ========================
function gameLoop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Input
  let dx = 0, dy = 0;
  if (keys['w'] || keys['arrowup']) dy -= PLAYER_SPEED;
  if (keys['s'] || keys['arrowdown']) dy += PLAYER_SPEED;
  if (keys['a'] || keys['arrowleft']) dx -= PLAYER_SPEED;
  if (keys['d'] || keys['arrowright']) dx += PLAYER_SPEED;

  if (joystickActive && touchMove) {
    dx += touchMove.dx * PLAYER_SPEED * 1.5;
    dy += touchMove.dy * PLAYER_SPEED * 1.5;
  }

  // Collision + move
  let newX = player.x + dx;
  let newY = player.y + dy;

  if (!isColliding(newX, newY)) {
    player.x = newX;
    player.y = newY;
    if (dx < 0) player.dir = 'left';
    if (dx > 0) player.dir = 'right';
    if (dy < 0) player.dir = 'up';
    if (dy > 0) player.dir = 'down';
  }

  // Door teleport
  if (inHouse && Math.abs(player.x - 6*TILE_SIZE) < TILE_SIZE && Math.abs(player.y - 4*TILE_SIZE) < TILE_SIZE) {
    inHouse = false;
    currentMap = OUTSIDE_MAP;
    player.x = 8 * TILE_SIZE;
    player.y = 5 * TILE_SIZE;
    showText(`Hello ${player.name}! This is the beginning of your legendary adventure...`);
    setTimeout(() => {
      document.getElementById('starter-choice').style.display = 'block';
    }, 1500);
  }

  // Camera follow (small view)
  camera.x = player.x - (canvas.width/2) + TILE_SIZE/2;
  camera.y = player.y - (canvas.height/2) + TILE_SIZE/2;

  // Draw map (only visible part)
  const startX = Math.floor(camera.x / TILE_SIZE);
  const startY = Math.floor(camera.y / TILE_SIZE);
  for (let y = startY; y < startY + VIEW_HEIGHT + 2; y++) {
    for (let x = startX; x < startX + VIEW_WIDTH + 2; x++) {
      if (x < 0 || y < 0 || x >= currentMap[0].length || y >= currentMap.length) continue;
      const tile = currentMap[y][x];
      const px = x*TILE_SIZE - camera.x;
      const py = y*TILE_SIZE - camera.y;

      if (tile === 1) {
        ctx.fillStyle = '#555';
        ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
      } else {
        ctx.fillStyle = inHouse ? '#8B5' : '#0A3';
        ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
      }
      if (tile === 2) {
        ctx.fillStyle = 'brown';
        ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
      }
    }
  }

  // Player (placeholder trainer with red hat)
  ctx.fillStyle = 'red';
  ctx.fillRect(player.x - camera.x - TILE_SIZE/2, player.y - camera.y - TILE_SIZE, TILE_SIZE, TILE_SIZE/2); // hat
  ctx.fillStyle = '#88f';
  ctx.fillRect(player.x - camera.x - TILE_SIZE/2, player.y - camera.y - TILE_SIZE/2, TILE_SIZE, TILE_SIZE/2); // body
  ctx.fillStyle = 'black';
  ctx.fillRect(player.x - camera.x - 4, player.y - camera.y - 4, 8, 8); // eyes

  // Debug info
  ctx.fillStyle = 'white';
  ctx.font = '16px Arial';
  ctx.textAlign = 'left';
  ctx.fillText(`Player: ${player.name} | Starter: ${player.starter || 'None'}`, 10, 30);

  requestAnimationFrame(gameLoop);
}

function isColliding(x, y) {
  const tx = Math.floor((x + TILE_SIZE/2) / TILE_SIZE);
  const ty = Math.floor((y + TILE_SIZE/2) / TILE_SIZE);
  if (tx < 0 || ty < 0 || tx >= currentMap[0].length || ty >= currentMap.length) return true;
  return currentMap[ty][tx] === 1;
}
</script>
</body>
</html>
