<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pok√©mon Amber: Route 1</title>
    <style>
        :root {
            --gba-blue: #285088;
            --gba-light-blue: #5888c8;
            --font-main: 'Courier New', Courier, monospace;
        }

        body, html {
            margin: 0; padding: 0; 
            width: 100vw; height: 100vh;
            background: #000; overflow: hidden; 
            touch-action: none;
            display: flex; justify-content: center; align-items: center;
        }

        #game-wrapper {
            position: relative;
            width: 100%; height: 100%;
        }

        canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
            image-rendering: pixelated;
        }

        #ui-layer {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%); width: 90%;
            z-index: 100; cursor: pointer;
        }

        #dialogue-box {
            background: white;
            border: 6px solid var(--gba-blue);
            border-radius: 18px;
            padding: 20px;
            font-family: var(--font-main);
            font-weight: bold;
            font-size: 20px;
            box-shadow: inset 0 0 0 3px var(--gba-light-blue), 0 4px 10px rgba(0,0,0,0.5);
            min-height: 80px;
            user-select: none;
        }

        #speaker-tag {
            position: absolute; top: -25px; left: 30px;
            background: var(--gba-blue); color: white;
            padding: 5px 20px; border-radius: 10px 10px 0 0;
            font-size: 16px; border: 3px solid var(--gba-blue);
        }

        #joystick-wrapper {
            position: absolute; bottom: 40px; left: 40px;
            width: 140px; height: 140px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);
            display: flex; justify-content: center; align-items: center;
            z-index: 200;
        }

        #joystick-knob {
            width: 60px; height: 60px;
            background: rgba(255,255,255,0.6);
            border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }

        #shimmer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none;
            transition: opacity 0.4s; z-index: 999;
        }

        #bag-btn {
            position: absolute; top: 20px; right: 20px;
            background: var(--gba-blue); color: white;
            padding: 10px 25px; border-radius: 8px;
            font-family: var(--font-main); font-weight: bold;
            border: 3px solid white; cursor: pointer; z-index: 300;
        }

        #bag-menu {
            display: none;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 250px; background: white;
            border: 6px solid var(--gba-blue); border-radius: 15px;
            padding: 20px; z-index: 1000; font-family: var(--font-main);
            box-shadow: 0 0 0 500px rgba(0,0,0,0.5);
        }

        .bag-item {
            display: flex; align-items: center; margin-bottom: 10px;
            font-size: 18px; border-bottom: 1px solid #ccc; padding-bottom: 5px;
        }

        /* BATTLE UI */
        #battle-screen {
            display: none;
            position: absolute; inset: 0;
            background: #fff; z-index: 500;
            flex-direction: column; justify-content: space-around; align-items: center;
            font-family: var(--font-main);
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="gameCanvas"></canvas>
    <div id="shimmer"></div>

    <div id="bag-btn" onclick="toggleBag()">BAG</div>
    
    <div id="bag-menu">
        <h3 style="margin-top:0; color:var(--gba-blue)">ITEMS</h3>
        <div id="bag-count" class="bag-item">üî¥ Pok√© Ball x5</div>
        <button onclick="toggleBag()" style="width:100%; margin-top:10px; cursor:pointer;">CLOSE</button>
    </div>

    <div id="battle-screen">
        <h2 id="battle-msg">A Wild Pok√©mon appeared!</h2>
        <div style="width: 80%; background: #eee; height: 20px; border: 2px solid #000;">
            <div id="hp-bar" style="width: 100%; height: 100%; background: green; transition: 0.3s;"></div>
        </div>
        <button onclick="attack()" style="padding: 20px; font-size: 20px; background: #e06060; color: white; border: none; border-radius: 10px;">ATTACK!</button>
    </div>

    <div id="ui-layer" onclick="handleDialogueClick()">
        <div id="speaker-tag">Professor Sequoia</div>
        <div id="dialogue-box">Welcome to the Habitat Research Lab!</div>
    </div>

    <div id="joystick-wrapper">
        <div id="joystick-knob"></div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const knob = document.getElementById('joystick-knob');
    const wrapper = document.getElementById('joystick-wrapper');
    const uiLayer = document.getElementById('ui-layer');
    const dialogueBox = document.getElementById('dialogue-box');
    const bagMenu = document.getElementById('bag-menu');
    const battleScreen = document.getElementById('battle-screen');

    const script = [
        "Welcome to the Habitat Research Lab!",
        "Look around! This facility is dedicated to studying Orebound's ecology.",
        "The tremor earlier was quite strong. We must act quickly.",
        "Go ahead and click on the Pok√©mon you want to partner with!"
    ];
    let scriptIndex = 0;
    let currentMap = 'LAB';
    let choosingState = false;
    let bagOpen = false;
    let holdingPokeball = false;
    let bagBalls = 5;

    let width, height;
    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
    }
    window.addEventListener('resize', resize);
    resize();

    const player = { x: width/2, y: height/2 + 50, speed: 5, history: [] };
    const follower = { active: false, name: '', x: 0, y: 0, color: '#000' };
    const pokeballs = [
        { name: 'Treecko', x: 0, y: 0, color: '#32CD32', active: true },
        { name: 'Froakie', x: 0, y: 0, color: '#1E90FF', active: true },
        { name: 'Charmander', x: 0, y: 0, color: '#FF4500', active: true }
    ];

    // --- NEW SPAWN SYSTEM ---
    let wildPokemons = [];
    function spawnWild() {
        wildPokemons = [];
        for(let i=0; i<25; i++) {
            wildPokemons.push({
                x: Math.random() * (width - 40) + 20,
                y: Math.random() * (height - 40) + 20,
                color: `hsl(${Math.random() * 360}, 70%, 50%)`,
                hp: 100,
                active: true
            });
        }
    }
    spawnWild();

    let inBattle = false;
    let activeEnemy = null;

    function toggleBag() {
        if(inBattle) return;
        bagOpen = !bagOpen;
        bagMenu.style.display = bagOpen ? 'block' : 'none';
    }

    function handleDialogueClick() {
        if (scriptIndex < script.length - 1) {
            scriptIndex++;
            dialogueBox.innerText = script[scriptIndex];
        } else {
            uiLayer.style.display = 'none';
            choosingState = true;
        }
    }

    canvas.addEventListener('mousedown', (e) => checkPokeClick(e.clientX, e.clientY));
    canvas.addEventListener('touchstart', (e) => checkPokeClick(e.touches[0].clientX, e.touches[0].clientY));

    function checkPokeClick(clickX, clickY) {
        if (!choosingState || follower.active || currentMap !== 'LAB') return;
        pokeballs.forEach(ball => {
            if(!ball.active) return;
            const dx = clickX - ball.realX;
            const dy = clickY - ball.realY;
            if (Math.sqrt(dx*dx + dy*dy) < 40) {
                follower.active = true;
                follower.name = ball.name;
                follower.color = ball.color;
                follower.x = ball.realX;
                follower.y = ball.realY;
                ball.active = false;
                holdingPokeball = true;
                uiLayer.style.display = 'block';
                dialogueBox.innerText = "Professor Sequoia: Step on the blue mat to explore! Catch wild Pok√©mon by touching them!";
            }
        });
    }

    let stickX = 0, stickY = 0, isTouching = false;
    wrapper.addEventListener('touchstart', () => isTouching = true);
    window.addEventListener('touchend', () => { isTouching = false; stickX = 0; stickY = 0; knob.style.transform = `translate(0px, 0px)`; });
    window.addEventListener('touchmove', (e) => {
        if (!isTouching) return;
        const rect = wrapper.getBoundingClientRect();
        const touch = e.touches[0];
        let dx = touch.clientX - (rect.left + rect.width/2);
        let dy = touch.clientY - (rect.top + rect.height/2);
        const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 45);
        const angle = Math.atan2(dy, dx);
        stickX = Math.cos(angle) * (dist/45);
        stickY = Math.sin(angle) * (dist/45);
        knob.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
    });

    function checkCollision(nx, ny) {
        if (currentMap === 'LAB') {
            const dW = 350, dH = 100, dX = width/2 - dW/2, dY = height/2.5;
            if (nx > dX - 15 && nx < dX + dW + 15 && ny > dY - 15 && ny < dY + dH + 15) return true;
            if (ny < 130) return true;
        } else {
            const hX = width/2 - 110, hY = height/2 - 150;
            if (nx > hX - 20 && nx < hX + 240 && ny > hY - 60 && ny < hY + 150) {
                if (Math.abs(nx - width/2) < 30 && ny > hY + 100) return false;
                return true;
            }
            if (ny > height/2 + 100 && ny < height/2 + 130) return true;
        }
        return false;
    }

    // --- BATTLE MECHANICS ---
    function startBattle(enemy) {
        inBattle = true;
        activeEnemy = enemy;
        activeEnemy.hp = 100;
        document.getElementById('hp-bar').style.width = '100%';
        document.getElementById('hp-bar').style.background = 'green';
        document.getElementById('battle-msg').innerText = "A Wild Pok√©mon appeared!";
        battleScreen.style.display = 'flex';
    }

    function attack() {
        activeEnemy.hp -= 34;
        const hpBar = document.getElementById('hp-bar');
        hpBar.style.width = activeEnemy.hp + '%';
        if(activeEnemy.hp < 50) hpBar.style.background = 'orange';
        
        if (activeEnemy.hp <= 0) {
            hpBar.style.width = '0%';
            if(bagBalls > 0) {
                bagBalls--;
                document.getElementById('bag-count').innerText = `üî¥ Pok√© Ball x${bagBalls}`;
                document.getElementById('battle-msg').innerText = "Pok√©mon Fainted! You caught it!";
                setTimeout(() => {
                    activeEnemy.active = false;
                    inBattle = false;
                    battleScreen.style.display = 'none';
                }, 1500);
            } else {
                document.getElementById('battle-msg').innerText = "Out of balls! It escaped!";
                setTimeout(() => { inBattle = false; battleScreen.style.display = 'none'; }, 1500);
            }
        }
    }

    let isTeleporting = false;
    function teleport() {
        if (isTeleporting) return;
        isTeleporting = true;
        const shim = document.getElementById('shimmer');
        shim.style.opacity = '1';
        setTimeout(() => {
            currentMap = (currentMap === 'LAB') ? 'OUTSIDE' : 'LAB';
            player.x = width/2;
            player.y = (currentMap === 'OUTSIDE') ? height/2 + 80 : height - 120;
            player.history = [];
            spawnWild(); // Respawn when changing maps
            shim.style.opacity = '0';
            setTimeout(() => { isTeleporting = false; }, 500);
        }, 400);
    }

    function update() {
        if (bagOpen || inBattle) return;

        if (isTouching) {
            let nextX = player.x + stickX * player.speed;
            let nextY = player.y + stickY * player.speed;
            if (!checkCollision(nextX, nextY)) {
                player.history.push({x: player.x, y: player.y});
                if (player.history.length > 60) player.history.shift();
                player.x = nextX;
                player.y = nextY;
            }
        }

        // Check Wild Encounter
        if(currentMap === 'OUTSIDE') {
            wildPokemons.forEach(p => {
                if(p.active && Math.abs(player.x - p.x) < 30 && Math.abs(player.y - p.y) < 30) {
                    startBattle(p);
                }
            });
        }

        const matX = width / 2;
        const matY = (currentMap === 'LAB') ? height - 30 : height / 2 + 10;
        if (Math.abs(player.x - matX) < 50 && Math.abs(player.y - matY) < 30) teleport();

        if (follower.active && player.history.length > 12) {
            const fp = player.history[player.history.length - 12];
            follower.x += (fp.x - follower.x) * 0.15;
            follower.y += (fp.y - follower.y) * 0.15;
        }
        player.x = Math.max(20, Math.min(width-20, player.x));
        player.y = Math.max(20, Math.min(height-20, player.y));
    }

    function draw() {
        ctx.clearRect(0, 0, width, height);

        if (currentMap === 'LAB') {
            ctx.fillStyle = '#d89060'; ctx.fillRect(0, 0, width, height);
            ctx.strokeStyle = '#b87040'; for(let i=0; i<width; i+=60) ctx.strokeRect(i, 0, 60, height);
            ctx.fillStyle = '#3a8fb7'; ctx.fillRect(width/2 - 50, height - 50, 100, 50);
            ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.strokeRect(width/2 - 50, height - 50, 100, 50);
            ctx.fillStyle = '#5d3a1a'; for(let i=50; i<width-100; i+=120) ctx.fillRect(i, 20, 100, 100);
            const dW = 350, dH = 100, dX = width/2 - dW/2, dY = height/2.5;
            ctx.fillStyle = '#804020'; ctx.fillRect(dX, dY, dW, dH);
            pokeballs.forEach((ball, i) => {
                if (!ball.active) return;
                ball.realX = dX + 60 + (i * 110); ball.realY = dY + 40;
                ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(ball.realX, ball.realY, 15, Math.PI, 0); ctx.fill();
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(ball.realX, ball.realY, 15, 0, Math.PI); ctx.fill();
            });
        } else {
            ctx.fillStyle = '#8dbd8d'; ctx.fillRect(0, 0, width, height);
            // Draw Wild Pokemon
            wildPokemons.forEach(p => {
                if(!p.active) return;
                ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 12, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = 'white'; ctx.fillRect(p.x-4, p.y-4, 2, 2); ctx.fillRect(p.x+2, p.y-4, 2, 2);
            });
            // Draw House/Trees
            const hX = width/2 - 110, hY = height/2 - 150;
            ctx.fillStyle = '#a0c0d8'; ctx.fillRect(hX, hY, 220, 150);
            ctx.fillStyle = '#e06060'; ctx.beginPath(); ctx.moveTo(hX-20, hY); ctx.lineTo(width/2, hY-60); ctx.lineTo(hX+240, hY); ctx.fill();
            ctx.fillStyle = '#3a8fb7'; ctx.fillRect(width/2 - 40, height/2, 80, 25);
        }

        if (follower.active) {
            ctx.fillStyle = follower.color; ctx.beginPath(); ctx.arc(follower.x, follower.y, 14, 0, Math.PI * 2); ctx.fill();
        }

        ctx.fillStyle = '#a03030'; ctx.fillRect(player.x-15, player.y-10, 30, 25);
        ctx.fillStyle = '#ffdbac'; ctx.fillRect(player.x-10, player.y-25, 20, 18);
        if (holdingPokeball) {
            ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(player.x + 15, player.y, 6, Math.PI, 0); ctx.fill();
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(player.x + 15, player.y, 6, 0, Math.PI); ctx.fill();
        }

        update();
        requestAnimationFrame(draw);
    }
    draw();
</script>
</body>
</html>
