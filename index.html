<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pokémon K&E Version</title>
    <style>
        :root {
            --gba-blue: #285088;
            --gba-light-blue: #5888c8;
            --font-main: 'Courier New', Courier, monospace;
        }

        body, html {
            margin: 0; padding: 0; 
            width: 100vw; height: 100vh;
            background: #000; overflow: hidden; 
            touch-action: none;
            display: flex; justify-content: center; align-items: center;
        }

        #game-wrapper { position: relative; width: 100%; height: 100%; }

        canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
            image-rendering: pixelated; /* Essential for mini-pixel look */
        }

        #title-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; transition: opacity 0.5s ease-out;
            font-family: var(--font-main);
        }

        #title-screen h1 { font-size: 40px; margin-bottom: 20px; color: #ffcb05; text-shadow: 3px 3px #2a75bb; }

        #start-btn {
            padding: 15px 40px; font-size: 20px; font-family: var(--font-main);
            background: var(--gba-blue); color: white; border: 4px solid white;
            cursor: pointer; border-radius: 10px; font-weight: bold;
        }

        #ui-layer {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%); width: 90%;
            z-index: 100; cursor: pointer; display: none;
        }

        #dialogue-box {
            background: white; border: 6px solid var(--gba-blue); border-radius: 18px;
            padding: 20px; font-family: var(--font-main); font-weight: bold;
            font-size: 20px; box-shadow: inset 0 0 0 3px var(--gba-light-blue), 0 4px 10px rgba(0,0,0,0.5);
            min-height: 80px;
        }

        #speaker-tag {
            position: absolute; top: -25px; left: 30px;
            background: var(--gba-blue); color: white;
            padding: 5px 20px; border-radius: 10px 10px 0 0;
            font-size: 16px; border: 3px solid var(--gba-blue);
        }

        #joystick-wrapper {
            position: absolute; bottom: 80px; left: 40px;
            width: 130px; height: 130px;
            background: rgba(255,255,255,0.15); border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);
            display: flex; justify-content: center; align-items: center; z-index: 200;
        }

        #joystick-knob { width: 50px; height: 50px; background: rgba(255,255,255,0.6); border-radius: 50%; }

        #bag-btn {
            position: absolute; bottom: 80px; right: 40px;
            background: var(--gba-blue); color: white;
            padding: 15px 30px; border-radius: 8px;
            font-family: var(--font-main); font-weight: bold;
            border: 3px solid white; cursor: pointer; z-index: 300;
        }

        #shimmer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; z-index: 999;
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="title-screen">
        <h1>Pokémon K&E Version</h1>
        <button id="start-btn" onclick="startGame()">START GAME</button>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div id="shimmer"></div>
    <div id="bag-btn" onclick="alert('Bag: 1x Pokédex, 5x Pokéballs')">BAG</div>

    <div id="ui-layer" onclick="handleDialogueClick()">
        <div id="speaker-tag">Professor Sequoia</div>
        <div id="dialogue-box">Welcome to the Habitat Research Lab!</div>
    </div>

    <div id="joystick-wrapper">
        <div id="joystick-knob"></div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const knob = document.getElementById('joystick-knob');
    const wrapper = document.getElementById('joystick-wrapper');
    const uiLayer = document.getElementById('ui-layer');
    const dialogueBox = document.getElementById('dialogue-box');
    const titleScreen = document.getElementById('title-screen');

    const script = [
        "Welcome to the Habitat Research Lab!",
        "Look around! This facility is dedicated to studying Orebound's ecology.",
        "The tremor earlier was quite strong. We must act quickly.",
        "Go ahead and click on the Pokémon you want to partner with!"
    ];
    let scriptIndex = 0;
    let currentMap = 'LAB';
    let choosingState = false;
    let width, height;
    let isTeleporting = false;

    function resize() {
        width = window.innerWidth; height = window.innerHeight;
        canvas.width = width; canvas.height = height;
    }
    window.addEventListener('resize', resize);
    resize();

    const player = { x: width/2, y: height - 120, speed: 4.5, history: [] };
    const follower = { active: false, name: '', x: 0, y: 0, color: '#000' };

    const pokemons = [
        { name: 'Treecko', x: 0, y: 0, color: '#32CD32', active: true },
        { name: 'Froakie', x: 0, y: 0, color: '#1E90FF', active: true },
        { name: 'Charmander', x: 0, y: 0, color: '#FF4500', active: true }
    ];

    function startGame() {
        titleScreen.style.opacity = '0';
        setTimeout(() => { titleScreen.style.display = 'none'; uiLayer.style.display = 'block'; }, 500);
    }

    let stickX = 0, stickY = 0, isTouching = false;

    function handleDialogueClick() {
        if (scriptIndex < script.length - 1) {
            scriptIndex++;
            dialogueBox.innerText = script[scriptIndex];
        } else {
            uiLayer.style.display = 'none';
            choosingState = true;
        }
    }

    canvas.addEventListener('touchstart', (e) => checkPokeClick(e.touches[0].clientX, e.touches[0].clientY));
    canvas.addEventListener('mousedown', (e) => checkPokeClick(e.clientX, e.clientY));

    function checkPokeClick(clickX, clickY) {
        if (!choosingState || follower.active || currentMap !== 'LAB') return;
        pokemons.forEach(p => {
            if(!p.active) return;
            const dx = clickX - p.realX; const dy = clickY - p.realY;
            if (Math.sqrt(dx*dx + dy*dy) < 40) {
                follower.active = true; follower.name = p.name;
                follower.color = p.color; follower.x = p.realX;
                follower.y = p.realY; p.active = false;
            }
        });
    }

    wrapper.addEventListener('touchstart', (e) => { isTouching = true; e.preventDefault(); });
    window.addEventListener('touchend', () => { isTouching = false; stickX = 0; stickY = 0; knob.style.transform = `translate(0px, 0px)`; });
    window.addEventListener('touchmove', (e) => {
        if (!isTouching) return;
        const rect = wrapper.getBoundingClientRect();
        const touch = e.touches[0];
        let dx = touch.clientX - (rect.left + rect.width/2);
        let dy = touch.clientY - (rect.top + rect.height/2);
        const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
        const angle = Math.atan2(dy, dx);
        stickX = Math.cos(angle) * (dist/40); stickY = Math.sin(angle) * (dist/40);
        knob.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
    });

    function checkCollision(nx, ny) {
        if (currentMap === 'LAB') {
            const dW = 350, dH = 100, dX = width/2 - dW/2, dY = height/2.5;
            if (nx > dX - 15 && nx < dX + dW + 15 && ny > dY - 15 && ny < dY + dH + 15) return true;
            if (ny < 130) return true;
        } else {
            const hX = width/2 - 110, hY = height/2 - 150;
            if (nx > hX - 20 && nx < hX + 240 && ny > hY - 60 && ny < hY + 150) {
                if (Math.abs(nx - width/2) < 30 && ny > hY + 100) return false;
                return true;
            }
            if (ny > height/2 + 120 && ny < height/2 + 130) { if (Math.abs(nx - width/2) > 40) return true; }
        }
        return false;
    }

    function teleport() {
        if (isTeleporting) return;
        isTeleporting = true;
        const shim = document.getElementById('shimmer');
        shim.style.opacity = '1';
        setTimeout(() => {
            currentMap = (currentMap === 'LAB') ? 'OUTSIDE' : 'LAB';
            player.x = width/2;
            player.y = (currentMap === 'OUTSIDE') ? height/2 + 80 : height - 120;
            player.history = []; shim.style.opacity = '0'; isTeleporting = false;
        }, 300);
    }

    // PIXEL DRAWING FUNCTIONS
    function drawMiniPlayer(x, y) {
        // Feet
        ctx.fillStyle = '#333'; ctx.fillRect(x-8, y+15, 6, 4); ctx.fillRect(x+2, y+15, 6, 4);
        // Body (Jacket)
        ctx.fillStyle = '#a03030'; ctx.fillRect(x-10, y-5, 20, 20);
        // Hands
        ctx.fillStyle = '#ffdbac'; ctx.fillRect(x-14, y+5, 4, 4); ctx.fillRect(x+10, y+5, 4, 4);
        // Head
        ctx.fillStyle = '#ffdbac'; ctx.fillRect(x-7, y-18, 14, 14);
        // Hat
        ctx.fillStyle = '#fff'; ctx.fillRect(x-9, y-22, 18, 6);
        // Eyes
        ctx.fillStyle = '#000'; ctx.fillRect(x-4, y-13, 2, 2); ctx.fillRect(x+2, y-13, 2, 2);
    }

    function drawMiniPokemon(x, y, name) {
        if (name === 'Treecko') {
            ctx.fillStyle = '#32CD32'; ctx.fillRect(x-8, y-5, 16, 16); // Body
            ctx.fillStyle = '#228B22'; ctx.fillRect(x+4, y+5, 8, 4); // Tail
            ctx.fillStyle = '#FFD700'; ctx.fillRect(x-4, y-2, 3, 3); ctx.fillRect(x+1, y-2, 3, 3); // Eyes
        } else if (name === 'Froakie') {
            ctx.fillStyle = '#1E90FF'; ctx.fillRect(x-10, y-5, 20, 15);
            ctx.fillStyle = '#FFFFFF'; ctx.fillRect(x-8, y-10, 16, 6); // Bubbles
            ctx.fillStyle = '#FFD700'; ctx.fillRect(x-5, y-2, 3, 3); ctx.fillRect(x+2, y-2, 3, 3);
        } else if (name === 'Charmander') {
            ctx.fillStyle = '#FF4500'; ctx.fillRect(x-8, y-8, 16, 18);
            ctx.fillStyle = '#FFFF00'; ctx.fillRect(x-3, y+2, 6, 6); // Belly
            ctx.fillStyle = '#FF0000'; ctx.fillRect(x+6, y+5, 4, 4); // Tail fire
        }
    }

    function drawMiniBush(x, y) {
        ctx.fillStyle = '#1e3d1e'; ctx.fillRect(x-30, y-15, 60, 45); // Outline
        ctx.fillStyle = '#3a6b3a'; ctx.fillRect(x-25, y-10, 50, 35); // Main
        ctx.fillStyle = '#6ab06a'; ctx.fillRect(x-15, y-5, 15, 5); // Highlight
    }

    function update() {
        if (isTouching) {
            let nextX = player.x + stickX * player.speed;
            let nextY = player.y + stickY * player.speed;
            if (!checkCollision(nextX, nextY)) {
                player.history.push({x: player.x, y: player.y});
                if (player.history.length > 60) player.history.shift();
                player.x = nextX; player.y = nextY;
            }
        }
        const matX = width / 2;
        const matY = (currentMap === 'LAB') ? height - 30 : height / 2 + 10;
        if (Math.abs(player.x - matX) < 50 && Math.abs(player.y - matY) < 30) teleport();
        if (follower.active && player.history.length > 12) {
            const fp = player.history[player.history.length - 12];
            follower.x += (fp.x - follower.x) * 0.15; follower.y += (fp.y - follower.y) * 0.15;
        }
    }

    function draw() {
        ctx.clearRect(0, 0, width, height);

        if (currentMap === 'LAB') {
            // Lab Floor & Rug
            ctx.fillStyle = '#d89060'; ctx.fillRect(0, 0, width, height);
            ctx.fillStyle = '#b87040'; for(let i=0; i<width; i+=40) ctx.fillRect(i, 0, 2, height);
            
            // Lab Decorations (Mini Pixel Style)
            ctx.fillStyle = '#444'; ctx.fillRect(50, 50, 80, 40); // Computer desk
            ctx.fillStyle = '#0ff'; ctx.fillRect(60, 55, 20, 10); // Screen
            ctx.fillStyle = '#5d3a1a'; ctx.fillRect(width-130, 50, 80, 120); // Bookshelf
            ctx.fillStyle = '#a63d3d'; ctx.fillRect(width-125, 60, 70, 5); // Books row
            
            const dW = 350, dH = 100, dX = width/2 - dW/2, dY = height/2.5;
            ctx.fillStyle = '#804020'; ctx.fillRect(dX, dY, dW, dH);
            
            pokemons.forEach((p, i) => {
                if (!p.active) return;
                p.realX = dX + 60 + (i * 110); p.realY = dY + 40;
                drawMiniPokemon(p.realX, p.realY, p.name);
                ctx.fillStyle = 'white'; ctx.font = 'bold 10px Courier'; ctx.textAlign = 'center';
                ctx.fillText(p.name.toUpperCase(), p.realX, p.realY - 30);
            });
        } else {
            // OUTSIDE - FULL MINI PIXEL DECORATIONS
            ctx.fillStyle = '#83c47a'; ctx.fillRect(0, 0, width, height); // Grass
            
            // Path with dithered edge
            ctx.fillStyle = '#dfd38a'; ctx.fillRect(0, height/2 + 120, width, height);
            ctx.fillStyle = '#c5b76b'; for(let i=0; i<width; i+=10) { if(i%20==0) ctx.fillRect(i, height/2+118, 5, 5); }

            // Pond (Pixelated Edge)
            const wX = width/2 - 350, wY = height/2 - 50;
            ctx.fillStyle = '#8dcbe4'; ctx.fillRect(wX - 150, wY - 100, 300, 200);
            ctx.fillStyle = '#b7e4f7'; ctx.fillRect(wX - 130, wY - 80, 260, 160);

            // Perimeter Trees (Bushes)
            const fenceY = height/2 + 120;
            for(let x = 40; x < width; x += 80) {
                drawMiniBush(x, 40);
                if (x < 120 || x > width - 120) { for(let y = 120; y < fenceY - 40; y += 80) { drawMiniBush(x, y); } }
            }

            // Wooden Fence Posts
            ctx.fillStyle = '#c28d63'; for(let x=0; x<width; x+=35) { if(Math.abs(x - width/2) > 50) ctx.fillRect(x, fenceY-10, 10, 30); }

            // HOUSE - IMPROVED MINI PIXEL DESIGN
            const hX = width/2 - 110, hY = height/2 - 150;
            ctx.fillStyle = '#d2966a'; ctx.fillRect(hX, hY, 220, 150); // Walls
            ctx.fillStyle = '#9e623d'; for(let i=hY; i<hY+150; i+=15) ctx.fillRect(hX, i, 220, 2); // Wood Grain
            ctx.fillStyle = '#a63d3d'; ctx.fillRect(hX-10, hY-50, 240, 60); // Roof
            ctx.fillStyle = '#7a2d2d'; for(let i=hX-10; i<hX+230; i+=15) ctx.fillRect(i, hY-50, 2, 60); // Roof detail
            ctx.fillStyle = '#333'; ctx.fillRect(hX+180, hY-70, 20, 30); // Chimney
            
            ctx.fillStyle = '#fff'; ctx.fillRect(hX+30, hY+20, 40, 40); ctx.fillRect(hX+150, hY+20, 40, 40); // Windows
            ctx.fillStyle = '#add8e6'; ctx.fillRect(hX+35, hY+25, 30, 30); ctx.fillRect(hX+155, hY+25, 30, 30); // Glass
            
            ctx.fillStyle = '#2a75bb'; ctx.fillRect(width/2 - 30, height/2 - 45, 60, 45); // Door
            ctx.fillStyle = '#ffcb05'; ctx.fillRect(width/2 + 15, height/2 - 25, 5, 5); // Doorknob
        }

        if (follower.active) drawMiniPokemon(follower.x, follower.y, follower.name);
        drawMiniPlayer(player.x, player.y);
        
        update();
        requestAnimationFrame(draw);
    }
    draw();
</script>
</body>
</html>
