
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pokemon Adventure</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background: #000;
    font-family: 'Arial', sans-serif;
    overflow: hidden;
    color: #fff;
}

canvas {
    display: block;
}

/* Login Screen */
#loginScreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a237e 0%, #283593 50%, #3949ab 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.login-container {
    background: rgba(0, 0, 0, 0.8);
    border: 4px solid #ffd700;
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    max-width: 400px;
    width: 90%;
}

.login-title {
    color: #ffd700;
    font-size: 28px;
    margin-bottom: 20px;
}

.login-input {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid #ffd700;
    border-radius: 8px;
    color: white;
    font-size: 16px;
}

.login-btn {
    background: linear-gradient(to bottom, #ff4444, #cc0000);
    color: white;
    border: none;
    padding: 12px 30px;
    margin: 10px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
}

.login-btn:hover {
    transform: scale(1.05);
}

.new-game-btn {
    background: linear-gradient(to bottom, #4a90e2, #2c6cb0);
}

/* Joystick */
#joyBase {
    position: fixed;
    bottom: 30px;
    left: 30px;
    width: 100px;
    height: 100px;
    background: rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.4);
    border-radius: 50%;
    z-index: 100;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    touch-action: none;
}

#joy {
    position: absolute;
    width: 40px;
    height: 40px;
    left: 30px;
    top: 30px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    border: 2px solid rgba(100, 100, 255, 0.8);
    box-shadow: 0 0 10px rgba(100, 100, 255, 0.5);
    transition: transform 0.1s;
    touch-action: none;
}

/* Battle UI */
#battle {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, #1a5f7a, #0a3d62);
    color: white;
    display: none;
    z-index: 1000;
    font-family: 'Arial', sans-serif;
}

.battle-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 20px;
    box-sizing: border-box;
}

.enemy-area {
    flex: 1;
    display: flex;
    justify-content: flex-end;
    align-items: flex-start;
    padding-top: 40px;
}

.player-area {
    flex: 1;
    display: flex;
    justify-content: flex-start;
    align-items: flex-end;
    padding-bottom: 40px;
}

.hp-bar {
    width: 200px;
    height: 20px;
    background: #333;
    border: 2px solid #fff;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}

.hp-fill {
    height: 100%;
    background: linear-gradient(to right, #ff4444, #ffaa44);
    transition: width 0.3s;
    width: 100%;
}

.battle-menu {
    background: rgba(0, 0, 0, 0.8);
    border: 3px solid #fff;
    border-radius: 10px;
    padding: 15px;
    margin-top: 20px;
    display: none;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    max-width: 300px;
    align-self: center;
}

.battle-menu button {
    background: linear-gradient(to bottom, #4a90e2, #2c6cb0);
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: bold;
}

.battle-menu button:hover {
    background: linear-gradient(to bottom, #5a9cf2, #3c7cd0);
    transform: translateY(-2px);
}

#battleLog {
    background: rgba(0, 0, 0, 0.7);
    border: 2px solid #fff;
    border-radius: 10px;
    padding: 15px;
    margin: 20px 0;
    min-height: 60px;
    font-size: 18px;
    color: #fff;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Dialog Box */
#dialogBox {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 600px;
    background: rgba(0, 0, 0, 0.9);
    border: 3px solid #fff;
    border-radius: 15px;
    padding: 20px;
    color: white;
    font-size: 18px;
    z-index: 2000;
    display: none;
}

#dialogText {
    margin-bottom: 15px;
    min-height: 60px;
    line-height: 1.5;
}

#dialogOptions {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}

.dialog-option {
    background: linear-gradient(to bottom, #4a90e2, #2c6cb0);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 120px;
}

.dialog-option:hover {
    background: linear-gradient(to bottom, #5a9cf2, #3c7cd0);
    transform: translateY(-2px);
}

/* Starter Selection */
#starterSelection {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 500px;
    background: rgba(0, 0, 0, 0.95);
    border: 4px solid #fff;
    border-radius: 20px;
    padding: 30px;
    color: white;
    z-index: 3000;
    display: none;
    text-align: center;
}

.starter-title {
    color: #ffd700;
    font-size: 28px;
    margin-bottom: 20px;
}

.starter-options {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 30px 0;
    flex-wrap: wrap;
}

.starter-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s;
    width: 120px;
    border: 2px solid transparent;
}

.starter-card:hover {
    transform: translateY(-10px);
    background: rgba(255, 255, 255, 0.2);
    border-color: #fff;
}

.starter-card.selected {
    border-color: #ffd700;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
}

.starter-name {
    font-size: 20px;
    margin: 10px 0;
    font-weight: bold;
}

/* Animation for attacks */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

@keyframes flash {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.shake { animation: shake 0.3s; }
.flash { animation: flash 0.3s; }
.float { animation: float 2s infinite; }

/* HUD */
#hud {
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 10px 15px;
    border-radius: 10px;
    border: 2px solid #fff;
    font-size: 14px;
    z-index: 50;
}

.enemy-info, .player-info {
    background: rgba(0, 0, 0, 0.6);
    padding: 10px 20px;
    border-radius: 10px;
    border: 2px solid #fff;
}

.battle-sprite {
    width: 100px;
    height: 100px;
    margin: 0 20px;
}

/* Inventory */
#inventory {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 700px;
    max-height: 80vh;
    background: rgba(0, 0, 0, 0.95);
    border: 4px solid #fff;
    border-radius: 20px;
    padding: 20px;
    color: white;
    z-index: 4000;
    display: none;
    overflow-y: auto;
}

.inventory-title {
    color: #ffd700;
    font-size: 24px;
    text-align: center;
    margin-bottom: 20px;
}

.inventory-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    justify-content: center;
}

.inventory-tab {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
}

.inventory-tab.active {
    background: #4a90e2;
}

.pokemon-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.pokemon-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}

.pokemon-card:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-5px);
}

.pokemon-card.active {
    border: 2px solid #ffd700;
    background: rgba(255, 215, 0, 0.1);
}

.item-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.item-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    text-align: center;
}

.shop-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.shop-item {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    text-align: center;
}

.shop-item button {
    background: linear-gradient(to bottom, #4a90e2, #2c6cb0);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 10px;
    width: 100%;
}

.sell-btn {
    background: linear-gradient(to bottom, #ff6b6b, #cc4444) !important;
    margin-top: 10px;
}

/* Controls */
#controls {
    position: fixed;
    bottom: 30px;
    right: 30px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 100;
}

.control-btn {
    background: rgba(0, 0, 0, 0.5);
    border: 2px solid rgba(255, 255, 255, 0.4);
    color: white;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.2s;
}

.control-btn:hover {
    background: rgba(0, 0, 0, 0.7);
    transform: scale(1.1);
}
</style>
</head>

<body>
<canvas id="game"></canvas>
<div id="joyBase"><div id="joy"></div></div>
<div id="hud"></div>

<!-- Login Screen -->
<div id="loginScreen">
    <div class="login-container">
        <div class="login-title">POKÃ‰MON ADVENTURE</div>
        <input type="text" id="username" class="login-input" placeholder="Enter Trainer Name" maxlength="12">
        <div style="margin: 20px 0;">
            <button class="login-btn" onclick="loadGame()">CONTINUE</button>
            <button class="login-btn new-game-btn" onclick="newGame()">NEW GAME</button>
        </div>
    </div>
</div>

<!-- Controls -->
<div id="controls">
    <div class="control-btn" onclick="toggleInventory()">ðŸ“¦</div>
    <div class="control-btn" onclick="switchPokemon()">ðŸ”„</div>
</div>

<!-- Starter Selection -->
<div id="starterSelection">
    <div class="starter-title">CHOOSE YOUR STARTER POKÃ‰MON!</div>
    <p>Select your first PokÃ©mon to begin your journey.</p>
    <div class="starter-options">
        <div class="starter-card" onclick="selectStarter('bulbasaur')" data-type="bulbasaur">
            <div class="starter-name" style="color: #78c850">Bulbasaur</div>
            <div class="starter-type">Grass/Poison</div>
        </div>
        <div class="starter-card" onclick="selectStarter('charmander')" data-type="charmander">
            <div class="starter-name" style="color: #f08030">Charmander</div>
            <div class="starter-type">Fire</div>
        </div>
        <div class="starter-card" onclick="selectStarter('squirtle')" data-type="squirtle">
            <div class="starter-name" style="color: #6890f0">Squirtle</div>
            <div class="starter-type">Water</div>
        </div>
    </div>
    <button onclick="confirmStarter()" style="margin-top: 20px; padding: 10px 30px; font-size: 18px;">START ADVENTURE!</button>
</div>

<!-- Dialog Box -->
<div id="dialogBox">
    <div id="dialogText"></div>
    <div id="dialogOptions"></div>
</div>

<!-- Inventory -->
<div id="inventory">
    <div class="inventory-title">INVENTORY</div>
    <div class="inventory-tabs">
        <button class="inventory-tab active" onclick="showInventoryTab('pokemon')">POKÃ‰MON (0)</button>
        <button class="inventory-tab" onclick="showInventoryTab('items')">ITEMS</button>
        <button class="inventory-tab" onclick="showInventoryTab('shop')">SHOP</button>
    </div>
    
    <div id="pokemonTab" class="inventory-content active">
        <div class="pokemon-grid" id="pokemonGrid"></div>
        <button onclick="closeInventory()" style="margin-top: 20px; padding: 10px 20px; width: 100%;">CLOSE</button>
    </div>
    
    <div id="itemsTab" class="inventory-content">
        <div class="item-grid" id="itemGrid"></div>
        <button onclick="closeInventory()" style="margin-top: 20px; padding: 10px 20px; width: 100%;">CLOSE</button>
    </div>
    
    <div id="shopTab" class="inventory-content">
        <div style="text-align: center; margin-bottom: 20px;">
            <h3>POKÃ‰MON CENTER SHOP</h3>
            <p>COINS: <span id="coinCount">100</span> <span style="color: gold">ðŸª™</span></p>
        </div>
        <div class="shop-grid" id="shopGrid"></div>
        <button onclick="closeInventory()" style="margin-top: 20px; padding: 10px 20px; width: 100%;">CLOSE</button>
    </div>
</div>

<!-- Battle UI -->
<div id="battle">
    <div class="battle-container">
        <div class="enemy-area">
            <div class="enemy-info">
                <h2 id="enemyName">Wild PokÃ©mon</h2>
                <div class="hp-bar">
                    <div id="enemyHPFill" class="hp-fill"></div>
                </div>
                <div id="enemyHPText">HP: 20/20</div>
            </div>
            <div id="enemySprite" class="battle-sprite"></div>
        </div>
        
        <div id="battleLog">A wild PokÃ©mon appeared!</div>
        
        <div class="player-area">
            <div id="playerSprite" class="battle-sprite"></div>
            <div class="player-info">
                <h2 id="playerPokemonName">Bulbasaur</h2>
                <div class="hp-bar">
                    <div id="playerHPFill" class="hp-fill"></div>
                </div>
                <div id="playerHPText">HP: 30/30</div>
            </div>
        </div>
        
        <div class="battle-menu" id="battleMenu">
            <button onclick="showAttackMenu()">FIGHT</button>
            <button onclick="showPokemonMenu()">POKÃ‰MON</button>
            <button onclick="showItemMenu()">ITEM</button>
            <button onclick="run()">RUN</button>
        </div>
        
        <div class="battle-menu" id="attackMenu" style="display: none;">
            <button class="attack-btn" onclick="useAttack(0)">Tackle</button>
            <button class="attack-btn" onclick="useAttack(1)">Growl</button>
            <button class="attack-btn" onclick="useAttack(2)">Vine Whip</button>
            <button class="attack-btn" onclick="useAttack(3)">Leech Seed</button>
            <button class="back-btn" onclick="showBattleMenu()">Back</button>
        </div>
        
        <div class="battle-menu" id="pokemonMenu" style="display: none;"></div>
        <div class="battle-menu" id="itemMenu" style="display: none;"></div>
    </div>
</div>

<script>
// Initialize canvas
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// Set canvas size
function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Game constants
const TILE = 64;
const GRASS_COLORS = ['#5dbb63', '#6fcf97', '#57a773'];

// Game state
let world = "outside";
let inBattle = false;
let inDialog = false;
let inInventory = false;
let gameTime = 0;
let playerPokemon = null;
let starterChosen = false;
let coins = 100;
let playerName = "";
let currentSaveSlot = "";

// Player inventory
let inventory = {
    pokemon: [],
    items: {
        potions: 3,
        pokeballs: 5,
        superPotions: 0,
        greatBalls: 0
    }
};

// Player
const player = {
    x: 0,
    y: 0,
    size: 24,
    speed: 3,
    direction: 0,
    animationFrame: 0
};

// Camera
const cam = { x: 0, y: 0 };

// PokÃ©mon data
const pokemonData = {
    bulbasaur: {
        id: "bulbasaur",
        name: "Bulbasaur",
        type: "Grass/Poison",
        color: "#78c850",
        hp: 30,
        maxHp: 30,
        level: 5,
        exp: 0,
        expToNext: 50,
        attacks: [
            { name: "Tackle", damage: 4, type: "Normal" },
            { name: "Growl", damage: 0, type: "Status", effect: "attackDown" },
            { name: "Vine Whip", damage: 7, type: "Grass" },
            { name: "Leech Seed", damage: 2, type: "Grass", effect: "drain" }
        ],
        spriteColor: "#78c850",
        price: 50
    },
    charmander: {
        id: "charmander",
        name: "Charmander",
        type: "Fire",
        color: "#f08030",
        hp: 28,
        maxHp: 28,
        level: 5,
        exp: 0,
        expToNext: 50,
        attacks: [
            { name: "Scratch", damage: 4, type: "Normal" },
            { name: "Growl", damage: 0, type: "Status", effect: "attackDown" },
            { name: "Ember", damage: 7, type: "Fire" },
            { name: "Smokescreen", damage: 0, type: "Status", effect: "accuracyDown" }
        ],
        spriteColor: "#f08030",
        price: 50
    },
    squirtle: {
        id: "squirtle",
        name: "Squirtle",
        type: "Water",
        color: "#6890f0",
        hp: 32,
        maxHp: 32,
        level: 5,
        exp: 0,
        expToNext: 50,
        attacks: [
            { name: "Tackle", damage: 4, type: "Normal" },
            { name: "Tail Whip", damage: 0, type: "Status", effect: "defenseDown" },
            { name: "Water Gun", damage: 7, type: "Water" },
            { name: "Withdraw", damage: 0, type: "Status", effect: "defenseUp" }
        ],
        spriteColor: "#6890f0",
        price: 50
    },
    // Wild PokÃ©mon
    pikachu: {
        id: "pikachu",
        name: "Pikachu",
        type: "Electric",
        color: "#ffd700",
        hp: 25,
        maxHp: 25,
        level: 4,
        exp: 0,
        expToNext: 40,
        attacks: [
            { name: "Thunder Shock", damage: 6, type: "Electric" },
            { name: "Quick Attack", damage: 4, type: "Normal" }
        ],
        spriteColor: "#ffd700",
        price: 40
    },
    rattata: {
        id: "rattata",
        name: "Rattata",
        type: "Normal",
        color: "#a8a878",
        hp: 22,
        maxHp: 22,
        level: 3,
        exp: 0,
        expToNext: 30,
        attacks: [
            { name: "Tackle", damage: 4, type: "Normal" },
            { name: "Quick Attack", damage: 4, type: "Normal" }
        ],
        spriteColor: "#a8a878",
        price: 30
    },
    pidgey: {
        id: "pidgey",
        name: "Pidgey",
        type: "Normal/Flying",
        color: "#a890f0",
        hp: 24,
        maxHp: 24,
        level: 3,
        exp: 0,
        expToNext: 30,
        attacks: [
            { name: "Gust", damage: 5, type: "Flying" },
            { name: "Sand Attack", damage: 0, type: "Status", effect: "accuracyDown" }
        ],
        spriteColor: "#a890f0",
        price: 30
    }
};

// Terrain details
const terrainDetails = [];
for(let i = 0; i < 50; i++) {
    terrainDetails.push({
        x: Math.random() * 1200 - 600,
        y: Math.random() * 1200 - 600,
        type: Math.random() > 0.5 ? 'flower' : 'bush',
        color: ['#ff6b9d', '#ffd166', '#06d6a0', '#118ab2'][Math.floor(Math.random() * 4)],
        size: Math.random() * 8 + 4
    });
}

// Buildings
const buildings = [
    { x: 300, y: 0, type: "house", width: 80, height: 60 },
    { x: -300, y: 0, type: "center", width: 100, height: 60 }
];

// Battle system
let enemyPokemon = null;
let battleState = "menu";

// Login and Save System
function loadGame() {
    playerName = document.getElementById("username").value.trim() || "Trainer";
    if (!playerName) {
        alert("Please enter a trainer name!");
        return;
    }
    
    // Check for existing save
    const saveData = localStorage.getItem(`pokemon_save_${playerName}`);
    if (saveData) {
        const data = JSON.parse(saveData);
        
        playerName = data.playerName;
        world = data.world || "outside";
        player.x = data.playerX || 0;
        player.y = data.playerY || 0;
        inventory = data.inventory || { pokemon: [], items: { potions: 3, pokeballs: 5 } };
        playerPokemon = data.playerPokemon;
        coins = data.coins || 100;
        starterChosen = data.starterChosen || false;
        
        document.getElementById('loginScreen').style.display = 'none';
        updateHUD();
        
        if (!starterChosen) {
            document.getElementById('starterSelection').style.display = 'block';
        } else {
            showDialog(`Welcome back, ${playerName}!`);
        }
    } else {
        alert("No save found for this name. Start a new game!");
    }
}

function newGame() {
    playerName = document.getElementById("username").value.trim() || "Trainer";
    if (!playerName) {
        alert("Please enter a trainer name!");
        return;
    }
    
    // Reset game state
    world = "outside";
    player.x = 0;
    player.y = 0;
    inventory = {
        pokemon: [],
        items: { potions: 3, pokeballs: 5, superPotions: 0, greatBalls: 0 }
    };
    coins = 100;
    starterChosen = false;
    
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('starterSelection').style.display = 'block';
}

function saveGame() {
    const saveData = {
        playerName: playerName,
        world: world,
        playerX: player.x,
        playerY: player.y,
        inventory: inventory,
        playerPokemon: playerPokemon,
        coins: coins,
        starterChosen: starterChosen,
        timestamp: Date.now()
    };
    
    localStorage.setItem(`pokemon_save_${playerName}`, JSON.stringify(saveData));
    showDialog("Game saved!");
}

// Auto-save every 30 seconds
setInterval(() => {
    if (starterChosen) {
        saveGame();
    }
}, 30000);

// Joystick
let joyX = 0, joyY = 0, drag = false;
const base = document.getElementById("joyBase");
const stick = document.getElementById("joy");

base.addEventListener('mousedown', startDrag);
base.addEventListener('touchstart', startDrag);
window.addEventListener('mouseup', endDrag);
window.addEventListener('touchend', endDrag);
window.addEventListener('mousemove', handleMove);
window.addEventListener('touchmove', handleMove);

function startDrag(e) {
    e.preventDefault();
    drag = true;
    updateJoy(e);
}

function endDrag() {
    drag = false;
    joyX = joyY = 0;
    stick.style.transform = 'translate(0, 0)';
    player.animationFrame = 0;
}

function handleMove(e) {
    if (!drag) return;
    updateJoy(e);
}

function updateJoy(e) {
    const rect = base.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : e;
    
    let x = touch.clientX - rect.left - 50;
    let y = touch.clientY - rect.top - 50;
    
    const distance = Math.sqrt(x * x + y * y);
    const maxDistance = 50;
    
    if (distance > maxDistance) {
        x = (x / distance) * maxDistance;
        y = (y / distance) * maxDistance;
    }
    
    joyX = x / maxDistance;
    joyY = y / maxDistance;
    
    stick.style.transform = `translate(${x}px, ${y}px)`;
    
    // Update player direction
    if (Math.abs(joyX) > Math.abs(joyY)) {
        player.direction = joyX > 0 ? 2 : 1;
    } else {
        player.direction = joyY > 0 ? 0 : 3;
    }
}

// Dialog System
function showDialog(text, options = []) {
    inDialog = true;
    document.getElementById("dialogText").textContent = text;
    const optionsDiv = document.getElementById("dialogOptions");
    optionsDiv.innerHTML = '';
    
    if (options.length === 0) {
        const continueBtn = document.createElement("button");
        continueBtn.className = "dialog-option";
        continueBtn.textContent = "Continue";
        continueBtn.onclick = closeDialog;
        optionsDiv.appendChild(continueBtn);
    } else {
        options.forEach(option => {
            const btn = document.createElement("button");
            btn.className = "dialog-option";
            btn.textContent = option.text;
            btn.onclick = option.action;
            optionsDiv.appendChild(btn);
        });
    }
    
    document.getElementById("dialogBox").style.display = "block";
}

function closeDialog() {
    inDialog = false;
    document.getElementById("dialogBox").style.display = "none";
}

// Inventory System
function toggleInventory() {
    if (inBattle || inDialog || !starterChosen) return;
    
    inInventory = !inInventory;
    if (inInventory) {
        updateInventory();
        document.getElementById("inventory").style.display = "block";
    } else {
        document.getElementById("inventory").style.display = "none";
    }
}

function closeInventory() {
    inInventory = false;
    document.getElementById("inventory").style.display = "none";
}

function showInventoryTab(tabName) {
    document.querySelectorAll('.inventory-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.inventory-content').forEach(content => {
        content.classList.remove('active');
    });
    
    document.querySelector(`button[onclick="showInventoryTab('${tabName}')"]`).classList.add('active');
    document.getElementById(`${tabName}Tab`).classList.add('active');
    
    if (tabName === 'pokemon') {
        updatePokemonTab();
    } else if (tabName === 'items') {
        updateItemsTab();
    } else if (tabName === 'shop') {
        updateShopTab();
    }
}

function updateInventory() {
    updatePokemonTab();
    updateItemsTab();
    updateShopTab();
}

function updatePokemonTab() {
    const pokemonGrid = document.getElementById("pokemonGrid");
    pokemonGrid.innerHTML = '';
    
    const pokemonTab = document.querySelector('button[onclick="showInventoryTab(\'pokemon\')"]');
    pokemonTab.textContent = `POKÃ‰MON (${inventory.pokemon.length})`;
    
    inventory.pokemon.forEach((pokemon, index) => {
        const card = document.createElement("div");
        card.className = "pokemon-card";
        if (pokemon === playerPokemon) {
            card.classList.add("active");
        }
        
        card.innerHTML = `
            <h4 style="color: ${pokemon.color}">${pokemon.name}</h4>
            <p>Lv. ${pokemon.level}</p>
            <p>HP: ${pokemon.hp}/${pokemon.maxHp}</p>
            <p>Type: ${pokemon.type}</p>
            <button class="sell-btn" onclick="sellPokemon(${index})" ${pokemon === playerPokemon ? 'disabled' : ''}>Sell for ${Math.floor(pokemon.price * 0.7)} coins</button>
        `;
        
        card.onclick = () => selectActivePokemon(index);
        pokemonGrid.appendChild(card);
    });
}

function updateItemsTab() {
    const itemGrid = document.getElementById("itemGrid");
    itemGrid.innerHTML = `
        <div class="item-card">
            <h4>PokÃ©balls</h4>
            <p>${inventory.items.pokeballs}</p>
            <p>Catch wild PokÃ©mon</p>
        </div>
        <div class="item-card">
            <h4>Great Balls</h4>
            <p>${inventory.items.greatBalls}</p>
            <p>Better catch rate</p>
        </div>
        <div class="item-card">
            <h4>Potions</h4>
            <p>${inventory.items.potions}</p>
            <p>Heals 20 HP</p>
        </div>
        <div class="item-card">
            <h4>Super Potions</h4>
            <p>${inventory.items.superPotions}</p>
            <p>Heals 50 HP</p>
        </div>
    `;
}

function updateShopTab() {
    document.getElementById("coinCount").textContent = coins;
    
    const shopGrid = document.getElementById("shopGrid");
    shopGrid.innerHTML = `
        <div class="shop-item">
            <h4>PokÃ©ball</h4>
            <p>Price: 20 coins</p>
            <p>Catch wild PokÃ©mon</p>
            <button onclick="buyItem('pokeball')" ${coins < 20 ? 'disabled' : ''}>Buy</button>
        </div>
        <div class="shop-item">
            <h4>Great Ball</h4>
            <p>Price: 50 coins</p>
            <p>Better catch rate</p>
            <button onclick="buyItem('greatball')" ${coins < 50 ? 'disabled' : ''}>Buy</button>
        </div>
        <div class="shop-item">
            <h4>Potion</h4>
            <p>Price: 30 coins</p>
            <p>Heals 20 HP</p>
            <button onclick="buyItem('potion')" ${coins < 30 ? 'disabled' : ''}>Buy</button>
        </div>
        <div class="shop-item">
            <h4>Super Potion</h4>
            <p>Price: 70 coins</p>
            <p>Heals 50 HP</p>
            <button onclick="buyItem('superpotion')" ${coins < 70 ? 'disabled' : ''}>Buy</button>
        </div>
    `;
}

function buyItem(itemType) {
    const prices = {
        pokeball: 20,
        greatball: 50,
        potion: 30,
        superpotion: 70
    };
    
    if (coins >= prices[itemType]) {
        coins -= prices[itemType];
        
        switch(itemType) {
            case 'pokeball':
                inventory.items.pokeballs++;
                break;
            case 'greatball':
                inventory.items.greatBalls++;
                break;
            case 'potion':
                inventory.items.potions++;
                break;
            case 'superpotion':
                inventory.items.superPotions++;
                break;
        }
        
        updateShopTab();
        updateItemsTab();
        updateHUD();
        showDialog(`You bought a ${itemType === 'pokeball' ? 'PokÃ©ball' : 
                    itemType === 'greatball' ? 'Great Ball' : 
                    itemType === 'potion' ? 'Potion' : 'Super Potion'}!`);
    }
}

function sellPokemon(index) {
    if (index < 0 || index >= inventory.pokemon.length) return;
    
    const pokemon = inventory.pokemon[index];
    const sellPrice = Math.floor(pokemon.price * 0.7);
    
    coins += sellPrice;
    inventory.pokemon.splice(index, 1);
    
    if (pokemon === playerPokemon) {
        if (inventory.pokemon.length > 0) {
            playerPokemon = inventory.pokemon[0];
        } else {
            playerPokemon = null;
            showDialog("You have no PokÃ©mon left!");
        }
    }
    
    updateInventory();
    updateHUD();
    showDialog(`You sold ${pokemon.name} for ${sellPrice} coins!`);
}

function selectActivePokemon(index) {
    if (index < 0 || index >= inventory.pokemon.length) return;
    
    playerPokemon = inventory.pokemon[index];
    updateInventory();
    updateHUD();
    showDialog(`${playerPokemon.name} is now your active PokÃ©mon!`);
}

function switchPokemon() {
    if (inBattle || inDialog || !starterChosen) return;
    
    if (inventory.pokemon.length <= 1) {
        showDialog("You only have one PokÃ©mon!");
        return;
    }
    
    const options = inventory.pokemon.map((pokemon, index) => ({
        text: `${pokemon.name} (Lv. ${pokemon.level})`,
        action: () => {
            playerPokemon = pokemon;
            closeDialog();
            updateHUD();
            showDialog(`${pokemon.name} is now your active PokÃ©mon!`);
        }
    }));
    
    showDialog("Select a PokÃ©mon to switch to:", options);
}

// Starter Selection
let selectedStarter = null;

function selectStarter(type) {
    selectedStarter = type;
    document.querySelectorAll('.starter-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelector(`[data-type="${type}"]`).classList.add('selected');
}

function confirmStarter() {
    if (!selectedStarter) {
        alert("Please select a starter PokÃ©mon!");
        return;
    }
    
    const starterData = pokemonData[selectedStarter];
    playerPokemon = JSON.parse(JSON.stringify(starterData));
    inventory.pokemon.push(playerPokemon);
    
    starterChosen = true;
    document.getElementById("starterSelection").style.display = "none";
    
    showDialog(`Congratulations! You chose ${playerPokemon.name}!`, [
        { text: "Begin!", action: () => {
            closeDialog();
            updateHUD();
            showDialog(`Welcome, ${playerName}! Explore the world, catch wild PokÃ©mon, and visit the PokÃ©mon Center.`);
        }}
    ]);
}

// Battle functions
function startBattle() {
    const wildPokemon = Math.random();
    if (wildPokemon < 0.33) {
        enemyPokemon = JSON.parse(JSON.stringify(pokemonData.pikachu));
    } else if (wildPokemon < 0.66) {
        enemyPokemon = JSON.parse(JSON.stringify(pokemonData.rattata));
    } else {
        enemyPokemon = JSON.parse(JSON.stringify(pokemonData.pidgey));
    }
    
    inBattle = true;
    battleState = "menu";
    
    document.getElementById("battle").style.display = "block";
    document.getElementById("enemyName").textContent = "Wild " + enemyPokemon.name;
    document.getElementById("enemyName").style.color = enemyPokemon.color;
    document.getElementById("playerPokemonName").textContent = playerPokemon.name;
    document.getElementById("playerPokemonName").style.color = playerPokemon.color;
    
    updateBattleText();
    createBattleSprites();
    
    setTimeout(() => {
        showBattleMenu();
        addBattleLog(`A wild ${enemyPokemon.name} appeared!`);
    }, 1000);
}

function updateBattleText() {
    const enemyPercent = Math.max(0, (enemyPokemon.hp / enemyPokemon.maxHp) * 100);
    const playerPercent = Math.max(0, (playerPokemon.hp / playerPokemon.maxHp) * 100);
    
    document.getElementById("enemyHPFill").style.width = enemyPercent + "%";
    document.getElementById("playerHPFill").style.width = playerPercent + "%";
    
    document.getElementById("enemyHPText").textContent = `HP: ${Math.max(0, enemyPokemon.hp)}/${enemyPokemon.maxHp}`;
    document.getElementById("playerHPText").textContent = `HP: ${Math.max(0, playerPokemon.hp)}/${playerPokemon.maxHp}`;
}

function createBattleSprites() {
    const enemySprite = document.getElementById("enemySprite");
    const playerSprite = document.getElementById("playerSprite");
    
    enemySprite.innerHTML = '';
    playerSprite.innerHTML = '';
    
    const enemyCanvas = document.createElement('canvas');
    enemyCanvas.width = 100;
    enemyCanvas.height = 100;
    const enemyCtx = enemyCanvas.getContext('2d');
    drawPokemonSprite(enemyCtx, 50, 50, enemyPokemon, 1.5);
    enemySprite.appendChild(enemyCanvas);
    
    const playerCanvas = document.createElement('canvas');
    playerCanvas.width = 100;
    playerCanvas.height = 100;
    const playerCtx = playerCanvas.getContext('2d');
    drawPokemonSprite(playerCtx, 50, 50, playerPokemon, 1.5);
    playerSprite.appendChild(playerCanvas);
}

function drawPokemonSprite(ctx, x, y, pokemon, scale = 1) {
    ctx.save();
    ctx.translate(x, y);
    ctx.scale(scale, scale);
    
    switch(pokemon.name) {
        case "Bulbasaur":
            ctx.fillStyle = pokemon.spriteColor;
            ctx.beginPath();
            ctx.arc(0, 0, 15, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = "#a8e6a8";
            ctx.beginPath();
            ctx.arc(0, -12, 8, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = "#000";
            ctx.fillRect(-6, -3, 3, 5);
            ctx.fillRect(3, -3, 3, 5);
            break;
            
        case "Charmander":
            ctx.fillStyle = pokemon.spriteColor;
            ctx.beginPath();
            ctx.arc(0, 0, 15, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = "#ff4444";
            ctx.beginPath();
            ctx.arc(15, -5, 6, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = "#000";
            ctx.fillRect(-6, -3, 3, 5);
            ctx.fillRect(3, -3, 3, 5);
            break;
            
        case "Squirtle":
            ctx.fillStyle = pokemon.spriteColor;
            ctx.beginPath();
            ctx.arc(0, 0, 15, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = "#a0522d";
            ctx.beginPath();
            ctx.arc(0, 0, 12, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = "#000";
            ctx.fillRect(-6, -3, 3, 5);
            ctx.fillRect(3, -3, 3, 5);
            break;
    }
    
    ctx.restore();
}

function addBattleLog(message) {
    document.getElementById("battleLog").textContent = message;
}

function showBattleMenu() {
    battleState = "menu";
    document.getElementById("battleMenu").style.display = "grid";
    document.getElementById("attackMenu").style.display = "none";
    document.getElementById("pokemonMenu").style.display = "none";
    document.getElementById("itemMenu").style.display = "none";
}

function showAttackMenu() {
    battleState = "attack";
    document.getElementById("battleMenu").style.display = "none";
    document.getElementById("attackMenu").style.display = "grid";
}

function showPokemonMenu() {
    battleState = "pokemon";
    document.getElementById("battleMenu").style.display = "none";
    document.getElementById("pokemonMenu").style.display = "grid";
    
    const pokemonMenu = document.getElementById("pokemonMenu");
    pokemonMenu.innerHTML = '<div style="grid-column: span 2; text-align: center; margin-bottom: 10px;"><p>Select a PokÃ©mon to switch to:</p></div>';
    
    inventory.pokemon.forEach((pokemon, index) => {
        if (pokemon.hp > 0 && pokemon !== playerPokemon) {
            const btn = document.createElement("button");
            btn.className = "attack-btn";
            btn.textContent = `${pokemon.name} (HP: ${pokemon.hp}/${pokemon.maxHp})`;
            btn.onclick = () => switchInBattle(index);
            pokemonMenu.appendChild(btn);
        }
    });
    
    const backBtn = document.createElement("button");
    backBtn.className = "back-btn";
    backBtn.textContent = "Back";
    backBtn.onclick = showBattleMenu;
    pokemonMenu.appendChild(backBtn);
}

function showItemMenu() {
    battleState = "item";
    document.getElementById("battleMenu").style.display = "none";
    document.getElementById("itemMenu").style.display = "grid";
    
    const itemMenu = document.getElementById("itemMenu");
    itemMenu.innerHTML = '<div style="grid-column: span 2; text-align: center; margin-bottom: 10px;"><p>Select an item to use:</p></div>';
    
    if (inventory.items.potions > 0) {
        const btn = document.createElement("button");
        btn.className = "attack-btn";
        btn.textContent = `Potion (${inventory.items.potions})`;
        btn.onclick = () => useItemInBattle('potion');
        itemMenu.appendChild(btn);
    }
    
    if (inventory.items.superPotions > 0) {
        const btn = document.createElement("button");
        btn.className = "attack-btn";
        btn.textContent = `Super Potion (${inventory.items.superPotions})`;
        btn.onclick = () => useItemInBattle('superpotion');
        itemMenu.appendChild(btn);
    }
    
    const backBtn = document.createElement("button");
    backBtn.className = "back-btn";
    backBtn.textContent = "Back";
    backBtn.onclick = showBattleMenu;
    itemMenu.appendChild(backBtn);
}

function useItemInBattle(itemType) {
    let healAmount = 0;
    
    switch(itemType) {
        case 'potion':
            if (inventory.items.potions > 0) {
                inventory.items.potions--;
                healAmount = 20;
                addBattleLog(`Used a Potion!`);
            }
            break;
        case 'superpotion':
            if (inventory.items.superPotions > 0) {
                inventory.items.superPotions--;
                healAmount = 50;
                addBattleLog(`Used a Super Potion!`);
            }
            break;
    }
    
    if (healAmount > 0) {
        playerPokemon.hp = Math.min(playerPokemon.hp + healAmount, playerPokemon.maxHp);
        addBattleLog(`${playerPokemon.name} recovered ${healAmount} HP!`);
        updateBattleText();
        updateHUD();
        updateInventory();
        
        setTimeout(() => enemyAttack(), 1000);
    } else {
        addBattleLog("No items left!");
        showBattleMenu();
    }
}

function switchInBattle(index) {
    if (index < 0 || index >= inventory.pokemon.length) return;
    
    const newPokemon = inventory.pokemon[index];
    if (newPokemon.hp <= 0) {
        addBattleLog(`${newPokemon.name} has no HP left!`);
        return;
    }
    
    addBattleLog(`Come back, ${playerPokemon.name}!`);
    addBattleLog(`Go, ${newPokemon.name}!`);
    
    playerPokemon = newPokemon;
    document.getElementById("playerPokemonName").textContent = playerPokemon.name;
    document.getElementById("playerPokemonName").style.color = playerPokemon.color;
    
    createBattleSprites();
    updateBattleText();
    updateHUD();
    
    setTimeout(() => {
        showBattleMenu();
        setTimeout(() => enemyAttack(), 500);
    }, 1500);
}

function useAttack(index) {
    if (!playerPokemon.attacks[index]) return;
    
    const attack = playerPokemon.attacks[index];
    let damage = attack.damage;
    
    damage += Math.floor(Math.random() * 3) - 1;
    if (damage < 0) damage = 0;
    
    enemyPokemon.hp -= damage;
    
    document.getElementById("enemySprite").classList.add('shake');
    document.getElementById("enemyHPFill").classList.add('flash');
    
    addBattleLog(`${playerPokemon.name} used ${attack.name}!`);
    if (damage > 0) {
        addBattleLog(`It did ${damage} damage!`);
    }
    
    updateBattleText();
    
    setTimeout(() => {
        document.getElementById("enemySprite").classList.remove('shake');
        document.getElementById("enemyHPFill").classList.remove('flash');
        
        if (enemyPokemon.hp <= 0) {
            addBattleLog(`Wild ${enemyPokemon.name} fainted!`);
            giveExp();
            setTimeout(() => endBattle(true), 1500);
            return;
        }
        
        setTimeout(() => enemyAttack(), 800);
    }, 500);
}

function giveExp() {
    const expGain = enemyPokemon.level * 10;
    playerPokemon.exp += expGain;
    addBattleLog(`${playerPokemon.name} gained ${expGain} EXP!`);
    
    if (playerPokemon.exp >= playerPokemon.expToNext) {
        playerPokemon.level++;
        playerPokemon.exp = 0;
        playerPokemon.expToNext = playerPokemon.level * 20;
        playerPokemon.maxHp += 5;
        playerPokemon.hp = playerPokemon.maxHp;
        
        addBattleLog(`${playerPokemon.name} grew to Level ${playerPokemon.level}!`);
    }
}

function enemyAttack() {
    const attackIndex = Math.floor(Math.random() * enemyPokemon.attacks.length);
    const attack = enemyPokemon.attacks[attackIndex];
    let damage = attack.damage;
    
    damage += Math.floor(Math.random() * 3) - 1;
    if (damage < 0) damage = 0;
    
    playerPokemon.hp -= damage;
    
    document.getElementById("playerSprite").classList.add('shake');
    document.getElementById("playerHPFill").classList.add('flash');
    
    addBattleLog(`Wild ${enemyPokemon.name} used ${attack.name}!`);
    if (damage > 0) {
        addBattleLog(`It did ${damage} damage!`);
    }
    
    updateBattleText();
    updateHUD();
    updateInventory();
    
    setTimeout(() => {
        document.getElementById("playerSprite").classList.remove('shake');
        document.getElementById("playerHPFill").classList.remove('flash');
        
        if (playerPokemon.hp <= 0) {
            addBattleLog(`${playerPokemon.name} fainted!`);
            
            const alivePokemon = inventory.pokemon.filter(p => p.hp > 0);
            if (alivePokemon.length > 0) {
                addBattleLog("Select another PokÃ©mon!");
                showPokemonMenu();
            } else {
                setTimeout(() => endBattle(false), 1500);
            }
        } else {
            showBattleMenu();
        }
    }, 500);
}

function run() {
    const runChance = 0.7;
    if (Math.random() < runChance) {
        addBattleLog("Got away safely!");
        setTimeout(() => endBattle(false), 1000);
    } else {
        addBattleLog("Couldn't escape!");
        setTimeout(() => enemyAttack(), 800);
    }
}

function endBattle(victory) {
    inBattle = false;
    document.getElementById("battle").style.display = "none";
    showBattleMenu();
    
    if (!victory && inventory.pokemon.filter(p => p.hp > 0).length === 0) {
        showDialog(`All your PokÃ©mon fainted!`, [
            { text: "OK", action: () => {
                closeDialog();
                player.x = buildings[1].x;
                player.y = buildings[1].y + 100;
                inventory.pokemon.forEach(p => p.hp = p.maxHp);
                updateHUD();
                updateInventory();
            }}
        ]);
    }
}

function updateHUD() {
    if (!playerPokemon) return;
    
    document.getElementById("hud").innerHTML = 
        `${playerPokemon.name} Lv.${playerPokemon.level}<br>` +
        `HP: ${playerPokemon.hp}/${playerPokemon.maxHp}<br>` +
        `PokÃ©balls: ${inventory.items.pokeballs}<br>` +
        `Potions: ${inventory.items.potions}<br>` +
        `Coins: ${coins} ðŸª™`;
}

// Drawing functions
function drawPlayer() {
    ctx.save();
    ctx.translate(canvas.width / 2, canvas.height / 2);
    
    // Player character (trainer) - NO CROSS
    ctx.fillStyle = '#ff4444'; // Red hat
    ctx.fillRect(-8, -20, 16, 8);
    
    ctx.fillStyle = '#2c8bff'; // Blue shirt
    ctx.fillRect(-10, -12, 20, 16);
    
    ctx.fillStyle = '#000'; // Pants
    ctx.fillRect(-10, 4, 20, 8);
    
    // Face
    ctx.fillStyle = '#ffcc99';
    ctx.beginPath();
    ctx.arc(0, -15, 6, 0, Math.PI * 2);
    ctx.fill();
    
    // Hair
    ctx.fillStyle = '#8b4513';
    ctx.fillRect(-8, -22, 16, 8);
    
    // Legs with walking animation
    let legOffset = 0;
    if ((joyX !== 0 || joyY !== 0) && !inBattle) {
        player.animationFrame = (player.animationFrame + 0.2) % 8;
        legOffset = Math.sin(player.animationFrame) * 3;
    }
    
    ctx.fillStyle = '#000';
    ctx.fillRect(-6, 12, 4, 8 + legOffset);
    ctx.fillRect(2, 12, 4, 8 - legOffset);
    
    ctx.restore();
}

function drawFollowingPokemon() {
    if (!playerPokemon || !starterChosen) return;
    
    ctx.save();
    const offsetX = player.direction === 1 ? -30 : player.direction === 2 ? 30 : 0;
    const offsetY = player.direction === 0 ? 20 : player.direction === 3 ? -20 : 0;
    
    const pokemonX = canvas.width / 2 + offsetX;
    const pokemonY = canvas.height / 2 + offsetY + Math.sin(gameTime * 0.1) * 2;
    
    drawPokemonSprite(ctx, pokemonX, pokemonY, playerPokemon, 0.8);
    ctx.restore();
}

function drawGrass() {
    const startX = Math.floor(cam.x / TILE);
    const endX = Math.ceil((cam.x + canvas.width) / TILE);
    const startY = Math.floor(cam.y / TILE);
    const endY = Math.ceil((cam.y + canvas.height) / TILE);
    
    for (let x = startX; x <= endX; x++) {
        for (let y = startY; y <= endY; y++) {
            const colorIndex = (x + y) % GRASS_COLORS.length;
            ctx.fillStyle = GRASS_COLORS[colorIndex];
            ctx.fillRect(x * TILE - cam.x, y * TILE - cam.y, TILE, TILE);
            
            if ((x + y) % 3 === 0) {
                ctx.fillStyle = '#3a7d34';
                ctx.fillRect(x * TILE - cam.x + 10, y * TILE - cam.y + 10, 3, 12);
                ctx.fillRect(x * TILE - cam.x + 20, y * TILE - cam.y + 15, 3, 8);
            }
        }
    }
}

function drawDetails() {
    terrainDetails.forEach(detail => {
        const dx = detail.x - cam.x;
        const dy = detail.y - cam.y;
        
        if (dx > -50 && dx < canvas.width + 50 && dy > -50 && dy < canvas.height + 50) {
            if (detail.type === 'flower') {
                ctx.fillStyle = '#2d5a27';
                ctx.fillRect(dx - 1, dy, 2, detail.size);
                
                ctx.fillStyle = detail.color;
                ctx.beginPath();
                ctx.arc(dx, dy - 5, 4, 0, Math.PI * 2);
                ctx.fill();
            } else {
                ctx.fillStyle = detail.color;
                ctx.beginPath();
                ctx.arc(dx, dy, detail.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }
    });
}

function drawBuilding(building) {
    const dx = building.x - cam.x;
    const dy = building.y - cam.y;
    
    if (building.type === "house") {
        ctx.fillStyle = '#a0522d';
        ctx.fillRect(dx - building.width/2, dy - building.height, building.width, building.height);
        
        ctx.fillStyle = '#8b4513';
        ctx.beginPath();
        ctx.moveTo(dx - building.width/2 - 10, dy - building.height);
        ctx.lineTo(dx, dy - building.height - 20);
        ctx.lineTo(dx + building.width/2 + 10, dy - building.height);
        ctx.closePath();
        ctx.fill();
        
        ctx.fillStyle = '#654321';
        ctx.fillRect(dx - 8, dy - 20, 16, 20);
        
        ctx.fillStyle = '#87CEEB';
        ctx.fillRect(dx - 25, dy - 40, 12, 12);
        ctx.fillRect(dx + 13, dy - 40, 12, 12);
        
    } else if (building.type === "center") {
        ctx.fillStyle = '#ff9999';
        ctx.fillRect(dx - building.width/2, dy - building.height, building.width, building.height);
        
        ctx.fillStyle = '#ff6b6b';
        ctx.fillRect(dx - building.width/2 - 5, dy - building.height - 10, building.width + 10, 10);
        
        ctx.fillStyle = '#87CEEB';
        for (let i = 0; i < 3; i++) {
            ctx.fillRect(dx - 35 + i * 25, dy - 40, 15, 15);
        }
        
        ctx.fillStyle = '#8b4513';
        ctx.fillRect(dx - 15, dy - 25, 30, 25);
    }
}

// Game loop functions
function update() {
    if (inBattle || inDialog || inInventory || !starterChosen) return;
    
    gameTime++;
    
    player.x += joyX * player.speed;
    player.y += joyY * player.speed;
    
    const BOUNDARY = 500;
    player.x = Math.max(-BOUNDARY, Math.min(BOUNDARY, player.x));
    player.y = Math.max(-BOUNDARY, Math.min(BOUNDARY, player.y));
    
    if (world === "outside") {
        buildings.forEach(building => {
            const dx = player.x - building.x;
            const dy = player.y - building.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < 50) {
                if (building.type === "house") {
                    world = "house";
                    player.x = 0;
                    player.y = 40;
                    showDialog("Welcome to the house! Rest here.");
                } else if (building.type === "center") {
                    world = "center";
                    player.x = 0;
                    player.y = 40;
                    inventory.pokemon.forEach(p => p.hp = p.maxHp);
                    updateHUD();
                    updateInventory();
                    showDialog("Welcome to the PokÃ©mon Center! Your PokÃ©mon have been healed!");
                }
            }
        });
    }
    
    if ((world === "house" || world === "center") && player.y > 100) {
        world = "outside";
        const buildingIndex = world === "house" ? 0 : 1;
        player.x = buildings[buildingIndex].x;
        player.y = buildings[buildingIndex].y + 80;
    }
    
    if (world === "outside" && Math.random() < 0.003 && joyX !== 0 && joyY !== 0) {
        startBattle();
    }
    
    cam.x += (player.x - canvas.width/2 - cam.x) * 0.1;
    cam.y += (player.y - canvas.height/2 - cam.y) * 0.1;
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (!inBattle && starterChosen) {
        if (world === "outside") {
            // Sky
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Clouds
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            for (let i = 0; i < 3; i++) {
                const cloudX = (cam.x * 0.2 + i * 200) % (canvas.width + 400) - 200;
                const cloudY = 50 + Math.sin(gameTime * 0.001 + i) * 20;
                ctx.beginPath();
                ctx.arc(cloudX, cloudY, 20, 0, Math.PI * 2);
                ctx.arc(cloudX + 25, cloudY - 10, 25, 0, Math.PI * 2);
                ctx.arc(cloudX + 55, cloudY, 20, 0, Math.PI * 2);
                ctx.fill();
            }
            
            drawGrass();
            drawDetails();
            buildings.forEach(drawBuilding);
            
            // Paths
            ctx.fillStyle = '#8b7355';
            ctx.fillRect(canvas.width/2 - 150, canvas.height/2, 300, 20);
            ctx.fillRect(canvas.width/2 - 10, canvas.height/2 - 150, 20, 300);
            
        } else if (world === "house") {
            ctx.fillStyle = '#d2b48c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            for (let x = 0; x < canvas.width; x += 40) {
                for (let y = 0; y < canvas.height; y += 40) {
                    ctx.fillStyle = (x + y) % 80 === 0 ? '#8b7355' : '#a0522d';
                    ctx.fillRect(x, y, 40, 40);
                }
            }
            
            ctx.fillStyle = '#8b4513';
            ctx.fillRect(canvas.width/2 - 100, canvas.height/2 - 50, 200, 20);
            ctx.fillRect(canvas.width/2 - 120, canvas.height/2 - 30, 40, 30);
            ctx.fillRect(canvas.width/2 + 80, canvas.height/2 - 30, 40, 30);
            ctx.fillRect(canvas.width/2 - 40, canvas.height/2 + 40, 80, 40);
            
            ctx.fillStyle = '#333';
            ctx.fillRect(canvas.width/2 - 30, canvas.height - 50, 60, 30);
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('EXIT', canvas.width/2, canvas.height - 30);
            
        } else if (world === "center") {
            ctx.fillStyle = '#f8f8f8';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            for (let x = 0; x < canvas.width; x += 40) {
                for (let y = 0; y < canvas.height; y += 40) {
                    ctx.fillStyle = (x + y) % 80 === 0 ? '#d0d0d0' : '#e8e8e8';
                    ctx.fillRect(x, y, 40, 40);
                }
            }
            
            ctx.fillStyle = '#8b4513';
            ctx.fillRect(canvas.width/2 - 120, canvas.height/2 - 30, 240, 20);
            
            ctx.fillStyle = '#4a8bca';
            ctx.fillRect(canvas.width/2 - 40, canvas.height/2 - 80, 80, 60);
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(canvas.width/2 - 20, canvas.height/2 - 60, 40, 20);
            
            ctx.fillStyle = '#333';
            ctx.fillRect(canvas.width/2 - 30, canvas.height - 50, 60, 30);
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('EXIT', canvas.width/2, canvas.height - 30);
        }
        
        drawPlayer();
        drawFollowingPokemon();
    }
}

function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

// Start the game
gameLoop();
</script>
</body>
</html>
