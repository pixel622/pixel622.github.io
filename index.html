<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pokémon Nova Genesis</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background:#000;
    font-family:'Press Start 2P',cursive;
    overflow:hidden;
    touch-action:none;
    height:100vh;
  }
  #container {
    position:relative;
    width:100vw;
    height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background:radial-gradient(#001122,#000);
  }
  #canvas {
    width:90vmin;
    height:calc(90vmin * 240/320);
    max-width:540px;
    max-height:405px;
    image-rendering:pixelated;
    image-rendering:crisp-edges;
    border:6px solid #222;
    box-shadow:0 0 30px rgba(0,255,255,0.3);
  }
  #ui {
    position:absolute;
    inset:0;
    pointer-events:none;
  }
  #dialogue {
    position:absolute;
    bottom:4%;
    left:4%;
    right:4%;
    height:18%;
    background:rgba(255,255,255,0.92);
    border:4px solid #0044cc;
    color:#000;
    padding:6px 10px;
    font-size:calc(10px + 0.8vw);
    line-height:1.3;
    display:flex;
    align-items:center;
    pointer-events:auto;
    overflow:hidden;
  }
  #advance {
    min-width:32px;
    height:32px;
    margin-left:8px;
    background:#0044cc;
    color:#fff;
    border:3px solid #fff;
    font-size:16px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }
  #controls {
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    height:38vh;
    pointer-events:none;
    display:none;
  }
  
  /* Joystick Styles */
  #joystickContainer {
    position:absolute;
    left:6%;
    bottom:12%;
    width:28vw;
    height:28vw;
    max-width:140px;
    max-height:140px;
    pointer-events:auto;
  }
  #joystickBase {
    position:absolute;
    width:100%;
    height:100%;
    background:rgba(255,255,255,0.15);
    border:4px solid rgba(255,255,255,0.8);
    border-radius:50%;
  }
  #joystickHandle {
    position:absolute;
    width:50%;
    height:50%;
    background:rgba(255,255,255,0.8);
    border:3px solid #0044cc;
    border-radius:50%;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    transition:transform 0.1s;
  }
  
  .ab {
    position:absolute;
    right:8%;
    bottom:14%;
    display:flex;
    flex-direction:column;
    gap:20%;
    pointer-events:auto;
  }
  .ab div {
    width:22vw;
    height:22vw;
    max-width:100px;
    max-height:100px;
    border-radius:50%;
    border:5px solid #fff;
    font-size:min(9vw,40px);
    font-weight:bold;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:auto;
  }
  #a { background:rgba(0,220,0,0.85); color:#fff; }
  #b { background:rgba(220,0,0,0.85); color:#fff; }
  #menuIcon {
    position:fixed;
    top:4%;
    right:4%;
    width:60px;
    height:60px;
    background:rgba(0,120,255,0.8);
    border:4px solid #fff;
    border-radius:50%;
    color:#fff;
    font-size:28px;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:auto;
    z-index:10;
  }
  #menuPanel {
    position:fixed;
    inset:0;
    background:rgba(0,0,120,0.96);
    color:#fff;
    padding:10%;
    display:none;
    flex-direction:column;
    font-size:calc(10px + 1vw);
    z-index:20;
    pointer-events:auto;
  }
  .menuRow {
    padding:12px 0;
    border-bottom:1px solid #444;
    cursor:pointer;
  }
  .menuRow:active { background:rgba(255,255,255,0.2); }
  
  /* Pokémon Selection Screen */
  #pokemonSelection {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.92);
    color:#fff;
    display:none;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    pointer-events:auto;
    z-index:30;
  }
  .pokeballContainer {
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    gap:20px;
    margin:20px;
    max-width:90%;
  }
  .pokeballOption {
    display:flex;
    flex-direction:column;
    align-items:center;
    cursor:pointer;
    transition:transform 0.2s;
    padding:10px;
  }
  .pokeballOption:hover {
    transform:scale(1.1);
  }
  .pokeball {
    width:80px;
    height:80px;
    position:relative;
    background:linear-gradient(to bottom, #ff3333 45%, #fff 45%);
    border-radius:50%;
    border:4px solid #000;
    overflow:hidden;
    margin-bottom:10px;
  }
  .pokeball:before {
    content:'';
    position:absolute;
    top:calc(45% - 2px);
    left:0;
    right:0;
    height:4px;
    background:#000;
  }
  .pokeball:after {
    content:'';
    position:absolute;
    top:calc(50% - 12px);
    left:calc(50% - 12px);
    width:24px;
    height:24px;
    background:#fff;
    border:4px solid #000;
    border-radius:50%;
  }
  .pokemonName {
    font-size:12px;
    color:#fff;
    text-align:center;
    margin-top:5px;
    text-shadow:2px 2px 0 #000;
  }
  
  #nameScreen, #confirmScreen {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.92);
    color:#fff;
    display:none;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    font-size:calc(12px + 1.2vw);
    pointer-events:auto;
    z-index:30;
  }
  #nameText { margin:20px 0; font-size:1.4em; }
  #kb {
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:4px;
    max-width:90%;
  }
  .kbKey {
    aspect-ratio:1;
    background:#555;
    border:3px solid #aaa;
    color:#fff;
    font-size:calc(10px + 0.8vw);
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }
  .kbKey:active { background:#fff; color:#000; }
  .wide { grid-column:span 2; }
  #confirmScreen button {
    margin:15px 20px;
    padding:12px 32px;
    font-size:1.1em;
    background:#0044cc;
    color:#fff;
    border:3px solid #fff;
    cursor:pointer;
  }
  .hidden { display:none !important; }
</style>
</head>
<body>

<div id="container">
  <canvas id="canvas" width="320" height="240"></canvas>

  <div id="ui">
    <div id="dialogue" class="hidden">
      <span id="text"></span>
      <div id="advance">▶</div>
    </div>
  </div>

  <div id="nameScreen">
    <div id="nameText">NOVA</div>
    <div id="kb"></div>
  </div>

  <!-- Pokémon Selection Screen -->
  <div id="pokemonSelection" class="hidden">
    <div style="font-size:1.2em; margin-bottom:30px; text-align:center;">
      Choose your first Pokémon partner!
    </div>
    <div class="pokeballContainer">
      <div class="pokeballOption" data-pokemon="treecko">
        <div class="pokeball"></div>
        <div class="pokemonName">TREECKO</div>
      </div>
      <div class="pokeballOption" data-pokemon="froakie">
        <div class="pokeball"></div>
        <div class="pokemonName">FROAKIE</div>
      </div>
      <div class="pokeballOption" data-pokemon="charmander">
        <div class="pokeball"></div>
        <div class="pokemonName">CHARMANDER</div>
      </div>
    </div>
    <div style="margin-top:30px; font-size:0.8em; color:#aaa;">
      Tap a Pokéball to select your Pokémon
    </div>
  </div>

  <div id="confirmScreen" class="hidden">
    <div id="confirmMsg">You chose CHARMANDER! Are you sure?</div>
    <button id="yes">YES</button>
    <button id="no">NO</button>
  </div>

  <div id="controls">
    <!-- Joystick -->
    <div id="joystickContainer">
      <div id="joystickBase"></div>
      <div id="joystickHandle"></div>
    </div>
    
    <div class="ab">
      <div id="b">B</div>
      <div id="a">A</div>
    </div>
  </div>

  <div id="menuIcon">M</div>

  <div id="menuPanel" class="hidden">
    <div class="menuRow">Pokémon</div>
    <div class="menuRow">Bag → Potion x1</div>
    <div class="menuRow" id="saveBtn">Save Game</div>
    <div class="menuRow" id="closeMenu">Close</div>
  </div>

</div>

<script>
// Game variables
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
ctx.imageSmoothingEnabled = false;

const TILE = 16;
const W = 320, H = 240;

// Game state
let state = 'title';
let playerName = 'NOVA';
let starter = null;
let playerX = 8, playerY = 7, playerDir = 2;
let followerX = 8, followerY = 8;
let camX = 0, camY = 0;
let currentMap = 'bed';
let dialog = [];
let dialogText = '';
let dialogPos = 0;
let potionCount = 1;
let talkedToMom = false;

// Joystick variables
let joystickActive = false;
let joystickX = 0;
let joystickY = 0;
const JOYSTICK_RADIUS = 50;

// Maps data
const maps = {
  bed: [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,8,8,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,9,9,9,9,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
  ],
  kit: [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,1],
    [1,3,3,4,4,4,5,5,5,5,0,0,0,0,0,0,0,0,0,1],
    [1,3,3,4,4,4,5,5,5,5,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,2,2,0,0,0,7,7,7,7,0,0,0,0,2,2,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
  ],
  town: [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,1],
    [1,11,11,12,12,12,12,12,12,12,12,11,11,11,11,11,11,11,11,1],
    [1,11,11,12,12,12,12,12,12,12,12,11,11,13,13,13,13,11,11,1],
    [1,11,11,11,11,11,11,11,11,11,11,11,11,13,13,13,13,11,11,1],
    [1,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,1],
    [1,14,14,14,14,0,0,0,0,0,0,0,0,0,0,15,15,15,15,1],
    [1,14,14,14,14,2,0,0,0,0,0,0,0,0,2,15,15,15,15,1],
    [1,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
  ]
};

// Tile colors
const colors = {
  0: 'transparent',
  1: '#a87048',
  2: '#c08030',
  3: '#909090',
  4: '#b07050',
  5: '#60a0c0',
  6: '#ff88cc',
  7: '#ffdd99',
  8: '#ffcc88',
  9: '#ddccaa',
  10: '#88ccff',
  11: '#90d070',
  12: '#d02020',
  13: '#f0f0f0',
  14: '#c0c0c0',
  15: '#a02020'
};

// Drawing functions
function drawTile(x, y, type) {
  if (type === 0) return;
  const screenX = x * TILE + camX;
  const screenY = y * TILE + camY;
  ctx.fillStyle = colors[type] || '#333';
  ctx.fillRect(screenX, screenY, TILE, TILE);
}

function drawMap() {
  const mapData = maps[currentMap];
  for (let y = 0; y < mapData.length; y++) {
    for (let x = 0; x < mapData[y].length; x++) {
      drawTile(x, y, mapData[y][x]);
    }
  }
}

function drawPlayer(x, y, dir, frame = 0) {
  const screenX = x * TILE + camX;
  const screenY = y * TILE + camY;
  
  // Head
  ctx.fillStyle = '#f8d8b0';
  ctx.fillRect(screenX + 4, screenY, 8, 8);
  
  // Body
  ctx.fillStyle = '#3060c0';
  ctx.fillRect(screenX + 2, screenY + 8, 12, 12);
  
  // Legs animation
  ctx.fillStyle = '#a04020';
  const offset = frame ? 1 : -1;
  ctx.fillRect(screenX + 4 + offset, screenY + 18, 4, 6);
  ctx.fillRect(screenX + 8 - offset, screenY + 18, 4, 6);
}

function drawPokemon(x, y) {
  if (!starter) return;
  
  const screenX = x * TILE + camX + 2;
  const screenY = y * TILE + camY + 2;
  
  if (starter === 'charmander') {
    ctx.fillStyle = '#ff8800';
    ctx.fillRect(screenX, screenY + 4, 12, 10);
    ctx.fillStyle = '#ff4400';
    ctx.fillRect(screenX + 8, screenY, 6, 6); // Tail
  } else if (starter === 'treecko') {
    ctx.fillStyle = '#00cc66';
    ctx.fillRect(screenX, screenY + 4, 12, 10);
    ctx.fillStyle = '#009944';
    ctx.fillRect(screenX + 2, screenY + 2, 8, 8);
  } else if (starter === 'froakie') {
    ctx.fillStyle = '#4488ff';
    ctx.fillRect(screenX, screenY + 4, 12, 10);
    ctx.fillStyle = '#2266cc';
    ctx.fillRect(screenX + 3, screenY + 3, 6, 6);
  }
}

function updateCamera() {
  camX = Math.floor(W / 2 - (playerX + 0.5) * TILE);
  camY = Math.floor(H / 2 - (playerY + 0.5) * TILE);
  
  const mapWidth = maps[currentMap][0].length * TILE;
  const mapHeight = maps[currentMap].length * TILE;
  
  camX = Math.max(-(mapWidth - W), Math.min(0, camX));
  camY = Math.max(-(mapHeight - H), Math.min(0, camY));
}

function render() {
  // Clear canvas
  ctx.fillStyle = '#081820';
  ctx.fillRect(0, 0, W, H);
  
  if (state === 'title') {
    // Title screen
    ctx.fillStyle = '#4060ff';
    for (let i = 0; i < 80; i++) {
      const x = (performance.now() / 30 + i * 13) % W;
      const y = (i * 17) % H;
      ctx.fillRect(x, y, 2, 2);
    }
    ctx.fillStyle = '#ffeb3b';
    ctx.font = 'bold 28px "Press Start 2P"';
    ctx.textAlign = 'center';
    ctx.fillText('POKÉMON', W / 2, H * 0.4);
    ctx.fillStyle = '#ff4444';
    ctx.font = 'bold 20px "Press Start 2P"';
    ctx.fillText('NOVA GENESIS', W / 2, H * 0.55);
    ctx.fillStyle = '#fff';
    ctx.font = '14px "Press Start 2P"';
    ctx.fillText('Tap screen to start', W / 2, H * 0.8);
  } else {
    // Game screen
    drawMap();
    drawPlayer(playerX, playerY, playerDir, Math.floor(performance.now() / 200) % 2);
    
    if (starter) {
      drawPokemon(followerX, followerY);
    }
    
    // Draw mom in kitchen
    if (currentMap === 'kit' && !talkedToMom) {
      const momX = 9, momY = 5;
      const screenX = momX * TILE + camX;
      const screenY = momY * TILE + camY;
      ctx.fillStyle = '#ff88cc';
      ctx.fillRect(screenX + 4, screenY, 8, 8);
      ctx.fillRect(screenX + 2, screenY + 8, 12, 12);
    }
  }
  
  // Update dialogue display
  if (dialogText) {
    document.getElementById('text').textContent = dialogText.slice(0, dialogPos);
    document.getElementById('dialogue').classList.remove('hidden');
  } else {
    document.getElementById('dialogue').classList.add('hidden');
  }
}

// Dialogue system
function queueDialog(lines) {
  dialog = dialog.concat(lines.map(line => line.replace('{name}', playerName)));
  if (!dialogText) {
    nextLine();
  }
}

function nextLine() {
  if (dialog.length === 0) {
    dialogText = '';
    dialogPos = 0;
    
    if (state === 'prof') {
      document.getElementById('nameScreen').style.display = 'flex';
    } else if (state === 'choose') {
      document.getElementById('pokemonSelection').classList.remove('hidden');
    }
    return;
  }
  
  dialogText = dialog.shift();
  dialogPos = 0;
}

function advanceDialog() {
  if (dialogPos < dialogText.length) {
    dialogPos = dialogText.length;
  } else {
    nextLine();
  }
}

// Pokémon selection
function showPokemonSelection() {
  document.getElementById('pokemonSelection').classList.remove('hidden');
}

function showConfirm(pokemon) {
  starter = pokemon;
  document.getElementById('confirmMsg').textContent = `You chose ${pokemon.toUpperCase()}! Are you sure?`;
  document.getElementById('confirmScreen').classList.remove('hidden');
}

// Event listeners for Pokémon selection
document.querySelectorAll('.pokeballOption').forEach(option => {
  option.addEventListener('click', (e) => {
    const pokemon = option.dataset.pokemon;
    showConfirm(pokemon);
  });
});

document.getElementById('yes').addEventListener('click', () => {
  document.getElementById('confirmScreen').classList.add('hidden');
  document.getElementById('pokemonSelection').classList.add('hidden');
  
  queueDialog([
    'An excellent choice! This Pokémon is full of potential!',
    `Alright, ${starter.toUpperCase()}! Let's go meet Mom downstairs, then start our journey!`
  ]);
  
  state = 'play';
  currentMap = 'bed';
  document.getElementById('controls').style.display = 'block';
  
  // Position follower behind player
  followerX = playerX - 1;
  followerY = playerY;
});

document.getElementById('no').addEventListener('click', () => {
  document.getElementById('confirmScreen').classList.add('hidden');
  showPokemonSelection();
});

// Start game on click
canvas.addEventListener('click', () => {
  if (state === 'title') {
    state = 'prof';
    queueDialog([
      "Ah! There you are! I've been expecting you.",
      "Welcome to the world of Pokémon! My name is Chen.",
      "I study the unique bond between humans and Pokémon here in the Aura Region.",
      "And you are...?"
    ]);
  }
});

// Keyboard for name entry
function buildKeyboard() {
  const row1 = 'QWERTYUIOP'.split('');
  const row2 = 'ASDFGHJKL'.split('');
  const row3 = 'ZXCVBNM'.split('');
  const keys = [...row1, ...row2, ...row3, 'DEL', 'OK'];
  const keyboard = document.getElementById('kb');
  keyboard.innerHTML = '';
  
  keys.forEach(key => {
    const button = document.createElement('div');
    button.className = 'kbKey' + (key.length > 1 ? ' wide' : '');
    button.textContent = key;
    
    button.addEventListener('click', () => {
      if (key === 'OK') {
        if (playerName) {
          document.getElementById('nameScreen').style.display = 'none';
          queueDialog([
            `Perfect, ${playerName}! Now, for your first partner.`,
            'Which of these three resonates with you?'
          ]);
          state = 'choose';
        }
      } else if (key === 'DEL') {
        playerName = playerName.slice(0, -1);
      } else {
        playerName += key;
        if (playerName.length > 10) {
          playerName = playerName.slice(0, 10);
        }
      }
      document.getElementById('nameText').textContent = playerName || 'NOVA';
    });
    
    keyboard.appendChild(button);
  });
}
buildKeyboard();

// Joystick implementation
const joystickContainer = document.getElementById('joystickContainer');
const joystickHandle = document.getElementById('joystickHandle');

let isDragging = false;
let startX = 0;
let startY = 0;
let handleX = 0;
let handleY = 0;

function startDrag(e) {
  e.preventDefault();
  isDragging = true;
  const rect = joystickContainer.getBoundingClientRect();
  startX = rect.left + rect.width / 2;
  startY = rect.top + rect.height / 2;
  updateJoystick(e);
}

function updateJoystick(e) {
  if (!isDragging) return;
  
  let clientX, clientY;
  if (e.touches) {
    clientX = e.touches[0].clientX;
    clientY = e.touches[0].clientY;
  } else {
    clientX = e.clientX;
    clientY = e.clientY;
  }
  
  let dx = clientX - startX;
  let dy = clientY - startY;
  const distance = Math.sqrt(dx * dx + dy * dy);
  
  if (distance > JOYSTICK_RADIUS) {
    dx = (dx / distance) * JOYSTICK_RADIUS;
    dy = (dy / distance) * JOYSTICK_RADIUS;
  }
  
  handleX = dx;
  handleY = dy;
  joystickHandle.style.transform = `translate(${dx}px, ${dy}px)`;
  
  // Calculate joystick direction
  joystickX = dx / JOYSTICK_RADIUS;
  joystickY = dy / JOYSTICK_RADIUS;
}

function stopDrag() {
  isDragging = false;
  handleX = 0;
  handleY = 0;
  joystickX = 0;
  joystickY = 0;
  joystickHandle.style.transform = 'translate(-50%, -50%)';
}

// Touch events for joystick
joystickContainer.addEventListener('touchstart', startDrag);
joystickContainer.addEventListener('touchmove', updateJoystick);
joystickContainer.addEventListener('touchend', stopDrag);
joystickContainer.addEventListener('touchcancel', stopDrag);

// Mouse events for joystick (for desktop testing)
joystickContainer.addEventListener('mousedown', (e) => {
  startDrag(e);
  
  const mouseMove = (e) => updateJoystick(e);
  const mouseUp = () => {
    stopDrag();
    document.removeEventListener('mousemove', mouseMove);
    document.removeEventListener('mouseup', mouseUp);
  };
  
  document.addEventListener('mousemove', mouseMove);
  document.addEventListener('mouseup', mouseUp);
});

// Button controls
document.getElementById('a').addEventListener('click', (e) => {
  e.preventDefault();
  if (state === 'play') {
    advanceDialog();
  }
});

document.getElementById('advance').addEventListener('click', advanceDialog);

// Menu controls
document.getElementById('menuIcon').addEventListener('click', () => {
  const menu = document.getElementById('menuPanel');
  menu.classList.toggle('hidden');
});

document.getElementById('closeMenu').addEventListener('click', () => {
  document.getElementById('menuPanel').classList.add('hidden');
});

document.getElementById('saveBtn').addEventListener('click', () => {
  const saveData = {
    name: playerName,
    starter: starter,
    px: playerX,
    py: playerY,
    map: currentMap,
    potion: potionCount,
    talkedMom: talkedToMom
  };
  localStorage.setItem('nova', JSON.stringify(saveData));
  queueDialog(['Game saved!']);
});

// Movement system
let lastMoveTime = 0;
const MOVE_DELAY = 150; // ms between moves

function updateMovement() {
  const now = Date.now();
  if (now - lastMoveTime < MOVE_DELAY) return;
  
  let moved = false;
  let moveX = 0;
  let moveY = 0;
  
  // Check joystick input
  if (Math.abs(joystickX) > 0.3 || Math.abs(joystickY) > 0.3) {
    if (Math.abs(joystickX) > Math.abs(joystickY)) {
      moveX = joystickX > 0 ? 1 : -1;
      playerDir = joystickX > 0 ? 3 : 1;
    } else {
      moveY = joystickY > 0 ? 1 : -1;
      playerDir = joystickY > 0 ? 2 : 0;
    }
  }
  
  if (moveX !== 0 || moveY !== 0) {
    if (tryMove(playerX + moveX, playerY + moveY)) {
      playerX += moveX;
      playerY += moveY;
      moved = true;
      lastMoveTime = now;
    }
  }
  
  // Update follower position
  if (moved && starter) {
    updateFollower();
  }
}

function tryMove(newX, newY) {
  const mapData = maps[currentMap];
  if (newY < 0 || newY >= mapData.length || newX < 0 || newX >= mapData[0].length) {
    return false;
  }
  return mapData[newY][newX] !== 1;
}

function updateFollower() {
  if (!starter) return;
  
  // Simple follow: follower goes to player's previous position
  // In a real game, you'd implement pathfinding
  const dx = playerX - followerX;
  const dy = playerY - followerY;
  
  if (Math.abs(dx) > 1 || Math.abs(dy) > 1) {
    if (Math.abs(dx) > Math.abs(dy)) {
      followerX += Math.sign(dx);
    } else {
      followerY += Math.sign(dy);
    }
  }
}

// Main game loop
function gameLoop() {
  if (state === 'play') {
    updateMovement();
    updateCamera();
  }
  
  // Update dialog typing effect
  if (dialogText && dialogPos < dialogText.length) {
    dialogPos = Math.min(dialogPos + 2, dialogText.length);
  }
  
  render();
  requestAnimationFrame(gameLoop);
}

// Start the game loop
gameLoop();
</script>
</body>
</html>
