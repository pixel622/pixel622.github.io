<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pokémon K&E Version</title>
    <style>
        :root {
            --gba-blue: #285088;
            --gba-light-blue: #5888c8;
            --font-main: 'Courier New', Courier, monospace;
        }

        body, html {
            margin: 0; padding: 0; 
            width: 100vw; height: 100vh;
            background: #000; overflow: hidden; 
            touch-action: none;
            display: flex; justify-content: center; align-items: center;
        }

        #game-wrapper {
            position: relative;
            width: 100%; height: 100%;
        }

        canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
            /* Added for pixel look */
            image-rendering: pixelated;
        }

        #title-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; transition: opacity 0.5s ease-out;
            font-family: var(--font-main);
        }

        #title-screen h1 { font-size: 40px; margin-bottom: 20px; text-align: center; color: #ffcb05; text-shadow: 3px 3px #2a75bb; }

        #start-btn {
            padding: 15px 40px; font-size: 20px; font-family: var(--font-main);
            background: var(--gba-blue); color: white; border: 4px solid white;
            cursor: pointer; border-radius: 10px; font-weight: bold;
        }

        #ui-layer {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%); width: 90%;
            z-index: 100; cursor: pointer; display: none;
        }

        #dialogue-box {
            background: white; border: 6px solid var(--gba-blue); border-radius: 18px;
            padding: 20px; font-family: var(--font-main); font-weight: bold;
            font-size: 20px; box-shadow: inset 0 0 0 3px var(--gba-light-blue), 0 4px 10px rgba(0,0,0,0.5);
            min-height: 80px; user-select: none;
        }

        #speaker-tag {
            position: absolute; top: -25px; left: 30px;
            background: var(--gba-blue); color: white;
            padding: 5px 20px; border-radius: 10px 10px 0 0;
            font-size: 16px; border: 3px solid var(--gba-blue);
        }

        #joystick-wrapper {
            position: absolute; bottom: 80px; left: 40px;
            width: 130px; height: 130px;
            background: rgba(255,255,255,0.15); border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);
            display: flex; justify-content: center; align-items: center; z-index: 200;
        }

        #joystick-knob { width: 50px; height: 50px; background: rgba(255,255,255,0.6); border-radius: 50%; }

        #shimmer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; z-index: 999;
        }

        #bag-btn {
            position: absolute; bottom: 80px; right: 40px;
            background: var(--gba-blue); color: white;
            padding: 15px 30px; border-radius: 8px;
            font-family: var(--font-main); font-weight: bold;
            border: 3px solid white; cursor: pointer; z-index: 300;
            box-shadow: 0 4px #183058;
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="title-screen">
        <h1>Pokémon K&E Version</h1>
        <button id="start-btn" onclick="startGame()">START GAME</button>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div id="shimmer"></div>
    <div id="bag-btn" onclick="alert('Bag is empty!')">BAG</div>

    <div id="ui-layer" onclick="handleDialogueClick()">
        <div id="speaker-tag">Professor Sequoia</div>
        <div id="dialogue-box">Welcome to the Habitat Research Lab!</div>
    </div>

    <div id="joystick-wrapper">
        <div id="joystick-knob"></div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const knob = document.getElementById('joystick-knob');
    const wrapper = document.getElementById('joystick-wrapper');
    const uiLayer = document.getElementById('ui-layer');
    const dialogueBox = document.getElementById('dialogue-box');
    const titleScreen = document.getElementById('title-screen');

    const script = [
        "Welcome to the Habitat Research Lab!",
        "Look around! This facility is dedicated to studying Orebound's ecology.",
        "The tremor earlier was quite strong. We must act quickly.",
        "Go ahead and click on the Pokémon you want to partner with!"
    ];
    let scriptIndex = 0;
    let currentMap = 'LAB';
    let choosingState = false;
    let holdingPokeball = false; 
    let width, height;

    function resize() {
        width = window.innerWidth; height = window.innerHeight;
        canvas.width = width; canvas.height = height;
    }
    window.addEventListener('resize', resize);
    resize();

    const player = { x: width/2, y: height - 120, speed: 5, history: [] };
    const follower = { active: false, name: '', x: 0, y: 0, color: '#000' };

    const pokeballs = [
        { name: 'Treecko', x: 0, y: 0, color: '#32CD32', active: true },
        { name: 'Froakie', x: 0, y: 0, color: '#1E90FF', active: true },
        { name: 'Charmander', x: 0, y: 0, color: '#FF4500', active: true }
    ];

    function startGame() {
        titleScreen.style.opacity = '0';
        setTimeout(() => {
            titleScreen.style.display = 'none';
            uiLayer.style.display = 'block';
        }, 500);
    }

    let stickX = 0, stickY = 0, isTouching = false;

    function handleDialogueClick() {
        if (scriptIndex < script.length - 1) {
            scriptIndex++;
            dialogueBox.innerText = script[scriptIndex];
        } else {
            uiLayer.style.display = 'none';
            choosingState = true;
        }
    }

    canvas.addEventListener('mousedown', (e) => checkPokeClick(e.clientX, e.clientY));
    canvas.addEventListener('touchstart', (e) => checkPokeClick(e.touches[0].clientX, e.touches[0].clientY));

    function checkPokeClick(clickX, clickY) {
        if (!choosingState || follower.active || currentMap !== 'LAB') return;
        pokeballs.forEach(ball => {
            if(!ball.active) return;
            const dx = clickX - ball.realX;
            const dy = clickY - ball.realY;
            if (Math.sqrt(dx*dx + dy*dy) < 40) {
                follower.active = true; follower.name = ball.name;
                follower.color = ball.color; follower.x = ball.realX;
                follower.y = ball.realY; ball.active = false;
                holdingPokeball = true;
            }
        });
    }

    wrapper.addEventListener('touchstart', (e) => { isTouching = true; e.preventDefault(); });
    window.addEventListener('touchend', () => { isTouching = false; stickX = 0; stickY = 0; knob.style.transform = `translate(0px, 0px)`; });
    window.addEventListener('touchmove', (e) => {
        if (!isTouching) return;
        const rect = wrapper.getBoundingClientRect();
        const touch = e.touches[0];
        let dx = touch.clientX - (rect.left + rect.width/2);
        let dy = touch.clientY - (rect.top + rect.height/2);
        const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
        const angle = Math.atan2(dy, dx);
        stickX = Math.cos(angle) * (dist/40); stickY = Math.sin(angle) * (dist/40);
        knob.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
    });

    function checkCollision(nx, ny) {
        if (currentMap === 'LAB') {
            const dW = 350, dH = 100, dX = width/2 - dW/2, dY = height/2.5;
            if (nx > dX - 15 && nx < dX + dW + 15 && ny > dY - 15 && ny < dY + dH + 15) return true;
            if (ny < 130) return true;
        } else {
            const hX = width/2 - 110, hY = height/2 - 150;
            if (nx > hX - 20 && nx < hX + 240 && ny > hY - 60 && ny < hY + 150) {
                if (Math.abs(nx - width/2) < 30 && ny > hY + 100) return false;
                return true;
            }
            if (ny > height/2 + 120 && ny < height/2 + 130) {
                if (Math.abs(nx - width/2) > 40) return true;
            }
        }
        return false;
    }

    let isTeleporting = false;
    function teleport() {
        if (isTeleporting) return;
        isTeleporting = true;
        const shim = document.getElementById('shimmer');
        shim.style.opacity = '1';
        setTimeout(() => {
            currentMap = (currentMap === 'LAB') ? 'OUTSIDE' : 'LAB';
            player.x = width/2;
            player.y = (currentMap === 'OUTSIDE') ? height/2 + 80 : height - 120;
            player.history = []; 
            shim.style.opacity = '0';
            isTeleporting = false;
        }, 300);
    }

    function update() {
        if (isTouching) {
            let nextX = player.x + stickX * player.speed;
            let nextY = player.y + stickY * player.speed;
            if (!checkCollision(nextX, nextY)) {
                player.history.push({x: player.x, y: player.y});
                if (player.history.length > 60) player.history.shift();
                player.x = nextX; player.y = nextY;
            }
        }
        const matX = width / 2;
        const matY = (currentMap === 'LAB') ? height - 30 : height / 2 + 10;
        if (Math.abs(player.x - matX) < 50 && Math.abs(player.y - matY) < 30) teleport();
        
        if (follower.active && player.history.length > 12) {
            const fp = player.history[player.history.length - 12];
            follower.x += (fp.x - follower.x) * 0.15; follower.y += (fp.y - follower.y) * 0.15;
        }
        player.x = Math.max(20, Math.min(width-20, player.x));
        player.y = Math.max(20, Math.min(height-20, player.y));
    }

    function draw() {
        ctx.clearRect(0, 0, width, height);
        ctx.imageSmoothingEnabled = false;

        if (currentMap === 'LAB') {
            ctx.fillStyle = '#d89060'; ctx.fillRect(0, 0, width, height);
            ctx.strokeStyle = '#b87040'; for(let i=0; i<width; i+=60) ctx.strokeRect(i, 0, 60, height);
            ctx.fillStyle = '#3a8fb7'; ctx.fillRect(width/2 - 50, height - 50, 100, 50);
            ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.strokeRect(width/2 - 50, height - 50, 100, 50);
            ctx.fillStyle = '#5d3a1a'; for(let i=50; i<width-100; i+=120) ctx.fillRect(i, 20, 100, 100);
            ctx.fillStyle = '#8b4513'; ctx.fillRect(20, height - 100, 30, 30); ctx.fillRect(width - 50, height - 100, 30, 30);
            ctx.fillStyle = '#228b22'; ctx.beginPath(); ctx.arc(35, height-110, 20, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(width-35, height-110, 20, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#444'; ctx.fillRect(width - 150, 130, 120, 60);

            const dW = 350, dH = 100, dX = width/2 - dW/2, dY = height/2.5;
            ctx.fillStyle = '#804020'; ctx.fillRect(dX, dY, dW, dH);
            pokeballs.forEach((ball, i) => {
                if (!ball.active) return;
                ball.realX = dX + 60 + (i * 110); ball.realY = dY + 40;
                // Pixel Pokéball
                ctx.fillStyle = 'red'; ctx.fillRect(ball.realX-12, ball.realY-12, 24, 12);
                ctx.fillStyle = 'white'; ctx.fillRect(ball.realX-12, ball.realY, 24, 12);
                ctx.fillStyle = 'black'; ctx.fillRect(ball.realX-4, ball.realY-4, 8, 8);
                ctx.fillStyle = 'white'; ctx.font = 'bold 12px var(--font-main)'; ctx.textAlign = 'center'; ctx.fillText(ball.name.toUpperCase(), ball.realX, ball.realY - 30);
            });
        } else {
            // COLORS FROM YOUR IMAGE
            ctx.fillStyle = '#91c1a1'; ctx.fillRect(0, 0, width, height); // Grass Base
            
            // GRASS PATCHES
            ctx.fillStyle = '#78b08d'; 
            for(let row=0; row<height; row+=40) {
                for(let col=0; col<width; col+=40) {
                    if((row+col)%80===0) ctx.fillRect(col, row, 30, 30);
                }
            }

            // YELLOW PATH
            ctx.fillStyle = '#eadd9a'; ctx.fillRect(0, height/2 + 120, width, height);

            // POND
            const wX = width/2 - 350, wY = height/2 - 50;
            ctx.fillStyle = '#5187ba'; ctx.beginPath(); ctx.ellipse(wX, wY, 145, 95, 0, 0, Math.PI*2); ctx.fill();

            // TREES (Blocky)
            ctx.fillStyle = '#3c6e4b';
            for(let x = 40; x < width; x += 80) {
                ctx.fillRect(x-30, 20, 60, 60);
                if (x < 100 || x > width - 100) {
                    for(let y = 120; y < height/2+80; y += 80) ctx.fillRect(x-30, y, 60, 60);
                }
            }
            
            // PIXEL HOUSE (Pokemon Center look)
            const hX = width/2 - 110, hY = height/2 - 150;
            ctx.fillStyle = '#d15341'; ctx.fillRect(hX-20, hY-20, 260, 60); // Red Roof
            ctx.fillStyle = '#f0f0f0'; ctx.fillRect(hX, hY+40, 220, 110); // White Walls
            ctx.fillStyle = '#4b7eb1'; ctx.fillRect(width/2 - 30, height/2 - 45, 60, 45); // Door
        }

        if (follower.active) {
            ctx.fillStyle = follower.color; ctx.fillRect(follower.x-14, follower.y-14, 28, 28);
            ctx.fillStyle = '#fff'; ctx.fillRect(follower.x-6, follower.y-5, 4, 4); ctx.fillRect(follower.x+2, follower.y-5, 4, 4);
        }

        // PLAYER PIXEL MODEL
        ctx.fillStyle = '#000'; ctx.fillRect(player.x-15, player.y+15, 10, 5); ctx.fillRect(player.x+5, player.y+15, 10, 5); // Shoes
        ctx.fillStyle = '#a03030'; ctx.fillRect(player.x-15, player.y-10, 30, 25); // Vest
        ctx.fillStyle = '#ffdbac'; ctx.fillRect(player.x-10, player.y-25, 20, 18); // Face
        ctx.fillStyle = '#fff'; ctx.fillRect(player.x-12, player.y-32, 24, 10); // Hat
        
        if (holdingPokeball) {
            ctx.fillStyle = 'red'; ctx.fillRect(player.x + 15, player.y-5, 12, 6);
            ctx.fillStyle = 'white'; ctx.fillRect(player.x + 15, player.y, 12, 6);
        }

        update();
        requestAnimationFrame(draw);
    }
    draw();
</script>
</body>
</html>
