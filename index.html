<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pokémon Nova Genesis</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background:#000;
    font-family:'Press Start 2P',cursive;
    overflow:hidden;
    touch-action:none;
    height:100vh;
  }
  #container {
    position:relative;
    width:100vw;
    height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background:radial-gradient(#001122,#000);
  }
  #canvas {
    width:90vmin;
    height:calc(90vmin * 240/320);
    max-width:540px;
    max-height:405px;
    image-rendering:pixelated;
    image-rendering:crisp-edges;
    border:6px solid #222;
    box-shadow:0 0 30px rgba(0,255,255,0.3);
  }
  #ui {
    position:absolute;
    inset:0;
    pointer-events:none;
  }
  #dialogue {
    position:absolute;
    bottom:4%;
    left:4%;
    right:4%;
    height:18%;
    background:rgba(255,255,255,0.92);
    border:4px solid #0044cc;
    color:#000;
    padding:6px 10px;
    font-size:calc(10px + 0.8vw);
    line-height:1.3;
    display:flex;
    align-items:center;
    pointer-events:auto;
    overflow:hidden;
  }
  #advance {
    min-width:32px;
    height:32px;
    margin-left:8px;
    background:#0044cc;
    color:#fff;
    border:3px solid #fff;
    font-size:16px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }
  #controls {
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    height:38vh;
    pointer-events:none;
    display:none;
  }
  .dpad {
    position:absolute;
    left:6%;
    bottom:12%;
    width:28vw;
    height:28vw;
    max-width:140px;
    max-height:140px;
  }
  .dpad div {
    position:absolute;
    width:38%;
    height:38%;
    background:rgba(255,255,255,0.35);
    border:4px solid #fff;
    color:#000;
    font-weight:bold;
    font-size:min(7vw,32px);
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:auto;
  }
  #up    { top:0;    left:31%; }
  #down  { bottom:0; left:31%; }
  #left  { left:0;   top:31%;  }
  #right { right:0;  top:31%;  }
  .ab {
    position:absolute;
    right:8%;
    bottom:14%;
    display:flex;
    flex-direction:column;
    gap:20%;
  }
  .ab div {
    width:22vw;
    height:22vw;
    max-width:100px;
    max-height:100px;
    border-radius:50%;
    border:5px solid #fff;
    font-size:min(9vw,40px);
    font-weight:bold;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:auto;
  }
  #a { background:rgba(0,220,0,0.85); color:#fff; }
  #b { background:rgba(220,0,0,0.85); color:#fff; }
  #menuIcon {
    position:fixed;
    top:4%;
    right:4%;
    width:60px;
    height:60px;
    background:rgba(0,120,255,0.8);
    border:4px solid #fff;
    border-radius:50%;
    color:#fff;
    font-size:28px;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:auto;
    z-index:10;
  }
  #menuPanel {
    position:fixed;
    inset:0;
    background:rgba(0,0,120,0.96);
    color:#fff;
    padding:10%;
    display:none;
    flex-direction:column;
    font-size:calc(10px + 1vw);
    z-index:20;
    pointer-events:auto;
  }
  .menuRow {
    padding:12px 0;
    border-bottom:1px solid #444;
    cursor:pointer;
  }
  .menuRow:active { background:rgba(255,255,255,0.2); }
  #nameScreen, #confirmScreen {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.92);
    color:#fff;
    display:none;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    font-size:calc(12px + 1.2vw);
    pointer-events:auto;
    z-index:30;
  }
  #nameText { margin:20px 0; font-size:1.4em; }
  #kb {
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:4px;
    max-width:90%;
  }
  .kbKey {
    aspect-ratio:1;
    background:#555;
    border:3px solid #aaa;
    color:#fff;
    font-size:calc(10px + 0.8vw);
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }
  .kbKey:active { background:#fff; color:#000; }
  .wide { grid-column:span 2; }
  #confirmScreen button {
    margin:15px 20px;
    padding:12px 32px;
    font-size:1.1em;
    background:#0044cc;
    color:#fff;
    border:3px solid #fff;
    cursor:pointer;
  }
  .hidden { display:none !important; }
</style>
</head>
<body>

<div id="container">
  <canvas id="canvas" width="320" height="240"></canvas>

  <div id="ui">
    <div id="dialogue" class="hidden">
      <span id="text"></span>
      <div id="advance">▶</div>
    </div>
  </div>

  <div id="nameScreen">
    <div id="nameText">NOVA</div>
    <div id="kb"></div>
  </div>

  <div id="confirmScreen">
    <div id="confirmMsg">You chose CHARMANDER! Are you sure?</div>
    <button id="yes">YES</button>
    <button id="no">NO</button>
  </div>

  <div id="controls">
    <div class="dpad">
      <div id="up">↑</div>
      <div id="down">↓</div>
      <div id="left">←</div>
      <div id="right">→</div>
    </div>
    <div class="ab">
      <div id="b">B</div>
      <div id="a">A</div>
    </div>
  </div>

  <div id="menuIcon">M</div>

  <div id="menuPanel">
    <div class="menuRow">Pokémon</div>
    <div class="menuRow">Bag → Potion x1</div>
    <div class="menuRow" id="saveBtn">Save Game</div>
    <div class="menuRow" id="closeMenu">Close</div>
  </div>

</div>

<script>
// ────────────────────────────────────────────────
const c = document.getElementById('canvas');
const ctx = c.getContext('2d');
ctx.imageSmoothingEnabled = false;

const TILE = 16;
const W = 320, H = 240; // bigger internal resolution

let state = 'title';
let name = 'NOVA';
let starter = null;
let px = 8, py = 7, pdir = 2; // 0↑ 1← 2↓ 3→
let fx = 8, fy = 8; // follower
let camx = 0, camy = 0;
let map = 'bed';
let dialog = [];
let dtext = '';
let dpos = 0;
let potion = 1;
let talkedMom = false;

const maps = {
  bed: [ // bedroom - bed left, desk right, stairs bottom
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,8,8,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], // bed
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,9,9,9,9,0,0,0,0,0,0,0,0,0,0,0,1], // desk/pc
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0,1], // stairs
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
  ],
  kit: [ // kitchen - pink floor, fridge left, sink/counter, table right, mom center-bottom, window top
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,1], // window line
    [1,3,3,4,4,4,5,5,5,5,0,0,0,0,0,0,0,0,0,1], // fridge + counter/sink
    [1,3,3,4,4,4,5,5,5,5,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,0,0,0,1], // mom
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,2,2,0,0,0,7,7,7,7,0,0,0,0,2,2,0,0,0,1], // table + doors
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
  ],
  town: [ // town - grass, red roof center, blue mart, house gray/red door
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,1],
    [1,11,11,12,12,12,12,12,12,12,12,11,11,11,11,11,11,11,11,1],
    [1,11,11,12,12,12,12,12,12,12,12,11,11,13,13,13,13,11,11,1], // center red roof
    [1,11,11,11,11,11,11,11,11,11,11,11,11,13,13,13,13,11,11,1],
    [1,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,1],
    [1,14,14,14,14,0,0,0,0,0,0,0,0,0,0,15,15,15,15,1], // house gray + red door
    [1,14,14,14,14,2,0,0,0,0,0,0,0,0,2,15,15,15,15,1],
    [1,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
  ]
};

const colors = {
  0: '#00000000', // transparent/walk
  1: '#a87048',   // wall brown
  2: '#c08030',   // door brown
  3: '#909090',   // fridge gray
  4: '#b07050',   // counter brown
  5: '#60a0c0',   // sink blue
  6: '#ff88cc',   // mom pink dress
  7: '#ffdd99',   // table wood + food
  8: '#ffcc88',   // bed orange
  9: '#ddccaa',   // desk wood
  10:'#88ccff',   // window blue
  11:'#90d070',   // grass green
  12:'#d02020',   // center red roof
  13:'#f0f0f0',   // center white building
  14:'#c0c0c0',   // house gray
  15:'#a02020'    // house red door
};

function drawTile(tx, ty, type) {
  if (type === 0) return;
  const sx = tx * TILE + camx;
  const sy = ty * TILE + camy;
  ctx.fillStyle = colors[type] || '#333';
  ctx.fillRect(sx, sy, TILE, TILE);
}

function drawMap() {
  const data = maps[map];
  for (let y = 0; y < data.length; y++) {
    for (let x = 0; x < data[y].length; x++) {
      drawTile(x, y, data[y][x]);
    }
  }
}

function drawChar(x, y, dir, frame = 0) {
  const sx = x * TILE + camx;
  const sy = y * TILE + camy;
  // head
  ctx.fillStyle = '#f8d8b0';
  ctx.fillRect(sx+4, sy, 8, 8);
  // body
  ctx.fillStyle = '#3060c0';
  ctx.fillRect(sx+2, sy+8, 12, 12);
  // legs anim
  ctx.fillStyle = '#a04020';
  const off = frame ? 1 : -1;
  ctx.fillRect(sx+4+off, sy+18, 4, 6);
  ctx.fillRect(sx+8-off, sy+18, 4, 6);
}

function drawStarter(x, y) {
  const sx = x * TILE + camx + 2;
  const sy = y * TILE + camy + 2;
  if (!starter) return;
  if (starter === 'charmander') {
    ctx.fillStyle = '#ff8800';
    ctx.fillRect(sx, sy+4, 12, 10);
    ctx.fillStyle = '#ff4400';
    ctx.fillRect(sx+8, sy, 6, 6); // tail
  } else if (starter === 'treecko') {
    ctx.fillStyle = '#00cc66';
    ctx.fillRect(sx, sy+4, 12, 10);
    ctx.fillStyle = '#009944';
    ctx.fillRect(sx+2, sy+2, 8, 8);
  } else if (starter === 'froakie') {
    ctx.fillStyle = '#4488ff';
    ctx.fillRect(sx, sy+4, 12, 10);
    ctx.fillStyle = '#2266cc';
    ctx.fillRect(sx+3, sy+3, 6, 6);
  }
}

function updateCam() {
  camx = Math.floor(W/2 - (px + 0.5) * TILE);
  camy = Math.floor(H/2 - (py + 0.5) * TILE);
  camx = Math.max(-(maps[map][0].length * TILE - W), Math.min(0, camx));
  camy = Math.max(-(maps[map].length * TILE - H), Math.min(0, camy));
}

function render() {
  ctx.fillStyle = '#081820';
  ctx.fillRect(0,0,W,H);

  if (state === 'title') {
    ctx.fillStyle = '#4060ff';
    for (let i=0;i<80;i++) {
      const x = (performance.now()/30 + i*13) % W;
      const y = (i*17) % H;
      ctx.fillRect(x,y,2,2);
    }
    ctx.fillStyle = '#ffeb3b';
    ctx.font = 'bold 28px "Press Start 2P"';
    ctx.textAlign = 'center';
    ctx.fillText('POKÉMON', W/2, H*0.4);
    ctx.fillStyle = '#ff4444';
    ctx.font = 'bold 20px "Press Start 2P"';
    ctx.fillText('NOVA GENESIS', W/2, H*0.55);
    ctx.fillStyle = '#fff';
    ctx.font = '14px "Press Start 2P"';
    ctx.fillText('Tap screen to start', W/2, H*0.8);
  } else {
    drawMap();
    drawChar(px, py, pdir, (performance.now()/200|0)%2);
    drawStarter(fx, fy);
    if (map === 'kit' && !talkedMom) drawChar(9,5,2); // mom
  }

  // dialog
  if (dtext) {
    document.getElementById('text').textContent = dtext.slice(0, dpos);
    document.getElementById('dialogue').classList.remove('hidden');
  } else {
    document.getElementById('dialogue').classList.add('hidden');
  }
}

function queueDialog(lines) {
  dialog = dialog.concat(lines.map(l=>l.replace('{name}',name)));
  if (!dtext) nextLine();
}

function nextLine() {
  if (!dialog.length) {
    dtext = '';
    dpos = 0;
    if (state === 'prof') document.getElementById('nameScreen').style.display = 'flex';
    return;
  }
  dtext = dialog.shift();
  dpos = 0;
}

function advance() {
  if (dpos < dtext.length) {
    dpos = dtext.length;
  } else {
    nextLine();
  }
}

function showConfirm(poke) {
  starter = poke;
  document.getElementById('confirmMsg').textContent = `You chose ${poke.toUpperCase()}! Are you sure?`;
  document.getElementById('confirmScreen').style.display = 'flex';
}

document.getElementById('yes').onclick = () => {
  document.getElementById('confirmScreen').style.display = 'none';
  queueDialog([
    'An excellent choice! This Pokémon is full of potential!',
    `Alright, ${starter.toUpperCase()}! Let's go meet Mom downstairs, then start our journey!`
  ]);
  state = 'play';
  map = 'bed';
  document.getElementById('controls').style.display = 'block';
};

document.getElementById('no').onclick = () => {
  document.getElementById('confirmScreen').style.display = 'none';
  starter = null;
};

// touch/click start
c.onclick = () => {
  if (state === 'title') {
    state = 'prof';
    queueDialog([
      "Ah! There you are! I've been expecting you.",
      "Welcome to the world of Pokémon! My name is Chen.",
      "I study the unique bond between humans and Pokémon here in the Aura Region.",
      "And you are...?"
    ]);
  }
};

// keyboard
function buildKb() {
  const row1 = 'QWERTYUIOP'.split('');
  const row2 = 'ASDFGHJKL'.split('');
  const row3 = 'ZXCVBNM'.split('');
  const keys = [...row1, ...row2, ...row3, 'DEL', 'OK'];
  const kb = document.getElementById('kb');
  kb.innerHTML = '';
  keys.forEach(k => {
    const b = document.createElement('div');
    b.className = 'kbKey' + (k.length>1?' wide':'');
    b.textContent = k;
    b.onclick = () => {
      if (k==='OK') {
        if (name) {
          document.getElementById('nameScreen').style.display = 'none';
          queueDialog([
            `Perfect, ${name}! Now, for your first partner.`,
            'Which of these three resonates with you?'
          ]);
          state = 'choose';
        }
      } else if (k==='DEL') {
        name = name.slice(0,-1);
      } else {
        name += k;
        if (name.length>10) name = name.slice(0,10);
      }
      document.getElementById('nameText').textContent = name || 'NOVA';
    };
    kb.appendChild(b);
  });
}
buildKb();

// controls
const dirs = {up:false,down:false,left:false,right:false};
['up','down','left','right'].forEach(d=>{
  document.getElementById(d).ontouchstart = e=>{e.preventDefault(); dirs[d]=true;};
  document.getElementById(d).ontouchend = ()=>dirs[d]=false;
});
document.getElementById('a').ontouchstart = e=>{e.preventDefault(); if(state==='play') advance();};
document.getElementById('advance').onclick = advance;
document.getElementById('menuIcon').onclick = ()=>{
  const p = document.getElementById('menuPanel');
  p.style.display = p.style.display==='flex'?'none':'flex';
};
document.getElementById('closeMenu').onclick = ()=>document.getElementById('menuPanel').style.display='none';
document.getElementById('saveBtn').onclick = ()=>{
  localStorage.setItem('nova',JSON.stringify({name,starter,px,py,map,potion,talkedMom}));
  queueDialog(['Game saved!']);
};

// game loop
function loop() {
  if (state==='play') {
    let moved = false;
    if (dirs.up)    { pdir=0; moved = tryMove(0,-1); }
    if (dirs.down)  { pdir=2; moved = tryMove(0,1); }
    if (dirs.left)  { pdir=1; moved = tryMove(-1,0); }
    if (dirs.right) { pdir=3; moved = tryMove(1,0); }
    if (moved) {
      fx = px; fy = py; // simple follow for now
    }
    updateCam();
  }

  if (dtext) dpos = Math.min(dpos+2, dtext.length);

  render();
  requestAnimationFrame(loop);
}

function tryMove(dx,dy) {
  const nx = px + dx, ny = py + dy;
  const m = maps[map];
  if (nx<0 || ny<0 || ny>=m.length || nx>=m[0].length) return false;
  if (m[ny][nx] !== 1) {
    px = nx; py = ny;
    return true;
  }
  return false;
}

loop();
</script>
</body>
</html>
