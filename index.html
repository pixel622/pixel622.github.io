<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
// ===============================
// üî• FIREBASE CONFIG (REPLACE THIS)
// ===============================
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_ID",
  appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ===============================
// ORIGINAL GAME CODE (UNCHANGED UI)
// ===============================

const listBtn = document.getElementById('listBtn');
const imageInp = document.getElementById('imageInp');
const fileLabel = document.getElementById('fileLabel');
const grid = document.getElementById('grid');
const balanceDisplay = document.getElementById('balanceDisplay');

let currentBalance = 10000;

// Image label update
imageInp.addEventListener('change', function() {
    if (this.files[0]) {
        fileLabel.innerText = "IMAGE LOADED: " + this.files[0].name;
        fileLabel.style.borderColor = "#0f0";
        fileLabel.style.color = "#0f0";
    } else {
        fileLabel.innerText = "[ SELECT FROM GALLERY ]";
        fileLabel.style.borderColor = "#444";
        fileLabel.style.color = "var(--accent)";
    }
});

// Load balance (still local per player)
window.onload = () => {
    const savedBalance = localStorage.getItem('kyc_balance');
    if (savedBalance !== null) {
        currentBalance = parseInt(savedBalance);
    } else {
        localStorage.setItem('kyc_balance', '10000');
    }
    updateBalanceDisplay();
};

// ===============================
// üî• MULTIPLAYER LISTENER
// ===============================
database.ref("market_items").on("child_added", (snapshot) => {
    const item = snapshot.val();
    createCard(item.name, item.price + " KYC", item.img, snapshot.key);
});

database.ref("market_items").on("child_removed", (snapshot) => {
    const itemId = snapshot.key;
    const card = document.querySelector(`[data-id='${itemId}']`);
    if (card) card.remove();
});

// ===============================
// LIST ITEM
// ===============================
listBtn.onclick = () => {
    const name = document.getElementById('nameInp').value.trim();
    const price = document.getElementById('priceInp').value.trim();
    const file = imageInp.files[0];

    if (!name || !price || !file) {
        alert("Fill all fields and select an image!");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const imgData = e.target.result;

        database.ref("market_items").push({
            name: name,
            price: parseInt(price),
            img: imgData
        });

        document.getElementById('nameInp').value = '';
        document.getElementById('priceInp').value = '';
        imageInp.value = '';
        fileLabel.innerText = "[ SELECT FROM GALLERY ]";
        fileLabel.style.borderColor = "#444";
        fileLabel.style.color = "var(--accent)";

        alert("Item listed globally!");
    };

    reader.readAsDataURL(file);
};

// ===============================
// CREATE CARD
// ===============================
function createCard(name, price, img, itemId) {
    if (document.querySelector(`[data-id='${itemId}']`)) return;

    const div = document.createElement('div');
    div.className = 'card';
    div.setAttribute('data-id', itemId);

    const numericPrice = parseInt(price) || 0;

    div.innerHTML = `
        <img src="${img}">
        <h3>${name}</h3>
        <div class="price">${numericPrice} <span>KYC</span></div>
        <button class="purchase-btn" onclick="purchaseItem('${itemId}', ${numericPrice}, this)">PURCHASE</button>
        <div class="seller-badge">‚óè LISTED ON BLACK MARKET</div>
    `;

    grid.prepend(div);

    const purchaseBtn = div.querySelector('.purchase-btn');
    if (numericPrice > currentBalance) {
        purchaseBtn.disabled = true;
    }
}

// ===============================
// PURCHASE ITEM
// ===============================
window.purchaseItem = function(itemId, price, btnElement) {
    if (price > currentBalance) {
        alert("Insufficient KYC balance!");
        return;
    }

    if (confirm(`Purchase for ${price} KYC?`)) {

        currentBalance -= price;
        localStorage.setItem('kyc_balance', currentBalance.toString());
        updateBalanceDisplay();

        database.ref("market_items/" + itemId).remove();

        alert("Purchase complete!");
    }
};

// ===============================
function updateAllPurchaseButtons() {
    document.querySelectorAll('.purchase-btn').forEach(btn => {
        const card = btn.closest('.card');
        const numericPrice = parseInt(card.querySelector('.price').textContent) || 0;
        btn.disabled = numericPrice > currentBalance;
    });
}

function updateBalanceDisplay() {
    balanceDisplay.textContent = currentBalance;
    updateAllPurchaseButtons();
}

// ===============================
// CLEAR MARKET (GLOBAL WIPE)
// ===============================
function clearMarket() {
    if(confirm("Wipe ALL listings globally and reset balance?")) {
        database.ref("market_items").remove();
        localStorage.setItem('kyc_balance', '10000');
        location.reload();
    }
}
</script>
