
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pok√©mon Pixel Adventure</title>
    <style>
        /* ===== RESET & FULLSCREEN STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: none;
            -moz-text-size-adjust: none;
            -ms-text-size-adjust: none;
            text-size-adjust: none;
            touch-action: manipulation;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: monospace;
        }

        body {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(45deg, #111, #222);
        }

        /* ===== GBA SCREEN (FULLSCREEN) ===== */
        #gba-screen {
            width: 100vw;
            height: 100vh;
            max-width: 100%;
            max-height: 100%;
            background: #8bac0f;
            position: relative;
            overflow: hidden;
        }

        /* ===== CANVAS ===== */
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* ===== SCREEN EFFECTS ===== */
        .screen-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        .crt-scanlines {
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            animation: scanlines 8s linear infinite;
        }

        .crt-glow {
            background: radial-gradient(
                ellipse at center,
                rgba(15, 56, 15, 0.2) 0%,
                rgba(0, 0, 0, 0.5) 100%
            );
        }

        .pixel-grid {
            background-image: 
                linear-gradient(rgba(15, 56, 15, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(15, 56, 15, 0.1) 1px, transparent 1px);
            background-size: 4px 4px;
        }

        @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(4px); }
        }

        /* ===== POWER LED ===== */
        .power-led {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            background: #ff4444;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff4444;
            animation: led-pulse 2s infinite;
            z-index: 1000;
        }

        @keyframes led-pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* ===== GAME SCREENS ===== */
        .game-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #screen-intro { 
            background: #000; 
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #screen-title { 
            background: linear-gradient(to bottom, #306230, #8bac0f); 
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #screen-gameplay { display: none; }
        #screen-battle { display: none; }
        #screen-name-input { display: none; }

        /* ===== INTRO SCREEN ===== */
        .nintendo-logo {
            color: #fff;
            text-align: center;
            font-size: 5vw;
            animation: logo-sequence 4s ease-in-out forwards;
        }

        .nintendo-copyright {
            font-size: 8vw;
            margin-bottom: 3vh;
            display: block;
        }

        .gba-text {
            font-size: 2.5vw;
            letter-spacing: 1vw;
            color: #8bac0f;
            margin-top: 2vh;
            opacity: 0;
            animation: fade-in 1s 3s forwards;
        }

        @keyframes logo-sequence {
            0% { opacity: 0; transform: scale(0.8); }
            20% { opacity: 1; transform: scale(1); }
            80% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.1); }
        }

        @keyframes fade-in {
            to { opacity: 1; }
        }

        /* ===== TITLE SCREEN ===== */
        .pokemon-logo {
            font-size: 8vw;
            color: #ffcc00;
            text-shadow: 
                0.4vw 0.4vw 0 #306230,
                0.6vw 0.6vw 0 rgba(0, 0, 0, 0.5);
            margin-bottom: 2vh;
            animation: logo-float 3s infinite ease-in-out;
        }

        .version-text {
            font-size: 3vw;
            color: #e8f8e0;
            margin-bottom: 6vh;
            text-shadow: 0.2vw 0.2vw 0 #306230;
        }

        .title-menu {
            display: flex;
            flex-direction: column;
            gap: 1vh;
            margin-bottom: 4vh;
        }

        .menu-option {
            padding: 2vh 4vw;
            background: #306230;
            border: 0.5vh solid #0f380f;
            color: #e8f8e0;
            font-size: 3vw;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .menu-option:hover, .menu-option.selected {
            background: #ffcc00;
            color: #306230;
        }

        .save-info {
            font-size: 2vw;
            color: #a8a878;
            margin-top: 3vh;
        }

        @keyframes logo-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-1vh); }
        }

        /* ===== DIALOG SYSTEM ===== */
        .dialog-box {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 25vh;
            background: #e8f8e0;
            border: 1vh solid #0f380f;
            border-left: 0;
            border-right: 0;
            border-bottom: 0;
            padding: 2vh;
            z-index: 50;
            display: none;
            box-shadow: 0 -1vh 3vh rgba(0, 0, 0, 0.4);
        }

        .dialog-text {
            font-size: 3vh;
            line-height: 3.5vh;
            color: #0f380f;
            height: 15vh;
            overflow: hidden;
        }

        .dialog-continue {
            position: absolute;
            bottom: 2vh;
            right: 3vh;
            color: #306230;
            font-size: 2.5vh;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* ===== NAME INPUT ===== */
        .name-input-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #e8f8e0;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 5vh;
        }

        .name-input-title {
            font-size: 4vh;
            color: #0f380f;
            margin-bottom: 4vh;
            text-align: center;
        }

        .name-display {
            font-size: 6vh;
            color: #306230;
            text-align: center;
            margin: 4vh 0;
            min-height: 8vh;
            letter-spacing: 1vh;
            font-weight: bold;
            border-bottom: 0.5vh solid #0f380f;
            padding-bottom: 2vh;
            width: 80%;
        }

        .name-keyboard {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 0.5vh;
            margin: 3vh 0;
            width: 80%;
            max-width: 80vw;
        }

        .keyboard-key {
            padding: 1.5vh;
            background: #306230;
            color: #e8f8e0;
            border: 0.3vh solid #0f380f;
            font-size: 2.5vh;
            cursor: pointer;
            text-align: center;
            border-radius: 0.5vh;
        }

        .keyboard-key:active {
            background: #ffcc00;
            color: #306230;
        }

        .name-controls {
            display: flex;
            gap: 3vw;
            margin-top: 4vh;
        }

        .name-control-btn {
            padding: 2vh 4vw;
            background: #306230;
            color: #e8f8e0;
            border: 0.5vh solid #0f380f;
            font-size: 3vh;
            cursor: pointer;
            min-width: 20vw;
            text-align: center;
            border-radius: 1vh;
        }

        .name-control-btn.confirm {
            background: #4a752c;
        }

        .name-control-btn.cancel {
            background: #d85050;
        }

        /* ===== BATTLE SYSTEM ===== */
        .battle-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #3060a8 0%, #8bac0f 100%);
            display: none;
            z-index: 40;
        }

        .battle-hud {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 25vh;
            background: #306230;
            border-top: 1vh solid #0f380f;
            padding: 2vh;
        }

        .battle-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1vh;
            height: 20vh;
        }

        .battle-option {
            background: #e8f8e0;
            border: 0.5vh solid #0f380f;
            color: #0f380f;
            font-size: 2.5vh;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 1vh;
        }

        .battle-option:active {
            background: #ffcc00;
        }

        .battle-info {
            position: absolute;
            top: 3vh;
            left: 3vh;
            background: #e8f8e0;
            border: 0.8vh solid #0f380f;
            padding: 2vh;
            width: 40vw;
            border-radius: 1vh;
        }

        .battle-info.enemy {
            left: auto;
            right: 3vh;
            text-align: right;
        }

        .pokemon-name {
            font-size: 2.5vh;
            color: #306230;
            margin-bottom: 1vh;
        }

        .pokemon-level {
            color: #ffcc00;
        }

        .health-container {
            margin: 1vh 0;
        }

        .health-bar {
            height: 2vh;
            background: #0f380f;
            border: 0.3vh solid #000;
            border-radius: 0.5vh;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(to right, #00ff00, #88ff00);
        }

        .health-text {
            font-size: 1.8vh;
            color: #0f380f;
            margin-top: 0.5vh;
        }

        .battle-sprites {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 30vh;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 5vw;
        }

        .battle-sprite {
            width: 25vw;
            height: 25vw;
            background: rgba(255, 255, 255, 0.1);
            border: 1vh solid rgba(255, 255, 255, 0.2);
            border-radius: 3vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15vw;
            color: #fff;
        }

        .battle-move-select {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(48, 98, 48, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 45;
        }

        .move-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2vh;
            padding: 5vh;
            width: 90%;
        }

        .move-option {
            padding: 3vh;
            background: #e8f8e0;
            border: 0.5vh solid #0f380f;
            color: #0f380f;
            font-size: 2.5vh;
            cursor: pointer;
            text-align: center;
            border-radius: 1vh;
        }

        .move-option:active {
            background: #ffcc00;
        }

        /* ===== MOBILE CONTROLS ===== */
        #mobile-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100vw;
            height: 30vh;
            z-index: 200;
            display: flex;
            justify-content: space-between;
            padding: 3vh;
            pointer-events: none;
        }

        .control-dpad {
            width: 30vh;
            height: 30vh;
            position: relative;
            pointer-events: auto;
        }

        .dpad-button {
            position: absolute;
            width: 10vh;
            height: 10vh;
            background: rgba(48, 98, 48, 0.9);
            border: 0.8vh solid #0f380f;
            color: #e8f8e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5vh;
            cursor: pointer;
            border-radius: 2vh;
            box-shadow: 0 0.5vh 1vh rgba(0, 0, 0, 0.3);
        }

        .dpad-button:active {
            background: #ffcc00;
            color: #306230;
            transform: scale(0.95);
        }

        .dpad-up { top: 0; left: 10vh; }
        .dpad-down { bottom: 0; left: 10vh; }
        .dpad-left { top: 10vh; left: 0; }
        .dpad-right { top: 10vh; right: 0; }

        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 3vh;
            pointer-events: auto;
            align-items: center;
        }

        .action-button {
            width: 12vh;
            height: 12vh;
            background: rgba(139, 172, 15, 0.9);
            border: 1vh solid #306230;
            border-radius: 50%;
            color: #e8f8e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4vh;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 1vh 2vh rgba(0, 0, 0, 0.4);
        }

        .action-button:active {
            background: #ffcc00;
            color: #306230;
            transform: scale(0.95);
        }

        .action-button.start {
            width: 20vh;
            height: 8vh;
            border-radius: 4vh;
            font-size: 3vh;
            margin-top: 2vh;
        }

        /* ===== LOADING SCREEN ===== */
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #8bac0f;
        }

        .loading-spinner {
            width: 10vh;
            height: 10vh;
            border: 1vh solid #306230;
            border-top-color: #ffcc00;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 3vh;
        }

        .loading-text {
            font-size: 3vh;
            animation: pulse 1.5s infinite;
        }

        /* ===== ORIENTATION WARNING ===== */
        #orientation-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #ffcc00;
            text-align: center;
            padding: 5vh;
        }

        .rotate-icon {
            font-size: 20vh;
            margin-bottom: 5vh;
            animation: rotate 2s infinite linear;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(90deg); }
        }

        /* ===== MEDIA QUERIES ===== */
        @media (max-width: 768px) {
            .nintendo-logo {
                font-size: 8vw;
            }
            .nintendo-copyright {
                font-size: 12vw;
            }
            .gba-text {
                font-size: 4vw;
                letter-spacing: 2vw;
            }
            .pokemon-logo {
                font-size: 12vw;
            }
            .version-text {
                font-size: 5vw;
            }
            .menu-option {
                font-size: 5vw;
                padding: 1.5vh 6vw;
            }
            .save-info {
                font-size: 3vw;
            }
        }

        @media (orientation: portrait) {
            #orientation-warning {
                display: flex;
            }
            #mobile-controls {
                display: none;
            }
        }

        @media (orientation: landscape) {
            #orientation-warning {
                display: none;
            }
            #mobile-controls {
                display: flex;
            }
        }

        /* ===== UTILITY ===== */
        .hidden { display: none !important; }
        .visible { display: flex !important; }
        .no-select { user-select: none; }
    </style>
</head>
<body class="no-select">
    <!-- GBA Screen -->
    <div id="gba-screen">
        <!-- Power LED -->
        <div class="power-led"></div>
        
        <!-- Game Screens -->
        <div id="screen-intro" class="game-screen">
            <div class="nintendo-logo">
                <span class="nintendo-copyright">¬©</span>
                NINTENDO<br>
                <span class="gba-text">GAME BOY ADVANCE</span>
            </div>
        </div>
        
        <div id="screen-title" class="game-screen">
            <div class="pokemon-logo">POK√©MON</div>
            <div class="version-text">PIXEL ADVENTURE</div>
            <div class="title-menu">
                <div class="menu-option selected" id="btn-new-game">NEW GAME</div>
                <div class="menu-option" id="btn-continue">CONTINUE</div>
                <div class="menu-option" id="btn-options">OPTIONS</div>
            </div>
            <div class="save-info" id="save-info">No save data</div>
        </div>
        
        <!-- Gameplay Screen -->
        <div id="screen-gameplay" class="game-screen">
            <canvas id="game-canvas"></canvas>
            
            <!-- Dialog Box -->
            <div id="dialog-box" class="dialog-box">
                <div id="dialog-text" class="dialog-text"></div>
                <div id="dialog-continue" class="dialog-continue">‚ñº</div>
            </div>
        </div>
        
        <!-- Battle Screen -->
        <div id="screen-battle" class="game-screen battle-container">
            <!-- Battle Sprites -->
            <div class="battle-sprites">
                <div class="battle-sprite" id="player-sprite">‚ö°</div>
                <div class="battle-sprite" id="enemy-sprite">üê¶</div>
            </div>
            
            <!-- Player Info -->
            <div class="battle-info">
                <div class="pokemon-name" id="player-pokemon-name">PIKACHU <span class="pokemon-level">Lv5</span></div>
                <div class="health-container">
                    <div class="health-bar">
                        <div id="player-health" class="health-fill" style="width: 100%"></div>
                    </div>
                    <div class="health-text" id="player-health-text">HP: 20/20</div>
                </div>
            </div>
            
            <!-- Enemy Info -->
            <div class="battle-info enemy">
                <div class="pokemon-name" id="enemy-pokemon-name">PIDGEY <span class="pokemon-level">Lv3</span></div>
                <div class="health-container">
                    <div class="health-bar">
                        <div id="enemy-health" class="health-fill" style="width: 100%"></div>
                    </div>
                    <div class="health-text" id="enemy-health-text">HP: 18/18</div>
                </div>
            </div>
            
            <!-- Move Selection -->
            <div id="move-select" class="battle-move-select">
                <div class="move-grid" id="move-grid"></div>
            </div>
            
            <!-- Battle Options -->
            <div class="battle-hud">
                <div class="battle-options" id="battle-options">
                    <div class="battle-option" data-action="fight">FIGHT</div>
                    <div class="battle-option" data-action="pokemon">POK√©MON</div>
                    <div class="battle-option" data-action="bag">BAG</div>
                    <div class="battle-option" data-action="run">RUN</div>
                </div>
            </div>
        </div>
        
        <!-- Name Input Screen -->
        <div id="screen-name-input" class="game-screen name-input-screen">
            <div class="name-input-title">What is your name?</div>
            <div id="name-display" class="name-display"></div>
            <div class="name-keyboard" id="name-keyboard"></div>
            <div class="name-controls">
                <div class="name-control-btn confirm" id="btn-name-confirm">OK</div>
                <div class="name-control-btn cancel" id="btn-name-cancel">CANCEL</div>
            </div>
        </div>
        
        <!-- Screen Effects -->
        <div class="screen-overlay crt-scanlines"></div>
        <div class="screen-overlay crt-glow"></div>
        <div class="screen-overlay pixel-grid"></div>
    </div>
    
    <!-- Mobile Controls -->
    <div id="mobile-controls">
        <div class="control-dpad">
            <div class="dpad-button dpad-up" data-direction="up">‚Üë</div>
            <div class="dpad-button dpad-down" data-direction="down">‚Üì</div>
            <div class="dpad-button dpad-left" data-direction="left">‚Üê</div>
            <div class="dpad-button dpad-right" data-direction="right">‚Üí</div>
        </div>
        
        <div class="control-buttons">
            <div class="action-button" id="btn-a">A</div>
            <div class="action-button" id="btn-b">B</div>
            <div class="action-button start" id="btn-start">START</div>
        </div>
    </div>
    
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">LOADING...</div>
    </div>
    
    <!-- Orientation Warning -->
    <div id="orientation-warning">
        <div class="rotate-icon">‚Üª</div>
        <h2 style="margin-bottom: 3vh; color: #ffcc00;">PLEASE ROTATE YOUR DEVICE</h2>
        <p style="color: #8bac0f; font-size: 3vh; line-height: 1.5;">
            This game requires landscape mode<br>
            for the best experience
        </p>
    </div>

    <script>
        // ============================================
        // GAME STATE
        // ============================================
        const GameState = {
            // Core State
            currentScreen: "loading",
            
            // Player Data
            player: {
                name: "",
                money: 3000,
                badges: 0,
                pokedex: {
                    seen: [25, 16],
                    caught: [25]
                },
                position: { x: 50, y: 50 },
                direction: "down",
                isRunning: false,
                steps: 0,
                
                // Team
                team: [
                    { 
                        id: 25, 
                        name: "PIKACHU", 
                        level: 5,
                        hp: 20,
                        maxHp: 20,
                        moves: [
                            { name: "THUNDERSHOCK", pp: 30, maxPP: 30 },
                            { name: "GROWL", pp: 40, maxPP: 40 },
                            { name: "QUICK ATTACK", pp: 30, maxPP: 30 }
                        ]
                    }
                ],
                
                // Bag
                bag: {
                    items: [
                        { id: "POTION", quantity: 3 },
                        { id: "POK√© BALL", quantity: 10 }
                    ]
                }
            },
            
            // Battle State
            battle: {
                active: false,
                enemy: null,
                turn: "player"
            },
            
            // Dialog State
            dialog: {
                active: false,
                lines: [],
                currentLine: 0,
                typing: false,
                speed: 30
            },
            
            // Map State
            map: {
                tiles: [],
                npcs: [
                    { x: 100, y: 100, name: "OAK", dialog: "Welcome to the world of POK√©MON!" },
                    { x: 200, y: 150, name: "MOM", dialog: "Be careful on your journey!" }
                ],
                buildings: [
                    { x: 50, y: 80, width: 60, height: 60, name: "YOUR HOUSE" },
                    { x: 200, y: 80, width: 60, height: 60, name: "OAK'S LAB" }
                ]
            }
        };

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const elements = {
            screens: {
                intro: document.getElementById('screen-intro'),
                title: document.getElementById('screen-title'),
                gameplay: document.getElementById('screen-gameplay'),
                battle: document.getElementById('screen-battle'),
                nameInput: document.getElementById('screen-name-input')
            },
            canvas: document.getElementById('game-canvas'),
            ctx: document.getElementById('game-canvas').getContext('2d'),
            dialog: {
                box: document.getElementById('dialog-box'),
                text: document.getElementById('dialog-text'),
                continue: document.getElementById('dialog-continue')
            },
            battle: {
                container: document.getElementById('screen-battle'),
                playerHealth: document.getElementById('player-health'),
                playerHealthText: document.getElementById('player-health-text'),
                enemyHealth: document.getElementById('enemy-health'),
                enemyHealthText: document.getElementById('enemy-health-text'),
                playerName: document.getElementById('player-pokemon-name'),
                enemyName: document.getElementById('enemy-pokemon-name'),
                moveSelect: document.getElementById('move-select'),
                moveGrid: document.getElementById('move-grid')
            },
            mobileControls: document.getElementById('mobile-controls'),
            loading: document.getElementById('loading-screen'),
            orientationWarning: document.getElementById('orientation-warning')
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        function initializeGame() {
            console.log("üéÆ Initializing game...");
            
            // Set canvas size to full screen
            resizeCanvas();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check orientation
            checkOrientation();
            
            // Hide loading screen after a moment
            setTimeout(() => {
                elements.loading.style.display = 'none';
                startIntroSequence();
            }, 1500);
            
            // Start game loop
            requestAnimationFrame(gameLoop);
            
            console.log("‚úÖ Game initialized!");
        }

        function resizeCanvas() {
            const screen = document.getElementById('gba-screen');
            elements.canvas.width = screen.clientWidth;
            elements.canvas.height = screen.clientHeight;
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            // Window events
            window.addEventListener('resize', resizeCanvas);
            window.addEventListener('orientationchange', checkOrientation);
            
            // Title screen buttons
            document.getElementById('btn-new-game').addEventListener('click', startNewGame);
            document.getElementById('btn-continue').addEventListener('click', continueGame);
            document.getElementById('btn-options').addEventListener('click', showOptions);
            
            // Name input
            document.getElementById('btn-name-confirm').addEventListener('click', confirmName);
            document.getElementById('btn-name-cancel').addEventListener('click', cancelNameInput);
            
            // Dialog
            elements.dialog.box.addEventListener('click', handleDialogClick);
            
            // Mobile controls
            setupMobileControls();
            
            // Keyboard support
            document.addEventListener('keydown', handleKeyDown);
            
            // Prevent default touch behaviors
            document.addEventListener('touchstart', (e) => {
                if (e.target === elements.canvas || 
                    e.target.closest('.dpad-button') || 
                    e.target.closest('.action-button')) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        function setupMobileControls() {
            // D-pad buttons
            document.querySelectorAll('.dpad-button[data-direction]').forEach(btn => {
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const direction = btn.getAttribute('data-direction');
                    handleDirectionPress(direction, true);
                });
                
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    const direction = btn.getAttribute('data-direction');
                    handleDirectionPress(direction, false);
                });
            });
            
            // Action buttons
            document.getElementById('btn-a').addEventListener('click', handleAButton);
            document.getElementById('btn-b').addEventListener('click', handleBButton);
            document.getElementById('btn-start').addEventListener('click', handleStartButton);
            
            // Battle buttons
            document.querySelectorAll('.battle-option').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.target.getAttribute('data-action');
                    handleBattleAction(action);
                });
            });
        }

        // ============================================
        // INPUT HANDLING
        // ============================================
        function handleKeyDown(e) {
            if (GameState.currentScreen === "name_input") {
                handleNameInputKey(e);
                return;
            }
            
            switch(e.key) {
                case 'ArrowUp':
                case 'w':
                    handleDirectionPress('up', true);
                    setTimeout(() => handleDirectionPress('up', false), 100);
                    break;
                case 'ArrowDown':
                case 's':
                    handleDirectionPress('down', true);
                    setTimeout(() => handleDirectionPress('down', false), 100);
                    break;
                case 'ArrowLeft':
                case 'a':
                    handleDirectionPress('left', true);
                    setTimeout(() => handleDirectionPress('left', false), 100);
                    break;
                case 'ArrowRight':
                case 'd':
                    handleDirectionPress('right', true);
                    setTimeout(() => handleDirectionPress('right', false), 100);
                    break;
                case 'Enter':
                case ' ':
                    handleAButton();
                    break;
                case 'Escape':
                case 'Backspace':
                    handleBButton();
                    break;
            }
        }

        let movementInterval = null;
        function handleDirectionPress(direction, pressed) {
            if (GameState.currentScreen !== "gameplay" || GameState.dialog.active || GameState.battle.active) return;
            
            if (pressed) {
                GameState.player.direction = direction;
                
                // Clear existing interval
                if (movementInterval) {
                    clearInterval(movementInterval);
                }
                
                // Start movement
                movementInterval = setInterval(() => {
                    movePlayer(direction);
                }, 16);
            } else {
                // Stop movement
                if (movementInterval) {
                    clearInterval(movementInterval);
                    movementInterval = null;
                }
            }
        }

        function movePlayer(direction) {
            const speed = GameState.player.isRunning ? 4 : 2;
            const canvas = elements.canvas;
            
            switch(direction) {
                case 'up':
                    GameState.player.position.y = Math.max(20, GameState.player.position.y - speed);
                    break;
                case 'down':
                    GameState.player.position.y = Math.min(canvas.height - 20, GameState.player.position.y + speed);
                    break;
                case 'left':
                    GameState.player.position.x = Math.max(20, GameState.player.position.x - speed);
                    break;
                case 'right':
                    GameState.player.position.x = Math.min(canvas.width - 20, GameState.player.position.x + speed);
                    break;
            }
            
            GameState.player.steps++;
            
            // Check for random encounters
            if (Math.random() < 0.005 && GameState.player.steps % 30 === 0) {
                startBattle();
            }
            
            // Check for NPC proximity
            checkNPCProximity();
        }

        function handleAButton() {
            switch(GameState.currentScreen) {
                case "title":
                    // Menu selection handled by click events
                    break;
                case "gameplay":
                    if (GameState.dialog.active) {
                        advanceDialog();
                    } else if (GameState.battle.active) {
                        // Battle actions handled by buttons
                    } else {
                        interactWithObject();
                    }
                    break;
                case "battle":
                    // Battle actions handled by buttons
                    break;
            }
        }

        function handleBButton() {
            if (GameState.dialog.active) {
                if (GameState.dialog.typing) {
                    // Skip typing animation
                    GameState.dialog.typing = false;
                    elements.dialog.text.textContent = GameState.dialog.lines[GameState.dialog.currentLine - 1];
                } else {
                    advanceDialog();
                }
            } else if (GameState.battle.active) {
                if (GameState.battle.menu === "moves") {
                    closeMoveSelection();
                } else {
                    endBattle();
                }
            }
        }

        function handleStartButton() {
            if (GameState.currentScreen === "gameplay" && !GameState.dialog.active && !GameState.battle.active) {
                showDialog([
                    "MENU",
                    "POK√©DEX: " + GameState.player.pokedex.seen.length,
                    "BADGES: " + GameState.player.badges,
                    "MONEY: $" + GameState.player.money,
                    "TIME: 0:00"
                ]);
            }
        }

        // ============================================
        // GAME SCREENS
        // ============================================
        function startIntroSequence() {
            GameState.currentScreen = "intro";
            
            // Show Nintendo logo for 4 seconds
            setTimeout(() => {
                switchToScreen("title");
                updateSaveInfo();
            }, 4000);
        }

        function switchToScreen(screen) {
            // Hide all screens
            Object.values(elements.screens).forEach(s => s.style.display = 'none');
            
            // Show requested screen
            elements.screens[screen].style.display = 'block';
            GameState.currentScreen = screen;
            
            // Special handling
            switch(screen) {
                case "gameplay":
                    initializeGameplay();
                    elements.mobileControls.style.display = 'flex';
                    break;
                case "title":
                    elements.mobileControls.style.display = 'none';
                    break;
                case "battle":
                    initializeBattle();
                    break;
                case "name_input":
                    initializeNameInput();
                    break;
            }
        }

        // ============================================
        // NEW GAME FLOW
        // ============================================
        function startNewGame() {
            // Reset player name
            GameState.player.name = "";
            
            // Switch to name input
            switchToScreen("name_input");
        }

        function initializeNameInput() {
            // Clear name display
            document.getElementById('name-display').textContent = "";
            
            // Create keyboard
            createKeyboard();
        }

        function createKeyboard() {
            const keyboard = document.getElementById('name-keyboard');
            keyboard.innerHTML = '';
            
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ  -.';
            
            for (let letter of letters) {
                const key = document.createElement('div');
                key.className = 'keyboard-key';
                key.textContent = letter;
                key.addEventListener('click', () => {
                    if (GameState.player.name.length < 10) {
                        GameState.player.name += letter;
                        updateNameDisplay();
                    }
                });
                keyboard.appendChild(key);
            }
            
            // Add backspace key
            const backspace = document.createElement('div');
            backspace.className = 'keyboard-key';
            backspace.textContent = '‚å´';
            backspace.style.gridColumn = 'span 2';
            backspace.addEventListener('click', () => {
                GameState.player.name = GameState.player.name.slice(0, -1);
                updateNameDisplay();
            });
            keyboard.appendChild(backspace);
        }

        function handleNameInputKey(e) {
            if (e.key === 'Backspace') {
                GameState.player.name = GameState.player.name.slice(0, -1);
            } else if (e.key === 'Enter') {
                confirmName();
            } else if (e.key.length === 1 && /[A-Za-z\s\-\.]/.test(e.key)) {
                if (GameState.player.name.length < 10) {
                    GameState.player.name += e.key.toUpperCase();
                }
            }
            updateNameDisplay();
            e.preventDefault();
        }

        function updateNameDisplay() {
            document.getElementById('name-display').textContent = 
                GameState.player.name.padEnd(10, '_');
        }

        function confirmName() {
            if (GameState.player.name.trim().length > 0) {
                GameState.player.name = GameState.player.name.trim().toUpperCase();
                switchToScreen("gameplay");
                startGameIntroduction();
            }
        }

        function cancelNameInput() {
            switchToScreen("title");
        }

        // ============================================
        // GAME INTRODUCTION
        // ============================================
        function startGameIntroduction() {
            showDialog([
                "Hello there! Welcome to the world",
                "of POK√©MON! My name is OAK!",
                "People call me the POK√©MON PROFESSOR!"
            ], () => {
                setTimeout(() => {
                    showDialog([
                        "This world is inhabited by creatures",
                        "called POK√©MON!",
                        "For some people, POK√©MON are pets.",
                        "Others use them for fights.",
                        "Myself... I study POK√©MON as a",
                        "profession."
                    ], () => {
                        setTimeout(() => {
                            showDialog([
                                `First, what is your name?`
                            ], () => {
                                setTimeout(() => {
                                    showDialog([
                                        `Right! So your name is`,
                                        `${GameState.player.name}!`
                                    ], () => {
                                        setTimeout(() => {
                                            showDialog([
                                                `This is my grandson.`,
                                                `He's been your rival since`,
                                                `you were a baby.`,
                                                `...Erm, what is his name again?`
                                            ], () => {
                                                setTimeout(() => {
                                                    showDialog([
                                                        `That's right! I remember now!`,
                                                        `His name is GARY!`
                                                    ], () => {
                                                        setTimeout(() => {
                                                            showDialog([
                                                                `${GameState.player.name}!`,
                                                                `Your very own POK√©MON legend`,
                                                                `is about to unfold!`,
                                                                `A world of dreams and adventures`,
                                                                `with POK√©MON awaits! Let's go!`
                                                            ]);
                                                        }, 1000);
                                                    });
                                                }, 1000);
                                            });
                                        }, 1000);
                                    });
                                }, 1000);
                            });
                        }, 1000);
                    });
                }, 1000);
            });
        }

        // ============================================
        // GAMEPLAY SYSTEM
        // ============================================
        function initializeGameplay() {
            // Center player
            const canvas = elements.canvas;
            GameState.player.position.x = canvas.width / 2;
            GameState.player.position.y = canvas.height / 2;
            
            // Start drawing
            drawGameWorld();
        }

        function drawGameWorld() {
            const ctx = elements.ctx;
            const canvas = elements.canvas;
            
            // Clear canvas
            ctx.fillStyle = '#8bac0f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw grass pattern
            drawGrassPattern();
            
            // Draw path
            drawPath();
            
            // Draw buildings
            drawBuildings();
            
            // Draw NPCs
            drawNPCs();
            
            // Draw player
            drawPlayer();
            
            // Draw HUD
            drawHUD();
        }

        function drawGrassPattern() {
            const ctx = elements.ctx;
            const canvas = elements.canvas;
            const tileSize = 32;
            
            // Calculate number of tiles
            const tilesX = Math.ceil(canvas.width / tileSize);
            const tilesY = Math.ceil(canvas.height / tileSize);
            
            // Draw grass tiles
            ctx.fillStyle = '#4a752c';
            for (let y = 0; y < tilesY; y++) {
                for (let x = 0; x < tilesX; x++) {
                    // Draw grass with some variation
                    if ((x + y) % 3 === 0) {
                        ctx.fillStyle = '#5a853c';
                    } else {
                        ctx.fillStyle = '#4a752c';
                    }
                    ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
                    
                    // Draw grass border
                    ctx.strokeStyle = '#0f380f';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x * tileSize, y * tileSize, tileSize, tileSize);
                }
            }
        }

        function drawPath() {
            const ctx = elements.ctx;
            const canvas = elements.canvas;
            
            // Draw horizontal path
            ctx.fillStyle = '#a8a878';
            const pathWidth = canvas.width * 0.2;
            const pathX = (canvas.width - pathWidth) / 2;
            ctx.fillRect(pathX, 0, pathWidth, canvas.height);
            
            // Draw path border
            ctx.strokeStyle = '#0f380f';
            ctx.lineWidth = 3;
            ctx.strokeRect(pathX, 0, pathWidth, canvas.height);
        }

        function drawBuildings() {
            const ctx = elements.ctx;
            
            GameState.map.buildings.forEach(building => {
                // Draw building base
                ctx.fillStyle = '#d87070';
                ctx.fillRect(building.x, building.y, building.width, building.height);
                
                // Draw roof
                ctx.fillStyle = '#306230';
                ctx.beginPath();
                ctx.moveTo(building.x - 10, building.y);
                ctx.lineTo(building.x + building.width + 10, building.y);
                ctx.lineTo(building.x + building.width / 2, building.y - 20);
                ctx.closePath();
                ctx.fill();
                
                // Draw door
                ctx.fillStyle = '#0f380f';
                ctx.fillRect(
                    building.x + building.width / 2 - 10,
                    building.y + building.height - 20,
                    20, 20
                );
                
                // Draw building border
                ctx.strokeStyle = '#0f380f';
                ctx.lineWidth = 3;
                ctx.strokeRect(building.x, building.y, building.width, building.height);
                
                // Draw building name
                ctx.fillStyle = '#0f380f';
                ctx.font = '12px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(
                    building.name,
                    building.x + building.width / 2,
                    building.y + building.height / 2
                );
            });
        }

        function drawNPCs() {
            const ctx = elements.ctx;
            
            GameState.map.npcs.forEach(npc => {
                // Draw NPC body
                ctx.fillStyle = '#3060a8';
                ctx.fillRect(npc.x - 8, npc.y - 8, 16, 16);
                
                // Draw NPC face
                ctx.fillStyle = '#ffcc00';
                ctx.fillRect(npc.x - 4, npc.y - 8, 8, 4);
                
                // Draw interaction indicator if close
                const distance = Math.sqrt(
                    Math.pow(GameState.player.position.x - npc.x, 2) + 
                    Math.pow(GameState.player.position.y - npc.y, 2)
                );
                
                if (distance < 40) {
                    ctx.fillStyle = '#ffcc00';
                    ctx.beginPath();
                    ctx.arc(npc.x, npc.y - 20, 6, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
        }

        function drawPlayer() {
            const ctx = elements.ctx;
            const x = GameState.player.position.x;
            const y = GameState.player.position.y;
            
            // Draw player body
            ctx.fillStyle = '#3060a8';
            ctx.fillRect(x - 10, y - 10, 20, 20);
            
            // Draw direction indicator
            ctx.fillStyle = '#ffcc00';
            switch(GameState.player.direction) {
                case 'up':
                    ctx.fillRect(x - 5, y - 10, 10, 5);
                    break;
                case 'down':
                    ctx.fillRect(x - 5, y + 5, 10, 5);
                    break;
                case 'left':
                    ctx.fillRect(x - 10, y - 5, 5, 10);
                    break;
                case 'right':
                    ctx.fillRect(x + 5, y - 5, 5, 10);
                    break;
            }
            
            // Draw running indicator
            if (GameState.player.isRunning) {
                ctx.fillStyle = '#ff4444';
                ctx.beginPath();
                ctx.arc(x, y + 15, 4, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawHUD() {
            const ctx = elements.ctx;
            const canvas = elements.canvas;
            
            // Draw HUD background
            ctx.fillStyle = 'rgba(15, 56, 15, 0.8)';
            ctx.fillRect(10, 10, 200, 50);
            ctx.strokeStyle = '#8bac0f';
            ctx.lineWidth = 2;
            ctx.strokeRect(10, 10, 200, 50);
            
            // Draw player info
            ctx.fillStyle = '#e8f8e0';
            ctx.font = '14px monospace';
            ctx.textAlign = 'left';
            ctx.fillText(GameState.player.name, 20, 30);
            ctx.fillText(`$${GameState.player.money}`, 20, 50);
            
            // Draw time
            ctx.fillText("TIME: 0:00", 120, 30);
            
            // Draw badges
            ctx.fillText(`BADGES: ${GameState.player.badges}/8`, 120, 50);
        }

        // ============================================
        // INTERACTION SYSTEM
        // ============================================
        function interactWithObject() {
            const player = GameState.player;
            
            // Check for NPC interactions
            for (const npc of GameState.map.npcs) {
                const distance = Math.sqrt(
                    Math.pow(player.position.x - npc.x, 2) + 
                    Math.pow(player.position.y - npc.y, 2)
                );
                
                if (distance < 40) {
                    // Check if player is facing NPC
                    let facingNPC = false;
                    switch(player.direction) {
                        case 'up':
                            facingNPC = player.position.y > npc.y && Math.abs(player.position.x - npc.x) < 20;
                            break;
                        case 'down':
                            facingNPC = player.position.y < npc.y && Math.abs(player.position.x - npc.x) < 20;
                            break;
                        case 'left':
                            facingNPC = player.position.x > npc.x && Math.abs(player.position.y - npc.y) < 20;
                            break;
                        case 'right':
                            facingNPC = player.position.x < npc.x && Math.abs(player.position.y - npc.y) < 20;
                            break;
                    }
                    
                    if (facingNPC) {
                        showDialog(npc.dialog);
                        return;
                    }
                }
            }
            
            // Check for building interactions
            for (const building of GameState.map.buildings) {
                const buildingCenterX = building.x + building.width / 2;
                const buildingCenterY = building.y + building.height / 2;
                
                const distance = Math.sqrt(
                    Math.pow(player.position.x - buildingCenterX, 2) + 
                    Math.pow(player.position.y - buildingCenterY, 2)
                );
                
                if (distance < 60) {
                    if (building.name === "YOUR HOUSE") {
                        showDialog("This is your house. Your bed looks comfortable!");
                    } else if (building.name === "OAK'S LAB") {
                        showDialog("PROF. OAK's POK√©MON RESEARCH LAB.");
                    }
                    return;
                }
            }
            
            // Default interaction
            showDialog("Nothing of interest here...");
        }

        function checkNPCProximity() {
            // Check if player is near any NPC for auto-trigger
            const player = GameState.player;
            
            for (const npc of GameState.map.npcs) {
                const distance = Math.sqrt(
                    Math.pow(player.position.x - npc.x, 2) + 
                    Math.pow(player.position.y - npc.y, 2)
                );
                
                if (distance < 30 && !GameState.dialog.active) {
                    // Small chance to trigger dialog when walking past
                    if (Math.random() < 0.01) {
                        showDialog("Hi there!");
                    }
                }
            }
        }

        // ============================================
        // BATTLE SYSTEM
        // ============================================
        function startBattle() {
            if (GameState.battle.active) return;
            
            // Create wild Pok√©mon
            const wildPokemon = {
                id: 16,
                name: "PIDGEY",
                level: 3,
                hp: 18,
                maxHp: 18,
                moves: [
                    { name: "TACKLE", pp: 30, maxPP: 30 },
                    { name: "GUST", pp: 30, maxPP: 30 }
                ]
            };
            
            GameState.battle.active = true;
            GameState.battle.enemy = wildPokemon;
            GameState.battle.turn = "player";
            
            // Switch to battle screen
            switchToScreen("battle");
            
            // Update battle UI
            updateBattleUI();
            
            // Show battle message
            showDialog(`Wild ${wildPokemon.name} appeared!`);
        }

        function initializeBattle() {
            // Setup battle UI
            updateBattleUI();
        }

        function updateBattleUI() {
            if (!GameState.battle.active) return;
            
            const playerPokemon = GameState.player.team[0];
            const enemyPokemon = GameState.battle.enemy;
            
            // Update names
            elements.battle.playerName.textContent = `${playerPokemon.name} Lv${playerPokemon.level}`;
            elements.battle.enemyName.textContent = `${enemyPokemon.name} Lv${enemyPokemon.level}`;
            
            // Update health bars
            const playerHealthPercent = (playerPokemon.hp / playerPokemon.maxHp) * 100;
            const enemyHealthPercent = (enemyPokemon.hp / enemyPokemon.maxHp) * 100;
            
            elements.battle.playerHealth.style.width = `${playerHealthPercent}%`;
            elements.battle.enemyHealth.style.width = `${enemyHealthPercent}%`;
            
            // Update health text
            elements.battle.playerHealthText.textContent = `HP: ${playerPokemon.hp}/${playerPokemon.maxHp}`;
            elements.battle.enemyHealthText.textContent = `HP: ${enemyPokemon.hp}/${enemyPokemon.maxHp}`;
            
            // Update sprites
            document.getElementById('player-sprite').textContent = "‚ö°";
            document.getElementById('enemy-sprite').textContent = "üê¶";
        }

        function handleBattleAction(action) {
            if (!GameState.battle.active) return;
            
            switch(action) {
                case 'fight':
                    showMoveSelection();
                    break;
                case 'pokemon':
                    showDialog("Choose a POK√©MON.");
                    break;
                case 'bag':
                    showDialog("Opened the BAG.");
                    break;
                case 'run':
                    attemptRun();
                    break;
            }
        }

        function showMoveSelection() {
            GameState.battle.menu = "moves";
            elements.battle.moveSelect.style.display = 'flex';
            
            const playerPokemon = GameState.player.team[0];
            const moveGrid = elements.battle.moveGrid;
            moveGrid.innerHTML = '';
            
            playerPokemon.moves.forEach(move => {
                const moveOption = document.createElement('div');
                moveOption.className = 'move-option';
                moveOption.textContent = move.name;
                moveOption.addEventListener('click', () => useMove(move.name));
                moveGrid.appendChild(moveOption);
            });
        }

        function closeMoveSelection() {
            GameState.battle.menu = null;
            elements.battle.moveSelect.style.display = 'none';
        }

        function useMove(moveName) {
            closeMoveSelection();
            
            const playerPokemon = GameState.player.team[0];
            const enemyPokemon = GameState.battle.enemy;
            
            // Simple damage calculation
            const damage = Math.floor(Math.random() * 10) + 5;
            enemyPokemon.hp = Math.max(0, enemyPokemon.hp - damage);
            
            // Show message
            showDialog(`${playerPokemon.name} used ${moveName}!`);
            
            // Update UI
            updateBattleUI();
            
            // Check if enemy fainted
            if (enemyPokemon.hp <= 0) {
                enemyFainted();
            } else {
                setTimeout(enemyTurn, 1500);
            }
        }

        function enemyTurn() {
            if (!GameState.battle.active || GameState.battle.enemy.hp <= 0) return;
            
            const enemyPokemon = GameState.battle.enemy;
            const playerPokemon = GameState.player.team[0];
            
            // Enemy attacks
            const damage = Math.floor(Math.random() * 8) + 3;
            playerPokemon.hp = Math.max(0, playerPokemon.hp - damage);
            
            // Show message
            showDialog(`Foe ${enemyPokemon.name} used TACKLE!`);
            
            // Update UI
            updateBattleUI();
            
            // Check if player fainted
            if (playerPokemon.hp <= 0) {
                playerFainted();
            }
        }

        function enemyFainted() {
            const enemyPokemon = GameState.battle.enemy;
            const playerPokemon = GameState.player.team[0];
            
            // Give experience
            const expGained = enemyPokemon.level * 10;
            
            // Show messages
            showDialog(`Foe ${enemyPokemon.name} fainted!`);
            setTimeout(() => {
                showDialog(`${playerPokemon.name} gained ${expGained} EXP. Points!`);
                setTimeout(endBattle, 1500);
            }, 1500);
        }

        function playerFainted() {
            const playerPokemon = GameState.player.team[0];
            
            showDialog(`${playerPokemon.name} fainted!`);
            setTimeout(() => {
                showDialog("You have no more Pok√©mon that can fight!");
                setTimeout(() => {
                    showDialog("You blacked out!");
                    setTimeout(endBattle, 1500);
                }, 1500);
            }, 1500);
        }

        function attemptRun() {
            const success = Math.random() > 0.2;
            if (success) {
                showDialog("Got away safely!");
                setTimeout(endBattle, 1000);
            } else {
                showDialog("Can't escape!");
                setTimeout(enemyTurn, 1500);
            }
        }

        function endBattle() {
            GameState.battle.active = false;
            switchToScreen("gameplay");
        }

        // ============================================
        // DIALOG SYSTEM
        // ============================================
        function showDialog(lines, callback = null) {
            if (typeof lines === 'string') {
                GameState.dialog.lines = lines.split('\n');
            } else {
                GameState.dialog.lines = lines;
            }
            
            GameState.dialog.currentLine = 0;
            GameState.dialog.active = true;
            GameState.dialog.typing = true;
            GameState.dialog.callback = callback;
            
            elements.dialog.box.style.display = 'block';
            typeDialogText();
        }

        function typeDialogText() {
            if (GameState.dialog.currentLine >= GameState.dialog.lines.length) {
                GameState.dialog.typing = false;
                if (GameState.dialog.callback) {
                    setTimeout(() => GameState.dialog.callback(), 500);
                }
                return;
            }
            
            const line = GameState.dialog.lines[GameState.dialog.currentLine];
            elements.dialog.text.textContent = '';
            GameState.dialog.currentLine++;
            
            let i = 0;
            const typeChar = () => {
                if (i < line.length && GameState.dialog.typing) {
                    elements.dialog.text.textContent += line.charAt(i);
                    i++;
                    setTimeout(typeChar, GameState.dialog.speed);
                } else {
                    GameState.dialog.typing = false;
                }
            };
            
            typeChar();
        }

        function handleDialogClick() {
            if (GameState.dialog.active) {
                if (GameState.dialog.typing) {
                    // Skip typing animation
                    GameState.dialog.typing = false;
                    elements.dialog.text.textContent = GameState.dialog.lines[GameState.dialog.currentLine - 1];
                } else {
                    advanceDialog();
                }
            }
        }

        function advanceDialog() {
            if (GameState.dialog.typing) {
                GameState.dialog.typing = false;
                elements.dialog.text.textContent = GameState.dialog.lines[GameState.dialog.currentLine - 1];
            } else {
                if (GameState.dialog.currentLine < GameState.dialog.lines.length) {
                    typeDialogText();
                } else {
                    closeDialog();
                }
            }
        }

        function closeDialog() {
            GameState.dialog.active = false;
            elements.dialog.box.style.display = 'none';
            GameState.dialog.callback = null;
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function checkOrientation() {
            const isPortrait = window.innerHeight > window.innerWidth;
            
            if (isPortrait) {
                elements.orientationWarning.style.display = 'flex';
                elements.mobileControls.style.display = 'none';
            } else {
                elements.orientationWarning.style.display = 'none';
                if (GameState.currentScreen === "gameplay") {
                    elements.mobileControls.style.display = 'flex';
                }
            }
        }

        function updateSaveInfo() {
            const saveData = localStorage.getItem('pokemon_save');
            if (saveData) {
                try {
                    const parsed = JSON.parse(saveData);
                    document.getElementById('save-info').textContent = 
                        `Saved: ${parsed.name} | ${parsed.badges} badges`;
                } catch (e) {
                    document.getElementById('save-info').textContent = "No save data";
                }
            } else {
                document.getElementById('save-info').textContent = "No save data";
            }
        }

        function continueGame() {
            const saveData = localStorage.getItem('pokemon_save');
            if (saveData) {
                try {
                    const parsed = JSON.parse(saveData);
                    GameState.player = parsed;
                    switchToScreen("gameplay");
                    showDialog(`Welcome back, ${GameState.player.name}!`);
                } catch (e) {
                    showDialog("Error loading save data!");
                }
            } else {
                showDialog("No save data found!");
            }
        }

        function showOptions() {
            showDialog([
                "OPTIONS",
                "Text Speed: FAST",
                "Battle Style: SET",
                "Sound: ON",
                "Music: ON"
            ]);
        }

        // ============================================
        // GAME LOOP
        // ============================================
        function gameLoop() {
            // Draw game world if in gameplay
            if (GameState.currentScreen === "gameplay" && !GameState.dialog.active && !GameState.battle.active) {
                drawGameWorld();
            }
            
            // Continue game loop
            requestAnimationFrame(gameLoop);
        }

        // ============================================
        // START THE GAME
        // ============================================
        window.addEventListener('load', initializeGame);
        
        // Prevent pull-to-refresh
        document.addEventListener('touchmove', (e) => {
            if (GameState.currentScreen === "gameplay") {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
