<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pokémon Nova Genesis</title>
    <style>
        @font-face {
            font-family: 'GBA';
            src: url('https://fonts.cdnfonts.com/s/14891/PokemonGb-RAeo.woff') format('woff');
        }
        :root {
            --gba-frame: #3a3a3a;
            --text-blue: #102040;
        }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: #111; overflow: hidden; font-family: 'GBA', monospace;
            display: flex; justify-content: center; align-items: center;
        }
        #game-wrapper {
            position: relative;
            width: 100vw; height: 100vh;
            max-width: 450px; /* Mobile width */
            background: var(--gba-frame);
            display: flex; flex-direction: column;
            border: 8px solid #222; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        canvas {
            image-rendering: pixelated;
            width: 100%; height: auto;
            background: #000;
        }
        /* Mobile Controls */
        #ui-layer {
            position: absolute; bottom: 0; width: 100%; height: 40%;
            background: #444; border-top: 4px solid #222;
            display: grid; grid-template-columns: 1fr 1fr;
            padding: 20px; box-sizing: border-box;
        }
        .dpad {
            display: grid; grid-template-columns: repeat(3, 45px);
            grid-template-rows: repeat(3, 45px);
        }
        .btn {
            background: #222; border: 2px solid #555; color: #fff;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px; font-size: 12px; touch-action: manipulation;
        }
        .btn:active { background: #666; }
        .dir-btn { border-radius: 5px; }
        .action-zone { display: flex; justify-content: flex-end; align-items: center; gap: 15px; }
        .circle-btn {
            width: 60px; height: 60px; border-radius: 50%;
            background: #800; border: 4px solid #400; font-weight: bold;
        }
        .btn-b { background: #990; border-color: #660; margin-top: 20px; }

        /* Text Box Overlay */
        #dialogue-container {
            position: absolute; top: 45%; left: 5%; right: 5%;
            height: 12%; background: #fff; border: 3px solid #102040;
            border-radius: 5px; padding: 10px; display: none; z-index: 100;
        }
        #text-content { font-size: 10px; line-height: 1.4; color: var(--text-blue); }
        #name-input {
            position: absolute; top: 30%; left: 50%; transform: translateX(-50%);
            background: white; border: 3px solid #102040; padding: 15px;
            display: none; text-align: center; z-index: 110;
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="screen" width="240" height="240"></canvas>
    
    <div id="dialogue-container">
        <div id="text-content"></div>
    </div>

    <div id="name-input">
        <p style="font-size: 10px;">YOUR NAME?</p>
        <input type="text" id="p-name" value="NOVA" maxlength="8" style="width: 80px; text-align: center;">
        <button onclick="submitName()">OK</button>
    </div>

    <div id="ui-layer">
        <div class="dpad">
            <div></div><div class="btn dir-btn" id="up">U</div><div></div>
            <div class="btn dir-btn" id="left">L</div><div></div><div class="btn dir-btn" id="right">R</div>
            <div></div><div class="btn dir-btn" id="down">D</div><div></div>
        </div>
        <div class="action-zone">
            <div class="btn circle-btn btn-b" id="b">B</div>
            <div class="btn circle-btn" id="a">A</div>
        </div>
    </div>
</div>

<script>
/**
 * POKEMON NOVA GENESIS - HIGH PRECISION GBA ENGINE
 */

const canvas = document.getElementById('screen');
const ctx = canvas.getContext('2d');
const textEl = document.getElementById('text-content');
const diagContainer = document.getElementById('dialogue-container');

// Game State Constants
const STATES = { TITLE: 0, PROF_INTRO: 1, NAMING: 2, STARTER_SELECT: 3, WORLD: 4 };
let currentState = STATES.TITLE;

// Game Data
let player = { x: 112, y: 120, dir: 'down', name: 'NOVA', starter: null, frame: 0 };
let worldMap = { tiles: [], width: 15, height: 15 };
let dialogueQueue = [];
let currentText = "";
let charIndex = 0;

// Input Buffer
const keys = { up: false, down: false, left: false, right: false, a: false, b: false };

/**
 * ASSET GENERATION (Pre-rendering pixel art so you don't need external files)
 */
const assets = {};
function createSprites() {
    // Player Sprite
    const pCanvas = document.createElement('canvas');
    pCanvas.width = 16; pCanvas.height = 16;
    const pCtx = pCanvas.getContext('2d');
    pCtx.fillStyle = '#f00'; pCtx.fillRect(4, 2, 8, 12); // Simple character
    assets.player = pCanvas;

    // Grass Tile
    const gCanvas = document.createElement('canvas');
    gCanvas.width = 16; gCanvas.height = 16;
    const gCtx = gCanvas.getContext('2d');
    gCtx.fillStyle = '#78c850'; gCtx.fillRect(0,0,16,16);
    gCtx.fillStyle = '#68b840'; gCtx.fillRect(2,2,2,2); gCtx.fillRect(10,8,2,2);
    assets.grass = gCanvas;
}

/**
 * ENGINE CORE
 */

function update() {
    if (currentState === STATES.WORLD) {
        if (keys.up) { player.y -= 1; player.dir = 'up'; }
        if (keys.down) { player.y += 1; player.dir = 'down'; }
        if (keys.left) { player.x -= 1; player.dir = 'left'; }
        if (keys.right) { player.x += 1; player.dir = 'right'; }
    }
}

function render() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    switch(currentState) {
        case STATES.TITLE:
            drawTitle();
            break;
        case STATES.PROF_INTRO:
            drawLab();
            drawNPC(112, 80, 'chen');
            break;
        case STATES.STARTER_SELECT:
            drawLab();
            drawStarters();
            break;
        case STATES.WORLD:
            drawWorld();
            break;
    }
}

// Sub-renders
function drawTitle() {
    ctx.fillStyle = '#204080';
    ctx.fillRect(0, 0, 240, 240);
    ctx.fillStyle = '#fff';
    ctx.textAlign = 'center';
    ctx.font = '14px Arial';
    ctx.fillText('POKEMON NOVA GENESIS', 120, 80);
    ctx.font = '8px Arial';
    ctx.fillText('PRESS A TO START', 120, 180);
}

function drawLab() {
    ctx.fillStyle = '#d0c8b0'; // Lab floor
    ctx.fillRect(0, 0, 240, 240);
}

function drawStarters() {
    const colors = ['#f08030', '#78c850', '#6890f0'];
    colors.forEach((c, i) => {
        ctx.fillStyle = c;
        ctx.fillRect(50 + (i * 60), 100, 24, 24);
    });
}

function drawWorld() {
    // Draw tiles
    for(let i=0; i<15; i++) {
        for(let j=0; j<15; j++) {
            ctx.drawImage(assets.grass, i*16, j*16);
        }
    }
    // Draw Player
    ctx.drawImage(assets.player, player.x, player.y);
}

function drawNPC(x, y, type) {
    ctx.fillStyle = '#fff';
    ctx.fillRect(x, y, 16, 24); // Professor shape
}

/**
 * DIALOGUE SYSTEM
 */
function playDialogue(lines) {
    dialogueQueue = lines;
    advanceDialogue();
}

function advanceDialogue() {
    if (dialogueQueue.length > 0) {
        diagContainer.style.display = 'block';
        currentText = dialogueQueue.shift();
        charIndex = 0;
        textEl.innerText = "";
        typeEffect();
    } else {
        diagContainer.style.display = 'none';
        handleStateProgression();
    }
}

function typeEffect() {
    if (charIndex < currentText.length) {
        textEl.innerText += currentText[charIndex];
        charIndex++;
        setTimeout(typeEffect, 30); // Text speed
    }
}

function handleStateProgression() {
    if (currentState === STATES.PROF_INTRO) {
        document.getElementById('name-input').style.display = 'block';
        currentState = STATES.NAMING;
    }
}

function submitName() {
    player.name = document.getElementById('p-name').value;
    document.getElementById('name-input').style.display = 'none';
    currentState = STATES.STARTER_SELECT;
    playDialogue([`Perfect, ${player.name}! Now, for your partner.`, "Which of these three resonates with you?"]);
}

/**
 * INPUTS
 */
function setupControls() {
    const bind = (id, key) => {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; handleInput(key); });
        el.addEventListener('touchend', () => { keys[key] = false; });
    };

    bind('up', 'up'); bind('down', 'down'); bind('left', 'left'); 
    bind('right', 'right'); bind('a', 'a'); bind('b', 'b');
}

function handleInput(key) {
    if (key === 'a') {
        if (currentState === STATES.TITLE) {
            currentState = STATES.PROF_INTRO;
            playDialogue([
                "Ah! There you are!",
                "Welcome to the world of Pokémon!",
                "My name is Chen.",
                "And you are...?"
            ]);
        } else if (diagContainer.style.display === 'block') {
            if (charIndex < currentText.length) {
                charIndex = currentText.length; // Skip typing
                textEl.innerText = currentText;
            } else {
                advanceDialogue();
            }
        } else if (currentState === STATES.STARTER_SELECT) {
            player.starter = "TREECKO";
            currentState = STATES.WORLD;
            playDialogue(["An excellent choice!", "Let's go meet Mom downstairs!"]);
        }
    }
}

// Initialize
createSprites();
setupControls();
function gameLoop() {
    update();
    render();
    requestAnimationFrame(gameLoop);
}
gameLoop();

</script>
</body>
</html>
