<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpine FPS - Snow Mountain Explorer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #87CEEB;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        canvas {
            display: block;
        }
        
        /* Mobile Controls */
        #controls {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        .joystick-area {
            position: absolute;
            width: 150px;
            height: 150px;
            pointer-events: auto;
        }
        
        #left-joystick {
            bottom: 30px;
            left: 30px;
        }
        
        #right-joystick {
            bottom: 30px;
            right: 30px;
        }
        
        .joystick-base {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
        }
        
        .joystick-thumb {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        #jump-button {
            position: absolute;
            right: 30px;
            top: 30px;
            width: 80px;
            height: 80px;
            background: rgba(52, 152, 219, 0.8);
            border-radius: 50%;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
        }
        
        #stats {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 5px;
            pointer-events: none;
        }
        
        #instructions {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            max-width: 300px;
            pointer-events: none;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial, sans-serif;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div id="loading">Loading Alpine FPS...</div>
    <div id="stats"></div>
    <div id="instructions">
        <h3>Alpine FPS</h3>
        <p>Left joystick: Move<br>Right joystick: Look around<br>Jump button: Jump</p>
        <p>Tap to start</p>
    </div>
    
    <div id="controls">
        <div id="left-joystick" class="joystick-area">
            <div class="joystick-base"></div>
            <div class="joystick-thumb" id="left-thumb"></div>
        </div>
        
        <div id="right-joystick" class="joystick-area">
            <div class="joystick-base"></div>
            <div class="joystick-thumb" id="right-thumb"></div>
        </div>
        
        <div id="jump-button">JUMP</div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Remove loading screen and instructions on first tap
        document.addEventListener('touchstart', function init() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('instructions').style.display = 'none';
            document.removeEventListener('touchstart', init);
        }, { once: true });
        
        // Core variables
        let scene, camera, renderer;
        let player, controls;
        let snowTerrain = [];
        let joystickState = { left: { x: 0, y: 0 }, right: { x: 0, y: 0 } };
        let isJumping = false;
        let velocityY = 0;
        const GRAVITY = -0.05;
        const JUMP_FORCE = 0.15;
        let isOnGround = false;
        let groundHeight = 0;
        
        // Initialize Three.js
        function init() {
            // Scene
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x87CEEB, 10, 100);
            
            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 0);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 100, 50);
            directionalLight.castShadow = true;
            directionalLight.shadow.camera.left = -100;
            directionalLight.shadow.camera.right = 100;
            directionalLight.shadow.camera.top = 100;
            directionalLight.shadow.camera.bottom = -100;
            scene.add(directionalLight);
            
            // Create player
            createPlayer();
            
            // Generate snow mountains
            generateTerrain();
            
            // Add sky
            const skyGeometry = new THREE.SphereGeometry(500, 32, 32);
            const skyMaterial = new THREE.MeshBasicMaterial({
                color: 0x87CEEB,
                side: THREE.BackSide
            });
            const sky = new THREE.Mesh(skyGeometry, skyMaterial);
            scene.add(sky);
            
            // Setup controls
            setupControls();
            
            // Start animation
            animate();
        }
        
        function createPlayer() {
            // Player collision body (invisible)
            player = new THREE.Group();
            player.position.set(0, 5, 0);
            scene.add(player);
            
            // Simple player visual (optional)
            const playerGeometry = new THREE.CapsuleGeometry(0.3, 1, 4, 8);
            const playerMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x3498db,
                shininess: 30 
            });
            const playerVisual = new THREE.Mesh(playerGeometry, playerMaterial);
            playerVisual.castShadow = true;
            player.add(playerVisual);
            
            // Camera is attached to player
            camera.position.set(0, 1.7, 0);
            player.add(camera);
        }
        
        function generateTerrain() {
            const terrainSize = 200;
            const segments = 100;
            
            // Create smooth terrain using sine waves
            const geometry = new THREE.PlaneGeometry(terrainSize, terrainSize, segments, segments);
            
            // Create mountainous terrain
            const vertices = geometry.attributes.position.array;
            for (let i = 0; i < vertices.length; i += 3) {
                const x = vertices[i];
                const z = vertices[i + 2];
                
                // Generate mountain-like terrain using multiple sine waves
                let height = 0;
                height += Math.sin(x * 0.05) * 8;
                height += Math.sin(z * 0.03) * 6;
                height += Math.sin((x + z) * 0.02) * 4;
                height += Math.sin(Math.sqrt(x*x + z*z) * 0.01) * 10;
                
                // Add some random peaks
                height += Math.random() * 2;
                
                vertices[i + 1] = height;
            }
            
            geometry.computeVertexNormals();
            
            const material = new THREE.MeshPhongMaterial({ 
                color: 0xf0f8ff,
                shininess: 10,
                flatShading: false
            });
            
            const terrain = new THREE.Mesh(geometry, material);
            terrain.rotation.x = -Math.PI / 2;
            terrain.receiveShadow = true;
            scene.add(terrain);
            snowTerrain.push(terrain);
            
            // Add more mountains in the distance
            for (let i = 0; i < 4; i++) {
                const distance = 150 + Math.random() * 100;
                const angle = Math.random() * Math.PI * 2;
                
                const farMountainGeometry = new THREE.ConeGeometry(15 + Math.random() * 20, 30 + Math.random() * 40, 8);
                const farMountain = new THREE.Mesh(farMountainGeometry, material);
                farMountain.position.set(
                    Math.cos(angle) * distance,
                    0,
                    Math.sin(angle) * distance
                );
                farMountain.receiveShadow = true;
                scene.add(farMountain);
                snowTerrain.push(farMountain);
            }
        }
        
        function setupControls() {
            const leftJoystick = document.getElementById('left-joystick');
            const leftThumb = document.getElementById('left-thumb');
            const rightJoystick = document.getElementById('right-joystick');
            const rightThumb = document.getElementById('right-thumb');
            const jumpButton = document.getElementById('jump-button');
            
            let leftActive = false;
            let rightActive = false;
            let leftStartX = 0, leftStartY = 0;
            let rightStartX = 0, rightStartY = 0;
            
            // Left joystick (movement)
            leftJoystick.addEventListener('touchstart', (e) => {
                leftActive = true;
                const rect = leftJoystick.getBoundingClientRect();
                leftStartX = rect.left + 75;
                leftStartY = rect.top + 75;
                e.preventDefault();
            });
            
            document.addEventListener('touchmove', (e) => {
                if (!leftActive) return;
                
                const touch = e.touches[0];
                let deltaX = touch.clientX - leftStartX;
                let deltaY = touch.clientY - leftStartY;
                
                // Limit joystick movement
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                if (distance > 50) {
                    deltaX = (deltaX / distance) * 50;
                    deltaY = (deltaY / distance) * 50;
                }
                
                // Update joystick visual
                leftThumb.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
                
                // Normalize values (-1 to 1)
                joystickState.left.x = deltaX / 50;
                joystickState.left.y = -deltaY / 50; // Invert Y for intuitive forward/backward
                
                e.preventDefault();
            });
            
            document.addEventListener('touchend', (e) => {
                leftActive = false;
                leftThumb.style.transform = 'translate(-50%, -50%)';
                joystickState.left.x = 0;
                joystickState.left.y = 0;
            });
            
            // Right joystick (camera)
            rightJoystick.addEventListener('touchstart', (e) => {
                rightActive = true;
                const rect = rightJoystick.getBoundingClientRect();
                rightStartX = rect.left + 75;
                rightStartY = rect.top + 75;
                e.preventDefault();
            });
            
            document.addEventListener('touchmove', (e) => {
                if (!rightActive) return;
                
                for (let i = 0; i < e.touches.length; i++) {
                    const touch = e.touches[i];
                    if (touch.target === rightJoystick || touch.target === rightThumb) {
                        let deltaX = touch.clientX - rightStartX;
                        let deltaY = touch.clientY - rightStartY;
                        
                        const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                        if (distance > 50) {
                            deltaX = (deltaX / distance) * 50;
                            deltaY = (deltaY / distance) * 50;
                        }
                        
                        rightThumb.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
                        
                        joystickState.right.x = deltaX / 50;
                        joystickState.right.y = deltaY / 50;
                        break;
                    }
                }
                e.preventDefault();
            });
            
            document.addEventListener('touchend', (e) => {
                rightActive = false;
                rightThumb.style.transform = 'translate(-50%, -50%)';
                joystickState.right.x = 0;
                joystickState.right.y = 0;
            });
            
            // Jump button
            jumpButton.addEventListener('touchstart', (e) => {
                if (isOnGround && !isJumping) {
                    isJumping = true;
                    velocityY = JUMP_FORCE;
                    isOnGround = false;
                }
                e.preventDefault();
            });
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
        }
        
        function updatePlayer() {
            const moveSpeed = 0.2;
            const lookSpeed = 0.03;
            
            // Camera rotation (right joystick)
            player.rotation.y -= joystickState.right.x * lookSpeed;
            camera.rotation.x -= joystickState.right.y * lookSpeed * 0.5;
            
            // Limit camera vertical look
            camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
            
            // Movement (left joystick)
            if (joystickState.left.x !== 0 || joystickState.left.y !== 0) {
                const angle = player.rotation.y;
                const forwardX = Math.sin(angle);
                const forwardZ = Math.cos(angle);
                
                const moveX = joystickState.left.x * forwardZ + joystickState.left.y * forwardX;
                const moveZ = joystickState.left.x * -forwardX + joystickState.left.y * forwardZ;
                
                player.position.x += moveX * moveSpeed;
                player.position.z += moveZ * moveSpeed;
            }
            
            // Jump physics
            if (!isOnGround) {
                velocityY += GRAVITY;
                player.position.y += velocityY;
                
                // Check ground collision
                if (player.position.y <= groundHeight) {
                    player.position.y = groundHeight;
                    velocityY = 0;
                    isOnGround = true;
                    isJumping = false;
                }
            }
            
            // Update ground height based on terrain
            updateGroundHeight();
            
            // Update stats display
            document.getElementById('stats').innerHTML = `
                Position: ${player.position.x.toFixed(1)}, ${player.position.y.toFixed(1)}, ${player.position.z.toFixed(1)}<br>
                On Ground: ${isOnGround}<br>
                Jumping: ${isJumping}
            `;
        }
        
        function updateGroundHeight() {
            // Simple ground detection (would need raycasting for proper collision)
            let minHeight = -1000;
            
            snowTerrain.forEach(terrain => {
                if (terrain.geometry.type === 'PlaneGeometry') {
                    // For the plane terrain
                    const terrainHeight = terrain.position.y;
                    if (player.position.y <= terrainHeight + 2) {
                        minHeight = Math.max(minHeight, terrainHeight);
                    }
                } else {
                    // For cone mountains (simplified)
                    const dx = player.position.x - terrain.position.x;
                    const dz = player.position.z - terrain.position.z;
                    const distance = Math.sqrt(dx * dx + dz * dz);
                    
                    if (distance < 20) { // Within mountain range
                        const height = terrain.position.y + (terrain.geometry.parameters.height || 0);
                        minHeight = Math.max(minHeight, height);
                    }
                }
            });
            
            if (minHeight > -1000) {
                groundHeight = minHeight + 1; // Player height offset
            }
            
            // If we're above ground, we're falling
            if (player.position.y > groundHeight) {
                isOnGround = false;
            }
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            updatePlayer();
            
            // Update fog based on altitude
            const altitude = player.position.y;
            scene.fog.near = Math.max(5, 10 - altitude);
            scene.fog.far = Math.max(50, 100 - altitude);
            
            renderer.render(scene, camera);
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // Start the game
        init();
    </script>
</body>
</html>
