<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pokémon K&E: Advanced Version</title>
    <style>
        :root {
            --gba-blue: #285088;
            --gba-light-blue: #5888c8;
            --font-main: 'Courier New', Courier, monospace;
        }

        body, html {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            background: #000; overflow: hidden; touch-action: none;
            display: flex; justify-content: center; align-items: center;
        }

        #game-wrapper { position: relative; width: 100%; height: 100%; }
        canvas { display: block; width: 100% !important; height: 100% !important; image-rendering: pixelated; }

        #title-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #fff; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 2000;
            font-family: var(--font-main);
        }

        #start-btn {
            padding: 15px 40px; font-size: 20px; background: var(--gba-blue);
            color: white; border: 4px solid white; cursor: pointer; border-radius: 10px;
        }

        /* BATTLE UI */
        #battle-ui {
            display: none; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; background: #e0f8cf; z-index: 4000;
            flex-direction: column; justify-content: space-between; font-family: var(--font-main);
        }

        .battle-arena {
            flex-grow: 1; position: relative; overflow: hidden;
            background: linear-gradient(to bottom, #88d0f0 0%, #88d0f0 50%, #d0f0a8 50%, #d0f0a8 100%);
        }

        .hp-box {
            position: absolute; background: #fffdf0; border: 4px solid #404040;
            padding: 10px; border-radius: 0 0 15px 0; width: 200px;
        }

        #player-hp-box { bottom: 120px; right: 20px; border-radius: 15px 0 0 15px; }
        #wild-hp-box { top: 40px; left: 20px; }

        .hp-bar-bg { height: 10px; background: #404040; border-radius: 5px; margin-top: 5px; }
        .hp-bar-fill { height: 100%; background: #70f8a8; width: 100%; transition: width 0.4s; border-radius: 5px; }

        #battle-menu {
            height: 100px; background: #404040; display: grid;
            grid-template-columns: 1fr 1fr; gap: 5px; padding: 10px;
        }

        .menu-btn {
            background: white; border: none; font-family: var(--font-main);
            font-weight: bold; font-size: 18px; cursor: pointer; border-radius: 5px;
        }

        #battle-msg {
            position: absolute; bottom: 110px; left: 0; width: 100%;
            background: rgba(255,255,255,0.9); padding: 10px; font-weight: bold;
            box-sizing: border-box; border-top: 4px solid var(--gba-blue);
        }

        #joystick-wrapper {
            position: absolute; bottom: 40px; left: 40px;
            width: 100px; height: 100px; background: rgba(255,255,255,0.2);
            border-radius: 50%; z-index: 1000;
        }
        #joystick-knob { width: 40px; height: 40px; background: #fff; border-radius: 50%; margin: 30px; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="title-screen">
        <h1 style="color: #ffcb05; text-shadow: 3px 3px #2a75bb;">POKÉMON K&E</h1>
        <button id="start-btn" onclick="startGame()">PRESS START</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="battle-ui">
        <div class="battle-arena">
            <div id="wild-hp-box" class="hp-box">
                <div id="wild-name" style="font-weight: bold;">WILD</div>
                <div class="hp-bar-bg"><div id="wild-hp-fill" class="hp-bar-fill"></div></div>
            </div>
            
            <canvas id="battleCanvas" style="position: absolute; width: 100%; height: 100%;"></canvas>

            <div id="player-hp-box" class="hp-box">
                <div id="player-name" style="font-weight: bold;">PARTNER</div>
                <div style="text-align: right; font-size: 12px;" id="player-hp-text">100/100</div>
                <div class="hp-bar-bg"><div id="player-hp-fill" class="hp-bar-fill"></div></div>
            </div>
            <div id="battle-msg">A wild Pokémon appeared!</div>
        </div>
        <div id="battle-menu">
            <button class="menu-btn" onclick="battleAction('fight')">FIGHT</button>
            <button class="menu-btn" onclick="battleAction('bag')">BAG</button>
            <button class="menu-btn" onclick="battleAction('pkmn')">POKÉMON</button>
            <button class="menu-btn" onclick="battleAction('run')">RUN</button>
        </div>
    </div>

    <div id="joystick-wrapper"><div id="joystick-knob"></div></div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const bCanvas = document.getElementById('battleCanvas');
    const bCtx = bCanvas.getContext('2d');

    // --- POKEMON DATA & SPRITES ---
    // Legend: G=Green, D=Dark Green, R=Red, O=Orange, W=White, B=Blue, K=Black, Y=Yellow
    const Pokedex = {
        'bulbasaur': {
            type: 'grass', hp: 45, atk: 49, def: 49, spd: 45,
            colors: { G:'#78C850', D:'#4A944A', K:'#000', W:'#FFF', R:'#E03030' },
            sprite: [
                '  KKKKK   ',
                ' KGGGGGK  ',
                'KGGWGGWGK ',
                'KGGGGGGGK ',
                ' KDRRRDDK ',
                '  KKKKK   '
            ]
        },
        'charmander': {
            type: 'fire', hp: 39, atk: 52, def: 43, spd: 65,
            colors: { O:'#F08030', Y:'#F8D030', K:'#000', W:'#FFF', R:'#F00' },
            sprite: [
                '   KKKK   ',
                '  KOOOOK  ',
                ' KOWOOWOK ',
                ' KOOOOOOK ',
                '  KYYYYK  ',
                '   K R K  '
            ]
        },
        'froakie': {
            type: 'water', hp: 41, atk: 56, def: 40, spd: 71,
            colors: { B:'#5090D6', L:'#A8D0E6', W:'#FFF', K:'#000' },
            sprite: [
                '  KKKKKK  ',
                ' KWWKKWWK ',
                'KLLWLLWLLK',
                'KBBBBBBBBK',
                ' KBBBBBBK ',
                '  KKKKKK  '
            ]
        }
    };

    const typeChart = {
        fire: { grass: 2, water: 0.5, fire: 0.5 },
        water: { fire: 2, grass: 0.5, water: 0.5 },
        grass: { water: 2, fire: 0.5, grass: 0.5 }
    };

    // --- GAME STATE ---
    let player = { x: 200, y: 200, size: 20, inventory: { pokeballs: 5 } };
    let follower = { active: false, name: '', hp: 0, maxHp: 0 };
    let wildPokemon = [];
    let inBattle = false;
    let battleState = {};

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        bCanvas.width = canvas.width;
        bCanvas.height = canvas.height * 0.7; 
        if(!inBattle) spawnWild();
    }
    window.addEventListener('resize', resize);
    resize();

    function spawnWild() {
        wildPokemon = [];
        const keys = Object.keys(Pokedex);
        for(let i=0; i<3; i++) {
            const name = keys[Math.floor(Math.random()*keys.length)];
            wildPokemon.push({
                name, x: Math.random()*(canvas.width-100)+50,
                y: Math.random()*(canvas.height-200)+50, active: true
            });
        }
    }

    // --- DRAWING ---
    function drawSprite(ctx, name, x, y, size, flip = false) {
        const p = Pokedex[name.toLowerCase()];
        if(!p) return;
        p.sprite.forEach((row, rIdx) => {
            row.split('').forEach((char, cIdx) => {
                if(char !== ' ') {
                    ctx.fillStyle = p.colors[char];
                    const xPos = flip ? x + (row.length - cIdx) * size : x + cIdx * size;
                    ctx.fillRect(xPos, y + rIdx * size, size, size);
                }
            });
        });
    }

    function gameLoop() {
        if(!inBattle) {
            ctx.fillStyle = '#90EE90';
            ctx.fillRect(0,0,canvas.width, canvas.height);
            
            // Draw Player
            ctx.fillStyle = '#333';
            ctx.fillRect(player.x, player.y, player.size, player.size);

            // Draw Wild Pokemon
            wildPokemon.forEach(w => {
                if(w.active) {
                    drawSprite(ctx, w.name, w.x, w.y, 4);
                    // Collision check
                    if(Math.abs(player.x - w.x) < 30 && Math.abs(player.y - w.y) < 30) {
                        startBattle(w);
                    }
                }
            });
        }
        requestAnimationFrame(gameLoop);
    }

    // --- BATTLE SYSTEM ---
    function startBattle(wild) {
        if(!follower.active) {
            // Auto-assign first pokemon if none (for demo)
            follower = { active: true, name: 'Froakie', hp: 41, maxHp: 41 };
        }
        inBattle = true;
        battleState = {
            wild: { ...wild, hp: Pokedex[wild.name].hp, maxHp: Pokedex[wild.name].hp },
            player: { ...follower },
            turn: 'player'
        };
        
        document.getElementById('battle-ui').style.display = 'flex';
        document.getElementById('wild-name').innerText = wild.name.toUpperCase();
        document.getElementById('player-name').innerText = follower.name.toUpperCase();
        updateBattleUI();
        renderBattleSprites();
    }

    function updateBattleUI() {
        const wPerc = (battleState.wild.hp / battleState.wild.maxHp) * 100;
        const pPerc = (battleState.player.hp / battleState.player.maxHp) * 100;
        document.getElementById('wild-hp-fill').style.width = wPerc + '%';
        document.getElementById('player-hp-fill').style.width = pPerc + '%';
        document.getElementById('player-hp-text').innerText = `${Math.ceil(battleState.player.hp)}/${battleState.player.maxHp}`;
    }

    function renderBattleSprites() {
        bCtx.clearRect(0,0,bCanvas.width, bCanvas.height);
        // Wild Pokemon (Top Right)
        drawSprite(bCtx, battleState.wild.name, bCanvas.width - 180, 60, 12);
        // Player Pokemon (Bottom Left)
        drawSprite(bCtx, battleState.player.name, 60, bCanvas.height - 180, 10, true);
    }

    function battleAction(type) {
        if(battleState.turn !== 'player') return;
        const msg = document.getElementById('battle-msg');

        if(type === 'fight') {
            const pData = Pokedex[battleState.player.name.toLowerCase()];
            const wData = Pokedex[battleState.wild.name.toLowerCase()];
            
            let mult = typeChart[pData.type][wData.type] || 1;
            let dmg = (pData.atk / wData.def) * 10 * mult;
            
            battleState.wild.hp -= dmg;
            msg.innerText = `${battleState.player.name} used Tackle!`;
            if(mult > 1) msg.innerText += " It's super effective!";
            
            updateBattleUI();
            battleState.turn = 'wild';
            
            if(battleState.wild.hp <= 0) {
                msg.innerText = `Wild ${battleState.wild.name} fainted!`;
                setTimeout(() => endBattle(), 1500);
            } else {
                setTimeout(wildTurn, 1000);
            }
        } else if (type === 'run') {
            msg.innerText = "Got away safely!";
            setTimeout(endBattle, 1000);
        }
    }

    function wildTurn() {
        const msg = document.getElementById('battle-msg');
        const wData = Pokedex[battleState.wild.name.toLowerCase()];
        const pData = Pokedex[battleState.player.name.toLowerCase()];
        
        let dmg = (wData.atk / pData.def) * 8;
        battleState.player.hp -= dmg;
        follower.hp = battleState.player.hp;
        
        msg.innerText = `Wild ${battleState.wild.name} used Scratch!`;
        updateBattleUI();

        if(battleState.player.hp <= 0) {
            msg.innerText = "Your Pokémon fainted...";
            setTimeout(endBattle, 1500);
        } else {
            battleState.turn = 'player';
        }
    }

    function endBattle() {
        inBattle = false;
        document.getElementById('battle-ui').style.display = 'none';
        spawnWild(); 
    }

    function startGame() {
        document.getElementById('title-screen').style.display = 'none';
        gameLoop();
    }

    // --- CONTROLS ---
    let stickX = 0, stickY = 0;
    const joystick = document.getElementById('joystick-wrapper');
    const knob = document.getElementById('joystick-knob');

    joystick.addEventListener('touchmove', (e) => {
        const rect = joystick.getBoundingClientRect();
        const touch = e.touches[0];
        const dx = touch.clientX - (rect.left + 50);
        const dy = touch.clientY - (rect.top + 50);
        const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 30);
        const angle = Math.atan2(dy, dx);
        
        stickX = Math.cos(angle) * (dist/30);
        stickY = Math.sin(angle) * (dist/30);
        knob.style.transform = `translate(${stickX*30}px, ${stickY*30}px)`;
        
        player.x += stickX * 5;
        player.y += stickY * 5;
    });

    joystick.addEventListener('touchend', () => {
        knob.style.transform = `translate(0,0)`;
        stickX = 0; stickY = 0;
    });

    // Keyboard support for testing
    window.addEventListener('keydown', (e) => {
        if(e.key === 'ArrowUp') player.y -= 10;
        if(e.key === 'ArrowDown') player.y += 10;
        if(e.key === 'ArrowLeft') player.x -= 10;
        if(e.key === 'ArrowRight') player.x += 10;
    });

</script>
</body>
</html>
