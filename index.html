<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pokémon Nova Genesis</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  body {
    margin:0; padding:0; overflow:hidden; background:#000; font-family:'Press Start 2P',cursive;
    height:100vh; touch-action:none; user-select:none;
  }
  #c {
    display:block; width:100vmin; height:calc(100vmin * 160/240);
    max-width:480px; max-height:320px;
    image-rendering:pixelated; image-rendering:crisp-edges;
    margin:0 auto; border:4px solid #222;
  }
  #ui {
    position:absolute; inset:0; pointer-events:none;
  }
  #dialog {
    position:absolute; bottom:6px; left:6px; right:6px; height:54px;
    background:#fff; border:4px solid #0040c0; color:#000;
    padding:6px 10px; font-size:11px; line-height:1.3;
    display:flex; align-items:center; overflow:hidden;
    pointer-events:auto;
  }
  #next { width:32px; height:32px; margin-left:8px; background:#0040c0; color:#fff;
          border:3px solid #fff; font-size:18px; flex-shrink:0;
          display:flex; align-items:center; justify-content:center; }
  #dpad {
    position:absolute; left:12px; bottom:12px; width:120px; height:120px;
    pointer-events:auto;
  }
  .btn {
    position:absolute; width:40px; height:40px; background:rgba(255,255,255,0.3);
    border:3px solid #fff; color:#000; font-weight:bold; font-size:24px;
    display:flex; align-items:center; justify-content:center;
  }
  #u { top:0;    left:40px; }
  #d { bottom:0; left:40px; }
  #l { left:0;   top:40px; }
  #r { right:0;  top:40px; }
  #a, #b {
    position:absolute; width:60px; height:60px; border-radius:50%;
    border:4px solid #fff; font-size:32px; font-weight:bold;
    display:flex; align-items:center; justify-content:center;
    pointer-events:auto;
  }
  #a { right:20px; bottom:80px; background:rgba(0,180,0,0.7); color:#fff; }
  #b { right:90px; bottom:30px; background:rgba(180,0,0,0.7); color:#fff; }
  #name, #confirm {
    position:absolute; inset:0; background:rgba(0,0,0,0.9);
    color:#fff; display:none; flex-direction:column;
    align-items:center; justify-content:center; z-index:10;
    pointer-events:auto;
  }
  #kb {
    display:grid; grid-template-columns:repeat(8,1fr); gap:4px;
    width:90%; max-width:340px; margin-top:20px;
  }
  .key {
    aspect-ratio:1; background:#555; border:2px solid #aaa; color:#fff;
    font-size:12px; display:flex; align-items:center; justify-content:center;
    cursor:pointer;
  }
  .key:active { background:#aaa; color:#000; }
  .wide { grid-column:span 2; }
  #confirm button {
    margin:12px 24px; padding:10px 32px; font-size:14px;
    background:#0040c0; color:#fff; border:3px solid #fff;
  }
</style>
</head>
<body>

<canvas id="c" width="240" height="160"></canvas>

<div id="ui">
  <div id="dialog" class="hidden">
    <span id="msg"></span>
    <div id="next">A</div>
  </div>
</div>

<div id="name">
  <div style="font-size:14px;margin-bottom:12px;">What's your name?</div>
  <div id="nametxt" style="font-size:18px;margin:16px 0;min-height:24px;">NOVA</div>
  <div id="kb"></div>
</div>

<div id="confirm">
  <div id="cmsg" style="margin:20px 0; font-size:14px; text-align:center; max-width:80%;"></div>
  <button id="cyes">YES</button>
  <button id="cno">NO</button>
</div>

<script>
// ────────────────────────────────────────────────
const c = document.getElementById('c');
const ctx = c.getContext('2d');
ctx.imageSmoothingEnabled = false;

const TILE = 16;
const COLS = 15;
const ROWS = 10;

let state = 'title';
let playerName = 'NOVA';
let starter = null;
let px = 7, py = 5, pdir = 2; // 0 up, 1 left, 2 down, 3 right
let fx = 7, fy = 6;           // follower
let dialogLines = [];
let dialogText = '';
let dialogChar = 0;
let mapId = 'house';

// ──────────────────────────────────────────────── Maps ────────────────────────────────────────────────
const maps = {
  house: [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,2,2,2,0,0,0,0,1], // door to outside
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
  ],
  outside: Array(40).fill().map(()=>Array(60).fill(11)) // big grass map
};

// Add some features to outside
for(let y=0;y<40;y++) for(let x=0;x<60;x++) {
  if(Math.random()<0.18) maps.outside[y][x] = 12; // tall grass
  if(Math.random()<0.03) maps.outside[y][x] = 13; // tree
}
// Gym building
for(let dy=-2;dy<=3;dy++) for(let dx=-4;dx<=4;dx++) {
  let tx=30+dx, ty=18+dy;
  if(tx>=0&&tx<60&&ty>=0&&ty<40) {
    maps.outside[ty][tx] = (dy===-2)?14:15; // roof / wall
  }
}
maps.outside[21][30] = 2; // gym door

const colors = {
  0:'#0000', 1:'#8c6840', 2:'#c09050', 11:'#88c070', 12:'#68a050',
  13:'#307020', 14:'#d82820', 15:'#e0d8d0'
};

function drawTile(x,y,t){
  if(!t) return;
  ctx.fillStyle=colors[t]||'#444';
  ctx.fillRect(x*TILE+camx,y*TILE+camy,TILE,TILE);
}

let camx=0, camy=0;
function updateCam(){
  camx = Math.floor(120 - (px+0.5)*TILE);
  camy = Math.floor(80  - (py+0.5)*TILE);
  if(mapId!=='outside'){
    camx = Math.max(-(15*TILE-240), Math.min(0,camx));
    camy = Math.max(-(10*TILE-160), Math.min(0,camy));
  }
}

function drawPlayer(){
  const sx = px*TILE + camx;
  const sy = py*TILE + camy;
  ctx.fillStyle='#f0d8a0'; ctx.fillRect(sx+4,sy,8,8);     // head
  ctx.fillStyle='#3060c0'; ctx.fillRect(sx+2,sy+8,12,12); // shirt
  ctx.fillStyle='#a84020'; ctx.fillRect(sx+4,sy+18,8,6);  // legs
}

function drawStarter(){
  if(!starter) return;
  const sx = fx*TILE + camx + 2;
  const sy = fy*TILE + camy + 2;
  if(starter==='charmander'){
    ctx.fillStyle='#ff8800'; ctx.fillRect(sx,sy+4,12,8);
    ctx.fillStyle='#ff4400'; ctx.fillRect(sx+8,sy,6,4);
  }else if(starter==='treecko'){
    ctx.fillStyle='#00cc66'; ctx.fillRect(sx,sy+4,12,8);
  }else{
    ctx.fillStyle='#4488ff'; ctx.fillRect(sx,sy+4,12,8);
  }
}

function render(){
  ctx.fillStyle='#000814';
  ctx.fillRect(0,0,240,160);

  if(state==='title'){
    ctx.fillStyle='#ffffff';
    ctx.font='bold 20px "Press Start 2P"';
    ctx.textAlign='center';
    ctx.fillText('Pokémon',120,60);
    ctx.fillStyle='#ff4444';
    ctx.font='bold 16px "Press Start 2P"';
    ctx.fillText('Nova Genesis',120,90);
    ctx.fillStyle='#cccccc';
    ctx.font='12px "Press Start 2P"';
    ctx.fillText('Tap to start',120,130);
  }
  else if(state==='choose'){
    ctx.fillStyle='#c8e0ff';
    ctx.fillRect(0,0,240,160);
    ctx.fillStyle='#888888';
    ctx.fillRect(40,100,48,16);
    ctx.fillRect(96,100,48,16);
    ctx.fillRect(152,100,48,16);

    [ {x:64,name:'CHARMANDER'}, {x:120,name:'TREECKO'}, {x:176,name:'FROAKIE'} ].forEach(p=>{
      ctx.fillStyle='white';
      ctx.beginPath(); ctx.arc(p.x,116,20,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='red'; ctx.fillRect(p.x-20,108,40,16);
      ctx.fillStyle='black';
      ctx.beginPath(); ctx.arc(p.x,116,8,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='white';
      ctx.font='10px "Press Start 2P"';
      ctx.textAlign='center';
      ctx.fillText(p.name,p.x,150);
    });
  }
  else {
    const m = maps[mapId] || maps.outside;
    for(let y=0;y<m.length;y++) for(let x=0;x<m[y].length;x++){
      drawTile(x,y,m[y][x]);
    }
    drawPlayer();
    drawStarter();
  }

  if(currentDialog){
    document.getElementById('msg').textContent = currentDialog.slice(0,dialogChar);
    document.getElementById('dialog').classList.remove('hidden');
  } else {
    document.getElementById('dialog').classList.add('hidden');
  }
}

// ──────────────────────────────────────────────── Dialogue & Flow ────────────────────────────────────────────────
function say(...lines){
  dialogLines.push(...lines);
  if(!currentDialog) nextLine();
}

function nextLine(){
  if(!dialogLines.length){
    currentDialog = '';
    if(state==='professor'){
      document.getElementById('name').style.display='flex';
    }
    return;
  }
  currentDialog = dialogLines.shift().replace('{name}',playerName);
  dialogChar = 0;
}

function advance(){
  if(dialogChar < currentDialog.length){
    dialogChar = currentDialog.length;
  } else {
    nextLine();
  }
}

document.getElementById('next').onclick = advance;

// ──────────────────────────────────────────────── Name input ────────────────────────────────────────────────
function buildKeyboard(){
  const keys = 'QWERTYUIOP ASDFGHJKL ZXCVBNM DEL OK'.split(' ');
  const kb = document.getElementById('kb');
  kb.innerHTML = '';
  keys.forEach(k=>{
    const b = document.createElement('div');
    b.className = 'key' + (k.length>1?' wide':'');
    b.textContent = k;
    b.onclick = ()=>{
      if(k==='OK'){
        if(playerName.trim()){
          document.getElementById('name').style.display='none';
          state = 'choose';
          say('Which Pokémon will you choose?');
        }
      }else if(k==='DEL'){
        playerName = playerName.slice(0,-1)||'';
      }else{
        playerName += k;
        if(playerName.length>10) playerName=playerName.slice(0,10);
      }
      document.getElementById('nametxt').textContent = playerName||'NOVA';
    };
    kb.appendChild(b);
  });
}
buildKeyboard();

// ──────────────────────────────────────────────── Starter choice ────────────────────────────────────────────────
c.onclick = e=>{
  if(state!=='choose') return;
  const r = c.getBoundingClientRect();
  const x = (e.clientX-r.left)*240/r.width;
  const y = (e.clientY-r.top)*160/r.height;

  if(y>80&&y<140){
    if(x<80) starter='charmander';
    else if(x<160) starter='treecko';
    else starter='froakie';

    if(starter){
      document.getElementById('cmsg').textContent = `You chose ${starter.toUpperCase()}!  Is that OK?`;
      document.getElementById('confirm').style.display='flex';
    }
  }
};

document.getElementById('cyes').onclick=()=>{
  document.getElementById('confirm').style.display='none';
  say('Great choice! Your new partner is full of energy!');
  say(`Come on ${starter.toUpperCase()}, let's go outside!`);
  setTimeout(()=>{
    mapId = 'outside';
    px=30; py=30;
    fx=30; fy=31;
    state='play';
    document.getElementById('controls').style.display='block';
  },1200);
};

document.getElementById('cno').onclick=()=>{
  document.getElementById('confirm').style.display='none';
  starter=null;
};

// ──────────────────────────────────────────────── Movement ────────────────────────────────────────────────
const input = {u:false,d:false,l:false,r:false};

['u','d','l','r'].forEach(k=>{
  const el = document.getElementById(k);
  el.ontouchstart = e=>{e.preventDefault(); input[k]=true;};
  el.ontouchend   = ()=>input[k]=false;
});

function move(){
  if(state!=='play') return;
  let dx=0, dy=0;
  if(input.u) dy=-1;
  if(input.d) dy=1;
  if(input.l) dx=-1;
  if(input.r) dx=1;

  if(dx||dy){
    const nx=px+dx, ny=py+dy;
    const m = maps[mapId]||maps.outside;
    if(nx>=0&&ny>=0&&ny<m.length&&nx<m[0].length){
      const t = m[ny][nx];
      if(t!==1 && t!==13 && t!==14 && t!==15 && t!==25){
        px=nx; py=ny;
        pdir = dy<0?0:dy>0?2:dx<0?1:3;
        // follow
        if(starter){
          fx = px - dx;
          fy = py - dy;
        }
      }
    }
  }
}

setInterval(move,120);

// ──────────────────────────────────────────────── Game start ────────────────────────────────────────────────
c.onclick = ()=>{
  if(state==='title'){
    state='professor';
    say("Ah! There you are! I've been expecting you.",
        "Welcome to the world of Pokémon!",
        "My name is Chen.",
        "And you are...?");
  }
};

function loop(){
  move();
  if(currentDialog) dialogChar = Math.min(dialogChar+1, currentDialog.length);
  render();
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
