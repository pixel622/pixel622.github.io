<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pokémon Nova Genesis</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:#000; font-family:'Press Start 2P',cursive; overflow:hidden; touch-action:none; height:100vh; }
  #container { position:relative; width:100vw; height:100vh; display:flex; align-items:center; justify-content:center; background:radial-gradient(#001122,#000); }
  #canvas { width:90vmin; height:calc(90vmin * 240/320); max-width:540px; max-height:405px; image-rendering:pixelated; image-rendering:crisp-edges; border:6px solid #222; box-shadow:0 0 30px rgba(0,255,255,0.3); }
  #ui { position:absolute; inset:0; pointer-events:none; }
  #dialogue { position:absolute; bottom:4%; left:4%; right:4%; height:18%; background:rgba(255,255,255,0.92); border:4px solid #0044cc; color:#000; padding:6px 10px; font-size:calc(10px + 0.8vw); line-height:1.3; display:flex; align-items:center; pointer-events:auto; overflow:hidden; }
  #advance { min-width:32px; height:32px; margin-left:8px; background:#0044cc; color:#fff; border:3px solid #fff; font-size:16px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
  #controls { position:fixed; bottom:0; left:0; right:0; height:38vh; pointer-events:none; display:none; }
  .dpad { position:absolute; left:6%; bottom:12%; width:28vw; height:28vw; max-width:140px; max-height:140px; }
  .dpad div { position:absolute; width:38%; height:38%; background:rgba(255,255,255,0.35); border:4px solid #fff; color:#000; font-weight:bold; font-size:min(7vw,32px); display:flex; align-items:center; justify-content:center; pointer-events:auto; }
  #up    { top:0;    left:31%; }
  #down  { bottom:0; left:31%; }
  #left  { left:0;   top:31%;  }
  #right { right:0;  top:31%;  }
  .ab { position:absolute; right:8%; bottom:14%; display:flex; flex-direction:column; gap:20%; }
  .ab div { width:22vw; height:22vw; max-width:100px; max-height:100px; border-radius:50%; border:5px solid #fff; font-size:min(9vw,40px); font-weight:bold; display:flex; align-items:center; justify-content:center; pointer-events:auto; }
  #a { background:rgba(0,220,0,0.85); color:#fff; }
  #b { background:rgba(220,0,0,0.85); color:#fff; }
  #menuIcon { position:fixed; top:4%; right:4%; width:60px; height:60px; background:rgba(0,120,255,0.8); border:4px solid #fff; border-radius:50%; color:#fff; font-size:28px; display:flex; align-items:center; justify-content:center; pointer-events:auto; z-index:10; }
  #menuPanel { position:fixed; inset:0; background:rgba(0,0,120,0.96); color:#fff; padding:10%; display:none; flex-direction:column; font-size:calc(10px + 1vw); z-index:20; pointer-events:auto; }
  .menuRow { padding:12px 0; border-bottom:1px solid #444; cursor:pointer; }
  .menuRow:active { background:rgba(255,255,255,0.2); }
  #nameScreen, #confirmScreen { position:fixed; inset:0; background:rgba(0,0,0,0.92); color:#fff; display:none; flex-direction:column; align-items:center; justify-content:center; font-size:calc(12px + 1.2vw); pointer-events:auto; z-index:30; }
  #nameText { margin:20px 0; font-size:1.4em; }
  #kb { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; max-width:90%; }
  .kbKey { aspect-ratio:1; background:#555; border:3px solid #aaa; color:#fff; font-size:calc(10px + 0.8vw); display:flex; align-items:center; justify-content:center; cursor:pointer; }
  .kbKey:active { background:#fff; color:#000; }
  .wide { grid-column:span 2; }
  #confirmScreen button { margin:15px 20px; padding:12px 32px; font-size:1.1em; background:#0044cc; color:#fff; border:3px solid #fff; cursor:pointer; }
  .hidden { display:none !important; }
</style>
</head>
<body>

<div id="container">
  <canvas id="canvas" width="320" height="240"></canvas>
  <div id="ui">
    <div id="dialogue" class="hidden"><span id="text"></span><div id="advance">▶</div></div>
  </div>

  <div id="nameScreen">
    <div id="nameText">NOVA</div>
    <div id="kb"></div>
  </div>

  <div id="confirmScreen">
    <div id="confirmMsg">You chose CHARMANDER! Are you sure?</div>
    <button id="yes">YES</button>
    <button id="no">NO</button>
  </div>

  <div id="controls">
    <div class="dpad">
      <div id="up">↑</div><div id="down">↓</div><div id="left">←</div><div id="right">→</div>
    </div>
    <div class="ab">
      <div id="b">B</div><div id="a">A</div>
    </div>
  </div>

  <div id="menuIcon">M</div>

  <div id="menuPanel">
    <div class="menuRow">Pokémon</div>
    <div class="menuRow">Bag → Potion x1</div>
    <div class="menuRow" id="saveBtn">Save Game</div>
    <div class="menuRow" id="closeMenu">Close</div>
  </div>
</div>

<script>
// ────────────────────────────────────────────────
const c = document.getElementById('canvas');
const ctx = c.getContext('2d');
ctx.imageSmoothingEnabled = false;

const TILE = 16;
const W = 320, H = 240;

let state = 'title';
let name = 'NOVA';
let starter = null;
let px = 8, py = 7, pdir = 2; // 0↑ 1← 2↓ 3→
let fx = 8, fy = 8;           // follower position
let camx = 0, camy = 0;
let map = 'bed';
let dialog = [];
let dtext = '';
let dpos = 0;
let potion = 1;
let talkedMom = false;
let showPokeChoice = false;

const maps = {
  bed: [ /* bedroom map same as before - omitted for brevity */ ],
  kit: [ /* kitchen map same as before */ ],
  town: [ /* town map same as before */ ],
  overworld: [ // NEW: very large grassy area
    Array(60).fill(11), // grass row (11 = green grass)
    Array(60).fill(11),
    Array(60).fill(11),
    Array(60).fill(11),
    Array(60).fill(11),
    Array(60).fill(11),
    Array(60).fill(11),
    Array(60).fill(11),
    Array(60).fill(11),
    Array(60).fill(11),
    // ... repeated many times for "extremely long"
  ].map(row => row.slice()) // make deep copy
};

// Fill overworld with grass + features
for (let y = 0; y < 40; y++) { // make it tall
  if (!maps.overworld[y]) maps.overworld[y] = Array(60).fill(11);
  for (let x = 0; x < 60; x++) {
    // Random tall grass patches
    if (Math.random() < 0.12) maps.overworld[y][x] = 24; // tall grass = 24
    // Trees
    if (Math.random() < 0.03) maps.overworld[y][x] = 25; // tree = 25
  }
}
// Gym Arena in center-ish
const gymX = 28, gymY = 18;
for (let dy = -2; dy <= 2; dy++) for (let dx = -3; dx <= 3; dx++) {
  if (maps.overworld[gymY+dy] && Math.abs(dx) + Math.abs(dy) < 5) {
    maps.overworld[gymY+dy][gymX+dx] = (dy === -2 && Math.abs(dx) < 3) ? 12 : 13; // roof red / building white
  }
}
maps.overworld[gymY+3][gymX] = 2; // door

const colors = {
  0: '#00000000',
  1: '#a87048',   // wall
  2: '#c08030',   // door
  11: '#90d070',  // normal grass
  24: '#70b050',  // tall grass (darker)
  25: '#307020',  // tree trunk + leaves
  12: '#d02020',  // gym roof
  13: '#f0f0f0',  // gym building
  // ... other colors from before
};

function drawTile(tx, ty, type) {
  if (type === 0) return;
  const sx = tx * TILE + camx;
  const sy = ty * TILE + camy;
  if (sx + TILE < 0 || sx > W || sy + TILE < 0 || sy > H) return;
  ctx.fillStyle = colors[type] || '#333';
  ctx.fillRect(sx, sy, TILE, TILE);
  // Tall grass overlay effect
  if (type === 24) {
    ctx.fillStyle = 'rgba(0,80,0,0.4)';
    ctx.fillRect(sx, sy, TILE, TILE);
  }
}

function drawMap() {
  const data = maps[map] || maps.overworld;
  const mw = data[0].length;
  const mh = data.length;
  for (let y = Math.max(0, Math.floor(-camy/TILE)); y < mh && y*TILE + camy < H; y++) {
    for (let x = Math.max(0, Math.floor(-camx/TILE)); x < mw && x*TILE + camx < W; x++) {
      drawTile(x, y, data[y][x]);
    }
  }
}

// ... keep drawChar, drawStarter as before ...

function updateCam() {
  camx = Math.floor(W/2 - (px + 0.5) * TILE);
  camy = Math.floor(H/2 - (py + 0.5) * TILE);
  // No hard clamp — allows "endless" feel in overworld
  if (map !== 'overworld') {
    camx = Math.max(-(maps[map][0].length * TILE - W), Math.min(0, camx));
    camy = Math.max(-(maps[map].length * TILE - H), Math.min(0, camy));
  }
}

function render() {
  ctx.fillStyle = '#081820';
  ctx.fillRect(0,0,W,H);

  if (state === 'title') {
    // title stars & text (same as before)
  } else if (state === 'prof' || state === 'choose') {
    ctx.fillStyle = '#c8e8ff';
    ctx.fillRect(0,0,W,H);
    drawChar(10, 4, 2);
    if (showPokeChoice) drawPokeChoice();
  } else {
    drawMap();
    drawChar(px, py, pdir, (performance.now()/200|0)%2);
    if (starter) drawStarter(fx, fy);
    if (map === 'kit' && !talkedMom) drawChar(9,5,2);
  }

  // dialog
  if (dtext) {
    document.getElementById('text').textContent = dtext.slice(0,dpos);
    document.getElementById('dialogue').classList.remove('hidden');
  } else {
    document.getElementById('dialogue').classList.add('hidden');
  }
}

// ... name input, confirm name → showPokeChoice = true, state = 'choose' ...

// Click to pick starter (same as before)
c.addEventListener('click', e => {
  if (state !== 'choose' || !showPokeChoice) return;
  const rect = c.getBoundingClientRect();
  const sx = W / rect.width;
  const sy = H / rect.height;
  const cx = (e.clientX - rect.left) * sx;
  const cy = (e.clientY - rect.top) * sy;

  const pokes = [
    {minX: 40, maxX: 120, poke:'charmander'},
    {minX: 140, maxX: 220, poke:'treecko'},
    {minX: 240, maxX: 320, poke:'froakie'}
  ];

  for (const p of pokes) {
    if (cx > p.minX && cx < p.maxX && cy > 100 && cy < 180) {
      document.getElementById('confirmMsg').textContent = `You chose ${p.poke.toUpperCase()}! Are you sure?`;
      document.getElementById('confirmScreen').style.display = 'flex';
      starter = p.poke;
      break;
    }
  }
});

// After confirm Yes → teleport outside to big overworld
document.getElementById('yes').onclick = () => {
  document.getElementById('confirmScreen').style.display = 'none';
  queueDialog([
    'An excellent choice!',
    `Alright, ${starter.toUpperCase()}! Let's go explore the world!`
  ]);
  // Teleport to overworld
  setTimeout(() => {
    map = 'overworld';
    px = 30; py = 30; // start near center/gym
    pdir = 0;
    fx = px; fy = py + 1; // follower starts below
    state = 'play';
    document.getElementById('controls').style.display = 'block';
  }, 1800);
};

// Movement (joystick/D-pad)
const dirs = {up:false,down:false,left:false,right:false};
['up','down','left','right'].forEach(d=>{
  const el = document.getElementById(d);
  el.ontouchstart = e=>{e.preventDefault(); dirs[d]=true;};
  el.ontouchend   = ()=>dirs[d]=false;
});

function gameLoop() {
  if (state === 'play') {
    let moved = false;
    if (dirs.up)    { pdir=0; moved = tryMove( 0,-1); }
    if (dirs.down)  { pdir=2; moved = tryMove( 0, 1); }
    if (dirs.left)  { pdir=1; moved = tryMove(-1, 0); }
    if (dirs.right) { pdir=3; moved = tryMove( 1, 0); }

    if (moved && starter) {
      // Pokémon follows (1 tile behind)
      fx = px - (pdir===1?-1:pdir===3?1:0);
      fy = py - (pdir===0?-1:pdir===2?1:0);
    }

    updateCam();
  }

  if (dtext) dpos = Math.min(dpos+2, dtext.length);

  render();
  requestAnimationFrame(gameLoop);
}

function tryMove(dx, dy) {
  const nx = px + dx, ny = py + dy;
  const m = maps[map] || maps.overworld;
  if (nx < 0 || ny < 0 || ny >= m.length || nx >= m[0].length) return false;
  const tile = m[ny][nx];
  if (tile === 1 || tile === 25 || tile === 12 || tile === 13) return false; // walls/trees/buildings
  px = nx; py = ny;
  // Tall grass "encounter" placeholder
  if (tile === 24 && Math.random() < 0.08) {
    queueDialog(['A wild Pokémon appeared! (battle coming soon...)']);
  }
  return true;
}

// Start game
c.onclick = () => {
  if (state === 'title') {
    state = 'prof';
    queueDialog([
      "Ah! There you are! I've been expecting you.",
      "Welcome to the world of Pokémon! My name is Chen.",
      "And you are...?"
    ]);
  }
};

gameLoop();
</script>
</body>
</html>
