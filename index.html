<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pokémon Amber: Following Partner</title>
    <style>
        :root {
            --gba-blue: #285088;
            --gba-light-blue: #5888c8;
            --font-main: 'Courier New', Courier, monospace;
        }

        body, html {
            margin: 0; padding: 0; 
            width: 100vw; height: 100vh;
            background: #000; overflow: hidden; 
            touch-action: none;
            display: flex; justify-content: center; align-items: center;
        }

        #game-wrapper {
            position: relative;
            width: 100%; height: 100%;
            background: #4a7a4a;
        }

        canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
            image-rendering: pixelated;
        }

        #ui-layer {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%); width: 90%;
            z-index: 100; cursor: pointer;
        }

        #dialogue-box {
            background: white;
            border: 6px solid var(--gba-blue);
            border-radius: 18px;
            padding: 20px;
            font-family: var(--font-main);
            font-weight: bold;
            font-size: 20px;
            box-shadow: inset 0 0 0 3px var(--gba-light-blue), 0 4px 10px rgba(0,0,0,0.5);
            min-height: 80px;
            user-select: none;
        }

        #speaker-tag {
            position: absolute; top: -25px; left: 30px;
            background: var(--gba-blue); color: white;
            padding: 5px 20px; border-radius: 10px 10px 0 0;
            font-size: 16px; border: 3px solid var(--gba-blue);
        }

        #joystick-wrapper {
            position: absolute; bottom: 40px; left: 40px;
            width: 140px; height: 140px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);
            display: flex; justify-content: center; align-items: center;
            z-index: 200;
        }

        #joystick-knob {
            width: 60px; height: 60px;
            background: rgba(255,255,255,0.6);
            border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }

        #shimmer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none;
            transition: opacity 0.4s; z-index: 999;
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="gameCanvas"></canvas>
    <div id="shimmer"></div>

    <div id="ui-layer" onclick="handleDialogueClick()">
        <div id="speaker-tag">Professor Sequoia</div>
        <div id="dialogue-box">Loading...</div>
    </div>

    <div id="joystick-wrapper">
        <div id="joystick-knob"></div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const knob = document.getElementById('joystick-knob');
    const wrapper = document.getElementById('joystick-wrapper');
    const dialogueBox = document.getElementById('dialogue-box');

    // Dialogue State
    const script = [
        "Welcome to the Orebound Region!",
        "Earlier, a mysterious tremor shook the lab.",
        "These three Pokémon need Trainers to protect them.",
        "Walk up and CLICK on the Pokémon you want to choose!"
    ];
    let scriptIndex = 0;
    let choosingState = false;

    // Game Setup
    let width, height;
    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
    }
    window.addEventListener('resize', resize);
    resize();

    const player = {
        x: width/2, y: height - 150,
        speed: 4, width: 40, height: 40,
        history: [] // Stores previous positions for follower to trace
    };

    const follower = {
        active: false,
        name: '',
        x: 0, y: 0,
        color: '#000',
        targetDist: 50 // How far behind the player it sits
    };

    const pokeballs = [
        { name: 'Treecko', x: 0, y: 0, color: '#32CD32', active: true },
        { name: 'Froakie', x: 0, y: 0, color: '#1E90FF', active: true },
        { name: 'Charmander', x: 0, y: 0, color: '#FF4500', active: true }
    ];

    // Input Logic
    let stickX = 0, stickY = 0, isTouching = false;

    function handleDialogueClick() {
        if (scriptIndex < script.length - 1) {
            scriptIndex++;
            updateUI();
        } else {
            choosingState = true;
            dialogueBox.innerText = "Click a Pokéball to choose your partner!";
        }
    }

    function updateUI() {
        dialogueBox.innerText = script[scriptIndex];
    }
    updateUI();

    canvas.addEventListener('mousedown', (e) => checkPokeClick(e.clientX, e.clientY));
    canvas.addEventListener('touchstart', (e) => checkPokeClick(e.touches[0].clientX, e.touches[0].clientY));

    function checkPokeClick(clickX, clickY) {
        if (!choosingState || follower.active) return;
        
        pokeballs.forEach(ball => {
            if(!ball.active) return;
            const dx = clickX - ball.realX;
            const dy = clickY - ball.realY;
            if (Math.sqrt(dx*dx + dy*dy) < 30) {
                selectPokemon(ball);
            }
        });
    }

    function selectPokemon(ball) {
        document.getElementById('shimmer').style.opacity = '1';
        follower.active = true;
        follower.name = ball.name;
        follower.color = ball.color;
        follower.x = ball.realX;
        follower.y = ball.realY;
        
        ball.active = false; // Remove the ball from the desk
        
        setTimeout(() => {
            document.getElementById('shimmer').style.opacity = '0';
            dialogueBox.innerText = "Professor Sequoia: " + ball.name + " seems to really like you! It wants to follow you.";
        }, 600);
    }

    // Joystick Engine
    wrapper.addEventListener('touchstart', () => isTouching = true);
    window.addEventListener('touchend', () => {
        isTouching = false; stickX = 0; stickY = 0;
        knob.style.transform = `translate(0px, 0px)`;
    });

    window.addEventListener('touchmove', (e) => {
        if (!isTouching) return;
        const rect = wrapper.getBoundingClientRect();
        const touch = e.touches[0];
        let dx = touch.clientX - (rect.left + rect.width/2);
        let dy = touch.clientY - (rect.top + rect.height/2);
        const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 45);
        const angle = Math.atan2(dy, dx);
        
        stickX = Math.cos(angle) * (dist/45);
        stickY = Math.sin(angle) * (dist/45);
        knob.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
    });

    function update() {
        if (isTouching) {
            // Save current position to history for the follower
            player.history.push({x: player.x, y: player.y});
            if (player.history.length > 100) player.history.shift();

            player.x += stickX * player.speed;
            player.y += stickY * player.speed;
        }

        // Follower logic: Move toward a point in player's history
        if (follower.active && player.history.length > 15) {
            const followPoint = player.history[player.history.length - 15];
            follower.x += (followPoint.x - follower.x) * 0.1;
            follower.y += (followPoint.y - follower.y) * 0.1;
        }
    }

    function draw() {
        ctx.clearRect(0, 0, width, height);

        // Draw Floor
        ctx.fillStyle = '#d89060';
        ctx.fillRect(0, 0, width, height);
        ctx.strokeStyle = '#b87040';
        for(let i=0; i<width; i+=50) ctx.strokeRect(i, 0, 50, height);

        // Draw Lab Desk
        const deskW = 350, deskH = 100;
        const deskX = width/2 - deskW/2, deskY = height/3;
        ctx.fillStyle = '#804020';
        ctx.fillRect(deskX, deskY, deskW, deskH);
        ctx.strokeRect(deskX, deskY, deskW, deskH);

        // Draw Pokéballs
        pokeballs.forEach((ball, i) => {
            if (!ball.active) return;
            ball.realX = deskX + 60 + (i * 110);
            ball.realY = deskY + 40;
            
            ctx.fillStyle = 'red';
            ctx.beginPath(); ctx.arc(ball.realX, ball.realY, 15, Math.PI, 0); ctx.fill();
            ctx.fillStyle = 'white';
            ctx.beginPath(); ctx.arc(ball.realX, ball.realY, 15, 0, Math.PI); ctx.fill();
            ctx.strokeStyle = 'black'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(ball.realX - 15, ball.realY); ctx.lineTo(ball.realX + 15, ball.realY); ctx.stroke();
            
            if (choosingState) {
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(ball.realX - 40, ball.realY - 45, 80, 20);
                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center';
                ctx.fillText(ball.name.toUpperCase(), ball.realX, ball.realY - 30);
            }
        });

        // Draw Follower Pokémon
        if (follower.active) {
            ctx.fillStyle = follower.color;
            ctx.beginPath(); ctx.arc(follower.x, follower.y, 12, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'white'; // Eyes for follower
            ctx.fillRect(follower.x - 5, follower.y - 4, 3, 3);
            ctx.fillRect(follower.x + 2, follower.y - 4, 3, 3);
        }

        // Draw Character Sprite
        const p = player;
        ctx.fillStyle = '#333'; ctx.fillRect(p.x - 15, p.y + 15, 10, 10); ctx.fillRect(p.x + 5, p.y + 15, 10, 10); // Feet
        ctx.fillStyle = '#a03030'; ctx.fillRect(p.x - 15, p.y - 10, 30, 25); // Body
        ctx.fillStyle = '#ffdbac'; ctx.fillRect(p.x - 10, p.y - 25, 20, 18); // Head
        ctx.fillStyle = 'white'; ctx.fillRect(p.x - 12, p.y - 30, 24, 8); // White Bandana/Hat
        ctx.fillStyle = '#000'; ctx.fillRect(p.x - 6, p.y - 18, 3, 3); ctx.fillRect(p.x + 3, p.y - 18, 3, 3); // Eyes

        update();
        requestAnimationFrame(draw);
    }

    draw();
</script>
</body>
</html>
